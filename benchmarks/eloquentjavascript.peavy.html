<html><head><link rel="stylesheet" type="text/css" href="css/book.css"/><link rel="stylesheet" type="text/css" href="css/highlight.css"/><link rel="stylesheet" type="text/css" href="css/console.css"/><link rel="stylesheet" type="text/css" href="css/codemirror.css"/><meta http-equiv="Content-Type" content="text/html;charset=utf-8"/><title>Print Version -- Eloquent JavaScript</title></head><body><div class="content"><h1><span class="number">Chapter 1: </span>Introduction</h1><div class="block"><p><a class="paragraph" href="#p791f9bee86072a50" name="p791f9bee86072a50"> ¶ </a>When personal computers were first introduced, most of them cameequipped with a simple programming language, usually a variant of<a name="key1"></a>BASIC. Interacting with the computer was closely integrated withthis language, and thus every computer-user, whether he wanted to ornot, would get a taste of it. Now that computers have become plentifuland cheap, typical users don't get much further than clicking thingswith a mouse. For most people, this works very well. But for those ofus with a natural inclination towards technological tinkering, theremoval of programming from every-day computer use presents somethingof a barrier.</p><p><a class="paragraph" href="#p4adc934200807fbb" name="p4adc934200807fbb"> ¶ </a>Fortunately, as an effect of developments in the World Wide Web, it sohappens that every computer equipped with a modern web-browser alsohas an environment for programming JavaScript. In today's spirit ofnot bothering the user with technical details, it is kept well hidden,but a web-page can make it accessible, and use it as a platform forlearning to program.</p><p><a class="paragraph" href="#pe15267081702eb5" name="pe15267081702eb5"> ¶ </a>That is what this (hyper-)book tries to do.</p></div><hr/><div class="block"><blockquote>I do not enlighten those who are not eager to learn, nor arouse thosewho are not anxious to give an explanation themselves. If I havepresented one corner of the square and they cannot come back to mewith the other three, I should not go over the points again.<br/><br/>― Confucius</blockquote><p><a class="paragraph" href="#p7168e82dd605bf59" name="p7168e82dd605bf59"> ¶ </a>Besides explaining JavaScript, this book tries to be an introductionto the basic principles of programming. Programming, it turns out, ishard. The fundamental rules are, most of the time, simple and clear.But programs, while built on top of these basic rules, tend to becomecomplex enough to introduce their own rules, their own complexity.Because of this, programming is rarely simple or predictable. AsDonald Knuth, who is something of a founding father of the field,says, it is an <em>art</em>.</p><p><a class="paragraph" href="#p2849f125de87d3b5" name="p2849f125de87d3b5"> ¶ </a>To get something out of this book, more than just passive reading isrequired. Try to stay sharp, make an effort to solve the exercises,and only continue on when you are reasonably sure you understand thematerial that came before.</p></div><hr/><div class="block"><blockquote>The computer programmer is a creator of universes for which he aloneis responsible. Universes of virtually unlimited complexity can becreated in the form of computer programs.<br/><br/>― Joseph Weizenbaum, <em>Computer Power and Human Reason</em></blockquote><p><a class="paragraph" href="#p6fd53be181d82388" name="p6fd53be181d82388"> ¶ </a>A program is many things. It is a piece of text typed by a programmer,it is the directing force that makes the computer do what it does, itis data in the computer's memory, yet it controls the actionsperformed on this same memory. Analogies that try to compare programsto objects we are familiar with tend to fall short, but asuperficially fitting one is that of a machine. The gears of amechanical watch fit together ingeniously, and if the watchmaker wasany good, it will accurately show the time for many years. Theelements of a program fit together in a similar way, and if theprogrammer knows what he is doing, the program will run withoutcrashing.</p><p><a class="paragraph" href="#p48ff3e75bab11884" name="p48ff3e75bab11884"> ¶ </a>A computer is a machine built to act as a host for these immaterialmachines. Computers themselves can only do stupidly straightforwardthings. The reason they are so useful is that they do these things atan incredibly high speed. A program can, by ingeniously combining manyof these simple actions, do very complicated things.</p><p><a class="paragraph" href="#p1ff6d46adeaed61b" name="p1ff6d46adeaed61b"> ¶ </a>To some of us, writing computer programs is a fascinating game. Aprogram is a building of thought. It is costless to build, weightless,growing easily under our typing hands. If we get carried away, itssize and complexity will grow out of control, confusing even the onewho created it. This is the main problem of programming. It is why somuch of today's software tends to crash, fail, screw up.</p><p><a class="paragraph" href="#p5a4281d62a20af99" name="p5a4281d62a20af99"> ¶ </a>When a program works, it is beautiful. The art of programming is theskill of controlling complexity. The great program is subdued, madesimple in its complexity.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p4e3bc648db1c061d" name="p4e3bc648db1c061d"> ¶ </a>Today, many programmers believe that this complexity is best managedby using only a small set of well-understood techniques in theirprograms. They have composed strict rules about the form programsshould have, and the more zealous among them will denounce those whobreak these rules as <em>bad</em> programmers.</p><p><a class="paragraph" href="#pb85bd0b48cb88dd" name="pb85bd0b48cb88dd"> ¶ </a>What hostility to the richness of programming! To try to reduce it tosomething straightforward and predictable, to place a taboo on all theweird and beautiful programs. The landscape of programming techniquesis enormous, fascinating in its diversity, still largely unexplored.It is certainly littered with traps and snares, luring theinexperienced programmer into all kinds of horrible mistakes, but thatonly means you should proceed with caution, keep your wits about you.As you learn, there will always be new challenges, new territory toexplore. The programmer who refuses to keep exploring will surelystagnate, forget his joy, lose the will to program (and become amanager).</p><p><a class="paragraph" href="#p6c59c7812ba8b9bb" name="p6c59c7812ba8b9bb"> ¶ </a>As far as I am concerned, the definite criterion for a program iswhether it is correct. Efficiency, clarity, and size are alsoimportant, but how to balance these against each other is always amatter of judgement, a judgement that each programmer must make forhimself. Rules of thumb are useful, but one should never be afraid tobreak them.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p6e133d7403fcf291" name="p6e133d7403fcf291"> ¶ </a>In the beginning, at the birth of computing, there were no programminglanguages. Programs looked something like this:</p><pre class="preformatted">00110001 00000000 0000000000110001 00000001 0000000100110011 00000001 0000001001010001 00001011 0000001000100010 00000010 0000100001000011 00000001 0000000001000001 00000001 0000000100010000 00000010 0000000001100010 00000000 00000000</pre><p><a class="paragraph" href="#p3be310f42eba4016" name="p3be310f42eba4016"> ¶ </a>That is a program to add the numbers from one to ten together, andprint out the result (1 + 2 + ... + 10=55). It could run on a verysimple kind of computer. To program early computers, it was necessaryto set large arrays of switches in the right position, or punch holesin strips of cardboard and feed them to the computer. You can imaginehow this was a tedious, error-prone procedure. Even the writing ofsimple programs required much cleverness and discipline, complex oneswere nearly inconceivable.</p><p><a class="paragraph" href="#p4bd5ecf3f5dbb2e3" name="p4bd5ecf3f5dbb2e3"> ¶ </a>Of course, manually entering these arcane patterns of bits (which iswhat the 1s and 0s above are generally called) did give the programmera profound sense of being a mighty wizard. And that has to be worthsomething, in terms of job satisfaction.</p><p><a class="paragraph" href="#p99870ffbdcd77f1" name="p99870ffbdcd77f1"> ¶ </a>Each line of the program contains a single instruction. It could bewritten in English like this:</p><ol><li>Store the number 0 in memory location 0</li><li>Store the number 1 in memory location 1</li><li>Store the value of memory location 1 in memory location 2</li><li>Decrement the value in memory location 2 by the number 11</li><li>If the value in memory location 2 is the number 0, continue with instruction 9</li><li>Increment the value in memory location 0 by the value in memory location 1</li><li>Increment the value in memory location 1 by the number 1</li><li>Continue with instruction 3</li><li>Output the value of memory location 0</li></ol><p><a class="paragraph" href="#p28087410c8942294" name="p28087410c8942294"> ¶ </a>While that is more readable than the binary soup, it is still ratherunpleasant. It might help to use names instead of numbers for theinstructions and memory locations:</p><pre class="preformatted"> Set 'total' to 0 Set 'count' to 1[loop] Set 'compare' to 'count' Subtract 11 from 'compare' If 'compare' is zero, continue at [end] Add 'count' to 'total' Add 1 to 'count' Continue at [loop][end] Output 'total'</pre><p><a class="paragraph" href="#p742448e76c15459b" name="p742448e76c15459b"> ¶ </a>At this point it is not too hard to see how the program works. Canyou? The first two lines give two memory locations their startingvalues: <code>total</code> will be used to build up the result of the program,and <code>count</code> keeps track of the number that we are currently lookingat. The lines using <code>compare</code> are probably the weirdest ones. What theprogram wants to do is see if <code>count</code> is equal to 11, in order todecide whether it can stop yet. Because the machine is so primitive,it can only test whether a number is zero, and make a decision (jump)based on that. So it uses the memory location labelled <code>compare</code> tocompute the value of <code>count - 11</code>, and makes a decision based on thatvalue. The next two lines add the value of <code>count</code> to the result, andincrement <code>count</code> by one every time the program has decided that it isnot 11 yet.</p><p><a class="paragraph" href="#p485d88d71ab25ae7" name="p485d88d71ab25ae7"> ¶ </a>Here is the same program in JavaScript:</p><pre class="code"><span class="keyword">var</span><span class="variable">total</span>=<span class="atom">0</span>, <span class="variable">count</span>=<span class="atom">1</span>;<span class="keyword">while</span> (<span class="variable">count</span> &lt;=<span class="atom">10</span>){<span class="variable">total</span> +=<span class="variable">count</span>;<span class="variable">count</span> +=<span class="atom">1</span>;}<span class="variable">print</span>(<span class="variable">total</span>);</pre><p><a class="paragraph" href="#p500d53fd9ae8deba" name="p500d53fd9ae8deba"> ¶ </a>This gives us a few more improvements. Most importantly, there is noneed to specify the way we want the program to jump back and forthanymore. The magic word <code>while</code> takes care of that. It continuesexecuting the lines below it as long as the condition it was givenholds: <code>count &lt;=10</code>, which means '<code>count</code> is less than or equalto <code>10</code>'. Apparently, there is no need anymore to create a temporaryvalue and compare that to zero. This was a stupid little detail, andthe power of programming languages is that they take care of stupidlittle details for us.</p><p><a class="paragraph" href="#p71e06cf06ceceb6e" name="p71e06cf06ceceb6e"> ¶ </a>Finally, here is what the program could look like if we happened tohave the convenient operations <code>range</code> and <code>sum</code> available, whichrespectively create a collection of numbers within a range and computethe sum of a collection of numbers:</p><pre class="code"><span class="variable">print</span>(<span class="variable">sum</span>(<span class="variable">range</span>(<span class="atom">1</span>, <span class="atom">10</span>)));</pre><p><a class="paragraph" href="#p5748f0480052ee2d" name="p5748f0480052ee2d"> ¶ </a>The moral of this story, then, is that the same program can beexpressed in long and short, unreadable and readable ways. The firstversion of the program was extremely obscure, while this last one isalmost English: <code>print</code> the <code>sum</code> of the <code>range</code> of numbers from <code>1</code>to <code>10</code>. (We will see in later chapters how to build things like <code>sum</code>and <code>range</code>.)</p><p><a class="paragraph" href="#pf3fe04d4c3f6ccc" name="pf3fe04d4c3f6ccc"> ¶ </a>A good programming language helps the programmer by providing a moreabstract way to express himself. It hides uninteresting details,provides convenient building blocks (such as the <code>while</code> construct),and, most of the time, allows the programmer to add building blockshimself (such as the <code>sum</code> and <code>range</code> operations).</p></div><hr/><div class="block"><p><a class="paragraph" href="#p3ec4f0fa1d7306d6" name="p3ec4f0fa1d7306d6"> ¶ </a>JavaScript is the language that is, at the moment, mostly being usedto do all kinds of clever and horrible things with pages on the WorldWide Web. Some <a href="http://steve-yegge.blogspot.com/2007/02/next-big-language.html">people</a> claimthat the next version of JavaScript will become an important languagefor other tasks too. I am unsure whether that will happen, but if youare interested in programming, JavaScript is definitely a usefullanguage to learn. Even if you do not end up doing muchweb programming, the mind-bending programs I will show you in thisbook will always stay with you, haunt you, and influence the programsyou write in other languages.</p><p><a class="paragraph" href="#p6ffc7e890b848901" name="p6ffc7e890b848901"> ¶ </a>There are those who will say <em>terrible</em> things about JavaScript. Manyof these things are true. When I was for the first time required towrite something in JavaScript, I quickly came to despise the language.It would accept almost anything I typed, but interpret it in a waythat was completely different from what I meant. This had a lot to dowith the fact that I did not have a clue what I was doing, but thereis also a real issue here: JavaScript is ridiculously liberal in whatit allows. The idea behind this design was that it would makeprogramming in JavaScript easier for beginners. In actuality, itmostly makes finding problems in your programs harder, because thesystem will not point them out to you.</p><p><a class="paragraph" href="#p6403e6cf1d6fd4ed" name="p6403e6cf1d6fd4ed"> ¶ </a>However, the flexibility of the language is also an advantage. Itleaves space for a lot of techniques that are impossible in more rigidlanguages, and it can be used to overcome some of JavaScript'sshortcomings. After learning it properly, and working with it for awhile, I have really learned to <em>like</em> this language.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p5d372a74466674a7" name="p5d372a74466674a7"> ¶ </a>Contrary to what the name suggests, JavaScript has very little to dowith the programming language named Java. The similar name wasinspired by marketing considerations, rather than good judgement. In1995, when JavaScript was introduced by Netscape, the Java languagewas being heavily marketed and gaining in popularity. Apparently,someone thought it a good idea to try and ride along on thismarketing. Now we are stuck with the name.</p><p><a class="paragraph" href="#p20bc2e21c259965b" name="p20bc2e21c259965b"> ¶ </a>Related to JavaScript is a thing called ECMAScript. When browsersother than Netscape started to support JavaScript, or something thatlooked like it, a document was written to describe precisely how thelanguage should work. The language described in this document iscalled ECMAScript, after the organisation that standardised it.</p><p><a class="paragraph" href="#p223e1f11afa03b89" name="p223e1f11afa03b89"> ¶ </a>ECMAScript describes a general-purpose programming language, and doesnot say anything about the integration of this language in an Internetbrowser. JavaScript is ECMAScript plus extra tools for dealing withInternet pages and browser windows.</p><p><a class="paragraph" href="#p680aa5a209e425af" name="p680aa5a209e425af"> ¶ </a>A few other pieces of software use the language described in theECMAScript document. Most importantly, the ActionScript language usedby Flash is based on ECMAScript (though it does not precisely followthe standard). Flash is a system for adding things that move and makelots of noise to web-pages. Knowing JavaScript won't hurt if you everfind yourself learning to build Flash movies.</p><p><a class="paragraph" href="#p23572bf9c21cdf90" name="p23572bf9c21cdf90"> ¶ </a>JavaScript is still evolving. Since this book came out, ECMAScript 5has been released, which is compatible with the version describedhere, but adds some of the functionality we will be writing ourselvesas built-in methods. The newest generation of browsers provides thisexpanded version of JavaScript. As of 2011, 'ECMAScript harmony', amore radical extension of the language, is in the process of beingstandardised. You should not worry too much about these new versionsmaking the things you learn from this book obsolete. For one thing,they will be an extension of the language we have now, so almosteverything written in this book will still hold.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p7f13eda01aab2232" name="p7f13eda01aab2232"> ¶ </a>Most chapters in this book contain quite a lot of code<a class="footref" href="#footnote1">1</a>. In myexperience, reading and writing code is an important part of learningto program. Try to not just glance over these examples, but read themattentively and understand them. This can be slow and confusing atfirst, but you will quickly get the hang of it. The same goes for theexercises. Don't assume you understand them until you've actuallywritten a working solution.</p><p><a class="paragraph" href="#p4eb8d1b48b2bb37b" name="p4eb8d1b48b2bb37b"> ¶ </a>Because of the way the web works, it is always possible to look at theJavaScript programs that people put in their web-pages. This can be agood way to learn how some things are done. Because most webprogrammers are not 'professional' programmers, or consider JavaScriptprogramming so uninteresting that they never properly learned it, alot of the code you can find like this is of a <em>very</em> bad quality.When learning from ugly or incorrect code, the ugliness and confusionwill propagate into your own code, so be careful who you learn from.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p42b9dbbc2906fda8" name="p42b9dbbc2906fda8"> ¶ </a>To allow you to try out programs, both the examples and the code youwrite yourself, this book makes use of something called a <a name="key2"></a>console.If you are using a modern graphical browser (Internet Explorer version6 or higher, Firefox 1.5 or higher, Opera 9 or higher, Safari 3 orhigher, Chrome), the pages in this book will show a blueish bar at thebottom of your screen. You can open the console by clicking on thelittle arrow on the far right of this bar. (Note that I am not talkingabout your browser's built-in console.)</p><p><a class="paragraph" href="#p5e7747de8cfc0946" name="p5e7747de8cfc0946"> ¶ </a>The console contains three important elements. There is the outputwindow, which is used to show error messages and things that programsprint out. Below that, there is a line where you can type in a pieceof JavaScript. Try typing in a number, and pressing the enter key torun what you typed. If the text you typed produced somethingmeaningful, it will be shown in the output window. Now try typing<code>wrong!</code>, and press enter again. The output window will show an errormessage. You can use the arrow-up and arrow-down keys to go back toprevious commands that you typed.</p><p><a class="paragraph" href="#p52d9e86c513e6d64" name="p52d9e86c513e6d64"> ¶ </a>For bigger pieces of code, those that span multiple lines and whichyou want to keep around for a while, the field on the right can beused. The 'Run' button is used to execute programs written in thisfield. It is possible to have multiple programs open at the same time.Use the 'New' button to open a new, empty buffer. When there is morethan one open buffer, the menu next to the 'Run' button can be used tochoose which one is being shown. The 'Close' button, as you mightexpect, closes a buffer.</p><p><a class="paragraph" href="#p590905737fc41d6e" name="p590905737fc41d6e"> ¶ </a>Example programs in this book always have a small button with an arrowin their top-right corner, which can be used to run them. The examplewe saw earlier looked like this:</p><pre class="code"><span class="keyword">var</span><span class="variable">total</span>=<span class="atom">0</span>, <span class="variable">count</span>=<span class="atom">1</span>;<span class="keyword">while</span> (<span class="variable">count</span> &lt;=<span class="atom">10</span>){<span class="variable">total</span> +=<span class="variable">count</span>;<span class="variable">count</span> +=<span class="atom">1</span>;}<span class="variable">print</span>(<span class="variable">total</span>);</pre><p><a class="paragraph" href="#p2a1912d818d21579" name="p2a1912d818d21579"> ¶ </a>Run it by clicking the arrow. There is also another button, which isused to load the program into the console. Do not hesitate to modifyit and try out the result. The worst that could happen is that youcreate an endless loop. An endless loop is what you get when thecondition of the <code>while</code> never becomes false, for example if youchoose to add <code>0</code> instead of <code>1</code> to the count variable. Now theprogram will run forever.</p><p><a class="paragraph" href="#p11cb94429bfcd757" name="p11cb94429bfcd757"> ¶ </a>Fortunately, browsers keep an eye on the programs running inside them.Whenever one of them is taking suspiciously long to finish, they willask you if you want to cut it off.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p320258aea4902e52" name="p320258aea4902e52"> ¶ </a>In some later chapters, we will build example programs that consist ofmany blocks of code. Often, you have to run every one of them for theprogram to work. As you may have noticed, the arrow in a block of codeturns purple after the block has been run. When reading a chapter, tryto run every block of code you come across, especially those that'define' something new (you will see what that means in the nextchapter).</p><p><a class="paragraph" href="#p4dfd5650784d1b5a" name="p4dfd5650784d1b5a"> ¶ </a>It is, of course, possible that you can not read a chapter in onesitting. This means you will have to start halfway when you continuereading, but if you don't run all the code starting from the top ofthe chapter, some things might not work. By holding the shift keywhile pressing the 'run' arrow on a block of code, all blocks beforethat one will be run as well, so when you start in the middle of achapter, hold shift the first time you run a piece of code, andeverything should work as expected.</p></div><ol class="footnotes"><li><a name="footnote1"></a>'Code' is the substance that programs are made of. Every piece of aprogram, whether it is a single line or the whole thing, can bereferred to as 'code'.</li></ol><h1><span class="number">Chapter 2: </span>Basic JavaScript: values, variables, and control flow</h1><div class="block"><p><a class="paragraph" href="#p61b1af7cf0e95900" name="p61b1af7cf0e95900"> ¶ </a>Inside the computer's world, there is only data. That which is notdata, does not exist. Although all data is in essence just a sequenceof bits<a class="footref" href="#footnote1">1</a>, and is thus fundamentally alike, every piece of data playsits own role. In JavaScript's system, most of this data is neatlyseparated into things called <a name="key1"></a>values. Every value has a type, whichdetermines the kind of role it can play. There are six basic types ofvalues: Numbers, strings, booleans, objects, functions, and undefinedvalues.</p><p><a class="paragraph" href="#p50fb86c9d3e2ba37" name="p50fb86c9d3e2ba37"> ¶ </a>To create a value, one must merely invoke its name. This is veryconvenient. You don't have to gather building material for yourvalues, or pay for them, you just call for one and <em>woosh</em>, you haveit. They are not created from thin air, of course. Every value has tobe stored somewhere, and if you want to use a gigantic number of themat the same time you might run out of computer memory. Fortunately,this is only a problem if you need them all simultaneously. As soon asyou no longer use a value, it will dissipate, leaving behind only afew bits. These bits are recycled to make the next generation ofvalues.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p50a3479ce6a9dffd" name="p50a3479ce6a9dffd"> ¶ </a>Values of the type <a name="key2"></a>number are, as you might have deduced, numericvalues. They are written the way numbers are usually written:</p><pre class="code expression"><span class="atom">144</span></pre><p><a class="paragraph" href="#p32ae9753e0ad5f5b" name="p32ae9753e0ad5f5b"> ¶ </a>Enter that in the console, and the same thing is printed in the outputwindow. The text you typed in gave rise to a number value, and theconsole took this number and wrote it out to the screen again. In acase like this, that was a rather pointless exercise, but soon we willbe producing values in less straightforward ways, and it can be usefulto 'try them out' on the console to see what they produce.</p><p><a class="paragraph" href="#p6b6235b9080cb806" name="p6b6235b9080cb806"> ¶ </a>This is what <code>144</code> looks like in bits<a class="footref" href="#footnote2">2</a>:</p><pre class="preformatted">0100000001100010000000000000000000000000000000000000000000000000</pre><p><a class="paragraph" href="#p259261911b9e3d68" name="p259261911b9e3d68"> ¶ </a>The number above has 64 bits. Numbers in JavaScript always do. Thishas one important repercussion: There is a limited amount of differentnumbers that can be expressed. With three decimal digits, only thenumbers 0 to 999 can be written, which is 10<sup>3</sup>=1000 differentnumbers. With 64 binary digits, 2<sup>64</sup> different numbers can be written.This is a lot, more than 10<sup>19</sup> (a one with nineteen zeroes).</p><p><a class="paragraph" href="#p6587537572d2d6de" name="p6587537572d2d6de"> ¶ </a>Not all whole numbers below 10<sup>19</sup> fit in a JavaScript number though.For one, there are also negative numbers, so one of the bits has to beused to store the sign of the number. A bigger issue is that non-wholenumbers must also be represented. To do this, 11 bits are used tostore the position of the fractional dot within the number.</p><p><a class="paragraph" href="#p7e2d0b7b96040227" name="p7e2d0b7b96040227"> ¶ </a>That leaves 52 bits<a class="footref" href="#footnote3">3</a>. Any whole number less than 2<sup>52</sup> (which is morethan 10<sup>15</sup>) will safely fit in a JavaScript number. In most cases, thenumbers we are using stay well below that, so we do not have toconcern ourselves with bits at all. Which is good. I have nothing inparticular against bits, but you <em>do</em> need a terrible lot of them toget anything done. When at all possible, it is more pleasant to dealwith bigger things.</p><p><a class="paragraph" href="#p2daf3430c67921cb" name="p2daf3430c67921cb"> ¶ </a>Fractional numbers are written by using a dot.</p><pre class="code expression"><span class="atom">9.81</span></pre><p><a class="paragraph" href="#p63af9617f4b5c93a" name="p63af9617f4b5c93a"> ¶ </a>For very big or very small numbers, one can also use 'scientific'notation by adding an <code>e</code>, followed by the exponent of the number:</p><pre class="code expression"><span class="atom">2.998e8</span></pre><p><a class="paragraph" href="#p13d16265cebf1ff9" name="p13d16265cebf1ff9"> ¶ </a>Which is 2.998 * 10<sup>8</sup>=299800000.</p><p><a class="paragraph" href="#p71dbd3c1f4974e33" name="p71dbd3c1f4974e33"> ¶ </a>Calculations with whole numbers (also called integers) that fit in 52bits are guaranteed to always be precise. Unfortunately, calculationswith fractional numbers are generally not. The same way that π (pi) can not beprecisely expressed by a finite amount of decimal digits, many numberslose some precision when only 64 bits are available to store them.This is a shame, but it only causes practical problems in veryspecific situations. The important thing is to be aware of it, andtreat fractional digital numbers as approximations, not as precisevalues.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p5e9cbe6e355f31b3" name="p5e9cbe6e355f31b3"> ¶ </a>The main thing to do with numbers is arithmetic. Arithmetic operationssuch as addition or multiplication take two number values and producea new number from them. Here is what they look like in JavaScript:</p><pre class="code expression"><span class="atom">100</span> + <span class="atom">4</span> * <span class="atom">11</span></pre><p><a class="paragraph" href="#p42661e965df9439a" name="p42661e965df9439a"> ¶ </a>The <a name="key3"></a><code>+</code> and <a name="key4"></a><code>*</code> symbols are called operators. The first stands foraddition, and the second for multiplication. Putting an operatorbetween two values will <a name="key5"></a>apply it to those values, andproduce a new value.</p><p><a class="paragraph" href="#p56a1ea0fbf26a539" name="p56a1ea0fbf26a539"> ¶ </a>Does the example mean 'add 4 and 100, and multiply the result by 11',or is the multiplication done before the adding? As you might haveguessed, the multiplication happens first. But, as in mathematics,this can be changed by wrapping the addition in parentheses<a name="key6"></a>:</p><pre class="code expression">(<span class="atom">100</span> + <span class="atom">4</span>) * <span class="atom">11</span></pre><p><a class="paragraph" href="#p50440df750d8329c" name="p50440df750d8329c"> ¶ </a>For subtraction, there is the <a name="key7"></a><code>-</code> operator, and division can be donewith <a name="key8"></a><code>/</code>. When operators appear together without parentheses, theorder in which they are applied is determined by the <a name="key9"></a>precedence ofthe operators. The first example shows that multiplication has ahigher precedence than addition. Division and multiplication alwayscome before subtraction and addition. When multiple operators with thesame precedence appear next to each other (<code>1 - 1 + 1</code>) they areapplied left-to-right.</p><p><a class="paragraph" href="#p5ece5e641cb7a91" name="p5ece5e641cb7a91"> ¶ </a>Try to figure out what value this produces, and then run it to see ifyou were correct...</p><pre class="code expression"><span class="atom">115</span> * <span class="atom">4</span> - <span class="atom">4</span> + <span class="atom">88</span> / <span class="atom">2</span></pre><p><a class="paragraph" href="#p1f2a225f25c63f52" name="p1f2a225f25c63f52"> ¶ </a>These rules of precedence are not something you should worry about.When in doubt, just add parentheses.</p><p><a class="paragraph" href="#p37f2f79789db8719" name="p37f2f79789db8719"> ¶ </a>There is one more arithmetic operator which is probably less familiarto you. The <a name="key10"></a><code>%</code> symbol is used to represent the <a name="key11"></a>remainder operation.<code>X % Y</code> is the remainder of dividing <code>X</code> by <code>Y</code>. For example<code>314 % 100</code> is <code>14</code>, <code>10 % 3</code> is <code>1</code>, and <code>144 % 12</code> is <code>0</code>. Remainderhas the same precedence as multiplication and division.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p60f72964a3424f8" name="p60f72964a3424f8"> ¶ </a>The next data type is the <a name="key12"></a>string. Its use is not as evident from itsname as with numbers, but it also fulfills a very basic role. Stringsare used to represent text, the name supposedly derives from the factthat it strings together a bunch of characters. Strings are written byenclosing their content in quotes:</p><pre class="code expression"><span class="string">&quot;Patch my boat with chewing gum.&quot;</span></pre><p><a class="paragraph" href="#p4b2c38f3da872ec1" name="p4b2c38f3da872ec1"> ¶ </a>Almost anything can be put between double quotes, and JavaScript willmake a string value out of it. But a few characters are tricky. Youcan imagine how putting quotes between quotes might be hard. Newlines,<a name="key13"></a>the things you get when you press enter, can also not be putbetween quotes, the string has to stay on a single line.</p><p><a class="paragraph" href="#p66a7f6315b134df3" name="p66a7f6315b134df3"> ¶ </a>To be able to have such characters in a string, the following trick isused: Whenever a backslash ('<code>\</code>') is found inside quoted text, itindicates that the character after it has a special meaning. A quotethat is preceded by a backslash will not end the string, but be partof it. When an '<code>n</code>' character occurs after a backslash, it isinterpreted as a newline. Similarly, a '<code>t</code>' after a backslash means atab character<a class="footref" href="#footnote4">4</a>.</p><pre class="code expression"><span class="string">&quot;This is the first line\nAnd this is the second&quot;</span></pre><p><a class="paragraph" href="#p5251dd2fc75a326" name="p5251dd2fc75a326"> ¶ </a>Note that if you type this into the console, it'll display it back in'source' form, with the quotes and backslash escapes. To see only theactual text, you can type <code>print(&quot;a\nb&quot;)</code>. What that does preciselywill be clarified a little further on.</p><p><a class="paragraph" href="#p3381259269b5ec55" name="p3381259269b5ec55"> ¶ </a>There are of course situations where you want a backslash in a stringto be just a backslash, not a special code. If two backslashes followeach other, they will collapse right into each other, and only onewill be left in the resulting string value:</p><pre class="code expression"><span class="string">&quot;A newline character is written like \&quot;\\n\&quot;.&quot;</span></pre></div><hr/><div class="block"><p><a class="paragraph" href="#pe7768638750d804" name="pe7768638750d804"> ¶ </a>Strings can not be divided, multiplied, or subtracted. The <a name="key14"></a><code>+</code>operator <em>can</em> be used on them. It does not add, but it concatenates,it glues two strings together.</p><pre class="code expression"><span class="string">&quot;con&quot;</span> + <span class="string">&quot;cat&quot;</span> + <span class="string">&quot;e&quot;</span> + <span class="string">&quot;nate&quot;</span></pre><p><a class="paragraph" href="#p2bf2c03f52eb7d44" name="p2bf2c03f52eb7d44"> ¶ </a>There are more ways of manipulating strings, but these are discussedlater.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p617d018066e362e9" name="p617d018066e362e9"> ¶ </a>Not all operators are symbols, some are written as words. For example,the <a name="key15"></a><code>typeof</code> operator, which produces a string value naming the typeof the value you give it.</p><pre class="code expression">typeof <span class="atom">4.5</span></pre><p><a class="paragraph" href="#p4665f4ba1393153f" name="p4665f4ba1393153f"> ¶ </a>The other operators we saw all operated on two values, <code>typeof</code> takesonly one. Operators that use two values are called <a name="key16"></a>binary operators,while those that take one are called <a name="key17"></a>unary operators. The<a name="key18"></a>minus operator can be used both as a binary and a unaryoperator:</p><pre class="code expression">- (<span class="atom">10</span> - <span class="atom">2</span>)</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p77bf1b47e2d73c8b" name="p77bf1b47e2d73c8b"> ¶ </a>Then there are values of the <a name="key19"></a>boolean type. There are only two ofthese: <a name="key20"></a><code>true</code> and <a name="key21"></a><code>false</code>. Here is one way to produce a <code>true</code>value:</p><pre class="code expression"><span class="atom">3</span> &gt;<span class="atom">2</span></pre><p><a class="paragraph" href="#p797832a59bded7cc" name="p797832a59bded7cc"> ¶ </a>And <code>false</code> can be produced like this:</p><pre class="code expression"><span class="atom">3</span> &lt;<span class="atom">2</span></pre><p><a class="paragraph" href="#p3a024c1cc18c61bc" name="p3a024c1cc18c61bc"> ¶ </a>I hope you have seen the <a name="key22"></a><code>&gt;</code> and <a name="key23"></a><code>&lt;</code> signs before. They mean,respectively, 'is greater than' and 'is less than'. They are binaryoperators, and the result of applying them is a boolean value thatindicates whether they hold in this case.</p><p><a class="paragraph" href="#p1b70e329d23af1ff" name="p1b70e329d23af1ff"> ¶ </a>Strings can be compared in the same way:</p><pre class="code expression"><span class="string">&quot;Aardvark&quot;</span> &lt;<span class="string">&quot;Zoroaster&quot;</span></pre><p><a class="paragraph" href="#p1bc6374d7e3e4694" name="p1bc6374d7e3e4694"> ¶ </a>The way strings are ordered is more or less alphabetic. More orless... Uppercase letters are always 'less' than lowercase ones, so<code>&quot;Z&quot;&lt;&quot;a&quot;</code> (upper-case Z, lower-case a) is <code>true</code>, and non-alphabeticcharacters ('<code>!</code>', '<code>@</code>', etc) are also included in the ordering. Theactual way in which the comparison is done is based on the <a name="key24"></a>Unicodestandard. This standard assigns a number to virtually every characterone would ever need, including characters from Greek, Arabic,Japanese, Tamil, and so on. Having such numbers is practical forstoring strings inside a computer ― you can represent them as a listof numbers. When comparing strings, JavaScript just compares thenumbers of the characters inside the string, from left to right.</p><p><a class="paragraph" href="#p1159736b16c0de67" name="p1159736b16c0de67"> ¶ </a>Other similar operators are <a name="key25"></a><code>&gt;=</code> ('is greater than or equal to'),<a name="key26"></a><code>&lt;=</code> (is less than or equal to), <a name="key27"></a><code>==</code> ('is equal to'), and <a name="key28"></a><code>!=</code>('is not equal to').</p><pre class="code expression"><span class="string">&quot;Itchy&quot;</span> !=<span class="string">&quot;Scratchy&quot;</span></pre><pre class="code expression"><span class="atom">5e2</span>==<span class="atom">500</span></pre></div><hr/><div class="block"><p><a class="paragraph" href="#p7cf9494fff734302" name="p7cf9494fff734302"> ¶ </a>There are also some useful operations that can be applied to booleanvalues themselves. JavaScript supports three logical operators: <em>and</em>,<em>or</em>, and <em>not</em>. These can be used to 'reason' about booleans.</p><p><a class="paragraph" href="#p7eb1852ca8c4b6f4" name="p7eb1852ca8c4b6f4"> ¶ </a>The <a name="key29"></a><code>&amp;&amp;</code> operator represents logical <em>and</em>. It is a binary operator,and its result is only <code>true</code> if both of the values given to it are<code>true</code>.</p><pre class="code expression"><span class="atom">true</span> &amp;&amp;<span class="atom">false</span></pre><p><a class="paragraph" href="#p2bea27b8212b9b68" name="p2bea27b8212b9b68"> ¶ </a><a name="key30"></a><code>||</code> is the logical <em>or</em>, it is <code>true</code> if either of the values givento it is <code>true</code>:</p><pre class="code expression"><span class="atom">true</span> || <span class="atom">false</span></pre><p><a class="paragraph" href="#p7442bf68e97118f" name="p7442bf68e97118f"> ¶ </a><em>Not</em> is written as an exclamation mark, <a name="key31"></a><code>!</code>, it is a unary operatorthat flips the value given to it, <code>!true</code> is <code>false</code>, and <code>!false</code> is<code>true</code>.</p></div><hr/><div class="block"><a name="exercise1"></a><div class="exercisenum">Ex. 2.1</div><div class="exercise"><pre class="code expression">((<span class="atom">4</span> &gt;=<span class="atom">6</span>) || (<span class="string">&quot;grass&quot;</span> !=<span class="string">&quot;green&quot;</span>)) &amp;&amp;!(((<span class="atom">12</span> * <span class="atom">2</span>)==<span class="atom">144</span>) &amp;&amp;<span class="atom">true</span>)</pre><p><a class="paragraph" href="#p5c4d1693fe971953" name="p5c4d1693fe971953"> ¶ </a>Is this true? For readability, there are a lot of unnecessaryparentheses in there. This simple version means the same thing:</p><pre class="code expression">(<span class="atom">4</span> &gt;=<span class="atom">6</span> || <span class="string">&quot;grass&quot;</span> !=<span class="string">&quot;green&quot;</span>) &amp;&amp;!(<span class="atom">12</span> * <span class="atom">2</span>==<span class="atom">144</span> &amp;&amp;<span class="atom">true</span>)</pre></div><div class="solution"><p><a class="paragraph" href="#p5c3cd3f27888dd02" name="p5c3cd3f27888dd02"> ¶ </a>Yes, it is <code>true</code>. You can reduce it step by step like this:</p><pre class="code expression">(<span class="atom">false</span> || <span class="atom">true</span>) &amp;&amp;!(<span class="atom">false</span> &amp;&amp;<span class="atom">true</span>)</pre><pre class="code expression"><span class="atom">true</span> &amp;&amp;!<span class="atom">false</span></pre><pre class="code expression"><span class="atom">true</span></pre><p><a class="paragraph" href="#p17cfd06bf8f94976" name="p17cfd06bf8f94976"> ¶ </a>I hope you noticed that <code>&quot;grass&quot;!=&quot;green&quot;</code> is <code>true</code>. Grass may begreen, but it is not equal to green.</p></div></div><hr/><div class="block"><p><a class="paragraph" href="#p13f5cf334222453" name="p13f5cf334222453"> ¶ </a>It is not always obvious when parentheses are needed. In practice, onecan usually get by with knowing that of the operators we have seen sofar, <code>||</code> has the lowest precedence, then comes <code>&amp;&amp;</code>, then thecomparison operators (<code>&gt;</code>, <code>==</code>, etcetera), and then the rest. Thishas been chosen in such a way that, in simple cases, as fewparentheses as possible are necessary.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p107cf27965af5913" name="p107cf27965af5913"> ¶ </a>All the examples so far have used the language like you would use apocket calculator. Make some values and apply operators to them to getnew values. Creating values like this is an essential part of everyJavaScript program, but it is only a part. A piece of code thatproduces a value is called an <a name="key32"></a>expression. Every value that iswritten directly (such as <code>22</code> or <code>&quot;psychoanalysis&quot;</code>) is anexpression. An expression between parentheses is also an expression.And a binary operator applied to two expressions, or a unary operatorapplied to one, is also an expression.</p><p><a class="paragraph" href="#p65fc46bd5b67046e" name="p65fc46bd5b67046e"> ¶ </a>There are a few more ways of building expressions, which will berevealed when the time is ripe.</p><p><a class="paragraph" href="#p6efb23219d3caa3e" name="p6efb23219d3caa3e"> ¶ </a>There exists a unit that is bigger than an expression. It is called a<a name="key33"></a>statement. A program is built as a list of statements. Moststatements end with a <a name="key34"></a>semicolon (<code>;</code>). The simplest kind ofstatement is an expression with a semicolon after it. This is aprogram:</p><pre class="code"><span class="atom">1</span>;!<span class="atom">false</span>;</pre><p><a class="paragraph" href="#p28351e9a29a7e8db" name="p28351e9a29a7e8db"> ¶ </a>It is a useless program. An expression can be content to just producea value, but a statement only amounts to something if it somehowchanges the world. It could print something to the screen ― thatcounts as changing the world ― or it could change the internal stateof the program in a way that will affect the statements that comeafter it. These changes are called '<a name="key35"></a>side effects'. The statements inthe example above just produce the values <code>1</code> and <code>true</code>, and thenimmediately throw them into the bit bucket<a class="footref" href="#footnote5">5</a>. This leaves noimpression on the world at all, and is not a side effect.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p5fb0b52a65170986" name="p5fb0b52a65170986"> ¶ </a>How does a program keep an internal state? How does it rememberthings? We have seen how to produce new values from old values, butthis does not change the old values, and the new value has to beimmediately used or it will dissipate again. To catch and hold values,JavaScript provides a thing called a <a name="key36"></a>variable.</p><pre class="code"><span class="keyword">var</span><span class="variable">caught</span>=<span class="atom">5</span> * <span class="atom">5</span>;</pre><p><a class="paragraph" href="#p58b88cf3405a34f5" name="p58b88cf3405a34f5"> ¶ </a>A variable always has a name, and it can point at a value, holding onto it. The statement above creates a variable called <code>caught</code> and usesit to grab hold of the number that is produced by multiplying <code>5</code> by<code>5</code>.</p><p><a class="paragraph" href="#p2c8171c6a3bce68" name="p2c8171c6a3bce68"> ¶ </a>After running the above program, you can type the word <code>caught</code> intothe console, and it will retrieve the value <code>25</code> for you. The name ofa variable is used to fetch its value. <code>caught + 1</code> also works. Avariable name can be used as an expression, and thus can be part ofbigger expressions.</p><p><a class="paragraph" href="#p62259c9d47e8e505" name="p62259c9d47e8e505"> ¶ </a>The word <a name="key37"></a><code>var</code> is used to create a new variable. After <code>var</code>, thename of the variable follows. Variable names can be almost every word,but they may not include spaces. Digits can be part of variable names,<code>catch22</code> is a valid name, but the name must not start with a digit. Thecharacters '<code>$</code>' and '<code>_</code>' can be used in names as if they wereletters, so <code>$_$</code> is a correct variable name.</p><p><a class="paragraph" href="#p17ec5282ddc9bc52" name="p17ec5282ddc9bc52"> ¶ </a>If you want the new variable to immediately capture a value, which isoften the case, the <a name="key38"></a><code>=</code> operator can be used to give it the value ofsome expression.</p><p><a class="paragraph" href="#p5c44155d666db7fe" name="p5c44155d666db7fe"> ¶ </a>When a variable points at a value, that does not mean it is tied tothat value forever. At any time, the <code>=</code> operator can be used onexisting variables to yank them away from their current value and makethem point to a new one.</p><pre class="code"><span class="variable">caught</span>=<span class="atom">4</span> * <span class="atom">4</span>;</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p1d46b0ecd273d88c" name="p1d46b0ecd273d88c"> ¶ </a>You should imagine variables as tentacles, rather than boxes. They donot <em>contain</em> values, they <em>grasp</em> them ― two variables can refer tothe same value. Only the values that the program still has a hold oncan be accessed by it. When you need to remember something, you grow atentacle to hold on to it, or re-attach one of your existing tentaclesto a new value: To remember the amount of dollars that Luigi stillowes you, you could do...</p><pre class="code"><span class="keyword">var</span><span class="variable">luigiDebt</span>=<span class="atom">140</span>;</pre><p><a class="paragraph" href="#p25ff31a51d72168c" name="p25ff31a51d72168c"> ¶ </a>Then, every time Luigi pays something back, this amount can bedecremented by giving the variable a new number:</p><pre class="code"><span class="variable">luigiDebt</span>=<span class="variable">luigiDebt</span> - <span class="atom">35</span>;</pre><p><a class="paragraph" href="#p7e8cd0bb233236e8" name="p7e8cd0bb233236e8"> ¶ </a>The collection of variables and their values that exist at a giventime is called the <a name="key39"></a>environment. When a program starts up, thisenvironment is not empty. It always contains a number of standardvariables. When your browser loads a page, it creates a newenvironment and attaches these standard values to it. The variablescreated and modified by programs on that page survive until thebrowser goes to a new page.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p7a2d22ee22a73bc5" name="p7a2d22ee22a73bc5"> ¶ </a>A lot of the values provided by the standard environment have the type'<a name="key40"></a>function'. A function is a piece of program wrapped in a value.Generally, this piece of program does something useful, which can beinvoked using the function value that contains it. In a browserenvironment, the variable <a name="key41"></a><code>alert</code> holds a function that shows alittle dialog window with a message. It is used like this:</p><pre class="code"><span class="variable">alert</span>(<span class="string">&quot;Avocados&quot;</span>);</pre><p><a class="paragraph" href="#p676ecb7ed3921d48" name="p676ecb7ed3921d48"> ¶ </a><a name="key42"></a>Executing the code in a function is called <a name="key43"></a>invoking, calling,or <a name="key44"></a>applying it. The notation for doing this uses parentheses. Everyexpression that produces a function value can be invoked by puttingparentheses after it. In the example, the value <code>&quot;Avocados&quot;</code> is givento the function, which uses it as the text to show in the dialogwindow. Values given to functions are called <a name="key45"></a>parameters or<a name="key46"></a>arguments. <code>alert</code> needs only one of them, but other functions mightneed a different number.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p7b3fd95c590dcad3" name="p7b3fd95c590dcad3"> ¶ </a>Showing a dialog window is a side effect. A lot of functions areuseful because of the side effects they produce. It is also possiblefor a function to produce a value, in which case it does not need tohave a side effect to be useful. For example, there is a function<a name="key47"></a><code>Math.max</code>, which takes any number of numeric arguments and givesback the greatest:</p><pre class="code"><span class="variable">alert</span>(<span class="variable">Math</span>.<span class="property">max</span>(<span class="atom">2</span>, <span class="atom">4</span>));</pre><p><a class="paragraph" href="#p86f6c2b80c0e6fc" name="p86f6c2b80c0e6fc"> ¶ </a><a name="key48"></a>When a function produces a value, it is said to <a name="key49"></a>returnit. Because things that produce values are always expressions inJavaScript, function calls can be used as a part of biggerexpressions:</p><pre class="code"><span class="variable">alert</span>(<span class="variable">Math</span>.<span class="property">min</span>(<span class="atom">2</span>, <span class="atom">4</span>) + <span class="atom">100</span>);</pre><p><a class="paragraph" href="#p1f0771d62babec3e" name="p1f0771d62babec3e"> ¶ </a><a href="chapter3.html">Chapter 3</a> discusses writing your own functions.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p71ef6330c6776122" name="p71ef6330c6776122"> ¶ </a>As the previous examples show, <code>alert</code> can be useful for showing theresult of some expression. Clicking away all those little windows canget on one's nerves though, so from now on we will prefer to use asimilar function, called <a name="key50"></a><code>print</code>, which does not pop up a window,but just writes a value to the output area of the console. <code>print</code> isnot a standard JavaScript function, browsers do not provide it foryou, but it is made available by this book, so you can use it on thesepages.</p><pre class="code"><span class="variable">print</span>(<span class="string">&quot;N&quot;</span>);</pre><p><a class="paragraph" href="#p2b7155906dde07b4" name="p2b7155906dde07b4"> ¶ </a>A similar function, also provided on these pages, is <code>show</code>. While<code>print</code> will display its argument as flat text, <a name="key51"></a><code>show</code> tries todisplay it the way it would look in a program, which can give moreinformation about the type of the value. For example, string valueskeep their quotes when given to <code>show</code>:</p><pre class="code"><span class="variable">show</span>(<span class="string">&quot;N&quot;</span>);</pre><p><a class="paragraph" href="#p3738004b5758ea97" name="p3738004b5758ea97"> ¶ </a>The standard environment provided by browsers contains a few morefunctions for popping up windows. You can ask the user an OK/Cancelquestion using <a name="key52"></a><code>confirm</code>. This returns a boolean, <code>true</code> if the userpresses 'OK', and <code>false</code> if he presses 'Cancel'.</p><pre class="code"><span class="variable">show</span>(<span class="variable">confirm</span>(<span class="string">&quot;Shall we, then?&quot;</span>));</pre><p><a class="paragraph" href="#p42ad8c1ef96a706b" name="p42ad8c1ef96a706b"> ¶ </a><a name="key53"></a><code>prompt</code> can be used to ask an 'open' question. The first argumentis the question, the second one is the text that the user starts with.A line of text can be typed into the window, and the function willreturn this as a string.</p><pre class="code"><span class="variable">show</span>(<span class="variable">prompt</span>(<span class="string">&quot;Tell us everything you know.&quot;</span>, <span class="string">&quot;...&quot;</span>));</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p228519d506327a1f" name="p228519d506327a1f"> ¶ </a>It is possible to give almost every variable in the environment a newvalue. This can be useful, but also dangerous. If you give <code>print</code> thevalue <code>8</code>, you won't be able to print things anymore. Fortunately,there is a big 'Reset' button on the console, which will reset theenvironment to its original state.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p4f28c3e2c3307f10" name="p4f28c3e2c3307f10"> ¶ </a>One-line programs are not very interesting. When you put more than onestatement into a program, the statements are, predictably, executedone at a time, from top to bottom.</p><pre class="code"><span class="keyword">var</span><span class="variable">theNumber</span>=<span class="variable">Number</span>(<span class="variable">prompt</span>(<span class="string">&quot;Pick a number&quot;</span>, <span class="string">&quot;&quot;</span>));<span class="variable">print</span>(<span class="string">&quot;Your number is the square root of &quot;</span> + (<span class="variable">theNumber</span> * <span class="variable">theNumber</span>));</pre><p><a class="paragraph" href="#p399942c25b700f68" name="p399942c25b700f68"> ¶ </a>The function <a name="key54"></a><code>Number</code> converts a value to a number, which is neededin this case because the result of <code>prompt</code> is a string value. Thereare similar functions called <a name="key55"></a><code>String</code> and <a name="key56"></a><code>Boolean</code> which convertvalues to those types.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p191d6f33e07ac9fd" name="p191d6f33e07ac9fd"> ¶ </a>Consider a program that prints out all even numbers from 0 to 12. Oneway to write this is:</p><pre class="code"><span class="variable">print</span>(<span class="atom">0</span>);<span class="variable">print</span>(<span class="atom">2</span>);<span class="variable">print</span>(<span class="atom">4</span>);<span class="variable">print</span>(<span class="atom">6</span>);<span class="variable">print</span>(<span class="atom">8</span>);<span class="variable">print</span>(<span class="atom">10</span>);<span class="variable">print</span>(<span class="atom">12</span>);</pre><p><a class="paragraph" href="#p7f8805a6587f2118" name="p7f8805a6587f2118"> ¶ </a>That works, but the idea of writing a program is to make something<em>less</em> work, not more. If we needed all even numbers below 1000, theabove would be unworkable. What we need is a way to automaticallyrepeat some code.</p><pre class="code"><span class="keyword">var</span><span class="variable">currentNumber</span>=<span class="atom">0</span>;<span class="keyword">while</span> (<span class="variable">currentNumber</span> &lt;=<span class="atom">12</span>){<span class="variable">print</span>(<span class="variable">currentNumber</span>);<span class="variable">currentNumber</span>=<span class="variable">currentNumber</span> + <span class="atom">2</span>;}</pre><p><a class="paragraph" href="#p49e5e5b54090b34b" name="p49e5e5b54090b34b"> ¶ </a>You may have seen <a name="key57"></a><code>while</code> in the introduction chapter. A statementstarting with the word <code>while</code> creates a <a name="key58"></a>loop. A loop is adisturbance in the sequence of statements ― it may cause the program torepeat some statements multiple times. In this case, the word <code>while</code>is followed by an expression in parentheses (the parentheses arecompulsory here), which is used to determine whether the loop willloop or finish. As long as the boolean value produced by thisexpression is <code>true</code>, the code in the loop is repeated. As soon as itis false, the program goes to the bottom of the loop and continues asnormal.</p><p><a class="paragraph" href="#p12de169b6ad2f5e2" name="p12de169b6ad2f5e2"> ¶ </a>The variable <code>currentNumber</code> demonstrates the way a variable can trackthe progress of a program. Every time the loop repeats, it isincremented by <code>2</code>, and at the beginning of every repetition, it iscompared with the number <code>12</code> to decide whether to keep on looping.</p><p><a class="paragraph" href="#p4c3faa857b49a0e7" name="p4c3faa857b49a0e7"> ¶ </a>The third part of a <code>while</code> statement is another statement. This isthe <a name="key59"></a>body of the loop, the action or actions that must take placemultiple times. If we did not have to print the numbers, the programcould have been:</p><pre class="code"><span class="keyword">var</span><span class="variable">currentNumber</span>=<span class="atom">0</span>;<span class="keyword">while</span> (<span class="variable">currentNumber</span> &lt;=<span class="atom">12</span>) <span class="variable">currentNumber</span>=<span class="variable">currentNumber</span> + <span class="atom">2</span>;</pre><p><a class="paragraph" href="#p28e18a0a9ae6fa64" name="p28e18a0a9ae6fa64"> ¶ </a>Here, <code>currentNumber=currentNumber + 2;</code> is the statement that formsthe body of the loop. We must also print the number, though, so theloop statement must consist of more than one statement. <a name="key60"></a>Braces(<code>{</code> and <code>}</code>) are used to group statements into <a name="key61"></a>blocks. To the worldoutside the block, a block counts as a single statement. In the earlierexample, this is used to include in the loop both the call to <code>print</code>and the statement that updates <code>currentNumber</code>.</p></div><hr/><div class="block"><a name="exercise2"></a><div class="exercisenum">Ex. 2.2</div><div class="exercise"><p><a class="paragraph" href="#p5442ca2a9bc50c8e" name="p5442ca2a9bc50c8e"> ¶ </a>Use the techniques shown so far to write a program that calculates andshows the value of 2<sup>10</sup> (2 to the 10th power). You are, obviously, notallowed to use a cheap trick like just writing <code>2 * 2 * ...</code>.</p><p><a class="paragraph" href="#p1810f758d84ce7c9" name="p1810f758d84ce7c9"> ¶ </a>If you are having trouble with this, try to see it in terms of theeven-numbers example. The program must perform an action a certainamount of times. A counter variable with a <code>while</code> loop can be usedfor that. Instead of printing the counter, the program must multiplysomething by 2. This something should be another variable, in whichthe result value is built up.</p><p><a class="paragraph" href="#p635c5eccaae1407e" name="p635c5eccaae1407e"> ¶ </a>Don't worry if you don't quite see how this would work yet. Even ifyou perfectly understand all the techniques this chapter covers, itcan be hard to apply them to a specific problem. Reading and writingcode will help develop a feeling for this, so study the solution, andtry the next exercise.</p></div><div class="solution"><pre class="code"><span class="keyword">var</span><span class="variable">result</span>=<span class="atom">1</span>;<span class="keyword">var</span><span class="variable">counter</span>=<span class="atom">0</span>;<span class="keyword">while</span> (<span class="variable">counter</span> &lt;<span class="atom">10</span>){<span class="variable">result</span>=<span class="variable">result</span> * <span class="atom">2</span>;<span class="variable">counter</span>=<span class="variable">counter</span> + <span class="atom">1</span>;}<span class="variable">show</span>(<span class="variable">result</span>);</pre><p><a class="paragraph" href="#p34e01f8922444a64" name="p34e01f8922444a64"> ¶ </a>The counter could also start at <code>1</code> and check for <code>&lt;=10</code>, but, forreasons that will become apparent later on, it is a good idea to getused to counting from 0.</p><p><a class="paragraph" href="#p48198b9ba530af8c" name="p48198b9ba530af8c"> ¶ </a>Obviously, your own solutions aren't required to be precisely the sameas mine. They should work. And if they are very different, make sureyou also understand my solution.</p></div></div><hr/><div class="block"><a name="exercise3"></a><div class="exercisenum">Ex. 2.3</div><div class="exercise"><p><a class="paragraph" href="#p641bbdee500f68ef" name="p641bbdee500f68ef"> ¶ </a>With some slight modifications, the solution to the previous exercisecan be made to draw a triangle. And when I say 'draw a triangle' Imean 'print out some text that almost looks like a triangle when yousquint'.</p><p><a class="paragraph" href="#p2f5c07093e5097db" name="p2f5c07093e5097db"> ¶ </a>Print out ten lines. On the first line there is one '#' character. Onthe second there are two. And so on.</p><p><a class="paragraph" href="#p5db823f0ebb01541" name="p5db823f0ebb01541"> ¶ </a>How does one get a string with X '#' characters in it? One way is tobuild it every time it is needed with an 'inner loop' ― a loop insidea loop. A simpler way is to reuse the string that the previousiteration of the loop used, and add one character to it.</p></div><div class="solution"><pre class="code"><span class="keyword">var</span><span class="variable">line</span>=<span class="string">&quot;&quot;</span>;<span class="keyword">var</span><span class="variable">counter</span>=<span class="atom">0</span>;<span class="keyword">while</span> (<span class="variable">counter</span> &lt;<span class="atom">10</span>){<span class="variable">line</span>=<span class="variable">line</span> + <span class="string">&quot;#&quot;</span>;<span class="variable">print</span>(<span class="variable">line</span>);<span class="variable">counter</span>=<span class="variable">counter</span> + <span class="atom">1</span>;}</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p2cbd44fa16ea3e42" name="p2cbd44fa16ea3e42"> ¶ </a>You will have noticed the spaces I put in front of some statements.These are not required: The computer will accept the program just finewithout them. In fact, even the line breaks in programs are optional.You could write them as a single long line if you felt like it. Therole of the <a name="key62"></a>indentation inside blocks is to make the structure ofthe code clearer to a reader. Because new blocks can be opened insideother blocks, it can become hard to see where one block ends andanother begins in a complex piece of code. When lines are indented,the visual shape of a program corresponds to the shape of the blocksinside it. I like to use two spaces for every open block, but tastesdiffer.</p><p><a class="paragraph" href="#p4a14ae9b87cb1618" name="p4a14ae9b87cb1618"> ¶ </a>The field in the console where you can type programs will help you byautomatically adding these spaces. This may seem annoying at first,but when you write a lot of code it becomes a huge time-saver.Pressing shift+tab will re-indent the line your cursor is currentlyon.</p><p><a class="paragraph" href="#p4560113d751953db" name="p4560113d751953db"> ¶ </a>In some cases, JavaScript allows you to omit the semicolon at the endof a statement. In other cases, it has to be there or strange thingswill happen. The rules for when it can be safely omitted are complexand weird. In this book, I won't leave out any semicolons, and Istrongly urge you to do the same in your own programs.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p18c9a1b55326c0b7" name="p18c9a1b55326c0b7"> ¶ </a>The uses of <code>while</code> we have seen so far all show the same pattern.First, a 'counter' variable is created. This variable tracks theprogress of the loop. The <code>while</code> itself contains a check, usually tosee whether the counter has reached some boundary yet. Then, at theend of the loop body, the counter is updated.</p><p><a class="paragraph" href="#p7669ecc2de8963e6" name="p7669ecc2de8963e6"> ¶ </a>A lot of loops fall into this pattern. For this reason, JavaScript,and similar languages, also provide a slightly shorter and morecomprehensive form:</p><pre class="code"><span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">number</span>=<span class="atom">0</span>;<span class="variable">number</span> &lt;=<span class="atom">12</span>;<span class="variable">number</span>=<span class="variable">number</span> + <span class="atom">2</span>) <span class="variable">show</span>(<span class="variable">number</span>);</pre><p><a class="paragraph" href="#p33ad2075537c4259" name="p33ad2075537c4259"> ¶ </a>This program is exactly equivalent to the earlier even-number-printingexample. The only change is that all the statements that are relatedto the 'state' of the loop are now on one line. The parentheses afterthe <a name="key63"></a><code>for</code> should contain two semicolons. The part before the firstsemicolon <em>initialises</em> the loop, usually by defining a variable. Thesecond part is the expression that <em>checks</em> whether the loop muststill continue. The final part <em>updates</em> the state of the loop. Inmost cases this is shorter and clearer than a <code>while</code> construction.</p></div><hr/><div class="block"><p><a class="paragraph" href="#pcbce05838d54058" name="pcbce05838d54058"> ¶ </a>I have been using some rather odd <a name="key64"></a>capitalisation in some variablenames. Because you can not have spaces in these names ― the computerwould read them as two separate variables ― your choices for a namethat is made of several words are more or less limited to thefollowing: <code>fuzzylittleturtle</code>, <code>fuzzy_little_turtle</code>,<code>FuzzyLittleTurtle</code>, or <code>fuzzyLittleTurtle</code>. The first one is hard toread. Personally, I like the one with the underscores, though it is alittle painful to type. However, the standard JavaScript functions,and most JavaScript programmers, follow the last one. It is not hardto get used to little things like that, so I will just follow thecrowd and capitalise the first letter of every word after the first.</p><p><a class="paragraph" href="#p52f29cd4dde6b1f" name="p52f29cd4dde6b1f"> ¶ </a>In a few cases, such as the <code>Number</code> function, the first letter of avariable is also capitalised. This was done to mark this function as aconstructor. What a constructor is will become clear in <a href="chapter8.html">chapter 8</a>. Fornow, the important thing is not to be bothered by this apparent lackof consistency.</p><p><a class="paragraph" href="#p4fcc7ad59bacc742" name="p4fcc7ad59bacc742"> ¶ </a>Note that names that have a special meaning, such as <code>var</code>, <code>while</code>,and <code>for</code> may not be used as variable names. These are called<a name="key65"></a>keywords. There are also a number of <a name="key66"></a>words whichare 'reserved for use' in future versions of JavaScript. These arealso officially not allowed to be used as variable names, though somebrowsers do allow them. The full list is rather long:</p><pre class="preformatted">abstract boolean break byte case catch char class const continuedebugger default delete do double else enum export extends falsefinal finally float for function goto if implements import ininstanceof int interface long native new null package privateprotected public return short static super switch synchronizedthis throw throws transient true try typeof var void volatilewhile with</pre><p><a class="paragraph" href="#p9adbe16f2e24759" name="p9adbe16f2e24759"> ¶ </a>Don't worry about memorising these for now, but remember that thismight be the problem when something does not work as expected. In myexperience, <code>char</code> (to store a one-character string) and <a name="key67"></a><code>class</code> arethe most common names to accidentally use.</p></div><hr/><div class="block"><a name="exercise4"></a><div class="exercisenum">Ex. 2.4</div><div class="exercise"><p><a class="paragraph" href="#p64b3e1eae7316320" name="p64b3e1eae7316320"> ¶ </a>Rewrite the solutions of the previous two exercises to use <code>for</code>instead of <code>while</code>.</p></div><div class="solution"><pre class="code"><span class="keyword">var</span><span class="variable">result</span>=<span class="atom">1</span>;<span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">counter</span>=<span class="atom">0</span>;<span class="variable">counter</span> &lt;<span class="atom">10</span>;<span class="variable">counter</span>=<span class="variable">counter</span> + <span class="atom">1</span>) <span class="variable">result</span>=<span class="variable">result</span> * <span class="atom">2</span>;<span class="variable">show</span>(<span class="variable">result</span>);</pre><p><a class="paragraph" href="#p7d53270d94954ca6" name="p7d53270d94954ca6"> ¶ </a>Note that even if no block is opened with a '<code>{</code>', the statement inthe loop is still indented two spaces to make it clear that it'belongs' to the line above it.</p><pre class="code"><span class="keyword">var</span><span class="variable">line</span>=<span class="string">&quot;&quot;</span>;<span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">counter</span>=<span class="atom">0</span>;<span class="variable">counter</span> &lt;<span class="atom">10</span>;<span class="variable">counter</span>=<span class="variable">counter</span> + <span class="atom">1</span>){<span class="variable">line</span>=<span class="variable">line</span> + <span class="string">&quot;#&quot;</span>;<span class="variable">print</span>(<span class="variable">line</span>);}</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p3fd3bf55c1bd6483" name="p3fd3bf55c1bd6483"> ¶ </a><a name="key68"></a><a name="key69"></a><a name="key70"></a><a name="key71"></a>A program often needs to 'update' avariable with a value that is based on its previous value. For example<code>counter=counter + 1</code>. JavaScript provides a shortcut for this:<code>counter +=1</code>. This also works for many other operators, for example<code>result *=2</code> to double the value of <code>result</code>, or <code>counter -=1</code> tocount downwards.</p><p><a class="paragraph" href="#p2600126f4acc14ef" name="p2600126f4acc14ef"> ¶ </a><a name="key72"></a><a name="key73"></a>For <code>counter +=1</code> and <code>counter -=1</code> there are evenshorter versions: <code>counter++</code> and <code>counter--</code>.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p4b80d7d05f3c7e54" name="p4b80d7d05f3c7e54"> ¶ </a>Loops are said to affect the <a name="key74"></a>control flow of a program. They changethe order in which statements are executed. In many cases, anotherkind of flow is useful: skipping statements.</p><p><a class="paragraph" href="#p677b8a85393a1809" name="p677b8a85393a1809"> ¶ </a>We want to show all numbers below 20 which are divisible both by 3 andby 4.</p><pre class="code"><span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">counter</span>=<span class="atom">0</span>;<span class="variable">counter</span> &lt;<span class="atom">20</span>;<span class="variable">counter</span>++){<span class="keyword">if</span> (<span class="variable">counter</span> % <span class="atom">3</span>==<span class="atom">0</span> &amp;&amp;<span class="variable">counter</span> % <span class="atom">4</span>==<span class="atom">0</span>) <span class="variable">show</span>(<span class="variable">counter</span>);}</pre><p><a class="paragraph" href="#p579ad0ae40d2b6b6" name="p579ad0ae40d2b6b6"> ¶ </a>The keyword <a name="key75"></a><code>if</code> is not too different from the keyword <code>while</code>: Itchecks the condition it is given (between parentheses), and executesthe statement after it based on this condition. But it does this onlyonce, so that the statement is executed zero or one time.</p><p><a class="paragraph" href="#p12100a1e5918d8f7" name="p12100a1e5918d8f7"> ¶ </a>The trick with the remainder (<a name="key76"></a><code>%</code>) operator is an easy way to testwhether a number is divisible by another number. If it is, theremainder of their division, which is what remainder gives you, is zero.</p><p><a class="paragraph" href="#p406399b46620cc88" name="p406399b46620cc88"> ¶ </a>If we wanted to print all numbers below 20, but putparentheses around the ones that are not divisible by 4, we can do itlike this:</p><pre class="code"><span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">counter</span>=<span class="atom">0</span>;<span class="variable">counter</span> &lt;<span class="atom">20</span>;<span class="variable">counter</span>++){<span class="keyword">if</span> (<span class="variable">counter</span> % <span class="atom">4</span>==<span class="atom">0</span>) <span class="variable">print</span>(<span class="variable">counter</span>);<span class="keyword">if</span> (<span class="variable">counter</span> % <span class="atom">4</span> !=<span class="atom">0</span>) <span class="variable">print</span>(<span class="string">&quot;(&quot;</span> + <span class="variable">counter</span> + <span class="string">&quot;)&quot;</span>);}</pre><p><a class="paragraph" href="#pb00f039a340e1f1" name="pb00f039a340e1f1"> ¶ </a>But now the program has to determine whether <code>counter</code> is divisible by<code>4</code> two times. The same effect can be obtained by appending an <code>else</code>part after an <code>if</code> statement. The <a name="key77"></a><code>else</code> statement is executed onlywhen the <code>if</code>'s condition is false.</p><pre class="code"><span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">counter</span>=<span class="atom">0</span>;<span class="variable">counter</span> &lt;<span class="atom">20</span>;<span class="variable">counter</span>++){<span class="keyword">if</span> (<span class="variable">counter</span> % <span class="atom">4</span>==<span class="atom">0</span>) <span class="variable">print</span>(<span class="variable">counter</span>);<span class="keyword">else</span><span class="variable">print</span>(<span class="string">&quot;(&quot;</span> + <span class="variable">counter</span> + <span class="string">&quot;)&quot;</span>);}</pre><p><a class="paragraph" href="#p44c5da1f0b1e4e71" name="p44c5da1f0b1e4e71"> ¶ </a>To stretch this trivial example a bit further, we now want to printthese same numbers, but add two stars after them when they are greaterthan 15, one star when they are greater than 10 (but not greater than15), and no stars otherwise.</p><pre class="code"><span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">counter</span>=<span class="atom">0</span>;<span class="variable">counter</span> &lt;<span class="atom">20</span>;<span class="variable">counter</span>++){<span class="keyword">if</span> (<span class="variable">counter</span> &gt;<span class="atom">15</span>) <span class="variable">print</span>(<span class="variable">counter</span> + <span class="string">&quot;**&quot;</span>);<span class="keyword">else</span><span class="keyword">if</span> (<span class="variable">counter</span> &gt;<span class="atom">10</span>) <span class="variable">print</span>(<span class="variable">counter</span> + <span class="string">&quot;*&quot;</span>);<span class="keyword">else</span><span class="variable">print</span>(<span class="variable">counter</span>);}</pre><p><a class="paragraph" href="#p10bbb4606536644" name="p10bbb4606536644"> ¶ </a>This demonstrates that you can chain <code>if</code> statements together. In thiscase, the program first looks if <code>counter</code> is greater than <code>15</code>. If itis, the two stars are printed and the other tests are skipped. If itis not, we continue to check if <code>counter</code> is greater than <code>10</code>. Onlyif <code>counter</code> is also not greater than <code>10</code> does it arrive at the last<code>print</code> statement.</p></div><hr/><div class="block"><a name="exercise5"></a><div class="exercisenum">Ex. 2.5</div><div class="exercise"><p><a class="paragraph" href="#p3d2dfd849f445bb0" name="p3d2dfd849f445bb0"> ¶ </a>Write a program to ask yourself, using <code>prompt</code>, what the value of 2 +2 is. If the answer is &quot;4&quot;, use <code>alert</code> to say something praising. Ifit is &quot;3&quot;or &quot;5&quot;, say &quot;Almost!&quot;. In other cases, say something mean.</p></div><div class="solution"><pre class="code"><span class="keyword">var</span><span class="variable">answer</span>=<span class="variable">prompt</span>(<span class="string">&quot;You! What is the value of 2 + 2?&quot;</span>, <span class="string">&quot;&quot;</span>);<span class="keyword">if</span> (<span class="variable">answer</span>==<span class="string">&quot;4&quot;</span>) <span class="variable">alert</span>(<span class="string">&quot;You must be a genius or something.&quot;</span>);<span class="keyword">else</span><span class="keyword">if</span> (<span class="variable">answer</span>==<span class="string">&quot;3&quot;</span> || <span class="variable">answer</span>==<span class="string">&quot;5&quot;</span>) <span class="variable">alert</span>(<span class="string">&quot;Almost!&quot;</span>);<span class="keyword">else</span><span class="variable">alert</span>(<span class="string">&quot;You're an embarrassment.&quot;</span>);</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p6f4a538a0fca3f13" name="p6f4a538a0fca3f13"> ¶ </a>When a loop does not always have to go all the way through to its end,the <a name="key78"></a><code>break</code> keyword can be useful. It immediately jumps out of thecurrent loop, continuing after it. This program finds the first numberthat is greater than or equal to 20 and divisible by 7:</p><pre class="code"><span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">current</span>=<span class="atom">20</span>;;<span class="variable">current</span>++){<span class="keyword">if</span> (<span class="variable">current</span> % <span class="atom">7</span>==<span class="atom">0</span>) <span class="keyword">break</span>;}<span class="variable">print</span>(<span class="variable">current</span>);</pre><p><a class="paragraph" href="#p22724963e529c807" name="p22724963e529c807"> ¶ </a>The <code>for</code> construct shown above does not have a part that checks forthe end of the loop. This means that it is dependent on the <code>break</code>statement inside it to ever stop. The same program could also havebeen written as simply...</p><pre class="code"><span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">current</span>=<span class="atom">20</span>;<span class="variable">current</span> % <span class="atom">7</span> !=<span class="atom">0</span>;<span class="variable">current</span>++) ;<span class="variable">print</span>(<span class="variable">current</span>);</pre><p><a class="paragraph" href="#p404799311561aa83" name="p404799311561aa83"> ¶ </a>In this case, the body of the loop is empty. A lone semicolon can beused to produce an empty statement. Here, the only effect of the loopis to increment the variable <code>current</code> to its desired value. But Ineeded an example that uses <code>break</code>, so pay attention to the firstversion too.</p></div><hr/><div class="block"><a name="exercise6"></a><div class="exercisenum">Ex. 2.6</div><div class="exercise"><p><a class="paragraph" href="#p7fdea634b22eece5" name="p7fdea634b22eece5"> ¶ </a>Add a <code>while</code> and optionally a <code>break</code> to your solution for theprevious exercise, so that it keeps repeating the question until acorrect answer is given.</p><p><a class="paragraph" href="#p165e246df3370008" name="p165e246df3370008"> ¶ </a>Note that <code>while (true) ...</code> can be used to create a loop that doesnot end on its own account. This is a bit silly, you ask the programto loop as long as <code>true</code> is <code>true</code>, but it is a useful trick.</p></div><div class="solution"><pre class="code"><span class="keyword">var</span><span class="variable">answer</span>;<span class="keyword">while</span> (<span class="atom">true</span>){<span class="variable">answer</span>=<span class="variable">prompt</span>(<span class="string">&quot;You! What is the value of 2 + 2?&quot;</span>, <span class="string">&quot;&quot;</span>);<span class="keyword">if</span> (<span class="variable">answer</span>==<span class="string">&quot;4&quot;</span>){<span class="variable">alert</span>(<span class="string">&quot;You must be a genius or something.&quot;</span>);<span class="keyword">break</span>;}<span class="keyword">else</span><span class="keyword">if</span> (<span class="variable">answer</span>==<span class="string">&quot;3&quot;</span> || <span class="variable">answer</span>==<span class="string">&quot;5&quot;</span>){<span class="variable">alert</span>(<span class="string">&quot;Almost!&quot;</span>);}<span class="keyword">else</span>{<span class="variable">alert</span>(<span class="string">&quot;You're an embarrassment.&quot;</span>);}}</pre><p><a class="paragraph" href="#p71ee6870077747b6" name="p71ee6870077747b6"> ¶ </a>Because the first <code>if</code>'s body now has two statements, I added bracesaround all the bodies. This is a matter of taste. Having an<code>if</code>/<code>else</code> chain where some of the bodies are blocks and others aresingle statements looks a bit lopsided to me, but you can make up yourown mind about that.</p><p><a class="paragraph" href="#paf1d0463f490564" name="paf1d0463f490564"> ¶ </a>Another solution, arguably nicer, but without <code>break</code>:</p><pre class="code"><span class="keyword">var</span><span class="variable">value</span>=<span class="atom">null</span>;<span class="keyword">while</span> (<span class="variable">value</span> !=<span class="string">&quot;4&quot;</span>){<span class="variable">value</span>=<span class="variable">prompt</span>(<span class="string">&quot;You! What is the value of 2 + 2?&quot;</span>, <span class="string">&quot;&quot;</span>);<span class="keyword">if</span> (<span class="variable">value</span>==<span class="string">&quot;4&quot;</span>) <span class="variable">alert</span>(<span class="string">&quot;You must be a genius or something.&quot;</span>);<span class="keyword">else</span><span class="keyword">if</span> (<span class="variable">value</span>==<span class="string">&quot;3&quot;</span> || <span class="variable">value</span>==<span class="string">&quot;5&quot;</span>) <span class="variable">alert</span>(<span class="string">&quot;Almost!&quot;</span>);<span class="keyword">else</span><span class="variable">alert</span>(<span class="string">&quot;You're an embarrassment.&quot;</span>);}</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p26084c692e69b3e7" name="p26084c692e69b3e7"> ¶ </a>In the solution to the previous exercise there is a statement <code>varanswer;</code>. This creates a variable named <code>answer</code>, but does not give ita value. What happens when you take the value of this variable?</p><pre class="code"><span class="keyword">var</span><span class="variable">mysteryVariable</span>;<span class="variable">show</span>(<span class="variable">mysteryVariable</span>);</pre><p><a class="paragraph" href="#p60044b005bb576ee" name="p60044b005bb576ee"> ¶ </a>In terms of tentacles, this variable ends in thin air, it has nothingto grasp. When you ask for the value of an empty place, you get aspecial value named <a name="key79"></a><code>undefined</code>. Functions which do not return aninteresting value, such as <code>print</code> and <code>alert</code>, also return an<code>undefined</code> value.</p><pre class="code"><span class="variable">show</span>(<span class="variable">alert</span>(<span class="string">&quot;I am a side effect.&quot;</span>));</pre><p><a class="paragraph" href="#p697d039f6b8b3ea" name="p697d039f6b8b3ea"> ¶ </a>There is also a similar value, <a name="key80"></a><code>null</code>, whose meaning is 'thisvariable is defined, but it does not have a value'. The difference inmeaning between <code>undefined</code> and <code>null</code> is mostly academic, and usuallynot very interesting. In practical programs, it is often necessary tocheck whether something 'has a value'. In these cases, the expression<code>something==undefined</code> may be used, because, even though they arenot exactly the same value, <code>null==undefined</code> will produce <code>true</code>.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p6fa1962abd3e4a44" name="p6fa1962abd3e4a44"> ¶ </a>Which brings us to another tricky subject...</p><pre class="code"><span class="variable">show</span>(<span class="atom">false</span>==<span class="atom">0</span>);<span class="variable">show</span>(<span class="string">&quot;&quot;</span>==<span class="atom">0</span>);<span class="variable">show</span>(<span class="string">&quot;5&quot;</span>==<span class="atom">5</span>);</pre><p><a class="paragraph" href="#p1e190ad10128d250" name="p1e190ad10128d250"> ¶ </a><a name="key81"></a>All these give the value <code>true</code>. When comparingvalues that have different types, JavaScript uses a complicated andconfusing set of rules. I am not going to try to explain themprecisely, but in most cases it just tries to convert one of thevalues to the type of the other value. However, when <code>null</code> or<code>undefined</code> occur, it only produces <code>true</code> if both sides are <code>null</code> or<code>undefined</code>.</p><p><a class="paragraph" href="#p24a1cdeb125eebb1" name="p24a1cdeb125eebb1"> ¶ </a>What if you want to test whether a variable refers to the value<code>false</code>? The rules for converting strings and numbers to booleanvalues state that <code>0</code> and the empty string count as <code>false</code>, while allthe other values count as <code>true</code>. Because of this, the expression<code>variable==false</code> is also <code>true</code> when <code>variable</code> refers to <code>0</code> or<code>&quot;&quot;</code>. For cases like this, where you do <em>not</em> want any automatic typeconversions to happen, there are two extra operators: <a name="key82"></a><code>===</code> and<a name="key83"></a><code>!==</code>. The first tests whether a value is precisely equal to theother, and the second tests whether it is not precisely equal.</p><pre class="code"><span class="variable">show</span>(<span class="atom">null</span>===<span class="atom">undefined</span>);<span class="variable">show</span>(<span class="atom">false</span>===<span class="atom">0</span>);<span class="variable">show</span>(<span class="string">&quot;&quot;</span>===<span class="atom">0</span>);<span class="variable">show</span>(<span class="string">&quot;5&quot;</span>===<span class="atom">5</span>);</pre><p><a class="paragraph" href="#p24c6f6ff2ef5a755" name="p24c6f6ff2ef5a755"> ¶ </a>All these are <code>false</code>.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p6b0cbd256d266d" name="p6b0cbd256d266d"> ¶ </a>Values given as the condition in an <code>if</code>, <code>while</code>, or <code>for</code> statementdo not have to be booleans. They will be automatically converted tobooleans before they are checked. This means that the number <code>0</code>, theempty string <code>&quot;&quot;</code>, <code>null</code>, <code>undefined</code>, and of course <code>false</code>, willall count as false.</p><p><a class="paragraph" href="#p9b525f85d56aa6e" name="p9b525f85d56aa6e"> ¶ </a>The fact that all other values are converted to <code>true</code> in this casemakes it possible to leave out explicit comparisons in manysituations. If a variable is known to contain either a string or<code>null</code>, one could check for this very simply...</p><pre class="code"><span class="keyword">var</span><span class="variable">maybeNull</span>=<span class="atom">null</span>;<span class="comment">// ... mystery code that might put a string into maybeNull ...</span><span class="keyword">if</span> (<span class="variable">maybeNull</span>) <span class="variable">print</span>(<span class="string">&quot;maybeNull has a value&quot;</span>);</pre><p><a class="paragraph" href="#p5a78f60b263ff17d" name="p5a78f60b263ff17d"> ¶ </a>... except in the case where the mystery code gives <code>maybeNull</code> thevalue <code>&quot;&quot;</code>. An empty string is false, so nothing is printed. Dependingon what you are trying to do, this might be <em>wrong</em>. It is often agood idea to add an explicit <code>===null</code> or <code>===false</code> in cases likethis to prevent subtle mistakes. The same occurs with number valuesthat might be <code>0</code>.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p679c07c88ec62790" name="p679c07c88ec62790"> ¶ </a>The line that talks about 'mystery code' in the previous example mighthave looked a bit suspicious to you. It is often useful to includeextra text in a program. The most common use for this is adding someexplanations in human language to a program.</p><pre class="code"><span class="comment">// The variable counter, which is about to be defined, is going</span><span class="comment">// to start with a value of 0, which is zero.</span><span class="keyword">var</span><span class="variable">counter</span>=<span class="atom">0</span>;<span class="comment">// Now, we are going to loop, hold on to your hat.</span><span class="keyword">while</span> (<span class="variable">counter</span> &lt;<span class="atom">100</span><span class="comment">/* counter is less than one hundred */</span>)<span class="comment">/* Every time we loop, we INCREMENT the value of counter, Seriously, we just add one to it. */</span><span class="variable">counter</span>++;<span class="comment">// And then, we are done.</span></pre><p><a class="paragraph" href="#p6314c8d46b2c537a" name="p6314c8d46b2c537a"> ¶ </a>This kind of text is called a <a name="key84"></a>comment. The rules are like this:'<code>/*</code>' starts a comment that goes on until a '<code>*/</code>' is found. '<code>//</code>'starts another kind of comment, which goes on until the end of theline.</p><p><a class="paragraph" href="#p1c8efde0fed0bf98" name="p1c8efde0fed0bf98"> ¶ </a>As you can see, even the simplest programs can be made to look big,ugly, and complicated by simply adding a lot of comments to them.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p6c1556cf0eda8c15" name="p6c1556cf0eda8c15"> ¶ </a>There are some other situations that cause automatic <a name="key85"></a>typeconversions to happen. If you add a non-string value to a string, thevalue is automatically converted to a string before it isconcatenated. If you multiply a number and a string, JavaScript triesto make a number out of the string.</p><pre class="code"><span class="variable">show</span>(<span class="string">&quot;Apollo&quot;</span> + <span class="atom">5</span>);<span class="variable">show</span>(<span class="atom">null</span> + <span class="string">&quot;ify&quot;</span>);<span class="variable">show</span>(<span class="string">&quot;5&quot;</span> * <span class="atom">5</span>);<span class="variable">show</span>(<span class="string">&quot;strawberry&quot;</span> * <span class="atom">5</span>);</pre><p><a class="paragraph" href="#p182041e0447d25bd" name="p182041e0447d25bd"> ¶ </a>The last statement prints <a name="key86"></a><code>NaN</code>, which is a special value. It standsfor 'not a number', and is of type number (which might sound a littlecontradictory). In this case, it refers to the fact that a strawberryis not a number. All arithmetic operations on the value <code>NaN</code> resultin <code>NaN</code>, which is why multiplying it by <code>5</code>, as in the example, stillgives a <code>NaN</code> value. Also, and this can be disorienting at times, <code>NaN==NaN</code> equals <code>false</code>, checking whether a value is <code>NaN</code> can be donewith the <a name="key87"></a><code>isNaN</code> function. <code>NaN</code> is another (the last) value thatcounts as <code>false</code> when converted to a boolean.</p><p><a class="paragraph" href="#p36148be46ecef1b3" name="p36148be46ecef1b3"> ¶ </a>These automatic conversions can be very convenient, but they are alsorather weird and error prone. Even though <code>+</code> and <code>*</code> are botharithmetic operators, they behave completely different in the example.In my own code, I use <code>+</code> to combine strings and non-strings a lot,but make it a point not to use <code>*</code> and the other numeric operators onstring values. Converting a number to a string is always possible andstraightforward, but converting a string to a number may not even work(as in the last line of the example). We can use <code>Number</code> toexplicitly convert the string to a number, making it clear that wemight run the risk of getting a <code>NaN</code> value.</p><pre class="code"><span class="variable">show</span>(<span class="variable">Number</span>(<span class="string">&quot;5&quot;</span>) * <span class="atom">5</span>);</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p558c67182a2437b2" name="p558c67182a2437b2"> ¶ </a>When we discussed the boolean operators <code>&amp;&amp;</code> and <code>||</code> earlier, Iclaimed they produced boolean values. This turns out to be a bit of anoversimplification. If you apply them to boolean values, they willindeed return booleans. But they can also be applied to other kinds ofvalues, in which case they will return one of their arguments.</p><p><a class="paragraph" href="#p3e7102c343c2cac3" name="p3e7102c343c2cac3"> ¶ </a>What <a name="key88"></a><code>||</code> really does is this: It looks at the value to the left ofit first. If converting this value to a boolean would produce <code>true</code>,it returns this left value, otherwise it returns the one on itsright. Check for yourself that this does the correct thing when thearguments are booleans. Why does it work like that? It turns out thisis very practical. Consider this example:</p><pre class="code"><span class="keyword">var</span><span class="variable">input</span>=<span class="variable">prompt</span>(<span class="string">&quot;What is your name?&quot;</span>, <span class="string">&quot;Kilgore Trout&quot;</span>);<span class="variable">print</span>(<span class="string">&quot;Well hello &quot;</span> + (<span class="variable">input</span> || <span class="string">&quot;dear&quot;</span>));</pre><p><a class="paragraph" href="#p1d27bd58eb76bd59" name="p1d27bd58eb76bd59"> ¶ </a>If the user presses 'Cancel' or closes the <code>prompt</code> dialog in someother way without giving a name, the variable <code>input</code> will hold thevalue <code>null</code> or <code>&quot;&quot;</code>. Both of these would give <code>false</code> when convertedto a boolean. The expression <code>input || &quot;dear&quot;</code> can in this case beread as 'the value of the variable <code>input</code>, or else the string<code>&quot;dear&quot;</code>'. It is an easy way to provide a 'fallback' value.</p><p><a class="paragraph" href="#p2c9d338cf8ef8b92" name="p2c9d338cf8ef8b92"> ¶ </a>The <a name="key89"></a><code>&amp;&amp;</code> operator works similarly, but the other way around. Whenthe value to its left is something that would give <code>false</code> whenconverted to a boolean, it returns that value, otherwise it returnsthe value on its right.</p><p><a class="paragraph" href="#p375b61ed74770a64" name="p375b61ed74770a64"> ¶ </a>Another property of these two operators is that the expression totheir right is only evaluated when necessary. In the case of <code>true ||X</code>, no matter what <code>X</code> is, the result will be <code>true</code>, so <code>X</code> is neverevaluated, and if it has side effects they never happen. The same goesfor <code>false &amp;&amp;X</code>.</p><pre class="code"><span class="atom">false</span> || <span class="variable">alert</span>(<span class="string">&quot;I'm happening!&quot;</span>);<span class="atom">true</span> || <span class="variable">alert</span>(<span class="string">&quot;Not me.&quot;</span>);</pre></div><ol class="footnotes"><li><a name="footnote1"></a>Bits are any kinds of two-valued things, usually described as <code>0</code>sand <code>1</code>s. Inside the computer, they take forms like a high or lowelectrical charge, a strong or weak signal, a shiny or dull spot onthe surface of a CD.</li><li><a name="footnote2"></a>If you were expecting something like <code>10010000</code> here ― good call,but read on. JavaScript's numbers are not stored as integers.</li><li><a name="footnote3"></a>Actually, 53, because of a trick that can be used to get one bitfor free. Look up the 'IEEE 754' format if you are curious about thedetails.</li><li><a name="footnote4"></a>When you type string values at the console, you'll notice that theywill come back with the quotes and backslashes the way you typed them.To get special characters to show properly, you can do <code>print(&quot;a\nb&quot;)</code>― why this works, we will see in a moment.</li><li><a name="footnote5"></a>The bit bucket is supposedly the place where old bits are kept. Onsome systems, the programmer has to manually empty it now and then.Fortunately, JavaScript comes with a fully-automatic bit-recyclingsystem.</li></ol><h1><span class="number">Chapter 3: </span>Functions</h1><div class="block"><p><a class="paragraph" href="#p1ab13025e2cb1812" name="p1ab13025e2cb1812"> ¶ </a>A program often needs to do the same thing in different places.Repeating all the necessary statements every time is tedious anderror-prone. It would be better to put them in one place, and have theprogram take a detour through there whenever necessary. This is what<a name="key1"></a>functions were invented for: They are canned code that a program cango through whenever it wants. Putting a string on the screen requiresquite a few statements, but when we have a <code>print</code> function we canjust write <code>print(&quot;Aleph&quot;)</code> and be done with it.</p><p><a class="paragraph" href="#p54c8e7a89febfb72" name="p54c8e7a89febfb72"> ¶ </a>To view functions merely as canned chunks of code doesn't do themjustice though. When needed, they can play the role of pure functions,algorithms, indirections, abstractions, decisions, modules,continuations, data structures, and more. Being able to effectivelyuse functions is a necessary skill for any kind of seriousprogramming. This chapter provides an introduction into the subject,<a href="chapter6.html">chapter 6</a> discusses the subtleties of functions in more depth.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p7a12e37bc40802a0" name="p7a12e37bc40802a0"> ¶ </a><a name="key2"></a>Pure functions, for a start, are the things that werecalled functions in the mathematics classes that I hope you have beensubjected to at some point in your life. Taking the cosine or theabsolute value of a number is a pure function of one argument.Addition is a pure function of two arguments.</p><p><a class="paragraph" href="#p522f322a2c4f7492" name="p522f322a2c4f7492"> ¶ </a>The defining properties of pure functions are that they always returnthe same value when given the same arguments, and never have sideeffects. They take some arguments, return a value based on thesearguments, and do not monkey around with anything else.</p><p><a class="paragraph" href="#p40b7ab0395b26dd5" name="p40b7ab0395b26dd5"> ¶ </a>In JavaScript, addition is an operator, but it could be wrapped in afunction like this (and as pointless as this looks, we will comeacross situations where it is actually useful):</p><pre class="code"><span class="keyword">function</span><span class="variable">add</span>(<span class="variabledef">a</span>, <span class="variabledef">b</span>){<span class="keyword">return</span><span class="localvariable">a</span> + <span class="localvariable">b</span>;}<span class="variable">show</span>(<span class="variable">add</span>(<span class="atom">2</span>, <span class="atom">2</span>));</pre><p><a class="paragraph" href="#p759819d221350eb" name="p759819d221350eb"> ¶ </a><code>add</code> is the name of the function. <code>a</code> and <code>b</code> are the names of thetwo arguments. <code>return a + b;</code> is the body of the function.</p><p><a class="paragraph" href="#p6d3341a7ad2c86b6" name="p6d3341a7ad2c86b6"> ¶ </a>The keyword <a name="key3"></a><code>function</code> is always used when creating a new function.When it is followed by a variable name, the resulting function will bestored under this name. After the name comes a list of <a name="key4"></a>argumentnames, and then finally the <a name="key5"></a>body of the function. Unlike thosearound the body of <code>while</code> loops or <code>if</code> statements, the braces arounda function body are obligatory<a class="footref" href="#footnote1">1</a>.</p><p><a class="paragraph" href="#p3734bedf153a1c6c" name="p3734bedf153a1c6c"> ¶ </a>The keyword <a name="key6"></a><code>return</code>, followed by an expression, is used todetermine the value the function returns. When control comes across a<code>return</code> statement, it immediately jumps out of the current functionand gives the returned value to the code that called the function. A<code>return</code> statement without an expression after it will cause thefunction to return <code>undefined</code>.</p><p><a class="paragraph" href="#p226693db801b5db6" name="p226693db801b5db6"> ¶ </a>A body can, of course, have more than one statement in it. Here is afunction for computing powers (with positive, integer exponents):</p><pre class="code"><span class="keyword">function</span><span class="variable">power</span>(<span class="variabledef">base</span>, <span class="variabledef">exponent</span>){<span class="keyword">var</span><span class="variabledef">result</span>=<span class="atom">1</span>;<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">count</span>=<span class="atom">0</span>;<span class="localvariable">count</span> &lt;<span class="localvariable">exponent</span>;<span class="localvariable">count</span>++) <span class="localvariable">result</span> *=<span class="localvariable">base</span>;<span class="keyword">return</span><span class="localvariable">result</span>;}<span class="variable">show</span>(<span class="variable">power</span>(<span class="atom">2</span>, <span class="atom">10</span>));</pre><p><a class="paragraph" href="#p19cfe95b03c8e65a" name="p19cfe95b03c8e65a"> ¶ </a>If you solved <a href="chapter2.html#exercise2">exercise 2.2</a>, this technique for computing a power shouldlook familiar.</p><p><a class="paragraph" href="#p1dcbee6b83ab5ea0" name="p1dcbee6b83ab5ea0"> ¶ </a>Creating a variable (<code>result</code>) and updating it are side effects.Didn't I just say pure functions had no side effects?</p><p><a class="paragraph" href="#p6c03fbcaffeb52" name="p6c03fbcaffeb52"> ¶ </a>A variable created inside a function exists only inside the function.This is fortunate, or a programmer would have to come up with adifferent name for every variable he needs throughout a program.Because <code>result</code> only exists inside <code>power</code>, the changes to it onlylast until the function returns, and from the perspective of code thatcalls it there are no side effects.</p></div><hr/><div class="block"><a name="exercise1"></a><div class="exercisenum">Ex. 3.1</div><div class="exercise"><p><a class="paragraph" href="#pf048437a44d112e" name="pf048437a44d112e"> ¶ </a>Write a function called <code>absolute</code>, which returns the absolute valueof the number it is given as its argument. The absolute value of anegative number is the positive version of that same number, and theabsolute value of a positive number (or zero) is that number itself.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">absolute</span>(<span class="variabledef">number</span>){<span class="keyword">if</span> (<span class="localvariable">number</span> &lt;<span class="atom">0</span>) <span class="keyword">return</span> -<span class="localvariable">number</span>;<span class="keyword">else</span><span class="keyword">return</span><span class="localvariable">number</span>;}<span class="variable">show</span>(<span class="variable">absolute</span>(-<span class="atom">144</span>));</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p3ab0c3f84a641284" name="p3ab0c3f84a641284"> ¶ </a>Pure functions have two very nice properties. They are easy to thinkabout, and they are easy to re-use.</p><p><a class="paragraph" href="#p68a342c634d718df" name="p68a342c634d718df"> ¶ </a>If a function is pure, a call to it can be seen as a thing in itself.When you are not sure that it is working correctly, you can test it bycalling it directly from the console, which is simple because it doesnot depend on any context<a class="footref" href="#footnote2">2</a>. It is easy to make these tests automatic― to write a program that tests a specific function. Non-purefunctions might return different values based on all kinds of factors,and have side effects that might be hard to test and think about.</p><p><a class="paragraph" href="#p9a097a88dff1354" name="p9a097a88dff1354"> ¶ </a>Because pure functions are self-sufficient, they are likely to beuseful and relevant in a wider range of situations than non-pure ones.Take <code>show</code>, for example. This function's usefulness depends on thepresence of a special place on the screen for printing output. If thatplace is not there, the function is useless. We can imagine a relatedfunction, let's call it <code>format</code>, that takes a value as an argumentand returns a string that represents this value. This function isuseful in more situations than <code>show</code>.</p><p><a class="paragraph" href="#p49c26f53b5129803" name="p49c26f53b5129803"> ¶ </a>Of course, <code>format</code> does not solve the same problem as <code>show</code>, and nopure function is going to be able to solve that problem, because itrequires a side effect. In many cases, non-pure functions areprecisely what you need. In other cases, a problem can be solved witha pure function but the non-pure variant is much more convenient orefficient.</p><p><a class="paragraph" href="#p7e26f30e06605ddf" name="p7e26f30e06605ddf"> ¶ </a>Thus, when something can easily be expressed as a pure function, writeit that way. But never feel dirty for writing non-pure functions.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p7e4f5f8e5d70151c" name="p7e4f5f8e5d70151c"> ¶ </a>Functions with side effects do not have to contain a <code>return</code>statement. If no <code>return</code> statement is encountered, the functionreturns <code>undefined</code>.</p><pre class="code"><span class="keyword">function</span><span class="variable">yell</span>(<span class="variabledef">message</span>){<span class="variable">alert</span>(<span class="localvariable">message</span> + <span class="string">&quot;!!&quot;</span>);}<span class="variable">yell</span>(<span class="string">&quot;Yow&quot;</span>);</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p468c043e14dd0d54" name="p468c043e14dd0d54"> ¶ </a>The names of the arguments of a function are available as variablesinside it. They will refer to the values of the arguments the functionis being called with, and like normal variables created inside afunction, they do not exist outside it. Aside from the <a name="key7"></a>top-levelenvironment, there are smaller, <a name="key8"></a>local environments created byfunction calls. When looking up a variable inside a function, thelocal environment is checked first, and only if the variable does notexist there is it looked up in the top-level environment. This makesit possible for variables inside a function to '<a name="key9"></a>shadow' top-levelvariables that have the same name.</p><pre class="code"><span class="keyword">function</span><span class="variable">alertIsPrint</span>(<span class="variabledef">value</span>){<span class="keyword">var</span><span class="variabledef">alert</span>=<span class="variable">print</span>;<span class="localvariable">alert</span>(<span class="localvariable">value</span>);}<span class="variable">alertIsPrint</span>(<span class="string">&quot;Troglodites&quot;</span>);</pre><p><a class="paragraph" href="#pbd8c4daf6299d2b" name="pbd8c4daf6299d2b"> ¶ </a>The variables in this local environment are only visible to the codeinside the function. If this function calls another function, thenewly called function does not see the variables inside the firstfunction:</p><pre class="code"><span class="keyword">var</span><span class="variable">variable</span>=<span class="string">&quot;top-level&quot;</span>;<span class="keyword">function</span><span class="variable">printVariable</span>(){<span class="variable">print</span>(<span class="string">&quot;inside printVariable, the variable holds '&quot;</span> + <span class="variable">variable</span> + <span class="string">&quot;'.&quot;</span>);}<span class="keyword">function</span><span class="variable">test</span>(){<span class="keyword">var</span><span class="variabledef">variable</span>=<span class="string">&quot;local&quot;</span>;<span class="variable">print</span>(<span class="string">&quot;inside test, the variable holds '&quot;</span> + <span class="localvariable">variable</span> + <span class="string">&quot;'.&quot;</span>);<span class="variable">printVariable</span>();}<span class="variable">test</span>();</pre><p><a class="paragraph" href="#p6aca90948e3a3b37" name="p6aca90948e3a3b37"> ¶ </a>However, and this is a subtle but extremely useful phenomenon, when afunction is defined <em>inside</em> another function, its local environmentwill be based on the local environment that surrounds it instead ofthe top-level environment.</p><pre class="code"><span class="keyword">var</span><span class="variable">variable</span>=<span class="string">&quot;top-level&quot;</span>;<span class="keyword">function</span><span class="variable">parentFunction</span>(){<span class="keyword">var</span><span class="variabledef">variable</span>=<span class="string">&quot;local&quot;</span>;<span class="keyword">function</span><span class="variabledef">childFunction</span>(){<span class="variable">print</span>(<span class="localvariable">variable</span>);}<span class="localvariable">childFunction</span>();}<span class="variable">parentFunction</span>();</pre><p><a class="paragraph" href="#pad6394b3204c0b3" name="pad6394b3204c0b3"> ¶ </a>What this comes down to is that which variables are visible inside afunction is determined by the place of that function in the programtext. All variables that were defined 'above' a function's definitionare visible, which means both those in function bodies that encloseit, and those at the top-level of the program. This approach tovariable visibility is called <a name="key10"></a>lexical scoping.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p56a7c524c38519f7" name="p56a7c524c38519f7"> ¶ </a>People who have experience with other programming languages mightexpect that a <a name="key11"></a>block of code (between braces) also produces a newlocal environment. Not in JavaScript. Functions are the only thingsthat create a new scope. You are allowed to use free-standing blockslike this...</p><pre class="code"><span class="keyword">var</span><span class="variable">something</span>=<span class="atom">1</span>;{<span class="keyword">var</span><span class="variable">something</span>=<span class="atom">2</span>;<span class="variable">print</span>(<span class="string">&quot;Inside: &quot;</span> + <span class="variable">something</span>);}<span class="variable">print</span>(<span class="string">&quot;Outside: &quot;</span> + <span class="variable">something</span>);</pre><p><a class="paragraph" href="#p34bdadb90acc781" name="p34bdadb90acc781"> ¶ </a>... but the <code>something</code> inside the block refers to the same variableas the one outside the block. In fact, although blocks like this areallowed, they are utterly pointless. Most people agree that this is abit of a design blunder by the designers of JavaScript, and ECMAScriptHarmony will add some way to define variables that stay inside blocks(the <code>let</code> keyword).</p></div><hr/><div class="block"><p><a class="paragraph" href="#p51e4eea024ff2593" name="p51e4eea024ff2593"> ¶ </a>Here is a case that might surprise you:</p><pre class="code"><span class="keyword">var</span><span class="variable">variable</span>=<span class="string">&quot;top-level&quot;</span>;<span class="keyword">function</span><span class="variable">parentFunction</span>(){<span class="keyword">var</span><span class="variabledef">variable</span>=<span class="string">&quot;local&quot;</span>;<span class="keyword">function</span><span class="variabledef">childFunction</span>(){<span class="variable">print</span>(<span class="localvariable">variable</span>);}<span class="keyword">return</span><span class="localvariable">childFunction</span>;}<span class="keyword">var</span><span class="variable">child</span>=<span class="variable">parentFunction</span>();<span class="variable">child</span>();</pre><p><a class="paragraph" href="#p5653f0ae129fabc0" name="p5653f0ae129fabc0"> ¶ </a><code>parentFunction</code><em>returns</em> its internal function, and the code at thebottom calls this function. Even though <code>parentFunction</code> has finishedexecuting at this point, the local environment where <code>variable</code> hasthe value <code>&quot;local&quot;</code> still exists, and <code>childFunction</code> still uses it.This phenomenon is called <a name="key12"></a>closure.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p428f678f2eb13e2b" name="p428f678f2eb13e2b"> ¶ </a>Apart from making it very easy to quickly see in which part of aprogram a variable will be available by looking at the shape of theprogram text, lexical scoping also allows us to 'synthesise'functions. By using some of the variables from an enclosing function,an inner function can be made to do different things. Imagine we needa few different but similar functions, one that adds 2 to itsargument, one that adds 5, and so on.</p><pre class="code"><span class="keyword">function</span><span class="variable">makeAddFunction</span>(<span class="variabledef">amount</span>){<span class="keyword">function</span><span class="variabledef">add</span>(<span class="variabledef">number</span>){<span class="keyword">return</span><span class="localvariable">number</span> + <span class="localvariable">amount</span>;}<span class="keyword">return</span><span class="localvariable">add</span>;}<span class="keyword">var</span><span class="variable">addTwo</span>=<span class="variable">makeAddFunction</span>(<span class="atom">2</span>);<span class="keyword">var</span><span class="variable">addFive</span>=<span class="variable">makeAddFunction</span>(<span class="atom">5</span>);<span class="variable">show</span>(<span class="variable">addTwo</span>(<span class="atom">1</span>) + <span class="variable">addFive</span>(<span class="atom">1</span>));</pre><p><a class="paragraph" href="#p1ab06c166100fc1" name="p1ab06c166100fc1"> ¶ </a>To wrap your head around this, you should consider functions to notjust package up a computation, but also an environment. Top-levelfunctions simply execute in the top-level environment, that much isobvious. But a function defined inside another function retains accessto the environment that existed in that function at the point when itwas defined.</p><p><a class="paragraph" href="#p1db9285e19fa7905" name="p1db9285e19fa7905"> ¶ </a>Thus, the <code>add</code> function in the above example, which is created when<code>makeAddFunction</code> is called, captures an environment in which <code>amount</code>has a certain value. It packages this environment, together with thecomputation <code>return number + amount</code>, into a value, which is thenreturned from the outer function.</p><p><a class="paragraph" href="#p1f062bceb7c6e565" name="p1f062bceb7c6e565"> ¶ </a>When this returned function (<code>addTwo</code> or <code>addFive</code>) is called, a newenvironment―-in which the variable <code>number</code> has a value―-is created,as a sub-environment of the captured environment (in which <code>amount</code>has a value). These two values are then added, and the result isreturned.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p666d720f386c0ed5" name="p666d720f386c0ed5"> ¶ </a>On top of the fact that different functions can contain variables ofthe same name without getting tangled up, these scoping rules alsoallow functions to call <em>themselves</em> without running into problems. Afunction that calls itself is called recursive. <a name="key13"></a>Recursionallows for some interesting definitions. Look at this implementationof <code>power</code>:</p><pre class="code"><span class="keyword">function</span><span class="variable">power</span>(<span class="variabledef">base</span>, <span class="variabledef">exponent</span>){<span class="keyword">if</span> (<span class="localvariable">exponent</span>==<span class="atom">0</span>) <span class="keyword">return</span><span class="atom">1</span>;<span class="keyword">else</span><span class="keyword">return</span><span class="localvariable">base</span> * <span class="variable">power</span>(<span class="localvariable">base</span>, <span class="localvariable">exponent</span> - <span class="atom">1</span>);}</pre><p><a class="paragraph" href="#pa41bf3c2429d4ce" name="pa41bf3c2429d4ce"> ¶ </a>This is rather close to the way mathematicians define exponentiation,and to me it looks a lot nicer than the earlier version. It sort ofloops, but there is no <code>while</code>, <code>for</code>, or even a local side effect tobe seen. By calling itself, the function produces the same effect.</p><p><a class="paragraph" href="#p713cfc3161eda8a4" name="p713cfc3161eda8a4"> ¶ </a>There is one important problem though: In most browsers, this secondversion is about ten times slower than the first one. In JavaScript,running through a simple loop is a lot cheaper than calling afunction multiple times.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p504e6707edebe21" name="p504e6707edebe21"> ¶ </a><a name="key14"></a>The dilemma of speed versus <a name="key15"></a>elegance is an interestingone. It not only occurs when deciding for or against recursion. Inmany situations, an elegant, intuitive, and often short solution canbe replaced by a more convoluted but faster solution.</p><p><a class="paragraph" href="#p18281cd06ea544c4" name="p18281cd06ea544c4"> ¶ </a>In the case of the <code>power</code> function above the un-elegant version isstill sufficiently simple and easy to read. It doesn't make very muchsense to replace it with the recursive version. Often, though, theconcepts a program is dealing with get so complex that giving up someefficiency in order to make the program more straightforward becomesan attractive choice.</p><p><a class="paragraph" href="#p41ace6ff96589ec2" name="p41ace6ff96589ec2"> ¶ </a>The basic rule, which has been repeated by many programmers and withwhich I wholeheartedly agree, is to not worry about efficiency untilyour program is provably too slow. When it is, find out which partsare too slow, and start exchanging elegance for efficiency in thoseparts.</p><p><a class="paragraph" href="#p4a09cae140ae6451" name="p4a09cae140ae6451"> ¶ </a>Of course, the above rule doesn't mean one should start ignoringperformance altogether. In many cases, like the <code>power</code> function, notmuch simplicity is gained by the 'elegant' approach. In other cases,an experienced programmer can see right away that a simple approach isnever going to be fast enough.</p><p><a class="paragraph" href="#p32fee7de3a4a76e7" name="p32fee7de3a4a76e7"> ¶ </a>The reason I am making a big deal out of this is that surprisinglymany programmers focus fanatically on efficiency, even in the smallestdetails. The result is bigger, more complicated, and often lesscorrect programs, which take longer to write than their morestraightforward equivalents and often run only marginally faster.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p567ecca0115e09ef" name="p567ecca0115e09ef"> ¶ </a>But I was talking about recursion. A concept closely related torecursion is a thing called the <a name="key16"></a>stack. When a function is called,control is given to the body of that function. When that body returns,the code that called the function is resumed. While the body isrunning, the computer must remember the context from which thefunction was called, so that it knows where to continue afterwards.The place where this context is stored is called the stack.</p><p><a class="paragraph" href="#p2a20f62a6ceb5021" name="p2a20f62a6ceb5021"> ¶ </a>The fact that it is called 'stack' has to do with the fact that, as wesaw, a function body can again call a function. Every time a functionis called, another context has to be stored. One can visualise this asa stack of contexts. Every time a function is called, the currentcontext is thrown on top of the stack. When a function returns, thecontext on top is taken off the stack and resumed.</p><p><a class="paragraph" href="#p66d5d68566b1c951" name="p66d5d68566b1c951"> ¶ </a>This stack requires space in the computer's memory to be stored. Whenthe stack grows too big, the computer will give up with a message like&quot;out of stack space&quot;or &quot;too much recursion&quot;. This is something thathas to be kept in mind when writing recursive functions.</p><pre class="code invalid"><span class="keyword">function</span><span class="variable">chicken</span>(){<span class="keyword">return</span><span class="variable">egg</span>();}<span class="keyword">function</span><span class="variable">egg</span>(){<span class="keyword">return</span><span class="variable">chicken</span>();}<span class="variable">print</span>(<span class="variable">chicken</span>() + <span class="string">&quot;came first.&quot;</span>);</pre><p><a class="paragraph" href="#p2236504013f7bcc1" name="p2236504013f7bcc1"> ¶ </a>In addition to demonstrating a very interesting way of writing abroken program, this example shows that a function does not have tocall itself directly to be recursive. If it calls another functionwhich (directly or indirectly) calls the first function again, it isstill recursive.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p55d89141e13b97c5" name="p55d89141e13b97c5"> ¶ </a>Recursion is not always just a less-efficient alternative to looping.Some problems are much easier to solve with recursion than with loops.Most often these are problems that require exploring or processingseveral 'branches', each of which might branch out again into morebranches.</p><p><a class="paragraph" href="#p305d5143d39f07b5" name="p305d5143d39f07b5"> ¶ </a>Consider this puzzle: By starting from the number 1 and repeatedlyeither adding 5 or multiplying by 3, an infinite amount of new numberscan be produced. How would you write a function that, given a number,tries to find a sequence of additions and multiplications that producethat number?</p><p><a class="paragraph" href="#p736964418741c593" name="p736964418741c593"> ¶ </a>For example, the number 13 could be reached by first multiplying 1 by3, and then adding 5 twice. The number 15 can not be reached at all.</p><p><a class="paragraph" href="#p39723b92f9615a1a" name="p39723b92f9615a1a"> ¶ </a>Here is the solution:</p><pre class="code"><span class="keyword">function</span><span class="variable">findSequence</span>(<span class="variabledef">goal</span>){<span class="keyword">function</span><span class="variabledef">find</span>(<span class="variabledef">start</span>, <span class="variabledef">history</span>){<span class="keyword">if</span> (<span class="localvariable">start</span>==<span class="localvariable">goal</span>) <span class="keyword">return</span><span class="localvariable">history</span>;<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">start</span> &gt;<span class="localvariable">goal</span>) <span class="keyword">return</span><span class="atom">null</span>;<span class="keyword">else</span><span class="keyword">return</span><span class="localvariable">find</span>(<span class="localvariable">start</span> + <span class="atom">5</span>, <span class="string">&quot;(&quot;</span> + <span class="localvariable">history</span> + <span class="string">&quot;+ 5)&quot;</span>) || <span class="localvariable">find</span>(<span class="localvariable">start</span> * <span class="atom">3</span>, <span class="string">&quot;(&quot;</span> + <span class="localvariable">history</span> + <span class="string">&quot;* 3)&quot;</span>);}<span class="keyword">return</span><span class="localvariable">find</span>(<span class="atom">1</span>, <span class="string">&quot;1&quot;</span>);}<span class="variable">print</span>(<span class="variable">findSequence</span>(<span class="atom">24</span>));</pre><p><a class="paragraph" href="#p31974c4e7a3d4a5" name="p31974c4e7a3d4a5"> ¶ </a>Note that it doesn't necessarily find the <em>shortest</em> sequence ofoperations, it is satisfied when it finds any sequence at all.</p><p><a class="paragraph" href="#p6bcdfa28934ac18b" name="p6bcdfa28934ac18b"> ¶ </a>The inner <code>find</code> function, by calling itself in two different ways,explores both the possibility of adding 5 to the current number and ofmultiplying it by 3. When it finds the number, it returns the<code>history</code> string, which is used to record all the operators that wereperformed to get to this number. It also checks whether the currentnumber is bigger than <code>goal</code>, because if it is, we should stopexploring this branch, it is not going to give us our number.</p><p><a class="paragraph" href="#p7a8b0e0dffcbe80c" name="p7a8b0e0dffcbe80c"> ¶ </a>The use of the <code>||</code> operator in the example can be read as 'return thesolution found by adding 5 to <code>start</code>, and if that fails, return thesolution found by multiplying <code>start</code> by 3'. It could also have beenwritten in a more wordy way like this:</p><pre class="preformatted">else{var found=find(start + 5, &quot;(&quot;+ history + &quot;+ 5)&quot;);if (found==null) found=find(start * 3, &quot;(&quot;+ history + &quot;* 3)&quot;);return found;}</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p3d589d4d45947faa" name="p3d589d4d45947faa"> ¶ </a>Even though function definitions occur as statements between the restof the program, they are not part of the same time-line:</p><pre class="code"><span class="variable">print</span>(<span class="string">&quot;The future says: &quot;</span>, <span class="variable">future</span>());<span class="keyword">function</span><span class="variable">future</span>(){<span class="keyword">return</span><span class="string">&quot;We STILL have no flying cars.&quot;</span>;}</pre><p><a class="paragraph" href="#p4e79d3c9d40230fe" name="p4e79d3c9d40230fe"> ¶ </a>What is happening is that the computer looks up all functiondefinitions, and stores the associated functions, <em>before</em> it startsexecuting the rest of the program. The same happens with functionsthat are defined inside other functions. When the outer function iscalled, the first thing that happens is that all inner functions areadded to the new environment.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p1daddade62c5d8a" name="p1daddade62c5d8a"> ¶ </a>There is another way to define function values, which more closelyresembles the way other values are created. When the <code>function</code>keyword is used in a place where an expression is expected, it istreated as an expression producing a function value. Functions createdin this way do not have to be given a name (though it is allowed togive them one).</p><pre class="code"><span class="keyword">var</span><span class="variable">add</span>=<span class="keyword">function</span>(<span class="variabledef">a</span>, <span class="variabledef">b</span>){<span class="keyword">return</span><span class="localvariable">a</span> + <span class="localvariable">b</span>;};<span class="variable">show</span>(<span class="variable">add</span>(<span class="atom">5</span>, <span class="atom">5</span>));</pre><p><a class="paragraph" href="#p1ff0501f8151fde7" name="p1ff0501f8151fde7"> ¶ </a>Note the semicolon after the definition of <code>add</code>. Normal functiondefinitions do not need these, but this statement has the same generalstructure as <code>var add=22;</code>, and thus requires the semicolon.</p><p><a class="paragraph" href="#p294c5a0ff8452901" name="p294c5a0ff8452901"> ¶ </a>This kind of function value is called an <a name="key17"></a>anonymous function, becauseit does not have a name. Sometimes it is useless to give a function aname, like in the <code>makeAddFunction</code> example we saw earlier:</p><pre class="code"><span class="keyword">function</span><span class="variable">makeAddFunction</span>(<span class="variabledef">amount</span>){<span class="keyword">return</span><span class="keyword">function</span> (<span class="variabledef">number</span>){<span class="keyword">return</span><span class="localvariable">number</span> + <span class="localvariable">amount</span>;};}</pre><p><a class="paragraph" href="#p3942ecf8918012ea" name="p3942ecf8918012ea"> ¶ </a>Since the function named <code>add</code> in the first version of<code>makeAddFunction</code> was referred to only once, the name does not serveany purpose and we might as well directly return the function value.</p></div><hr/><div class="block"><a name="exercise2"></a><div class="exercisenum">Ex. 3.2</div><div class="exercise"><p><a class="paragraph" href="#p39ef6ece83c48ffd" name="p39ef6ece83c48ffd"> ¶ </a>Write a function <code>greaterThan</code>, which takes one argument, a number,and returns a function that represents a test. When this returnedfunction is called with a single number as argument, it returns aboolean: <code>true</code> if the given number is greater than the number thatwas used to create the test function, and <code>false</code> otherwise.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">greaterThan</span>(<span class="variabledef">x</span>){<span class="keyword">return</span><span class="keyword">function</span>(<span class="variabledef">y</span>){<span class="keyword">return</span><span class="localvariable">y</span> &gt;<span class="localvariable">x</span>;};}<span class="keyword">var</span><span class="variable">greaterThanTen</span>=<span class="variable">greaterThan</span>(<span class="atom">10</span>);<span class="variable">show</span>(<span class="variable">greaterThanTen</span>(<span class="atom">9</span>));</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p229f158aa3834c6d" name="p229f158aa3834c6d"> ¶ </a>Try the following:</p><pre class="code"><span class="variable">alert</span>(<span class="string">&quot;Hello&quot;</span>, <span class="string">&quot;Good Evening&quot;</span>, <span class="string">&quot;How do you do?&quot;</span>, <span class="string">&quot;Goodbye&quot;</span>);</pre><p><a class="paragraph" href="#p77166a1bf06b3798" name="p77166a1bf06b3798"> ¶ </a>The function <code>alert</code> officially only accepts one argument. Yet whenyou call it like this, the computer does not complain at all, but justignores the other arguments.</p><pre class="code"><span class="variable">show</span>();</pre><p><a class="paragraph" href="#p1985bd9435f81fe3" name="p1985bd9435f81fe3"> ¶ </a>You can, apparently, even get away with passing too few arguments.When an argument is not passed, its value inside the function is<code>undefined</code>.</p><p><a class="paragraph" href="#p3e4bab204c00a239" name="p3e4bab204c00a239"> ¶ </a>In the next chapter, we will see a way in which a function body canget at the exact list of arguments that were passed to it. This can beuseful, as it makes it possible to have a function accept any numberof arguments. <code>print</code> makes use of this:</p><pre class="code"><span class="variable">print</span>(<span class="string">&quot;R&quot;</span>, <span class="atom">2</span>, <span class="string">&quot;D&quot;</span>, <span class="atom">2</span>);</pre><p><a class="paragraph" href="#p2626cadb33f5c110" name="p2626cadb33f5c110"> ¶ </a>Of course, the downside of this is that it is also possible toaccidentally pass the wrong number of arguments to functions thatexpect a fixed amount of them, like <code>alert</code>, and never be told aboutit.</p></div><ol class="footnotes"><li><a name="footnote1"></a>Technically, this wouldn't have been necessary, but I suppose thedesigners of JavaScript felt it would clarify things if functionbodies always had braces.</li><li><a name="footnote2"></a>Technically, a pure function can not use the value of any externalvariables. These values might change, and this could make the functionreturn a different value for the same arguments. In practice, theprogrammer may consider some variables 'constant' ― they are notexpected to change ― and consider functions that use only constantvariables pure. Variables that contain a function value are often goodexamples of constant variables.</li></ol><h1><span class="number">Chapter 4: </span>Data structures: Objects and Arrays</h1><div class="block"><p><a class="paragraph" href="#p3dad71ee8f395a59" name="p3dad71ee8f395a59"> ¶ </a>This chapter will be devoted to solving a few simple problems. In theprocess, we will discuss two new types of values, arrays and objects,and look at some techniques related to them.</p><p><a class="paragraph" href="#p564e8d1b4b91712a" name="p564e8d1b4b91712a"> ¶ </a>Consider the following situation: Your crazy aunt Emily, who isrumoured to have over fifty cats living with her (you never managed tocount them), regularly sends you e-mails to keep you up to date on herexploits. They usually look like this:</p><blockquote>Dear nephew,<br/><br/>Your mother told me you have taken up skydiving. Is this true? Youwatch yourself, young man! Remember what happened to my husband? Andthat was only from the second floor!<br/><br/>Anyway, things are very exciting here. I have spent all week trying toget the attention of Mr. Drake, the nice gentleman who moved in nextdoor, but I think he is afraid of cats. Or allergic to them? I amgoing to try putting Fat Igor on his shoulder next time I see him,very curious what will happen.<br/><br/>Also, the scam I told you about is going better than expected. I havealready gotten back five 'payments', and only one complaint. It isstarting to make me feel a bit bad though. And you are right that itis probably illegal in some way.<br/><br/>(... etc ...)<br/><br/>Much love,Aunt Emily<br/><br/>died 27/04/2006: Black Leclère<br/><br/>born 05/04/2006 (mother Lady Penelope): Red Lion, Doctor Hobbles the3rd, Little Iroquois</blockquote><p><a class="paragraph" href="#p301a6a2df4db3245" name="p301a6a2df4db3245"> ¶ </a>To humour the old dear, you would like to keep track of the genealogyof her cats, so you can add things like &quot;P.S. I hope Doctor Hobblesthe 2nd enjoyed his birthday this Saturday!&quot;, or &quot;How is old LadyPenelope doing? She's five years old now, isn't she?&quot;, preferablywithout accidentally asking about dead cats. You are in the possessionof a large quantity of old e-mails from your aunt, and fortunately sheis very consistent in always putting information about the cats'births and deaths at the end of her mails in precisely the sameformat.</p><p><a class="paragraph" href="#p15cf28da1188e7aa" name="p15cf28da1188e7aa"> ¶ </a>You are hardly inclined to go through all those mails by hand.Fortunately, we were just in need of an example problem, so we willtry to work out a program that does the work for us. For a start, wewrite a program that gives us a list of cats that are still aliveafter the last e-mail.</p><p><a class="paragraph" href="#p3ee0a4d551384142" name="p3ee0a4d551384142"> ¶ </a>Before you ask, at the start of the correspondence, aunt Emily hadonly a single cat: Spot. (She was still rather conventional in thosedays.)</p></div><hr/><div class="block"><div class="picture"><img src="img/eyes.png"/></div></div><hr/><div class="block"><p><a class="paragraph" href="#p1d776b34e90a830e" name="p1d776b34e90a830e"> ¶ </a>It usually pays to have some kind of clue what one's program is goingto do before starting to type. Here's a plan:</p><ol><li>Start with a set of cat names that has only &quot;Spot&quot;in it.</li><li>Go over every e-mail in our archive, in chronological order.</li><li>Look for paragraphs that start with &quot;born&quot;or &quot;died&quot;.</li><li>Add the names from paragraphs that start with &quot;born&quot;to our set of names.</li><li>Remove the names from paragraphs that start with &quot;died&quot;from our set.</li></ol><p><a class="paragraph" href="#p22f6a88dc6385bae" name="p22f6a88dc6385bae"> ¶ </a>Where taking the names from a paragraph goes like this:</p><ol><li>Find the colon in the paragraph.</li><li>Take the part after this colon.</li><li>Split this part into separate names by looking for commas.</li></ol><p><a class="paragraph" href="#p31ed7fa7e0fb7b15" name="p31ed7fa7e0fb7b15"> ¶ </a>It may require some suspension of disbelief to accept that aunt Emilyalways used this exact format, and that she never forgot or misspelleda name, but that is just how your aunt is.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p381d38ad2a5f03fb" name="p381d38ad2a5f03fb"> ¶ </a>First, let me tell you about <a name="key1"></a>properties. A lot of JavaScript valueshave other values associated with them. These associations are calledproperties. Every string has a property called <a name="key2"></a><code>length</code>, which refersto a number, the amount of characters in that string.</p><p><a class="paragraph" href="#p48e9e703da61d7cb" name="p48e9e703da61d7cb"> ¶ </a><a name="key3"></a>Properties can be accessed in two ways:</p><pre class="code"><span class="keyword">var</span><span class="variable">text</span>=<span class="string">&quot;purple haze&quot;</span>;<span class="variable">show</span>(<span class="variable">text</span>[<span class="string">&quot;length&quot;</span>]);<span class="variable">show</span>(<span class="variable">text</span>.<span class="property">length</span>);</pre><p><a class="paragraph" href="#p2c4a983bace7fd1e" name="p2c4a983bace7fd1e"> ¶ </a>The second way is a shorthand for the first, and it only works whenthe name of the property would be a valid variable name ― when itdoesn't have any spaces or symbols in it and does not start with adigit character.</p><p><a class="paragraph" href="#p618918d23b0e51d1" name="p618918d23b0e51d1"> ¶ </a>The values <code>null</code> and <code>undefined</code> do not have any properties. Tryingto read properties from such a value produces an error. Try thefollowing code, if only to get an idea about the kind of error-messageyour browser produces in such a case (which, for some browsers, can berather cryptic).</p><pre class="code invalid"><span class="keyword">var</span><span class="variable">nothing</span>=<span class="atom">null</span>;<span class="variable">show</span>(<span class="variable">nothing</span>.<span class="property">length</span>);</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p3a782c2198acba80" name="p3a782c2198acba80"> ¶ </a>The properties of a string value can not be changed. There are quite afew more than just <code>length</code>, as we will see, but you are not allowedto add or remove any.</p><p><a class="paragraph" href="#p16941343cc6e526c" name="p16941343cc6e526c"> ¶ </a>This is different with values of the type <a name="key4"></a>object. Their main role isto hold other values. They have, you could say, their own set oftentacles in the form of properties. You are free to modify these,remove them, or add new ones.</p><p><a class="paragraph" href="#p40b069744fe1b3f6" name="p40b069744fe1b3f6"> ¶ </a><a name="key5"></a>An object can be written like this:</p><pre class="code"><span class="keyword">var</span><span class="variable">cat</span>={<span class="property">colour</span>: <span class="string">&quot;grey&quot;</span>, <span class="property">name</span>: <span class="string">&quot;Spot&quot;</span>, <span class="property">size</span>: <span class="atom">46</span>};<span class="variable">cat</span>.<span class="property">size</span>=<span class="atom">47</span>;<span class="variable">show</span>(<span class="variable">cat</span>.<span class="property">size</span>);<span class="keyword">delete</span><span class="variable">cat</span>.<span class="property">size</span>;<span class="variable">show</span>(<span class="variable">cat</span>.<span class="property">size</span>);<span class="variable">show</span>(<span class="variable">cat</span>);</pre><p><a class="paragraph" href="#p13bcd81d1795ba64" name="p13bcd81d1795ba64"> ¶ </a>Like variables, each property attached to an object is labelled by astring. The first statement creates an object in which the property<code>&quot;colour&quot;</code> holds the string <code>&quot;grey&quot;</code>, the property <code>&quot;name&quot;</code> is attachedto the string <code>&quot;Spot&quot;</code>, and the property <code>&quot;size&quot;</code> refers to the number<code>46</code>. The second statement gives the property named <code>size</code> a newvalue, which is done in the same way as modifying a variable.</p><p><a class="paragraph" href="#p4a08c86f5895f714" name="p4a08c86f5895f714"> ¶ </a>The keyword <a name="key6"></a><code>delete</code> cuts off properties. Trying to read anon-existent property gives the value <code>undefined</code>.</p><p><a class="paragraph" href="#p20597691898398b" name="p20597691898398b"> ¶ </a>If a property that does not yet exist is set with the <a name="key7"></a><code>=</code> operator,it is added to the object.</p><pre class="code"><span class="keyword">var</span><span class="variable">empty</span>={};<span class="variable">empty</span>.<span class="property">notReally</span>=<span class="atom">1000</span>;<span class="variable">show</span>(<span class="variable">empty</span>.<span class="property">notReally</span>);</pre><p><a class="paragraph" href="#p205e668d2c45ec08" name="p205e668d2c45ec08"> ¶ </a>Properties whose names are not valid variable names have to be quotedwhen creating the object, and approached using brackets:</p><pre class="code"><span class="keyword">var</span><span class="variable">thing</span>={<span class="string">&quot;gabba gabba&quot;</span>: <span class="string">&quot;hey&quot;</span>, <span class="string">&quot;5&quot;</span>: <span class="atom">10</span>};<span class="variable">show</span>(<span class="variable">thing</span>[<span class="string">&quot;5&quot;</span>]);<span class="variable">thing</span>[<span class="string">&quot;5&quot;</span>]=<span class="atom">20</span>;<span class="variable">show</span>(<span class="variable">thing</span>[<span class="atom">2</span> + <span class="atom">3</span>]);<span class="keyword">delete</span><span class="variable">thing</span>[<span class="string">&quot;gabba gabba&quot;</span>];</pre><p><a class="paragraph" href="#p7d28b3bf47e572d8" name="p7d28b3bf47e572d8"> ¶ </a>As you can see, the part between the brackets can be any expression.It is converted to a string to determine the property name it refersto. One can even use variables to name properties:</p><pre class="code"><span class="keyword">var</span><span class="variable">propertyName</span>=<span class="string">&quot;length&quot;</span>;<span class="keyword">var</span><span class="variable">text</span>=<span class="string">&quot;mainline&quot;</span>;<span class="variable">show</span>(<span class="variable">text</span>[<span class="variable">propertyName</span>]);</pre><p><a class="paragraph" href="#p48975384feabef2b" name="p48975384feabef2b"> ¶ </a>The operator <a name="key8"></a><code>in</code> can be used to test whether an object has acertain property. It produces a boolean.</p><pre class="code"><span class="keyword">var</span><span class="variable">chineseBox</span>={};<span class="variable">chineseBox</span>.<span class="property">content</span>=<span class="variable">chineseBox</span>;<span class="variable">show</span>(<span class="string">&quot;content&quot;</span> in <span class="variable">chineseBox</span>);<span class="variable">show</span>(<span class="string">&quot;content&quot;</span> in <span class="variable">chineseBox</span>.<span class="property">content</span>);</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p75f93b43a15f6b97" name="p75f93b43a15f6b97"> ¶ </a>When object values are shown on the console, they can be clicked toinspect their properties. This changes the output window to an'inspect' window. The little 'x' at the top-right can be used toreturn to the output window, and the left-arrow can be used to go backto the properties of the previously inspected object.</p><pre class="code"><span class="variable">show</span>(<span class="variable">chineseBox</span>);</pre></div><hr/><div class="block"><a name="exercise1"></a><div class="exercisenum">Ex. 4.1</div><div class="exercise"><p><a class="paragraph" href="#p27ecd9cf2dacfc4f" name="p27ecd9cf2dacfc4f"> ¶ </a>The solution for the cat problem talks about a 'set' of names. A <a name="key9"></a>setis a collection of values in which no value may occur more than once.If names are strings, can you think of a way to use an object torepresent a set of names?</p><p><a class="paragraph" href="#p43887c2aefc059e4" name="p43887c2aefc059e4"> ¶ </a>Show how a name can be added to this set, how one can be removed, andhow you can check whether a name occurs in it.</p></div><div class="solution"><p><a class="paragraph" href="#p24ea5ce9465c6b97" name="p24ea5ce9465c6b97"> ¶ </a>This can be done by storing the content of the set as the propertiesof an object. Adding a name is done by setting a property by that nameto a value, any value. Removing a name is done by deleting thisproperty. The <code>in</code> operator can be used to determine whether a certainname is part of the set<a class="footref" href="#footnote1">1</a>.</p><pre class="code"><span class="keyword">var</span><span class="variable">set</span>={<span class="string">&quot;Spot&quot;</span>: <span class="atom">true</span>};<span class="comment">// Add &quot;White Fang&quot;to the set</span><span class="variable">set</span>[<span class="string">&quot;White Fang&quot;</span>]=<span class="atom">true</span>;<span class="comment">// Remove &quot;Spot&quot;</span><span class="keyword">delete</span><span class="variable">set</span>[<span class="string">&quot;Spot&quot;</span>];<span class="comment">// See if &quot;Asoka&quot;is in the set</span><span class="variable">show</span>(<span class="string">&quot;Asoka&quot;</span> in <span class="variable">set</span>);</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p374d5585e1413051" name="p374d5585e1413051"> ¶ </a><a name="key10"></a>Object values, apparently, can change. The types ofvalues discussed in <a href="chapter2.html">chapter 2</a> are all immutable, it is impossible tochange an existing value of those types. You can combine them andderive new values from them, but when you take a specific stringvalue, the text inside it can not change. With objects, on the otherhand, the content of a value can be modified by changing itsproperties.</p><p><a class="paragraph" href="#p304f40f25d1c0387" name="p304f40f25d1c0387"> ¶ </a>When we have two numbers, <code>120</code> and <code>120</code>, they can for all practicalpurposes be considered the precise same number. With objects, there isa difference between having two references to the same object andhaving two different objects that contain the same properties.Consider the following code:</p><pre class="code"><span class="keyword">var</span><span class="variable">object1</span>={<span class="property">value</span>: <span class="atom">10</span>};<span class="keyword">var</span><span class="variable">object2</span>=<span class="variable">object1</span>;<span class="keyword">var</span><span class="variable">object3</span>={<span class="property">value</span>: <span class="atom">10</span>};<span class="variable">show</span>(<span class="variable">object1</span>==<span class="variable">object2</span>);<span class="variable">show</span>(<span class="variable">object1</span>==<span class="variable">object3</span>);<span class="variable">object1</span>.<span class="property">value</span>=<span class="atom">15</span>;<span class="variable">show</span>(<span class="variable">object2</span>.<span class="property">value</span>);<span class="variable">show</span>(<span class="variable">object3</span>.<span class="property">value</span>);</pre><p><a class="paragraph" href="#p33251549b1ce2fd4" name="p33251549b1ce2fd4"> ¶ </a><code>object1</code> and <code>object2</code> are two variables grasping the <em>same</em> value.There is only one actual object, which is why changing <code>object1</code> alsochanges the value of <code>object2</code>. The variable <code>object3</code> points toanother object, which initially contains the same properties as<code>object1</code>, but lives a separate life.</p><p><a class="paragraph" href="#p586f09a0de2c9531" name="p586f09a0de2c9531"> ¶ </a>JavaScript's <a name="key11"></a><code>==</code> operator, when comparing objects, will only return<code>true</code> if both values given to it are the precise same value.Comparing different objects with identical contents will give <code>false</code>.This is useful in some situations, but impractical in others.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p545a9c43b75af0cd" name="p545a9c43b75af0cd"> ¶ </a>Object values can play a lot of different roles. Behaving like a setis only one of those. We will see a few other roles in this chapter,and <a href="chapter8.html">chapter 8</a> shows another important way of using objects.</p><p><a class="paragraph" href="#p706ccf569a6428ed" name="p706ccf569a6428ed"> ¶ </a>In the plan for the cat problem ― in fact, call it an <em>algorithm</em>,not a plan, that makes it sound like we know what we are talking about― in the algorithm, it talks about going over all the e-mails in anarchive. What does this archive look like? And where does it comefrom?</p><p><a class="paragraph" href="#p2e21e98d83db57ad" name="p2e21e98d83db57ad"> ¶ </a>Do not worry about the second question for now. <a href="chapter14.html">Chapter 14</a> talks aboutsome ways to import data into your programs, but for now you will findthat the e-mails are just magically there. Some magic is really easy,inside computers.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p2a379b494a92b2d4" name="p2a379b494a92b2d4"> ¶ </a>The way in which the archive is stored is still an interestingquestion. It contains a number of e-mails. An e-mail can be a string,that should be obvious. The whole archive could be put into one hugestring, but that is hardly practical. What we want is a collection ofseparate strings.</p><p><a class="paragraph" href="#p69666f13ed683e93" name="p69666f13ed683e93"> ¶ </a>Collections of things are what objects are used for. One could make anobject like this:</p><pre class="code"><span class="keyword">var</span><span class="variable">mailArchive</span>={<span class="string">&quot;the first e-mail&quot;</span>: <span class="string">&quot;Dear nephew, ...&quot;</span>, <span class="string">&quot;the second e-mail&quot;</span>: <span class="string">&quot;...&quot;</span><span class="comment">/* and so on ... */</span>};</pre><p><a class="paragraph" href="#p1aba2b421ecbd9f3" name="p1aba2b421ecbd9f3"> ¶ </a>But that makes it hard to go over the e-mails from start to end ― howdoes the program guess the name of these properties? This can besolved by more predictable property names:</p><pre class="code"><span class="keyword">var</span><span class="variable">mailArchive</span>={<span class="atom">0</span>: <span class="string">&quot;Dear nephew, ... (mail number 1)&quot;</span>, <span class="atom">1</span>: <span class="string">&quot;(mail number 2)&quot;</span>, <span class="atom">2</span>: <span class="string">&quot;(mail number 3)&quot;</span>};<span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">current</span>=<span class="atom">0</span>;<span class="variable">current</span> in <span class="variable">mailArchive</span>;<span class="variable">current</span>++) <span class="variable">print</span>(<span class="string">&quot;Processing e-mail #&quot;</span>, <span class="variable">current</span>, <span class="string">&quot;: &quot;</span>, <span class="variable">mailArchive</span>[<span class="variable">current</span>]);</pre><p><a class="paragraph" href="#p5d88f1adde4f9e20" name="p5d88f1adde4f9e20"> ¶ </a>Luck has it that there is a special kind of objects specifically forthis kind of use. They are called <a name="key12"></a>arrays, and they provide someconveniences, such as a <a name="key13"></a><code>length</code> property that contains the amountof values in the array, and a number of operations useful for thiskind of collection.</p><p><a class="paragraph" href="#p66a8f15bc365329f" name="p66a8f15bc365329f"> ¶ </a><a name="key14"></a>New arrays can be created using brackets (<code>[</code> and <code>]</code>):</p><pre class="code"><span class="keyword">var</span><span class="variable">mailArchive</span>=[<span class="string">&quot;mail one&quot;</span>, <span class="string">&quot;mail two&quot;</span>, <span class="string">&quot;mail three&quot;</span>];<span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">current</span>=<span class="atom">0</span>;<span class="variable">current</span> &lt;<span class="variable">mailArchive</span>.<span class="property">length</span>;<span class="variable">current</span>++) <span class="variable">print</span>(<span class="string">&quot;Processing e-mail #&quot;</span>, <span class="variable">current</span>, <span class="string">&quot;: &quot;</span>, <span class="variable">mailArchive</span>[<span class="variable">current</span>]);</pre><p><a class="paragraph" href="#p208a5481ace28737" name="p208a5481ace28737"> ¶ </a>In this example, the numbers of the elements are not specifiedexplicitly anymore. The first one automatically gets the number 0, thesecond the number 1, and so on.</p><p><a class="paragraph" href="#p63946de7837cdea6" name="p63946de7837cdea6"> ¶ </a>Why start at 0? People tend to start counting from 1. As unintuitiveas it seems, numbering the elements in a collection from 0 is oftenmore practical. Just go with it for now, it will grow on you.</p><p><a class="paragraph" href="#p6b60b0919e690668" name="p6b60b0919e690668"> ¶ </a>Starting at element 0 also means that in a collection with <code>X</code>elements, the last element can be found at position <code>X - 1</code>. This iswhy the <code>for</code> loop in the example checks for <code>current &lt;mailArchive.length</code>. There is no element at position<code>mailArchive.length</code>, so as soon as <code>current</code> has that value, we stoplooping.</p></div><hr/><div class="block"><a name="exercise2"></a><div class="exercisenum">Ex. 4.2</div><div class="exercise"><p><a class="paragraph" href="#p5bb2a834279b6896" name="p5bb2a834279b6896"> ¶ </a>Write a function <code>range</code> that takes one argument, a positive number,and returns an array containing all numbers from 0 up to and includingthe given number.</p><p><a class="paragraph" href="#p2d6da830cab7863d" name="p2d6da830cab7863d"> ¶ </a>An empty array can be created by simply typing <code>[]</code>. Also rememberthat adding properties to an object, and thus also to an array, can bedone by assigning them a value with the <code>=</code> operator. The <code>length</code>property is automatically updated when elements are added.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">range</span>(<span class="variabledef">upto</span>){<span class="keyword">var</span><span class="variabledef">result</span>=[];<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">i</span>=<span class="atom">0</span>;<span class="localvariable">i</span> &lt;=<span class="localvariable">upto</span>;<span class="localvariable">i</span>++) <span class="localvariable">result</span>[<span class="localvariable">i</span>]=<span class="localvariable">i</span>;<span class="keyword">return</span><span class="localvariable">result</span>;}<span class="variable">show</span>(<span class="variable">range</span>(<span class="atom">4</span>));</pre><p><a class="paragraph" href="#p691dda347a9c0f9b" name="p691dda347a9c0f9b"> ¶ </a>Instead of naming the loop variable <code>counter</code> or <code>current</code>, as I havebeen doing so far, it is now called simply <code>i</code>. Using single letters,usually <code>i</code>, <code>j</code>, or <code>k</code> for loop variables is a widely spread habitamong programmers. It has its origin mostly in laziness: We'd rathertype one character than seven, and names like <code>counter</code> and <code>current</code>do not really clarify the meaning of the variable much.</p><p><a class="paragraph" href="#p41226ce7fea00811" name="p41226ce7fea00811"> ¶ </a>If a program uses too many meaningless single-letter variables, it canbecome unbelievably confusing. In my own programs, I try to only dothis in a few common cases. Small loops are one of these cases. If theloop contains another loop, and that one also uses a variable named<code>i</code>, the inner loop will modify the variable that the outer loop isusing, and everything will break. One could use <code>j</code> for the innerloop, but in general, when the body of a loop is big, you should comeup with a variable name that has some clear meaning.</p></div></div><hr/><div class="block"><p><a class="paragraph" href="#p63f311670d53896a" name="p63f311670d53896a"> ¶ </a>Both string and array objects contain, in addition to the <code>length</code>property, a number of properties that refer to function values.</p><pre class="code"><span class="keyword">var</span><span class="variable">doh</span>=<span class="string">&quot;Doh&quot;</span>;<span class="variable">print</span>(typeof <span class="variable">doh</span>.<span class="property">toUpperCase</span>);<span class="variable">print</span>(<span class="variable">doh</span>.<span class="property">toUpperCase</span>());</pre><p><a class="paragraph" href="#p172dc5b33324ebd" name="p172dc5b33324ebd"> ¶ </a>Every string has a <a name="key15"></a><code>toUpperCase</code> property. When called, it willreturn a copy of the string, in which all letters have been convertedto uppercase. There is also <a name="key16"></a><code>toLowerCase</code>. Guess what that does.</p><p><a class="paragraph" href="#p70ebdb3340519977" name="p70ebdb3340519977"> ¶ </a>Notice that, even though the call to <code>toUpperCase</code> does not pass anyarguments, the function does somehow have access to the string<code>&quot;Doh&quot;</code>, the value of which it is a property. How this works preciselyis described in <a href="chapter8.html">chapter 8</a>.</p><p><a class="paragraph" href="#p43a78e4cbfe94f0f" name="p43a78e4cbfe94f0f"> ¶ </a>Properties that contain functions are generally called <a name="key17"></a>methods, asin '<code>toUpperCase</code> is a method of a string object'.</p><pre class="code"><span class="keyword">var</span><span class="variable">mack</span>=[];<span class="variable">mack</span>.<span class="property">push</span>(<span class="string">&quot;Mack&quot;</span>);<span class="variable">mack</span>.<span class="property">push</span>(<span class="string">&quot;the&quot;</span>);<span class="variable">mack</span>.<span class="property">push</span>(<span class="string">&quot;Knife&quot;</span>);<span class="variable">show</span>(<span class="variable">mack</span>.<span class="property">join</span>(<span class="string">&quot;&quot;</span>));<span class="variable">show</span>(<span class="variable">mack</span>.<span class="property">pop</span>());<span class="variable">show</span>(<span class="variable">mack</span>);</pre><p><a class="paragraph" href="#p78f9e8a5e60b4ac4" name="p78f9e8a5e60b4ac4"> ¶ </a>The method <a name="key18"></a><code>push</code>, which is associated with arrays, can be used toadd values to it. It could have been used in the last exercise, as analternative to <code>result[i]=i</code>. Then there is <a name="key19"></a><code>pop</code>, the opposite of<code>push</code>: it takes off and returns the last value in the array. <a name="key20"></a><code>join</code>builds a single big string from an array of strings. The parameter itis given is pasted between the values in the array.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p3e9601168069b19b" name="p3e9601168069b19b"> ¶ </a>Coming back to those cats, we now know that an array would be a goodway to store the archive of e-mails. On this page, the function<code>retrieveMails</code> can be used to (magically) get hold of this array.Going over them to process them one after another is not rocket scienceanymore either:</p><pre class="code"><span class="keyword">var</span><span class="variable">mailArchive</span>=<span class="variable">retrieveMails</span>();<span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">i</span>=<span class="atom">0</span>;<span class="variable">i</span> &lt;<span class="variable">mailArchive</span>.<span class="property">length</span>;<span class="variable">i</span>++){<span class="keyword">var</span><span class="variable">email</span>=<span class="variable">mailArchive</span>[<span class="variable">i</span>];<span class="variable">print</span>(<span class="string">&quot;Processing e-mail #&quot;</span>, <span class="variable">i</span>);<span class="comment">// Do more things...</span>}</pre><p><a class="paragraph" href="#p217d5ce915c57420" name="p217d5ce915c57420"> ¶ </a>We have also decided on a way to represent the set of cats that arealive. The next problem, then, is to find the paragraphs in an e-mailthat start with <code>&quot;born&quot;</code> or <code>&quot;died&quot;</code>.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p71e3cb0ed700e41a" name="p71e3cb0ed700e41a"> ¶ </a>The first question that comes up is what exactly a paragraph is. Inthis case, the string value itself can't help us much: JavaScript'sconcept of text does not go any deeper than the 'sequence ofcharacters' idea, so we must define paragraphs in those terms.</p><p><a class="paragraph" href="#p67017c07e4cdab3b" name="p67017c07e4cdab3b"> ¶ </a>Earlier, we saw that there is such a thing as a newline character.These are what most people use to split paragraphs. We consider aparagraph, then, to be a part of an e-mail that starts at a newlinecharacter or at the start of the content, and ends at the next newlinecharacter or at the end of the content.</p><p><a class="paragraph" href="#p6f0a818766388399" name="p6f0a818766388399"> ¶ </a>And we don't even have to write the algorithm for splitting a stringinto paragraphs ourselves. Strings already have a method named<a name="key21"></a><code>split</code>, which is (almost) the opposite of the <code>join</code> method ofarrays. It splits a string into an array, using the string given asits argument to determine in which places to cut.</p><pre class="code"><span class="keyword">var</span><span class="variable">words</span>=<span class="string">&quot;Cities of the Interior&quot;</span>;<span class="variable">show</span>(<span class="variable">words</span>.<span class="property">split</span>(<span class="string">&quot;&quot;</span>));</pre><p><a class="paragraph" href="#p75504e71133f9c11" name="p75504e71133f9c11"> ¶ </a>Thus, cutting on newlines (<code>&quot;\n&quot;</code>), can be used to split an e-mailinto paragraphs.</p></div><hr/><div class="block"><a name="exercise3"></a><div class="exercisenum">Ex. 4.3</div><div class="exercise"><p><a class="paragraph" href="#p4049fe84b8fbac8c" name="p4049fe84b8fbac8c"> ¶ </a><code>split</code> and <code>join</code> are not precisely each other's inverse.<code>string.split(x).join(x)</code> always produces the original value, but<code>array.join(x).split(x)</code> does not. Can you give an example of an arraywhere <code>.join(&quot;&quot;).split(&quot;&quot;)</code> produces a different value?</p></div><div class="solution"><pre class="code"><span class="keyword">var</span><span class="variable">array</span>=[<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c d&quot;</span>];<span class="variable">show</span>(<span class="variable">array</span>.<span class="property">join</span>(<span class="string">&quot;&quot;</span>).<span class="property">split</span>(<span class="string">&quot;&quot;</span>));</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p59d1a3239c60a7e6" name="p59d1a3239c60a7e6"> ¶ </a>Paragraphs that do not start with either &quot;born&quot;or &quot;died&quot;can beignored by the program. How do we test whether a string starts with acertain word? The method <a name="key22"></a><code>charAt</code> can be used to get a specificcharacter from a string. <code>x.charAt(0)</code> gives the first character, <code>1</code>is the second one, and so on. One way to check whether a string startswith &quot;born&quot;is:</p><pre class="code"><span class="keyword">var</span><span class="variable">paragraph</span>=<span class="string">&quot;born 15-11-2003 (mother Spot): White Fang&quot;</span>;<span class="variable">show</span>(<span class="variable">paragraph</span>.<span class="property">charAt</span>(<span class="atom">0</span>)==<span class="string">&quot;b&quot;</span> &amp;&amp;<span class="variable">paragraph</span>.<span class="property">charAt</span>(<span class="atom">1</span>)==<span class="string">&quot;o&quot;</span> &amp;&amp;<span class="variable">paragraph</span>.<span class="property">charAt</span>(<span class="atom">2</span>)==<span class="string">&quot;r&quot;</span> &amp;&amp;<span class="variable">paragraph</span>.<span class="property">charAt</span>(<span class="atom">3</span>)==<span class="string">&quot;n&quot;</span>);</pre><p><a class="paragraph" href="#p222f704190a769ff" name="p222f704190a769ff"> ¶ </a>But that gets a bit clumsy ― imagine checking for a word of tencharacters. There is something to be learned here though: when a linegets ridiculously long, it can be spread over multiple lines. Theresult can be made easier to read by lining up the start of the newline with the first element on the original line that plays a similarrole.</p><p><a class="paragraph" href="#p463b2febd9dcb0ff" name="p463b2febd9dcb0ff"> ¶ </a>Strings also have a method called <a name="key23"></a><code>slice</code>. It copies out a piece ofthe string, starting from the character at the position given by thefirst argument, and ending before (not including) the character at theposition given by the second one. This allows the check to be writtenin a shorter way.</p><pre class="code"><span class="variable">show</span>(<span class="variable">paragraph</span>.<span class="property">slice</span>(<span class="atom">0</span>, <span class="atom">4</span>)==<span class="string">&quot;born&quot;</span>);</pre></div><hr/><div class="block"><a name="exercise4"></a><div class="exercisenum">Ex. 4.4</div><div class="exercise"><p><a class="paragraph" href="#p44eb0c2117451fa5" name="p44eb0c2117451fa5"> ¶ </a>Write a function called <code>startsWith</code> that takes two arguments, bothstrings. It returns <code>true</code> when the first argument starts with thecharacters in the second argument, and <code>false</code> otherwise.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">startsWith</span>(<span class="variabledef">string</span>, <span class="variabledef">pattern</span>){<span class="keyword">return</span><span class="localvariable">string</span>.<span class="property">slice</span>(<span class="atom">0</span>, <span class="localvariable">pattern</span>.<span class="property">length</span>)==<span class="localvariable">pattern</span>;}<span class="variable">show</span>(<span class="variable">startsWith</span>(<span class="string">&quot;rotation&quot;</span>, <span class="string">&quot;rot&quot;</span>));</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p7a960e3d6b231017" name="p7a960e3d6b231017"> ¶ </a>What happens when <code>charAt</code> or <code>slice</code> are used to take a piece of astring that does not exist? Will the <code>startsWith</code> I showed still workwhen the pattern is longer than the string it is matched against?</p><pre class="code"><span class="variable">show</span>(<span class="string">&quot;Pip&quot;</span>.<span class="property">charAt</span>(<span class="atom">250</span>));<span class="variable">show</span>(<span class="string">&quot;Nop&quot;</span>.<span class="property">slice</span>(<span class="atom">1</span>, <span class="atom">10</span>));</pre><p><a class="paragraph" href="#p4efb4e9aa94c9fb3" name="p4efb4e9aa94c9fb3"> ¶ </a><code>charAt</code> will return <code>&quot;&quot;</code> when there is no character at the givenposition, and <code>slice</code> will simply leave out the part of the newstring that does not exist.</p><p><a class="paragraph" href="#p6b24782e0b53201d" name="p6b24782e0b53201d"> ¶ </a>So yes, that version of <code>startsWith</code> works. When <code>startsWith(&quot;Idiots&quot;,&quot;Most honoured colleagues&quot;)</code> is called, the call to <code>slice</code> will,because <code>string</code> does not have enough characters, always return astring that is shorter than <code>pattern</code>. Because of that, the comparisonwith <code>==</code> will return <code>false</code>, which is correct.</p><p><a class="paragraph" href="#p6ca9d35fb6e0cf1c" name="p6ca9d35fb6e0cf1c"> ¶ </a>It helps to always take a moment to consider abnormal (but valid)inputs for a program. These are usually called <a name="key24"></a>corner cases, and itis very common for programs that work perfectly on all the 'normal'inputs to screw up on corner cases.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p6f5e0704b3198e32" name="p6f5e0704b3198e32"> ¶ </a>The only part of the cat-problem that is still unsolved is theextraction of names from a paragraph. The algorithm was this:</p><ol><li>Find the colon in the paragraph.</li><li>Take the part after this colon.</li><li>Split this part into separate names by looking for commas.</li></ol><p><a class="paragraph" href="#p13747a447dcf78d9" name="p13747a447dcf78d9"> ¶ </a>This has to happen both for paragraphs that start with <code>&quot;died&quot;</code>, andparagraphs that start with <code>&quot;born&quot;</code>. It would be a good idea to put itinto a function, so that the two pieces of code that handle thesedifferent kinds of paragraphs can both use it.</p></div><hr/><div class="block"><a name="exercise5"></a><div class="exercisenum">Ex. 4.5</div><div class="exercise"><p><a class="paragraph" href="#p582574767c781ba1" name="p582574767c781ba1"> ¶ </a>Can you write a function <code>catNames</code> that takes a paragraph as anargument and returns an array of names?</p><p><a class="paragraph" href="#p3d70e965f76e0906" name="p3d70e965f76e0906"> ¶ </a>Strings have an <a name="key25"></a><code>indexOf</code> method that can be used to find the(first) position of a character or sub-string within that string. Also,when <code>slice</code> is given only one argument, it will return the part ofthe string from the given position all the way to the end.</p><p><a class="paragraph" href="#pb782cd8caeb5db8" name="pb782cd8caeb5db8"> ¶ </a>It can be helpful to use the console to 'explore' functions. Forexample, type <code>&quot;foo: bar&quot;.indexOf(&quot;:&quot;)</code> and see what you get.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">catNames</span>(<span class="variabledef">paragraph</span>){<span class="keyword">var</span><span class="variabledef">colon</span>=<span class="localvariable">paragraph</span>.<span class="property">indexOf</span>(<span class="string">&quot;:&quot;</span>);<span class="keyword">return</span><span class="localvariable">paragraph</span>.<span class="property">slice</span>(<span class="localvariable">colon</span> + <span class="atom">2</span>).<span class="property">split</span>(<span class="string">&quot;, &quot;</span>);}<span class="variable">show</span>(<span class="variable">catNames</span>(<span class="string">&quot;born 20/09/2004 (mother Yellow Bess): &quot;</span> + <span class="string">&quot;Doctor Hobbles the 2nd, Noog&quot;</span>));</pre><p><a class="paragraph" href="#p200fca11a3ac1241" name="p200fca11a3ac1241"> ¶ </a>The tricky part, which the original description of the algorithmignored, is dealing with spaces after the colon and the commas.The <code>+ 2</code> used when slicing the string is needed to leave out thecolon itself and the space after it. The argument to <code>split</code> containsboth a comma and a space, because that is what the names are reallyseparated by, rather than just a comma.</p><p><a class="paragraph" href="#p4c75b2280949cdf6" name="p4c75b2280949cdf6"> ¶ </a>This function does not do any checking for problems. We assume, inthis case, that the input is always correct.</p></div></div><hr/><div class="block"><p><a class="paragraph" href="#p6d6a82a0b28a0847" name="p6d6a82a0b28a0847"> ¶ </a>All that remains now is putting the pieces together. One way to dothat looks like this:</p><pre class="code"><span class="keyword">var</span><span class="variable">mailArchive</span>=<span class="variable">retrieveMails</span>();<span class="keyword">var</span><span class="variable">livingCats</span>={<span class="string">&quot;Spot&quot;</span>: <span class="atom">true</span>};<span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">mail</span>=<span class="atom">0</span>;<span class="variable">mail</span> &lt;<span class="variable">mailArchive</span>.<span class="property">length</span>;<span class="variable">mail</span>++){<span class="keyword">var</span><span class="variable">paragraphs</span>=<span class="variable">mailArchive</span>[<span class="variable">mail</span>].<span class="property">split</span>(<span class="string">&quot;\n&quot;</span>);<span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">paragraph</span>=<span class="atom">0</span>;<span class="variable">paragraph</span> &lt;<span class="variable">paragraphs</span>.<span class="property">length</span>;<span class="variable">paragraph</span>++){<span class="keyword">if</span> (<span class="variable">startsWith</span>(<span class="variable">paragraphs</span>[<span class="variable">paragraph</span>], <span class="string">&quot;born&quot;</span>)){<span class="keyword">var</span><span class="variable">names</span>=<span class="variable">catNames</span>(<span class="variable">paragraphs</span>[<span class="variable">paragraph</span>]);<span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">name</span>=<span class="atom">0</span>;<span class="variable">name</span> &lt;<span class="variable">names</span>.<span class="property">length</span>;<span class="variable">name</span>++) <span class="variable">livingCats</span>[<span class="variable">names</span>[<span class="variable">name</span>]]=<span class="atom">true</span>;}<span class="keyword">else</span><span class="keyword">if</span> (<span class="variable">startsWith</span>(<span class="variable">paragraphs</span>[<span class="variable">paragraph</span>], <span class="string">&quot;died&quot;</span>)){<span class="keyword">var</span><span class="variable">names</span>=<span class="variable">catNames</span>(<span class="variable">paragraphs</span>[<span class="variable">paragraph</span>]);<span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">name</span>=<span class="atom">0</span>;<span class="variable">name</span> &lt;<span class="variable">names</span>.<span class="property">length</span>;<span class="variable">name</span>++) <span class="keyword">delete</span><span class="variable">livingCats</span>[<span class="variable">names</span>[<span class="variable">name</span>]];}}}<span class="variable">show</span>(<span class="variable">livingCats</span>);</pre><p><a class="paragraph" href="#p4d35b993acbc1dd8" name="p4d35b993acbc1dd8"> ¶ </a>That is quite a big dense chunk of code. We'll look into making it abit lighter in a moment. But first let us look at our results. We knowhow to check whether a specific cat survives:</p><pre class="code"><span class="keyword">if</span> (<span class="string">&quot;Spot&quot;</span> in <span class="variable">livingCats</span>) <span class="variable">print</span>(<span class="string">&quot;Spot lives!&quot;</span>);<span class="keyword">else</span><span class="variable">print</span>(<span class="string">&quot;Good old Spot, may she rest in peace.&quot;</span>);</pre><p><a class="paragraph" href="#p4453cb8513584d0d" name="p4453cb8513584d0d"> ¶ </a>But how do we list all the cats that are alive? The <a name="key26"></a><code>in</code> keyword hasa somewhat different meaning when it is used together with <code>for</code>:</p><pre class="code"><span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">cat</span><span class="keyword">in</span><span class="variable">livingCats</span>) <span class="variable">print</span>(<span class="variable">cat</span>);</pre><p><a class="paragraph" href="#p2c5cb96013184931" name="p2c5cb96013184931"> ¶ </a>A loop like that will go over the names of the properties in anobject, which allows us to enumerate all the names in our set.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p3a76bee6b1c1b27c" name="p3a76bee6b1c1b27c"> ¶ </a>Some pieces of code look like an impenetrable jungle. The examplesolution to the cat problem suffers from this. One way to make somelight shine through it is to just add some strategic blank lines. Thismakes it look better, but doesn't really solve the problem.</p><p><a class="paragraph" href="#p79acc3d63f2626f6" name="p79acc3d63f2626f6"> ¶ </a>What is needed here is to break the code up. We already wrote twohelper functions, <code>startsWith</code> and <code>catNames</code>, which both take care ofa small, understandable part of the problem. Let us continue doingthis.</p><pre class="code"><span class="keyword">function</span><span class="variable">addToSet</span>(<span class="variabledef">set</span>, <span class="variabledef">values</span>){<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">i</span>=<span class="atom">0</span>;<span class="localvariable">i</span> &lt;<span class="localvariable">values</span>.<span class="property">length</span>;<span class="localvariable">i</span>++) <span class="localvariable">set</span>[<span class="localvariable">values</span>[<span class="localvariable">i</span>]]=<span class="atom">true</span>;}<span class="keyword">function</span><span class="variable">removeFromSet</span>(<span class="variabledef">set</span>, <span class="variabledef">values</span>){<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">i</span>=<span class="atom">0</span>;<span class="localvariable">i</span> &lt;<span class="localvariable">values</span>.<span class="property">length</span>;<span class="localvariable">i</span>++) <span class="keyword">delete</span><span class="localvariable">set</span>[<span class="localvariable">values</span>[<span class="localvariable">i</span>]];}</pre><p><a class="paragraph" href="#p4954367c9f5eda1a" name="p4954367c9f5eda1a"> ¶ </a>These two functions take care of the adding and removing of names fromthe set. That already cuts out the two most inner loops from thesolution:</p><pre class="code"><span class="keyword">var</span><span class="variable">livingCats</span>={<span class="property">Spot</span>: <span class="atom">true</span>};<span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">mail</span>=<span class="atom">0</span>;<span class="variable">mail</span> &lt;<span class="variable">mailArchive</span>.<span class="property">length</span>;<span class="variable">mail</span>++){<span class="keyword">var</span><span class="variable">paragraphs</span>=<span class="variable">mailArchive</span>[<span class="variable">mail</span>].<span class="property">split</span>(<span class="string">&quot;\n&quot;</span>);<span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">paragraph</span>=<span class="atom">0</span>;<span class="variable">paragraph</span> &lt;<span class="variable">paragraphs</span>.<span class="property">length</span>;<span class="variable">paragraph</span>++){<span class="keyword">if</span> (<span class="variable">startsWith</span>(<span class="variable">paragraphs</span>[<span class="variable">paragraph</span>], <span class="string">&quot;born&quot;</span>)) <span class="variable">addToSet</span>(<span class="variable">livingCats</span>, <span class="variable">catNames</span>(<span class="variable">paragraphs</span>[<span class="variable">paragraph</span>]));<span class="keyword">else</span><span class="keyword">if</span> (<span class="variable">startsWith</span>(<span class="variable">paragraphs</span>[<span class="variable">paragraph</span>], <span class="string">&quot;died&quot;</span>)) <span class="variable">removeFromSet</span>(<span class="variable">livingCats</span>, <span class="variable">catNames</span>(<span class="variable">paragraphs</span>[<span class="variable">paragraph</span>]));}}</pre><p><a class="paragraph" href="#p707956d48832422b" name="p707956d48832422b"> ¶ </a>Quite an improvement, if I may say so myself.</p><p><a class="paragraph" href="#p79b79974ad51c8ae" name="p79b79974ad51c8ae"> ¶ </a>Why do <code>addToSet</code> and <code>removeFromSet</code> take the set as an argument?They could use the variable <code>livingCats</code> directly, if they wanted to.The reason is that this way they are not completely tied to ourcurrent problem. If <code>addToSet</code> directly changed <code>livingCats</code>, it wouldhave to be called <code>addCatsToCatSet</code>, or something similar. The way itis now, it is a more generally useful tool.</p><p><a class="paragraph" href="#pcf887f065caa752" name="pcf887f065caa752"> ¶ </a>Even if we are never going to use these functions for anything else,which is quite probable, it is useful to write them like this. Becausethey are 'self sufficient', they can be read and understood on theirown, without needing to know about some external variable called<code>livingCats</code>.</p><p><a class="paragraph" href="#p7f96a36fb45208f7" name="p7f96a36fb45208f7"> ¶ </a>The functions are not pure: They change the object passed as their<code>set</code> argument. This makes them slightly trickier than real purefunctions, but still a lot less confusing than functions that run amokand change any value or variable they please.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p4215ba8a538a2c0b" name="p4215ba8a538a2c0b"> ¶ </a>We continue breaking the algorithm into pieces:</p><pre class="code"><span class="keyword">function</span><span class="variable">findLivingCats</span>(){<span class="keyword">var</span><span class="variabledef">mailArchive</span>=<span class="variable">retrieveMails</span>();<span class="keyword">var</span><span class="variabledef">livingCats</span>={<span class="string">&quot;Spot&quot;</span>: <span class="atom">true</span>};<span class="keyword">function</span><span class="variabledef">handleParagraph</span>(<span class="variabledef">paragraph</span>){<span class="keyword">if</span> (<span class="variable">startsWith</span>(<span class="localvariable">paragraph</span>, <span class="string">&quot;born&quot;</span>)) <span class="variable">addToSet</span>(<span class="localvariable">livingCats</span>, <span class="variable">catNames</span>(<span class="localvariable">paragraph</span>));<span class="keyword">else</span><span class="keyword">if</span> (<span class="variable">startsWith</span>(<span class="localvariable">paragraph</span>, <span class="string">&quot;died&quot;</span>)) <span class="variable">removeFromSet</span>(<span class="localvariable">livingCats</span>, <span class="variable">catNames</span>(<span class="localvariable">paragraph</span>));}<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">mail</span>=<span class="atom">0</span>;<span class="localvariable">mail</span> &lt;<span class="localvariable">mailArchive</span>.<span class="property">length</span>;<span class="localvariable">mail</span>++){<span class="keyword">var</span><span class="variabledef">paragraphs</span>=<span class="localvariable">mailArchive</span>[<span class="localvariable">mail</span>].<span class="property">split</span>(<span class="string">&quot;\n&quot;</span>);<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">i</span>=<span class="atom">0</span>;<span class="localvariable">i</span> &lt;<span class="localvariable">paragraphs</span>.<span class="property">length</span>;<span class="localvariable">i</span>++) <span class="localvariable">handleParagraph</span>(<span class="localvariable">paragraphs</span>[<span class="localvariable">i</span>]);}<span class="keyword">return</span><span class="localvariable">livingCats</span>;}<span class="keyword">var</span><span class="variable">howMany</span>=<span class="atom">0</span>;<span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">cat</span><span class="keyword">in</span><span class="variable">findLivingCats</span>()) <span class="variable">howMany</span>++;<span class="variable">print</span>(<span class="string">&quot;There are &quot;</span>, <span class="variable">howMany</span>, <span class="string">&quot;cats.&quot;</span>);</pre><p><a class="paragraph" href="#p3dae279b6f62cc0f" name="p3dae279b6f62cc0f"> ¶ </a>The whole algorithm is now encapsulated by a function. This means thatit does not leave a mess after it runs: <code>livingCats</code> is now a localvariable in the function, instead of a top-level one, so it onlyexists while the function runs. The code that needs this set can call<code>findLivingCats</code> and use the value it returns.</p><p><a class="paragraph" href="#p68353a56b1f8d562" name="p68353a56b1f8d562"> ¶ </a>It seemed to me that making <code>handleParagraph</code> a separate function alsocleared things up. But this one is so closely tied to thecat-algorithm that it is meaningless in any other situation. On top ofthat, it needs access to the <code>livingCats</code> variable. Thus, it is aperfect candidate to be a function-inside-a-function. When it livesinside <code>findLivingCats</code>, it is clear that it is only relevant there,and it has access to the variables of its parent function.</p><p><a class="paragraph" href="#p6c1eba78ad0b2665" name="p6c1eba78ad0b2665"> ¶ </a>This solution is actually <em>bigger</em> than the previous one. Still, it istidier and I hope you'll agree that it is easier to read.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p28893aeb55b4a635" name="p28893aeb55b4a635"> ¶ </a>The program still ignores a lot of the information that is containedin the e-mails. There are birth-dates, dates of death, and the namesof mothers in there.</p><p><a class="paragraph" href="#p72f03ac49aec1af" name="p72f03ac49aec1af"> ¶ </a>To start with the dates: What would be a good way to store a date? Wecould make an object with three properties, <code>year</code>, <code>month</code>, and<code>day</code>, and store numbers in them.</p><pre class="code"><span class="keyword">var</span><span class="variable">when</span>={<span class="property">year</span>: <span class="atom">1980</span>, <span class="property">month</span>: <span class="atom">2</span>, <span class="property">day</span>: <span class="atom">1</span>};</pre><p><a class="paragraph" href="#p589c2140a9195d5d" name="p589c2140a9195d5d"> ¶ </a>But JavaScript already provides a kind of object for this purpose.Such an object can be created by using the keyword <a name="key27"></a><code>new</code>:</p><pre class="code"><span class="keyword">var</span><span class="variable">when</span>=<span class="keyword">new</span><span class="variable">Date</span>(<span class="atom">1980</span>, <span class="atom">1</span>, <span class="atom">1</span>);<span class="variable">show</span>(<span class="variable">when</span>);</pre><p><a class="paragraph" href="#p63649032fd757eea" name="p63649032fd757eea"> ¶ </a>Just like the notation with braces and colons we have alreadyseen, <code>new</code> is a way to create object values. Instead of specifyingall the property names and values, a function is used to build up theobject. This makes it possible to define a kind of standard procedurefor creating objects. Functions like this are called <a name="key28"></a>constructors,and in <a href="chapter8.html">chapter 8</a> we will see how to write them.</p><p><a class="paragraph" href="#pd46a19fe682dcf9" name="pd46a19fe682dcf9"> ¶ </a>The <a name="key29"></a><code>Date</code> constructor can be used in different ways.</p><pre class="code"><span class="variable">show</span>(<span class="keyword">new</span><span class="variable">Date</span>());<span class="variable">show</span>(<span class="keyword">new</span><span class="variable">Date</span>(<span class="atom">1980</span>, <span class="atom">1</span>, <span class="atom">1</span>));<span class="variable">show</span>(<span class="keyword">new</span><span class="variable">Date</span>(<span class="atom">2007</span>, <span class="atom">2</span>, <span class="atom">30</span>, <span class="atom">8</span>, <span class="atom">20</span>, <span class="atom">30</span>));</pre><p><a class="paragraph" href="#p4ecedb91cc67fbd2" name="p4ecedb91cc67fbd2"> ¶ </a>As you can see, these objects can store a time of day as well as adate. When not given any arguments, an object representing the currenttime and date is created. Arguments can be given to ask for a specificdate and time. The order of the arguments is year, month, day, hour,minute, second, milliseconds. These last four are optional, theybecome 0 when not given.</p><p><a class="paragraph" href="#p7616478b4c1deb97" name="p7616478b4c1deb97"> ¶ </a>The month numbers these objects use go from 0 to 11, which can beconfusing. Especially since day numbers <em>do</em> start from 1.</p></div><hr/><div class="block"><p><a class="paragraph" href="#pd9326f8cf70c31c" name="pd9326f8cf70c31c"> ¶ </a>The content of a <code>Date</code> object can be inspected with a number of<code>get...</code> methods.</p><pre class="code"><span class="keyword">var</span><span class="variable">today</span>=<span class="keyword">new</span><span class="variable">Date</span>();<span class="variable">print</span>(<span class="string">&quot;Year: &quot;</span>, <span class="variable">today</span>.<span class="property">getFullYear</span>(), <span class="string">&quot;, month: &quot;</span>, <span class="variable">today</span>.<span class="property">getMonth</span>(), <span class="string">&quot;, day: &quot;</span>, <span class="variable">today</span>.<span class="property">getDate</span>());<span class="variable">print</span>(<span class="string">&quot;Hour: &quot;</span>, <span class="variable">today</span>.<span class="property">getHours</span>(), <span class="string">&quot;, minutes: &quot;</span>, <span class="variable">today</span>.<span class="property">getMinutes</span>(), <span class="string">&quot;, seconds: &quot;</span>, <span class="variable">today</span>.<span class="property">getSeconds</span>());<span class="variable">print</span>(<span class="string">&quot;Day of week: &quot;</span>, <span class="variable">today</span>.<span class="property">getDay</span>());</pre><p><a class="paragraph" href="#p6247902a24924a7" name="p6247902a24924a7"> ¶ </a>All of these, except for <code>getDay</code>, also have a <code>set...</code> variant thatcan be used to change the value of the date object.</p><p><a class="paragraph" href="#p592bddf4ad4a7dd5" name="p592bddf4ad4a7dd5"> ¶ </a>Inside the object, a date is represented by the amount of millisecondsit is away from January 1st 1970. You can imagine this is quite alarge number.</p><pre class="code"><span class="keyword">var</span><span class="variable">today</span>=<span class="keyword">new</span><span class="variable">Date</span>();<span class="variable">show</span>(<span class="variable">today</span>.<span class="property">getTime</span>());</pre><p><a class="paragraph" href="#p2bbd7e384781286e" name="p2bbd7e384781286e"> ¶ </a>A very useful thing to do with dates is comparing them.</p><pre class="code"><span class="keyword">var</span><span class="variable">wallFall</span>=<span class="keyword">new</span><span class="variable">Date</span>(<span class="atom">1989</span>, <span class="atom">10</span>, <span class="atom">9</span>);<span class="keyword">var</span><span class="variable">gulfWarOne</span>=<span class="keyword">new</span><span class="variable">Date</span>(<span class="atom">1990</span>, <span class="atom">6</span>, <span class="atom">2</span>);<span class="variable">show</span>(<span class="variable">wallFall</span> &lt;<span class="variable">gulfWarOne</span>);<span class="variable">show</span>(<span class="variable">wallFall</span>==<span class="variable">wallFall</span>);<span class="comment">// but</span><span class="variable">show</span>(<span class="variable">wallFall</span>==<span class="keyword">new</span><span class="variable">Date</span>(<span class="atom">1989</span>, <span class="atom">10</span>, <span class="atom">9</span>));</pre><p><a class="paragraph" href="#p19255137ba410999" name="p19255137ba410999"> ¶ </a>Comparing dates with <code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code>, and <code>&gt;=</code> does exactly what youwould expect. When a date object is compared to itself with <code>==</code> theresult is <code>true</code>, which is also good. But when <a name="key30"></a><code>==</code> is used tocompare a date object to a different, equal date object, we get<code>false</code>. Huh?</p><p><a class="paragraph" href="#p3948ccce640dd7f8" name="p3948ccce640dd7f8"> ¶ </a>As mentioned earlier, <code>==</code> will return <code>false</code> when comparing twodifferent objects, even if they contain the same properties. This is abit clumsy and error-prone here, since one would expect <code>&gt;=</code> and <code>==</code>to behave in a more or less similar way. Testing whether two dates areequal can be done like this:</p><pre class="code"><span class="keyword">var</span><span class="variable">wallFall1</span>=<span class="keyword">new</span><span class="variable">Date</span>(<span class="atom">1989</span>, <span class="atom">10</span>, <span class="atom">9</span>), <span class="variable">wallFall2</span>=<span class="keyword">new</span><span class="variable">Date</span>(<span class="atom">1989</span>, <span class="atom">10</span>, <span class="atom">9</span>);<span class="variable">show</span>(<span class="variable">wallFall1</span>.<span class="property">getTime</span>()==<span class="variable">wallFall2</span>.<span class="property">getTime</span>());</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p1f17c7dc7bee5aeb" name="p1f17c7dc7bee5aeb"> ¶ </a>In addition to a date and time, <code>Date</code> objects also containinformation about a <a name="key31"></a>timezone. When it is one o'clock in Amsterdam,it can, depending on the time of year, be noon in London, and seven inthe morning in New York. Such times can only be compared when you taketheir time zones into account. The <a name="key32"></a><code>getTimezoneOffset</code> function of a<code>Date</code> can be used to find out how many minutes it differs from GMT(Greenwich Mean Time).</p><pre class="code"><span class="keyword">var</span><span class="variable">now</span>=<span class="keyword">new</span><span class="variable">Date</span>();<span class="variable">print</span>(<span class="variable">now</span>.<span class="property">getTimezoneOffset</span>());</pre></div><hr/><div class="block"><a name="exercise6"></a><div class="exercisenum">Ex. 4.6</div><div class="exercise"><pre class="preformatted">&quot;died 27/04/2006: Black Leclère&quot;</pre><p><a class="paragraph" href="#pb1d0ff442ec8e6f" name="pb1d0ff442ec8e6f"> ¶ </a>The date part is always in the exact same place of a paragraph. Howconvenient. Write a function <code>extractDate</code> that takes such a paragraphas its argument, extracts the date, and returns it as a date object.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">extractDate</span>(<span class="variabledef">paragraph</span>){<span class="keyword">function</span><span class="variabledef">numberAt</span>(<span class="variabledef">start</span>, <span class="variabledef">length</span>){<span class="keyword">return</span><span class="variable">Number</span>(<span class="localvariable">paragraph</span>.<span class="property">slice</span>(<span class="localvariable">start</span>, <span class="localvariable">start</span> + <span class="localvariable">length</span>));}<span class="keyword">return</span><span class="keyword">new</span><span class="variable">Date</span>(<span class="localvariable">numberAt</span>(<span class="atom">11</span>, <span class="atom">4</span>), <span class="localvariable">numberAt</span>(<span class="atom">8</span>, <span class="atom">2</span>) - <span class="atom">1</span>, <span class="localvariable">numberAt</span>(<span class="atom">5</span>, <span class="atom">2</span>));}<span class="variable">show</span>(<span class="variable">extractDate</span>(<span class="string">&quot;died 27-04-2006: Black Leclère&quot;</span>));</pre><p><a class="paragraph" href="#p69f81ed7e3e5af4b" name="p69f81ed7e3e5af4b"> ¶ </a>It would work without the calls to <code>Number</code>, but as mentioned earlier,I prefer not to use strings as if they are numbers. The inner functionwas introduced to prevent having to repeat the <code>Number</code> and <code>slice</code>part three times.</p><p><a class="paragraph" href="#p17a75abbb24156d6" name="p17a75abbb24156d6"> ¶ </a>Note the <code>- 1</code> for the month number. Like most people, Aunt Emilycounts her months from 1, so we have to adjust the value before givingit to the <code>Date</code> constructor. (The day number does not have thisproblem, since <code>Date</code> objects count days in the usual human way.)</p><p><a class="paragraph" href="#p78edee83ce3ee883" name="p78edee83ce3ee883"> ¶ </a>In <a href="chapter10.html">chapter 10</a> we will see a more practical and robust way of extractingpieces from strings that have a fixed structure.</p></div></div><hr/><div class="block"><p><a class="paragraph" href="#p6231188669290e08" name="p6231188669290e08"> ¶ </a>Storing cats will work differently from now on. Instead of justputting the value <code>true</code> into the set, we store an object withinformation about the cat. When a cat dies, we do not remove it fromthe set, we just add a property <code>death</code> to the object to store thedate on which the creature died.</p><p><a class="paragraph" href="#p5e80cffb16b8822b" name="p5e80cffb16b8822b"> ¶ </a>This means our <code>addToSet</code> and <code>removeFromSet</code> functions have becomeuseless. Something similar is needed, but it must also storebirth-dates and, later, the mother's name.</p><pre class="code"><span class="keyword">function</span><span class="variable">catRecord</span>(<span class="variabledef">name</span>, <span class="variabledef">birthdate</span>, <span class="variabledef">mother</span>){<span class="keyword">return</span>{<span class="property">name</span>: <span class="localvariable">name</span>, <span class="property">birth</span>: <span class="localvariable">birthdate</span>, <span class="property">mother</span>: <span class="localvariable">mother</span>};}<span class="keyword">function</span><span class="variable">addCats</span>(<span class="variabledef">set</span>, <span class="variabledef">names</span>, <span class="variabledef">birthdate</span>, <span class="variabledef">mother</span>){<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">i</span>=<span class="atom">0</span>;<span class="localvariable">i</span> &lt;<span class="localvariable">names</span>.<span class="property">length</span>;<span class="localvariable">i</span>++) <span class="localvariable">set</span>[<span class="localvariable">names</span>[<span class="localvariable">i</span>]]=<span class="variable">catRecord</span>(<span class="localvariable">names</span>[<span class="localvariable">i</span>], <span class="localvariable">birthdate</span>, <span class="localvariable">mother</span>);}<span class="keyword">function</span><span class="variable">deadCats</span>(<span class="variabledef">set</span>, <span class="variabledef">names</span>, <span class="variabledef">deathdate</span>){<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">i</span>=<span class="atom">0</span>;<span class="localvariable">i</span> &lt;<span class="localvariable">names</span>.<span class="property">length</span>;<span class="localvariable">i</span>++) <span class="localvariable">set</span>[<span class="localvariable">names</span>[<span class="localvariable">i</span>]].<span class="property">death</span>=<span class="localvariable">deathdate</span>;}</pre><p><a class="paragraph" href="#p6faa980ecfae9cd0" name="p6faa980ecfae9cd0"> ¶ </a><code>catRecord</code> is a separate function for creating these storage objects.It might be useful in other situations, such as creating the objectfor Spot. 'Record' is a term often used for objects like this, whichare used to group a limited number of values.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p8813bf1acd966d7" name="p8813bf1acd966d7"> ¶ </a>So let us try to extract the names of the mother cats from theparagraphs.</p><pre class="preformatted">&quot;born 15/11/2003 (mother Spot): White Fang&quot;</pre><p><a class="paragraph" href="#p7d8bd57ae8eb1851" name="p7d8bd57ae8eb1851"> ¶ </a>One way to do this would be...</p><pre class="code"><span class="keyword">function</span><span class="variable">extractMother</span>(<span class="variabledef">paragraph</span>){<span class="keyword">var</span><span class="variabledef">start</span>=<span class="localvariable">paragraph</span>.<span class="property">indexOf</span>(<span class="string">&quot;(mother &quot;</span>) + <span class="string">&quot;(mother &quot;</span>.<span class="property">length</span>;<span class="keyword">var</span><span class="variabledef">end</span>=<span class="localvariable">paragraph</span>.<span class="property">indexOf</span>(<span class="string">&quot;)&quot;</span>);<span class="keyword">return</span><span class="localvariable">paragraph</span>.<span class="property">slice</span>(<span class="localvariable">start</span>, <span class="localvariable">end</span>);}<span class="variable">show</span>(<span class="variable">extractMother</span>(<span class="string">&quot;born 15/11/2003 (mother Spot): White Fang&quot;</span>));</pre><p><a class="paragraph" href="#p5e1cda67dde3c884" name="p5e1cda67dde3c884"> ¶ </a>Notice how the start position has to be adjusted for the length of<code>&quot;(mother &quot;</code>, because <code>indexOf</code> returns the position of the start ofthe pattern, not its end.</p></div><hr/><div class="block"><a name="exercise7"></a><div class="exercisenum">Ex. 4.7</div><div class="exercise"><p><a class="paragraph" href="#pd8b2deab1823547" name="pd8b2deab1823547"> ¶ </a>The thing that <code>extractMother</code> does can be expressed in a more generalway. Write a function <code>between</code> that takes three arguments, all ofwhich are strings. It will return the part of the first argument thatoccurs between the patterns given by the second and the thirdarguments.</p><p><a class="paragraph" href="#p10683394354b9d86" name="p10683394354b9d86"> ¶ </a>So <code>between(&quot;born 15/11/2003 (mother Spot): White Fang&quot;, &quot;(mother &quot;,&quot;)&quot;)</code> gives <code>&quot;Spot&quot;</code>.</p><p><a class="paragraph" href="#p2b71a5af1756297e" name="p2b71a5af1756297e"> ¶ </a><code>between(&quot;bu] boo [ bah] gzz&quot;, &quot;[ &quot;, &quot;]&quot;)</code> returns <code>&quot;bah&quot;</code>.</p><p><a class="paragraph" href="#p51f662968c8adaa7" name="p51f662968c8adaa7"> ¶ </a>To make that second test work, it can be useful to know that <code>indexOf</code>can be given a second, optional parameter that specifies at whichpoint it should start searching.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">between</span>(<span class="variabledef">string</span>, <span class="variabledef">start</span>, <span class="variabledef">end</span>){<span class="keyword">var</span><span class="variabledef">startAt</span>=<span class="localvariable">string</span>.<span class="property">indexOf</span>(<span class="localvariable">start</span>) + <span class="localvariable">start</span>.<span class="property">length</span>;<span class="keyword">var</span><span class="variabledef">endAt</span>=<span class="localvariable">string</span>.<span class="property">indexOf</span>(<span class="localvariable">end</span>, <span class="localvariable">startAt</span>);<span class="keyword">return</span><span class="localvariable">string</span>.<span class="property">slice</span>(<span class="localvariable">startAt</span>, <span class="localvariable">endAt</span>);}<span class="variable">show</span>(<span class="variable">between</span>(<span class="string">&quot;bu] boo [ bah] gzz&quot;</span>, <span class="string">&quot;[ &quot;</span>, <span class="string">&quot;]&quot;</span>));</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p4064448f6a557c9c" name="p4064448f6a557c9c"> ¶ </a>Having <code>between</code> makes it possible to express extractMother in asimpler way:</p><pre class="code"><span class="keyword">function</span><span class="variable">extractMother</span>(<span class="variabledef">paragraph</span>){<span class="keyword">return</span><span class="variable">between</span>(<span class="localvariable">paragraph</span>, <span class="string">&quot;(mother &quot;</span>, <span class="string">&quot;)&quot;</span>);}</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p50633f100de91e0" name="p50633f100de91e0"> ¶ </a>The new, improved cat-algorithm looks like this:</p><pre class="code"><span class="keyword">function</span><span class="variable">findCats</span>(){<span class="keyword">var</span><span class="variabledef">mailArchive</span>=<span class="variable">retrieveMails</span>();<span class="keyword">var</span><span class="variabledef">cats</span>={<span class="string">&quot;Spot&quot;</span>: <span class="variable">catRecord</span>(<span class="string">&quot;Spot&quot;</span>, <span class="keyword">new</span><span class="variable">Date</span>(<span class="atom">1997</span>, <span class="atom">2</span>, <span class="atom">5</span>), <span class="string">&quot;unknown&quot;</span>)};<span class="keyword">function</span><span class="variabledef">handleParagraph</span>(<span class="variabledef">paragraph</span>){<span class="keyword">if</span> (<span class="variable">startsWith</span>(<span class="localvariable">paragraph</span>, <span class="string">&quot;born&quot;</span>)) <span class="variable">addCats</span>(<span class="localvariable">cats</span>, <span class="variable">catNames</span>(<span class="localvariable">paragraph</span>), <span class="variable">extractDate</span>(<span class="localvariable">paragraph</span>), <span class="variable">extractMother</span>(<span class="localvariable">paragraph</span>));<span class="keyword">else</span><span class="keyword">if</span> (<span class="variable">startsWith</span>(<span class="localvariable">paragraph</span>, <span class="string">&quot;died&quot;</span>)) <span class="variable">deadCats</span>(<span class="localvariable">cats</span>, <span class="variable">catNames</span>(<span class="localvariable">paragraph</span>), <span class="variable">extractDate</span>(<span class="localvariable">paragraph</span>));}<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">mail</span>=<span class="atom">0</span>;<span class="localvariable">mail</span> &lt;<span class="localvariable">mailArchive</span>.<span class="property">length</span>;<span class="localvariable">mail</span>++){<span class="keyword">var</span><span class="variabledef">paragraphs</span>=<span class="localvariable">mailArchive</span>[<span class="localvariable">mail</span>].<span class="property">split</span>(<span class="string">&quot;\n&quot;</span>);<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">i</span>=<span class="atom">0</span>;<span class="localvariable">i</span> &lt;<span class="localvariable">paragraphs</span>.<span class="property">length</span>;<span class="localvariable">i</span>++) <span class="localvariable">handleParagraph</span>(<span class="localvariable">paragraphs</span>[<span class="localvariable">i</span>]);}<span class="keyword">return</span><span class="localvariable">cats</span>;}<span class="keyword">var</span><span class="variable">catData</span>=<span class="variable">findCats</span>();</pre><p><a class="paragraph" href="#p64c74e3df6edee0b" name="p64c74e3df6edee0b"> ¶ </a>Having that extra data allows us to finally have a clue about the catsaunt Emily talks about. A function like this could be useful:</p><pre class="code"><span class="keyword">function</span><span class="variable">formatDate</span>(<span class="variabledef">date</span>){<span class="keyword">return</span><span class="localvariable">date</span>.<span class="property">getDate</span>() + <span class="string">&quot;/&quot;</span> + (<span class="localvariable">date</span>.<span class="property">getMonth</span>() + <span class="atom">1</span>) + <span class="string">&quot;/&quot;</span> + <span class="localvariable">date</span>.<span class="property">getFullYear</span>();}<span class="keyword">function</span><span class="variable">catInfo</span>(<span class="variabledef">data</span>, <span class="variabledef">name</span>){<span class="keyword">if</span> (!(<span class="localvariable">name</span> in <span class="localvariable">data</span>)) <span class="keyword">return</span><span class="string">&quot;No cat by the name of &quot;</span> + <span class="localvariable">name</span> + <span class="string">&quot;is known.&quot;</span>;<span class="keyword">var</span><span class="variabledef">cat</span>=<span class="localvariable">data</span>[<span class="localvariable">name</span>];<span class="keyword">var</span><span class="variabledef">message</span>=<span class="localvariable">name</span> + <span class="string">&quot;, born &quot;</span> + <span class="variable">formatDate</span>(<span class="localvariable">cat</span>.<span class="property">birth</span>) + <span class="string">&quot;from mother &quot;</span> + <span class="localvariable">cat</span>.<span class="property">mother</span>;<span class="keyword">if</span> (<span class="string">&quot;death&quot;</span> in <span class="localvariable">cat</span>) <span class="localvariable">message</span> +=<span class="string">&quot;, died &quot;</span> + <span class="variable">formatDate</span>(<span class="localvariable">cat</span>.<span class="property">death</span>);<span class="keyword">return</span><span class="localvariable">message</span> + <span class="string">&quot;.&quot;</span>;}<span class="variable">print</span>(<span class="variable">catInfo</span>(<span class="variable">catData</span>, <span class="string">&quot;Fat Igor&quot;</span>));</pre><p><a class="paragraph" href="#p744754e286e636d9" name="p744754e286e636d9"> ¶ </a>The first <code>return</code> statement in <code>catInfo</code> is used as an escape hatch.If there is no data about the given cat, the rest of the function ismeaningless, so we immediately return a value, which prevents the restof the code from running.</p><p><a class="paragraph" href="#p65a8337e1b1950af" name="p65a8337e1b1950af"> ¶ </a>In the past, certain groups of programmers considered functions thatcontain multiple <code>return</code> statements sinful. The idea was that thismade it hard to see which code was executed and which code was not.Other techniques, which will be discussed in <a href="chapter5.html">chapter 5</a>, have made thereasons behind this idea more or less obsolete, but you might stilloccasionally come across someone who will criticise the use of'shortcut' return statements.</p></div><hr/><div class="block"><a name="exercise8"></a><div class="exercisenum">Ex. 4.8</div><div class="exercise"><p><a class="paragraph" href="#p4a0ed3bb5d1716e3" name="p4a0ed3bb5d1716e3"> ¶ </a>The <code>formatDate</code> function used by <code>catInfo</code> does not add a zero beforethe month and the day part when these are only one digit long. Write anew version that does this.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">formatDate</span>(<span class="variabledef">date</span>){<span class="keyword">function</span><span class="variabledef">pad</span>(<span class="variabledef">number</span>){<span class="keyword">if</span> (<span class="localvariable">number</span> &lt;<span class="atom">10</span>) <span class="keyword">return</span><span class="string">&quot;0&quot;</span> + <span class="localvariable">number</span>;<span class="keyword">else</span><span class="keyword">return</span><span class="localvariable">number</span>;}<span class="keyword">return</span><span class="localvariable">pad</span>(<span class="localvariable">date</span>.<span class="property">getDate</span>()) + <span class="string">&quot;/&quot;</span> + <span class="localvariable">pad</span>(<span class="localvariable">date</span>.<span class="property">getMonth</span>() + <span class="atom">1</span>) + <span class="string">&quot;/&quot;</span> + <span class="localvariable">date</span>.<span class="property">getFullYear</span>();}<span class="variable">print</span>(<span class="variable">formatDate</span>(<span class="keyword">new</span><span class="variable">Date</span>(<span class="atom">2000</span>, <span class="atom">0</span>, <span class="atom">1</span>)));</pre></div></div><hr/><div class="block"><a name="exercise9"></a><div class="exercisenum">Ex. 4.9</div><div class="exercise"><p><a class="paragraph" href="#pb4c5eaeeba870f0" name="pb4c5eaeeba870f0"> ¶ </a>Write a function <code>oldestCat</code> which, given an object containing cats asits argument, returns the name of the oldest living cat.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">oldestCat</span>(<span class="variabledef">data</span>){<span class="keyword">var</span><span class="variabledef">oldest</span>=<span class="atom">null</span>;<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">name</span><span class="keyword">in</span><span class="localvariable">data</span>){<span class="keyword">var</span><span class="variabledef">cat</span>=<span class="localvariable">data</span>[<span class="localvariable">name</span>];<span class="keyword">if</span> (!(<span class="string">&quot;death&quot;</span> in <span class="localvariable">cat</span>) &amp;&amp;(<span class="localvariable">oldest</span>==<span class="atom">null</span> || <span class="localvariable">oldest</span>.<span class="property">birth</span> &gt;<span class="localvariable">cat</span>.<span class="property">birth</span>)) <span class="localvariable">oldest</span>=<span class="localvariable">cat</span>;}<span class="keyword">if</span> (<span class="localvariable">oldest</span>==<span class="atom">null</span>) <span class="keyword">return</span><span class="atom">null</span>;<span class="keyword">else</span><span class="keyword">return</span><span class="localvariable">oldest</span>.<span class="property">name</span>;}<span class="variable">print</span>(<span class="variable">oldestCat</span>(<span class="variable">catData</span>));</pre><p><a class="paragraph" href="#p285408cd2c93c127" name="p285408cd2c93c127"> ¶ </a>The condition in the <code>if</code> statement might seem a little intimidating.It can be read as 'only store the current cat in the variable <code>oldest</code>if it is not dead, and <code>oldest</code> is either <code>null</code> or a cat that wasborn after the current cat'.</p><p><a class="paragraph" href="#p4feaed58fe9460c6" name="p4feaed58fe9460c6"> ¶ </a>Note that this function returns <code>null</code> when there are no living catsin <code>data</code>. What does your solution do in that case?</p></div></div><hr/><div class="block"><p><a class="paragraph" href="#p4d7165898045f99" name="p4d7165898045f99"> ¶ </a>Now that we are familiar with arrays, I can show you somethingrelated. Whenever a function is called, a special variable named<a name="key33"></a><code>arguments</code> is added to the environment in which the function bodyruns. This variable refers to an object that resembles an array. Ithas a property <code>0</code> for the first argument, <code>1</code> for the second, and soon for every argument the function was given. It also has a <a name="key34"></a><code>length</code>property.</p><p><a class="paragraph" href="#p5d6f061498f2c6ec" name="p5d6f061498f2c6ec"> ¶ </a>This object is not a real array though, it does not have methods like<code>push</code>, and it does not automatically update its <code>length</code> propertywhen you add something to it. Why not, I never really found out, butthis is something one needs to be aware of.</p><pre class="code"><span class="keyword">function</span><span class="variable">argumentCounter</span>(){<span class="variable">print</span>(<span class="string">&quot;You gave me &quot;</span>, <span class="localvariable">arguments</span>.<span class="property">length</span>, <span class="string">&quot;arguments.&quot;</span>);}<span class="variable">argumentCounter</span>(<span class="string">&quot;Death&quot;</span>, <span class="string">&quot;Famine&quot;</span>, <span class="string">&quot;Pestilence&quot;</span>);</pre><p><a class="paragraph" href="#pe2ca89d1a2931ea" name="pe2ca89d1a2931ea"> ¶ </a>Some functions can take any number of arguments, like <code>print</code> does.These typically loop over the values in the <code>arguments</code> object to dosomething with them. Others can take optional arguments which, whennot given by the caller, get some sensible default value.</p><pre class="code"><span class="keyword">function</span><span class="variable">add</span>(<span class="variabledef">number</span>, <span class="variabledef">howmuch</span>){<span class="keyword">if</span> (<span class="localvariable">arguments</span>.<span class="property">length</span> &lt;<span class="atom">2</span>) <span class="localvariable">howmuch</span>=<span class="atom">1</span>;<span class="keyword">return</span><span class="localvariable">number</span> + <span class="localvariable">howmuch</span>;}<span class="variable">show</span>(<span class="variable">add</span>(<span class="atom">6</span>));<span class="variable">show</span>(<span class="variable">add</span>(<span class="atom">6</span>, <span class="atom">4</span>));</pre></div><hr/><div class="block"><a name="exercise10"></a><div class="exercisenum">Ex. 4.10</div><div class="exercise"><p><a class="paragraph" href="#p20228267b5983b13" name="p20228267b5983b13"> ¶ </a>Extend the <code>range</code> function from <a href="chapter4.html#exercise2">exercise 4.2</a> to take a second, optionalargument. If only one argument is given, it behaves as earlier andproduces a range from 0 to the given number. If two arguments aregiven, the first indicates the start of the range, the second the end.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">range</span>(<span class="variabledef">start</span>, <span class="variabledef">end</span>){<span class="keyword">if</span> (<span class="localvariable">arguments</span>.<span class="property">length</span> &lt;<span class="atom">2</span>){<span class="localvariable">end</span>=<span class="localvariable">start</span>;<span class="localvariable">start</span>=<span class="atom">0</span>;}<span class="keyword">var</span><span class="variabledef">result</span>=[];<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">i</span>=<span class="localvariable">start</span>;<span class="localvariable">i</span> &lt;=<span class="localvariable">end</span>;<span class="localvariable">i</span>++) <span class="localvariable">result</span>.<span class="property">push</span>(<span class="localvariable">i</span>);<span class="keyword">return</span><span class="localvariable">result</span>;}<span class="variable">show</span>(<span class="variable">range</span>(<span class="atom">4</span>));<span class="variable">show</span>(<span class="variable">range</span>(<span class="atom">2</span>, <span class="atom">4</span>));</pre><p><a class="paragraph" href="#p41212ba9134d0970" name="p41212ba9134d0970"> ¶ </a>The optional argument does not work precisely like the one in the<code>add</code> example above. When it is not given, the first argument takesthe role of <code>end</code>, and <code>start</code> becomes <code>0</code>.</p></div></div><hr/><div class="block"><a name="exercise11"></a><div class="exercisenum">Ex. 4.11</div><div class="exercise"><p><a class="paragraph" href="#p7e9a60fc2a17f3d8" name="p7e9a60fc2a17f3d8"> ¶ </a>You may remember this line of code from the introduction:</p><pre class="code invalid"><span class="variable">print</span>(<span class="variable">sum</span>(<span class="variable">range</span>(<span class="atom">1</span>, <span class="atom">10</span>)));</pre><p><a class="paragraph" href="#p717ee2c2365c357f" name="p717ee2c2365c357f"> ¶ </a>We have <code>range</code> now. All we need to make this line work is a <code>sum</code>function. This function takes an array of numbers, and returns theirsum. Write it, it should be easy.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">sum</span>(<span class="variabledef">numbers</span>){<span class="keyword">var</span><span class="variabledef">total</span>=<span class="atom">0</span>;<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">i</span>=<span class="atom">0</span>;<span class="localvariable">i</span> &lt;<span class="localvariable">numbers</span>.<span class="property">length</span>;<span class="localvariable">i</span>++) <span class="localvariable">total</span> +=<span class="localvariable">numbers</span>[<span class="localvariable">i</span>];<span class="keyword">return</span><span class="localvariable">total</span>;}<span class="variable">print</span>(<span class="variable">sum</span>(<span class="variable">range</span>(<span class="atom">1</span>, <span class="atom">10</span>)));</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p12ff9c0aced56748" name="p12ff9c0aced56748"> ¶ </a><a href="chapter2.html">Chapter 2</a> mentioned the functions <code>Math.max</code> and <code>Math.min</code>.With what you know now, you will notice that these are really theproperties <code>max</code> and <code>min</code> of the object stored under the name<a name="key35"></a><code>Math</code>. This is another role that objects can play: A warehouseholding a number of related values.</p><p><a class="paragraph" href="#p43b6d0895389b0ba" name="p43b6d0895389b0ba"> ¶ </a>There are quite a lot of values inside <code>Math</code>, if they would all havebeen placed directly into the global environment they would, as it iscalled, pollute it. The more names have been taken, the more likelyone is to accidentally overwrite the value of some variable. Forexample, it is not a far shot to want to name something <code>max</code>.</p><p><a class="paragraph" href="#p169966adcd36c941" name="p169966adcd36c941"> ¶ </a>Most languages will stop you, or at least warn you, when you aredefining a variable with a name that is already taken. Not JavaScript.</p><p><a class="paragraph" href="#p6c55460a225e2a59" name="p6c55460a225e2a59"> ¶ </a>In any case, one can find a whole outfit of mathematical functions andconstants inside <code>Math</code>. All the trigonometric functions are there ―<code>cos</code>, <code>sin</code>, <code>tan</code>, <code>acos</code>, <code>asin</code>, <code>atan</code>. π and e, which arewritten with all capital letters (<code>PI</code> and <code>E</code>), which was, at onetime, a fashionable way to indicate something is a constant. <code>pow</code> isa good replacement for the <code>power</code> functions we have been writing, italso accepts negative and fractional exponents. <code>sqrt</code> takes squareroots. <code>max</code> and <code>min</code> can give the maximum or minimum of two values.<a name="key36"></a><a name="key37"></a><a name="key38"></a><code>round</code>, <code>floor</code>, and<code>ceil</code> will round numbers to the closest whole number, the wholenumber below it, and the whole number above it respectively.</p><p><a class="paragraph" href="#p372cb886b60de3b5" name="p372cb886b60de3b5"> ¶ </a>There are a number of other values in <code>Math</code>, but this text is anintroduction, not a <a name="key39"></a>reference. References are what you look at whenyou suspect something exists in the language, but need to find outwhat it is called or how it works exactly. Unfortunately, there is noone comprehensive complete reference for JavaScript. This is mostlybecause its current form is the result of a chaotic process ofdifferent browsers adding different extensions at different times. TheECMA standard document that was mentioned in the introduction providesa solid documentation of the basic language, but is more or lessunreadable. For most things, your best bet is the <a href="https://developer.mozilla.org/en/JavaScript/Reference/">Mozilla DeveloperNetwork</a>.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p13075c1e2cf024c1" name="p13075c1e2cf024c1"> ¶ </a>Maybe you already thought of a way to find out what is available inthe <code>Math</code> object:</p><pre class="code"><span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">name</span><span class="keyword">in</span><span class="variable">Math</span>) <span class="variable">print</span>(<span class="variable">name</span>);</pre><p><a class="paragraph" href="#p75f3933a7434183f" name="p75f3933a7434183f"> ¶ </a>But alas, nothing appears. Similarly, when you do this:</p><pre class="code"><span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">name</span><span class="keyword">in</span> [<span class="string">&quot;Huey&quot;</span>, <span class="string">&quot;Dewey&quot;</span>, <span class="string">&quot;Loui&quot;</span>]) <span class="variable">print</span>(<span class="variable">name</span>);</pre><p><a class="paragraph" href="#p4b432c2f1e6f0ac5" name="p4b432c2f1e6f0ac5"> ¶ </a>You only see <code>0</code>, <code>1</code>, and <code>2</code>, not <code>length</code>, or <code>push</code>, or <code>join</code>,which are definitely also in there. Apparently, some properties ofobjects are hidden<a name="key40"></a>. There is a good reason forthis: All objects have a few methods, for example <a name="key41"></a><code>toString</code>, whichconverts the object into some kind of relevant string, and you do notwant to see those when you are, for example, looking for the cats thatyou stored in the object.</p><p><a class="paragraph" href="#p24f5b457aa728472" name="p24f5b457aa728472"> ¶ </a>Why the properties of <code>Math</code> are hidden is unclear to me. Someoneprobably wanted it to be a mysterious kind of object.</p><p><a class="paragraph" href="#p1bb9785463d8ae0c" name="p1bb9785463d8ae0c"> ¶ </a>All properties your programs add to objects are visible. There is noway to make them hidden, which is unfortunate because, as we will seein <a href="chapter8.html">chapter 8</a>, it would be nice to be able to add methods to objectswithout having them show up in our <code>for</code>/<code>in</code> loops.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p32975b9cc4433e91" name="p32975b9cc4433e91"> ¶ </a><a name="key42"></a>Some properties are read-only, you can gettheir value but not change it. For example, the properties of a stringvalue are all read-only.</p><p><a class="paragraph" href="#p15ce1d78b184077e" name="p15ce1d78b184077e"> ¶ </a>Other properties can be 'active'. Changing themcauses <em>things</em> to happen. For example, lowering the length of anarray causes excess elements to be discarded:</p><pre class="code"><span class="keyword">var</span><span class="variable">array</span>=[<span class="string">&quot;Heaven&quot;</span>, <span class="string">&quot;Earth&quot;</span>, <span class="string">&quot;Man&quot;</span>];<span class="variable">array</span>.<span class="property">length</span>=<span class="atom">2</span>;<span class="variable">show</span>(<span class="variable">array</span>);</pre></div><ol class="footnotes"><li><a name="footnote1"></a>There are a few subtle problems with this approach, which will bediscussed and solved in <a href="chapter8.html">chapter 8</a>. For this chapter, it works well enough.</li></ol><h1><span class="number">Chapter 5: </span>Error Handling</h1><div class="block"><p><a class="paragraph" href="#p23415e96aafc7a8d" name="p23415e96aafc7a8d"> ¶ </a>Writing programs that work when everything goes as expected is a goodstart. Making your programs behave properly when encounteringunexpected conditions is where it really gets challenging.</p><p><a class="paragraph" href="#p1139aa50a5371761" name="p1139aa50a5371761"> ¶ </a>The problematic situations that a program can encounter fall into twocategories: Programmer mistakes and genuine problems. If someoneforgets to pass a required argument to a function, that is an exampleof the first kind of problem. On the other hand, if a program asks theuser to enter a name and it gets back an empty string, that issomething the programmer can not prevent.</p><p><a class="paragraph" href="#p20ee0eeaf72d4de1" name="p20ee0eeaf72d4de1"> ¶ </a>In general, one deals with programmer errors by finding and fixingthem, and with genuine errors by having the code check for them andperform some suitable action to remedy them (for example, asking forthe name again), or at least fail in a well-defined and clean way.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p265cd385d7c63b7f" name="p265cd385d7c63b7f"> ¶ </a>It is important to decide into which of these categories a certainproblem falls. For example, consider our old <code>power</code> function:</p><pre class="code"><span class="keyword">function</span><span class="variable">power</span>(<span class="variabledef">base</span>, <span class="variabledef">exponent</span>){<span class="keyword">var</span><span class="variabledef">result</span>=<span class="atom">1</span>;<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">count</span>=<span class="atom">0</span>;<span class="localvariable">count</span> &lt;<span class="localvariable">exponent</span>;<span class="localvariable">count</span>++) <span class="localvariable">result</span> *=<span class="localvariable">base</span>;<span class="keyword">return</span><span class="localvariable">result</span>;}</pre><p><a class="paragraph" href="#p76fc78f5e4d27491" name="p76fc78f5e4d27491"> ¶ </a>When some geek tries to call <code>power(&quot;Rabbit&quot;, 4)</code>, that is quiteobviously a programmer error, but how about <code>power(9, 0.5)</code>? Thefunction can not handle fractional exponents, but, mathematicallyspeaking, raising a number to the halfth power is perfectly reasonable(<a name="key1"></a><code>Math.pow</code> can handle it). In situations where it is not entirelyclear what kind of input a function accepts, it is often a good ideato explicitly state the kind of arguments that are acceptable in acomment.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p603873105d7487a4" name="p603873105d7487a4"> ¶ </a>If a function encounters a problem that it can not solve itself, whatshould it do? In <a href="chapter4.html">chapter 4</a> we wrote the function <code>between</code>:</p><pre class="code"><span class="keyword">function</span><span class="variable">between</span>(<span class="variabledef">string</span>, <span class="variabledef">start</span>, <span class="variabledef">end</span>){<span class="keyword">var</span><span class="variabledef">startAt</span>=<span class="localvariable">string</span>.<span class="property">indexOf</span>(<span class="localvariable">start</span>) + <span class="localvariable">start</span>.<span class="property">length</span>;<span class="keyword">var</span><span class="variabledef">endAt</span>=<span class="localvariable">string</span>.<span class="property">indexOf</span>(<span class="localvariable">end</span>, <span class="localvariable">startAt</span>);<span class="keyword">return</span><span class="localvariable">string</span>.<span class="property">slice</span>(<span class="localvariable">startAt</span>, <span class="localvariable">endAt</span>);}</pre><p><a class="paragraph" href="#p3f610153f264b3d7" name="p3f610153f264b3d7"> ¶ </a>If the given <code>start</code> and <code>end</code> do not occur in the string, <code>indexOf</code>will return <code>-1</code> and this version of <code>between</code> will return a lot ofnonsense: <code>between(&quot;Your mother!&quot;, &quot;{-&quot;, &quot;-}&quot;)</code> returns <code>&quot;our mother&quot;</code>.</p><p><a class="paragraph" href="#p499735628bc535b3" name="p499735628bc535b3"> ¶ </a>When the program is running, and the function is called like that, thecode that called it will get a string value, as it expected, andhappily continue doing something with it. But the value is wrong, sowhatever it ends up doing with it will also be wrong. And if you areunlucky, this wrongness only causes a problem after having passedthrough twenty other functions. In cases like that, it is extremelyhard to find out where the problem started.</p><p><a class="paragraph" href="#p3b2ec371666f4e1a" name="p3b2ec371666f4e1a"> ¶ </a>In some cases, you will be so unconcerned about these problems thatyou don't mind the function misbehaving when given incorrect input.For example, if you know for sure the function will only be calledfrom a few places, and you can prove that these places give it decentinput, it is generally not worth the trouble to make the functionbigger and uglier so that it can handle problematic cases.</p><p><a class="paragraph" href="#p487f962e97db245e" name="p487f962e97db245e"> ¶ </a>But most of the time, functions that fail 'silently' are hard to use,and even dangerous. What if the code calling <code>between</code> wants to knowwhether everything went well? At the moment, it can not tell, exceptby re-doing all the work that <code>between</code> did and checking the result of<code>between</code> with its own result. That is bad. One solution is to make<code>between</code> return a special value, such as <code>false</code> or <code>undefined</code>, whenit fails.</p><pre class="code"><span class="keyword">function</span><span class="variable">between</span>(<span class="variabledef">string</span>, <span class="variabledef">start</span>, <span class="variabledef">end</span>){<span class="keyword">var</span><span class="variabledef">startAt</span>=<span class="localvariable">string</span>.<span class="property">indexOf</span>(<span class="localvariable">start</span>);<span class="keyword">if</span> (<span class="localvariable">startAt</span>==-<span class="atom">1</span>) <span class="keyword">return</span><span class="atom">undefined</span>;<span class="localvariable">startAt</span> +=<span class="localvariable">start</span>.<span class="property">length</span>;<span class="keyword">var</span><span class="variabledef">endAt</span>=<span class="localvariable">string</span>.<span class="property">indexOf</span>(<span class="localvariable">end</span>, <span class="localvariable">startAt</span>);<span class="keyword">if</span> (<span class="localvariable">endAt</span>==-<span class="atom">1</span>) <span class="keyword">return</span><span class="atom">undefined</span>;<span class="keyword">return</span><span class="localvariable">string</span>.<span class="property">slice</span>(<span class="localvariable">startAt</span>, <span class="localvariable">endAt</span>);}</pre><p><a class="paragraph" href="#p3fa9a1283c5c0ee6" name="p3fa9a1283c5c0ee6"> ¶ </a>You can see that error checking does not generally make functionsprettier. But now code that calls <code>between</code> can do something like:</p><pre class="code"><span class="keyword">var</span><span class="variable">input</span>=<span class="variable">prompt</span>(<span class="string">&quot;Tell me something&quot;</span>, <span class="string">&quot;&quot;</span>);<span class="keyword">var</span><span class="variable">parenthesized</span>=<span class="variable">between</span>(<span class="variable">input</span>, <span class="string">&quot;(&quot;</span>, <span class="string">&quot;)&quot;</span>);<span class="keyword">if</span> (<span class="variable">parenthesized</span> !=<span class="atom">undefined</span>) <span class="variable">print</span>(<span class="string">&quot;You parenthesized '&quot;</span>, <span class="variable">parenthesized</span>, <span class="string">&quot;'.&quot;</span>);</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p60066c2098aade00" name="p60066c2098aade00"> ¶ </a>In many cases returning a special value is a perfectly fine way toindicate an error. It does, however, have its downsides. Firstly, whatif the function can already return every possible kind of value? Forexample, consider this function that gets the last element from anarray:</p><pre class="code"><span class="keyword">function</span><span class="variable">lastElement</span>(<span class="variabledef">array</span>){<span class="keyword">if</span> (<span class="localvariable">array</span>.<span class="property">length</span> &gt;<span class="atom">0</span>) <span class="keyword">return</span><span class="localvariable">array</span>[<span class="localvariable">array</span>.<span class="property">length</span> - <span class="atom">1</span>];<span class="keyword">else</span><span class="keyword">return</span><span class="atom">undefined</span>;}<span class="variable">show</span>(<span class="variable">lastElement</span>([<span class="atom">1</span>, <span class="atom">2</span>, <span class="atom">undefined</span>]));</pre><p><a class="paragraph" href="#p25b05ae4df778f0e" name="p25b05ae4df778f0e"> ¶ </a>So did the array have a last element? Looking at the value<code>lastElement</code> returns, it is impossible to say.</p><p><a class="paragraph" href="#p59d5d030b1223110" name="p59d5d030b1223110"> ¶ </a>The second issue with returning special values is that it cansometimes lead to a whole lot of clutter. If a piece of code calls<code>between</code> ten times, it has to check ten times whether <code>undefined</code> wasreturned. Also, if a function calls <code>between</code> but does not have astrategy to recover from a failure, it will have to check the returnvalue of <code>between</code>, and if it is <code>undefined</code>, this function can thenreturn <code>undefined</code> or some other special value to its caller, who inturn also checks for this value.</p><p><a class="paragraph" href="#p2d4a742116a20f7" name="p2d4a742116a20f7"> ¶ </a>Sometimes, when something strange occurs, it would be practical tojust stop doing what we are doing and immediately jump back to a placethat knows how to handle the problem.</p><p><a class="paragraph" href="#p75820b4abd417475" name="p75820b4abd417475"> ¶ </a>Well, we are in luck, a lot of programming languages provide such athing. Usually, it is called <a name="key2"></a>exception handling.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p48d4032291a4063d" name="p48d4032291a4063d"> ¶ </a>The theory behind exception handling goes like this: It is possiblefor code to <a name="key3"></a>raise (or <a name="key4"></a>throw) an <a name="key5"></a>exception, which is a value.Raising an exception somewhat resembles a super-charged return from afunction ― it does not just jump out of the current function, butalso out of its callers, all the way up to the top-level call thatstarted the current execution. This is called <a name="key6"></a>unwinding the stack.You may remember the <a name="key7"></a>stack of function calls that was mentioned in<a href="chapter3.html">chapter 3</a>. An exception zooms down this stack, throwing away allthe call contexts it encounters.</p><p><a class="paragraph" href="#p577e309ea04ff91d" name="p577e309ea04ff91d"> ¶ </a>If they always zoomed right down to the base of the stack, exceptionswould not be of much use, they would just provide a novel way to blowup your program. Fortunately, it is possible to set obstacles forexceptions along the stack. These '<a name="key8"></a>catch' the exception as it iszooming down, and can do something with it, after which the programcontinues running at the point where the exception was caught.</p><p><a class="paragraph" href="#pd35fda8d169697d" name="pd35fda8d169697d"> ¶ </a>An example:</p><pre class="code"><span class="keyword">function</span><span class="variable">lastElement</span>(<span class="variabledef">array</span>){<span class="keyword">if</span> (<span class="localvariable">array</span>.<span class="property">length</span> &gt;<span class="atom">0</span>) <span class="keyword">return</span><span class="localvariable">array</span>[<span class="localvariable">array</span>.<span class="property">length</span> - <span class="atom">1</span>];<span class="keyword">else</span><span class="keyword">throw</span><span class="string">&quot;Can not take the last element of an empty array.&quot;</span>;}<span class="keyword">function</span><span class="variable">lastElementPlusTen</span>(<span class="variabledef">array</span>){<span class="keyword">return</span><span class="variable">lastElement</span>(<span class="localvariable">array</span>) + <span class="atom">10</span>;}<span class="keyword">try</span>{<span class="variable">print</span>(<span class="variable">lastElementPlusTen</span>([]));}<span class="keyword">catch</span> (<span class="variabledef">error</span>){<span class="variable">print</span>(<span class="string">&quot;Something went wrong: &quot;</span>, <span class="localvariable">error</span>);}</pre><p><a class="paragraph" href="#p56436d45f8fad659" name="p56436d45f8fad659"> ¶ </a><a name="key9"></a><code>throw</code> is the keyword that is used to raise an exception. Thekeyword <a name="key10"></a><code>try</code> sets up an obstacle for exceptions: When the code inthe block after it raises an exception, the <a name="key11"></a><code>catch</code> block will beexecuted. The variable named in parentheses after the word <code>catch</code> isthe name given to the exception value inside this block.</p><p><a class="paragraph" href="#p2b53d4284ce191bf" name="p2b53d4284ce191bf"> ¶ </a>Note that the function <code>lastElementPlusTen</code> completely ignores thepossibility that <code>lastElement</code> might go wrong. This is the bigadvantage of exceptions ― error-handling code is only necessary atthe point where the error occurs, and the point where it is handled.The functions in between can forget all about it.</p><p><a class="paragraph" href="#p66b04af462386c28" name="p66b04af462386c28"> ¶ </a>Well, almost.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p593204985074522e" name="p593204985074522e"> ¶ </a>Consider the following: A function <code>processThing</code> wants to set atop-level variable <code>currentThing</code> to point to a specific thing whileits body executes, so that other functions can have access to thatthing too. Normally you would of course just pass the thing as anargument, but assume for a moment that that is not practical. When thefunction finishes, <code>currentThing</code> should be set back to <code>null</code>.</p><pre class="code"><span class="keyword">var</span><span class="variable">currentThing</span>=<span class="atom">null</span>;<span class="keyword">function</span><span class="variable">processThing</span>(<span class="variabledef">thing</span>){<span class="keyword">if</span> (<span class="variable">currentThing</span> !=<span class="atom">null</span>) <span class="keyword">throw</span><span class="string">&quot;Oh no! We are already processing a thing!&quot;</span>;<span class="variable">currentThing</span>=<span class="localvariable">thing</span>;<span class="comment">/* do complicated processing... */</span><span class="variable">currentThing</span>=<span class="atom">null</span>;}</pre><p><a class="paragraph" href="#p61e6f0e964bfa434" name="p61e6f0e964bfa434"> ¶ </a>But what if the complicated processing raises an exception? In thatcase the call to <code>processThing</code> will be thrown off the stack by theexception, and <code>currentThing</code> will never be reset to <code>null</code>.</p><p><a class="paragraph" href="#p16204fe3ccdbe7d3" name="p16204fe3ccdbe7d3"> ¶ </a><code>try</code> statements can also be followed by a <a name="key12"></a><code>finally</code> keyword, whichmeans 'no matter <em>what</em> happens, run this code after trying to run thecode in the <code>try</code> block'. If a function has to clean something up, thecleanup code should usually be put into a <code>finally</code> block:</p><pre class="code"><span class="keyword">function</span><span class="variable">processThing</span>(<span class="variabledef">thing</span>){<span class="keyword">if</span> (<span class="variable">currentThing</span> !=<span class="atom">null</span>) <span class="keyword">throw</span><span class="string">&quot;Oh no! We are already processing a thing!&quot;</span>;<span class="variable">currentThing</span>=<span class="localvariable">thing</span>;<span class="keyword">try</span>{<span class="comment">/* do complicated processing... */</span>}<span class="keyword">finally</span>{<span class="variable">currentThing</span>=<span class="atom">null</span>;}}</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p61c863902bde0b98" name="p61c863902bde0b98"> ¶ </a>A lot of errors in programs cause the JavaScript environment to raisean exception. For example:</p><pre class="code"><span class="keyword">try</span>{<span class="variable">print</span>(<span class="variable">Sasquatch</span>);}<span class="keyword">catch</span> (<span class="variabledef">error</span>){<span class="variable">print</span>(<span class="string">&quot;Caught: &quot;</span> + <span class="localvariable">error</span>.<span class="property">message</span>);}</pre><p><a class="paragraph" href="#p2fc14e19e1879089" name="p2fc14e19e1879089"> ¶ </a>In cases like this, special error objects are raised. These alwayshave a <code>message</code> property containing a description of the problem. Youcan raise similar objects using the <code>new</code> keyword and the <a name="key13"></a><code>Error</code>constructor:</p><pre class="code"><span class="keyword">throw</span><span class="keyword">new</span><span class="variable">Error</span>(<span class="string">&quot;Fire!&quot;</span>);</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p663e29c2fc3163a1" name="p663e29c2fc3163a1"> ¶ </a>When an exception goes all the way to the bottom of the stack withoutbeing caught, it gets handled by the environment. What this meansdiffers between the different browsers, sometimes a description of theerror is written to some kind of log, sometimes a window pops updescribing the error.</p><p><a class="paragraph" href="#p79ca4f9b2f4c2a81" name="p79ca4f9b2f4c2a81"> ¶ </a>The errors produced by entering code in the console on this page arealways caught by the console, and displayed among the other output.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p6f4a56186561ecaa" name="p6f4a56186561ecaa"> ¶ </a>Most programmers consider exceptions purely an error-handlingmechanism. In essence, though, they are just another way ofinfluencing the control flow of a program. For example, they can beused as a kind of <code>break</code> statement in a recursive function. Here is aslightly strange function which determines whether an object, and theobjects stored inside it, contain at least seven <code>true</code> values:</p><pre class="code"><span class="keyword">var</span><span class="variable">FoundSeven</span>={};<span class="keyword">function</span><span class="variable">hasSevenTruths</span>(<span class="variabledef">object</span>){<span class="keyword">var</span><span class="variabledef">counted</span>=<span class="atom">0</span>;<span class="keyword">function</span><span class="variabledef">count</span>(<span class="variabledef">object</span>){<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">name</span><span class="keyword">in</span><span class="localvariable">object</span>){<span class="keyword">if</span> (<span class="localvariable">object</span>[<span class="localvariable">name</span>]===<span class="atom">true</span>){<span class="localvariable">counted</span>++;<span class="keyword">if</span> (<span class="localvariable">counted</span>==<span class="atom">7</span>) <span class="keyword">throw</span><span class="variable">FoundSeven</span>;}<span class="keyword">else</span><span class="keyword">if</span> (typeof <span class="localvariable">object</span>[<span class="localvariable">name</span>]==<span class="string">&quot;object&quot;</span>){<span class="localvariable">count</span>(<span class="localvariable">object</span>[<span class="localvariable">name</span>]);}}}<span class="keyword">try</span>{<span class="localvariable">count</span>(<span class="localvariable">object</span>);<span class="keyword">return</span><span class="atom">false</span>;}<span class="keyword">catch</span> (<span class="variabledef">exception</span>){<span class="keyword">if</span> (<span class="localvariable">exception</span> !=<span class="variable">FoundSeven</span>) <span class="keyword">throw</span><span class="localvariable">exception</span>;<span class="keyword">return</span><span class="atom">true</span>;}}</pre><p><a class="paragraph" href="#p478fb7ee5eac6383" name="p478fb7ee5eac6383"> ¶ </a>The inner function <code>count</code> is recursively called for every object thatis part of the argument. When the variable <code>counted</code> reaches seven,there is no point in continuing to count, but just returning from thecurrent call to <code>count</code> will not necessarily stop the counting, sincethere might be more calls below it. So what we do is just throw avalue, which will cause the control to jump right out of any calls to<code>count</code>, and land at the <code>catch</code> block.</p><p><a class="paragraph" href="#p770a470bd00d3706" name="p770a470bd00d3706"> ¶ </a>But just returning <code>true</code> in case of an exception is not correct.Something else might be going wrong, so we first check whether theexception is the object <code>FoundSeven</code>, created specifically for thispurpose. If it is not, this <code>catch</code> block does not know how to handleit, so it raises it again.</p><p><a class="paragraph" href="#p1040256860b43e79" name="p1040256860b43e79"> ¶ </a>This is a pattern that is also common when dealing with errorconditions ― you have to make sure that your <code>catch</code> block onlyhandles exceptions that it knows how to handle. Throwing stringvalues, as some of the examples in this chapter do, is rarely a goodidea, because it makes it hard to recognise the type of the exception.A better idea is to use unique values, such as the <code>FoundSeven</code>object, or to introduce a new type of objects, as described in <a href="chapter8.html">chapter 8</a>.</p></div><h1><span class="number">Chapter 6: </span>Functional Programming</h1><div class="block"><p><a class="paragraph" href="#p406bc0550dba7201" name="p406bc0550dba7201"> ¶ </a>As programs get bigger, they also become more complex and harder tounderstand. We all think ourselves pretty clever, of course, but weare mere human beings, and even a moderate amount of chaos tends tobaffle us. And then it all goes downhill. Working on something you donot really understand is a bit like cutting random wires on thosetime-activated bombs they always have in movies. If you are lucky, youmight get the right one ― especially if you are the hero of the movieand strike a suitably dramatic pose ― but there is always thepossibility of blowing everything up.</p><p><a class="paragraph" href="#p61d9c58b7ccd55b" name="p61d9c58b7ccd55b"> ¶ </a>Admittedly, in most cases, breaking a program does not cause any largeexplosions. But when a program, by someone's ignorant tinkering, hasdegenerated into a ramshackle mass of errors, reshaping it intosomething sensible is a terrible labour ― sometimes you might just aswell start over.</p><p><a class="paragraph" href="#pe323e5622f00be3" name="pe323e5622f00be3"> ¶ </a><a name="key1"></a>Thus, the programmer is always looking for ways to keepthe complexity of his programs as low as possible. An important way todo this is to try and make code more abstract. When writing a program,it is easy to get sidetracked into small details at every point. Youcome across some little issue, and you deal with it, and then proceedto the next little problem, and so on. This makes the code read like agrandmother's tale.</p><blockquote>Yes, dear, to make pea soup you will need split peas, the dry kind.And you have to soak them at least for a night, or you will have tocook them for hours and hours. I remember one time, when my dull sontried to make pea soup. Would you believe he hadn't soaked the peas?We almost broke our teeth, all of us. Anyway, when you have soakedthe peas, and you'll want about a cup of them per person, and payattention because they will expand a bit while they are soaking, soif you aren't careful they will spill out of whatever you use tohold them, so also use plenty water to soak in, but as I said, abouta cup of them, when they are dry, and after they are soaked you cookthem in four cups of water per cup of dry peas. Let it simmer fortwo hours, which means you cover it and keep it barely cooking, andthen add some diced onions, sliced celery stalk, and maybe a carrotor two and some ham. Let it all cook for a few minutes more, and itis ready to eat.</blockquote><p><a class="paragraph" href="#p2f9bf5e014dcdc06" name="p2f9bf5e014dcdc06"> ¶ </a>Another way to describe this recipe:</p><blockquote>Per person: one cup dried split peas, half a chopped onion, half acarrot, a celery stalk, and optionally ham.<br/><br/>Soak peas overnight, simmer them for two hours in four cups of water(per person), add vegetables and ham, and cook for ten more minutes.</blockquote><p><a class="paragraph" href="#p4abdc642ee7bc293" name="p4abdc642ee7bc293"> ¶ </a>This is shorter, but if you don't know how to soak peas you'll surelyscrew up and put them in too little water. But how to soak peas can belooked up, and that is the trick. If you assume a certain basicknowledge in the audience, you can talk in a language that deals withbigger concepts, and express things in a much shorter and clearer way.This, more or less, is what abstraction is.</p><p><a class="paragraph" href="#p2bfd98498baedead" name="p2bfd98498baedead"> ¶ </a>How is this far-fetched recipe story relevant to programming? Well,obviously, the recipe is the program. Furthermore, the basic knowledgethat the cook is supposed to have corresponds to the functions andother constructs that are available to the programmer. If you rememberthe introduction of this book, things like <code>while</code> make it easier tobuild loops, and in <a href="chapter4.html">chapter 4</a> we wrote some simple functions in order tomake other functions shorter and more straightforward. Such tools,some of them made available by the language itself, others built bythe programmer, are used to reduce the amount of uninteresting detailsin the rest of the program, and thus make that program easier to workwith.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p1029fd844bd24fc8" name="p1029fd844bd24fc8"> ¶ </a><a name="key2"></a>Functional programming, which is the subjectof this chapter, produces abstraction through clever ways of combiningfunctions. A programmer armed with a repertoire of fundamentalfunctions and, more importantly, the knowledge on how to use them, ismuch more effective than one who starts from scratch. Unfortunately, astandard JavaScript environment comes with deplorably few essentialfunctions, so we have to write them ourselves or, which is oftenpreferable, make use of somebody else's code (more on that in<a href="chapter9.html">chapter 9</a>).</p><p><a class="paragraph" href="#p5b2b16eeb6c201d1" name="p5b2b16eeb6c201d1"> ¶ </a>There are other popular approaches to abstraction, most notablyobject-oriented programming, the subject of <a href="chapter8.html">chapter 8</a>.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p755f4be241af5b12" name="p755f4be241af5b12"> ¶ </a>One ugly detail that, if you have any good taste at all, must bestarting to bother you is the endlessly repeated <code>for</code> loop going overan array: <code>for (var i=0;i &lt;something.length;i++) ...</code>. Can thisbe abstracted?</p><p><a class="paragraph" href="#p6dce7810233c1f28" name="p6dce7810233c1f28"> ¶ </a>The problem is that, whereas most functions just take some values,combine them, and return something, such a loop contains a piece ofcode that it must execute. It is easy to write a function that goesover an array and prints out every element:</p><pre class="code"><span class="keyword">function</span><span class="variable">printArray</span>(<span class="variabledef">array</span>){<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">i</span>=<span class="atom">0</span>;<span class="localvariable">i</span> &lt;<span class="localvariable">array</span>.<span class="property">length</span>;<span class="localvariable">i</span>++) <span class="variable">print</span>(<span class="localvariable">array</span>[<span class="localvariable">i</span>]);}</pre><p><a class="paragraph" href="#p5e43c3fda6edbd78" name="p5e43c3fda6edbd78"> ¶ </a>But what if we want to do something else than print? Since 'doingsomething' can be represented as a function, and functions are alsovalues, we can pass our action as a function value:</p><pre class="code"><span class="keyword">function</span><span class="variable">forEach</span>(<span class="variabledef">array</span>, <span class="variabledef">action</span>){<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">i</span>=<span class="atom">0</span>;<span class="localvariable">i</span> &lt;<span class="localvariable">array</span>.<span class="property">length</span>;<span class="localvariable">i</span>++) <span class="localvariable">action</span>(<span class="localvariable">array</span>[<span class="localvariable">i</span>]);}<span class="variable">forEach</span>([<span class="string">&quot;Wampeter&quot;</span>, <span class="string">&quot;Foma&quot;</span>, <span class="string">&quot;Granfalloon&quot;</span>], <span class="variable">print</span>);</pre><p><a class="paragraph" href="#p5c6ce2b695bd142d" name="p5c6ce2b695bd142d"> ¶ </a>And by making use of an anonymous function, something just like a<code>for</code> loop can be written with less useless details:</p><pre class="code"><span class="keyword">function</span><span class="variable">sum</span>(<span class="variabledef">numbers</span>){<span class="keyword">var</span><span class="variabledef">total</span>=<span class="atom">0</span>;<span class="variable">forEach</span>(<span class="localvariable">numbers</span>, <span class="keyword">function</span> (<span class="variabledef">number</span>){<span class="localvariable">total</span> +=<span class="localvariable">number</span>;});<span class="keyword">return</span><span class="localvariable">total</span>;}<span class="variable">show</span>(<span class="variable">sum</span>([<span class="atom">1</span>, <span class="atom">10</span>, <span class="atom">100</span>]));</pre><p><a class="paragraph" href="#p22480fe89f06c197" name="p22480fe89f06c197"> ¶ </a>Note that the variable <code>total</code> is visible inside the anonymousfunction because of the lexical scoping rules. Also note that thisversion is hardly shorter than the <code>for</code> loop and requires a ratherclunky <code>});</code> at its end ― the brace closes the body of the anonymousfunction, the parenthesis closes the function call to <a name="key3"></a><code>forEach</code>, andthe semicolon is needed because this call is a statement.</p><p><a class="paragraph" href="#p58553fdda22a0049" name="p58553fdda22a0049"> ¶ </a>You do get a variable bound to the current element in the array,<code>number</code>, so there is no need to use <code>numbers[i]</code> anymore, and whenthis array is created by evaluating some expression, there is no needto store it in a variable, because it can be passed to <code>forEach</code>directly.</p><p><a class="paragraph" href="#p551f69c843687e97" name="p551f69c843687e97"> ¶ </a>The cat-code in <a href="chapter4.html">chapter 4</a> contains a piece like this:</p><pre class="preformatted">var paragraphs=mailArchive[mail].split(&quot;\n&quot;);for (var i=0;i &lt;paragraphs.length;i++) handleParagraph(paragraphs[i]);</pre><p><a class="paragraph" href="#pffb217033b4c9e0" name="pffb217033b4c9e0"> ¶ </a>This can now be written as...</p><pre class="preformatted">forEach(mailArchive[mail].split(&quot;\n&quot;), handleParagraph);</pre><p><a class="paragraph" href="#p75cea5d2d73e38c4" name="p75cea5d2d73e38c4"> ¶ </a>On the whole, using more abstract (or 'higher level') constructsresults in more information and less noise: The code in <code>sum</code> reads'<em>for each number in numbers add that number to the total</em>', insteadof... '<em>there is this variable that starts at zero, and it countsupward to the length of the array called numbers, and for every valueof this variable we look up the corresponding element in the array andadd this to the total</em>'.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p177cb39381c8ab4" name="p177cb39381c8ab4"> ¶ </a>What <code>forEach</code> does is take an algorithm, in this case 'going over anarray', and abstract it. The 'gaps' in the algorithm, in this case,what to do for each of these elements, are filled by functions whichare passed to the algorithm function.</p><p><a class="paragraph" href="#p3d4f511f55eb429c" name="p3d4f511f55eb429c"> ¶ </a>Functions that operate on other functions are called <a name="key4"></a>higher-orderfunctions. By operating on functions, they can talk about actions ona whole new level. The <code>makeAddFunction</code> function from <a href="chapter3.html">chapter 3</a> isalso a higher-order function. Instead of taking a function value as anargument, it produces a new function.</p><p><a class="paragraph" href="#p95f3cd5d57a5d96" name="p95f3cd5d57a5d96"> ¶ </a>Higher-order functions can be used to generalise many algorithms thatregular functions can not easily describe. When you have a repertoireof these functions at your disposal, it can help you think about yourcode in a clearer way: Instead of a messy set of variables and loops,you can decompose algorithms into a combination of a few fundamentalalgorithms, which are invoked by name, and do not have to be typed outagain and again.</p><p><a class="paragraph" href="#p5541a4757333b993" name="p5541a4757333b993"> ¶ </a>Being able to write <em>what</em> we want to do instead of <em>how</em> we do itmeans we are working at a higher level of abstraction. In practice,this means shorter, clearer, and more pleasant code.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p59860b27992bc7e4" name="p59860b27992bc7e4"> ¶ </a>Another useful type of higher-order function <em>modifies</em> the functionvalue it is given:</p><pre class="code"><span class="keyword">function</span><span class="variable">negate</span>(<span class="variabledef">func</span>){<span class="keyword">return</span><span class="keyword">function</span>(<span class="variabledef">x</span>){<span class="keyword">return</span> !<span class="localvariable">func</span>(<span class="localvariable">x</span>);};}<span class="keyword">var</span><span class="variable">isNotNaN</span>=<span class="variable">negate</span>(<span class="variable">isNaN</span>);<span class="variable">show</span>(<span class="variable">isNotNaN</span>(<span class="atom">NaN</span>));</pre><p><a class="paragraph" href="#p6604314a4be645ae" name="p6604314a4be645ae"> ¶ </a>The function returned by <code>negate</code> feeds the argument it is given tothe original function <code>func</code>, and then negates the result. But what ifthe function you want to negate takes more than one argument? You canget access to any arguments passed to a function with the <code>arguments</code>array, but how do you call a function when you do not know how manyarguments you have?</p><p><a class="paragraph" href="#p254e0cc081a6d7df" name="p254e0cc081a6d7df"> ¶ </a>Functions have a method called <a name="key5"></a><code>apply</code>, which is used for situationslike this. It takes two arguments. The role of the first argument willbe discussed in <a href="chapter8.html">chapter 8</a>, for now we just use <code>null</code> there. The secondargument is an array containing the arguments that the function mustbe applied to.</p><pre class="code"><span class="variable">show</span>(<span class="variable">Math</span>.<span class="property">min</span>.<span class="property">apply</span>(<span class="atom">null</span>, [<span class="atom">5</span>, <span class="atom">6</span>]));<span class="keyword">function</span><span class="variable">negate</span>(<span class="variabledef">func</span>){<span class="keyword">return</span><span class="keyword">function</span>(){<span class="keyword">return</span> !<span class="localvariable">func</span>.<span class="property">apply</span>(<span class="atom">null</span>, <span class="localvariable">arguments</span>);};}</pre><p><a class="paragraph" href="#p4cbc103f8e1c6a70" name="p4cbc103f8e1c6a70"> ¶ </a>Unfortunately, on the Internet Explorer browser a lot of built-infunctions, such as <code>alert</code>, are not <em>really</em> functions... orsomething. They report their type as <code>&quot;object&quot;</code> when given to the<code>typeof</code> operator, and they do not have an <code>apply</code> method. Your ownfunctions do not suffer from this, they are always real functions.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p43bea35b65e9846c" name="p43bea35b65e9846c"> ¶ </a>Let us look at a few more basic algorithms related to arrays. The<code>sum</code> function is really a variant of an algorithm which is usuallycalled <a name="key6"></a><code>reduce</code> or <code>fold</code>:</p><pre class="code"><span class="keyword">function</span><span class="variable">reduce</span>(<span class="variabledef">combine</span>, <span class="variabledef">base</span>, <span class="variabledef">array</span>){<span class="variable">forEach</span>(<span class="localvariable">array</span>, <span class="keyword">function</span> (<span class="variabledef">element</span>){<span class="localvariable">base</span>=<span class="localvariable">combine</span>(<span class="localvariable">base</span>, <span class="localvariable">element</span>);});<span class="keyword">return</span><span class="localvariable">base</span>;}<span class="keyword">function</span><span class="variable">add</span>(<span class="variabledef">a</span>, <span class="variabledef">b</span>){<span class="keyword">return</span><span class="localvariable">a</span> + <span class="localvariable">b</span>;}<span class="keyword">function</span><span class="variable">sum</span>(<span class="variabledef">numbers</span>){<span class="keyword">return</span><span class="variable">reduce</span>(<span class="variable">add</span>, <span class="atom">0</span>, <span class="localvariable">numbers</span>);}</pre><p><a class="paragraph" href="#p3a26d72d5d539372" name="p3a26d72d5d539372"> ¶ </a><code>reduce</code> combines an array into a single value by repeatedly using afunction that combines an element of the array with a base value. Thisis exactly what <code>sum</code> did, so it can be made shorter by using<code>reduce</code>... except that addition is an operator and not a function inJavaScript, so we first had to put it into a function.</p><p><a class="paragraph" href="#p1e327ea6dfd8d5a9" name="p1e327ea6dfd8d5a9"> ¶ </a>The reason <code>reduce</code> takes the function as its first argument insteadof its last, as in <code>forEach</code>, is partly that this is tradition ―other languages do it like that ― and partly that this allows us touse a particular trick, which will be discussed at the end of thischapter. It does mean that, when calling <code>reduce</code>, writing thereducing function as an anonymous function looks a bit weirder,because now the other arguments follow after the function, and theresemblance to a normal <code>for</code> block is lost entirely.</p></div><hr/><div class="block"><a name="exercise1"></a><div class="exercisenum">Ex. 6.1</div><div class="exercise"><p><a class="paragraph" href="#p60c55bb8b0ec0f52" name="p60c55bb8b0ec0f52"> ¶ </a>Write a function <code>countZeroes</code>, which takes an array of numbers as itsargument and returns the amount of zeroes that occur in it. Use<code>reduce</code>.</p><p><a class="paragraph" href="#pc668a5d771065b3" name="pc668a5d771065b3"> ¶ </a>Then, write the higher-order function <code>count</code>, which takes an arrayand a test function as arguments, and returns the amount of elementsin the array for which the test function returned <code>true</code>. Re-implement<code>countZeroes</code> using this function.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">countZeroes</span>(<span class="variabledef">array</span>){<span class="keyword">function</span><span class="variabledef">counter</span>(<span class="variabledef">total</span>, <span class="variabledef">element</span>){<span class="keyword">return</span><span class="localvariable">total</span> + (<span class="localvariable">element</span>===<span class="atom">0</span> ? <span class="atom">1</span> : <span class="atom">0</span>);}<span class="keyword">return</span><span class="variable">reduce</span>(<span class="localvariable">counter</span>, <span class="atom">0</span>, <span class="localvariable">array</span>);}</pre><p><a class="paragraph" href="#p543f21adae0dab0c" name="p543f21adae0dab0c"> ¶ </a><a name="key7"></a>The weird part, with the question mark and the colon, uses anew operator. In <a href="chapter2.html">chapter 2</a> we have seen unary and binary operators.This one is ternary ― it acts on three values. Its effect resemblesthat of <code>if</code>/<code>else</code>, except that, where <code>if</code> conditionally executesstatements, this one conditionally chooses expressions. The firstpart, before the question mark, is the condition. If this condition is<code>true</code>, the expression after the question mark is chosen, <code>1</code> in thiscase. If it is <code>false</code>, the part after the colon, <code>0</code> in this case, ischosen.</p><p><a class="paragraph" href="#p588c930c925024a1" name="p588c930c925024a1"> ¶ </a>Use of this operator can make some pieces of code much shorter. Whenthe expressions inside it get very big, or you have to make moredecisions inside the conditional parts, just using plain <code>if</code> and<code>else</code> is usually more readable.</p><p><a class="paragraph" href="#p29cfd0dde807fe3b" name="p29cfd0dde807fe3b"> ¶ </a>Here is the solution that uses a <code>count</code> function, with a functionthat produces equality-testers included to make the final<code>countZeroes</code> function even shorter:</p><pre class="code"><span class="keyword">function</span><span class="variable">count</span>(<span class="variabledef">test</span>, <span class="variabledef">array</span>){<span class="keyword">return</span><span class="variable">reduce</span>(<span class="keyword">function</span>(<span class="variabledef">total</span>, <span class="variabledef">element</span>){<span class="keyword">return</span><span class="localvariable">total</span> + (<span class="localvariable">test</span>(<span class="localvariable">element</span>) ? <span class="atom">1</span> : <span class="atom">0</span>);}, <span class="atom">0</span>, <span class="localvariable">array</span>);}<span class="keyword">function</span><span class="variable">equals</span>(<span class="variabledef">x</span>){<span class="keyword">return</span><span class="keyword">function</span>(<span class="variabledef">element</span>){<span class="keyword">return</span><span class="localvariable">x</span>===<span class="localvariable">element</span>;};}<span class="keyword">function</span><span class="variable">countZeroes</span>(<span class="variabledef">array</span>){<span class="keyword">return</span><span class="variable">count</span>(<span class="variable">equals</span>(<span class="atom">0</span>), <span class="localvariable">array</span>);}</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p487fc5acce55439c" name="p487fc5acce55439c"> ¶ </a>One other generally useful 'fundamental algorithm' related to arraysis called <a name="key8"></a><code>map</code>. It goes over an array, applying a function to everyelement, just like <code>forEach</code>. But instead of discarding the valuesreturned by function, it builds up a new array from these values.</p><pre class="code"><span class="keyword">function</span><span class="variable">map</span>(<span class="variabledef">func</span>, <span class="variabledef">array</span>){<span class="keyword">var</span><span class="variabledef">result</span>=[];<span class="variable">forEach</span>(<span class="localvariable">array</span>, <span class="keyword">function</span> (<span class="variabledef">element</span>){<span class="localvariable">result</span>.<span class="property">push</span>(<span class="localvariable">func</span>(<span class="localvariable">element</span>));});<span class="keyword">return</span><span class="localvariable">result</span>;}<span class="variable">show</span>(<span class="variable">map</span>(<span class="variable">Math</span>.<span class="property">round</span>, [<span class="atom">0.01</span>, <span class="atom">2</span>, <span class="atom">9.89</span>, <span class="variable">Math</span>.<span class="property">PI</span>]));</pre><p><a class="paragraph" href="#pfbaec59a02a1d15" name="pfbaec59a02a1d15"> ¶ </a>Note that the first argument is called <code>func</code>, not <code>function</code>, thisis because <code>function</code> is a keyword and thus not a valid variable name.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p72845d53f6f05268" name="p72845d53f6f05268"> ¶ </a>There once was, living in the deep mountain forests of Transylvania, arecluse. Most of the time, he just wandered around his mountain,talking to trees and laughing with birds. But now and then, when thepouring rain trapped him in his little hut, and the howling wind madehim feel unbearably small, the recluse felt an urge to writesomething, wanted to pour some thoughts out onto paper, where theycould maybe grow bigger than he himself was.</p><p><a class="paragraph" href="#p518bcf1e2791bb49" name="p518bcf1e2791bb49"> ¶ </a>After failing miserably at poetry, fiction, and philosophy, therecluse finally decided to write a technical book. In his youth, hehad done some computer programming, and he figured that if he couldjust write a good book about that, fame and recognition would surelyfollow.</p><p><a class="paragraph" href="#p4838ad8fb26c0acd" name="p4838ad8fb26c0acd"> ¶ </a>So he wrote. At first he used fragments of tree bark, but that turnedout not to be very practical. He went down to the nearest village andbought himself a laptop computer. After a few chapters, he realised hewanted to put the book in HTML format, in order to put it on hisweb-page...</p></div><hr/><div class="block"><p><a class="paragraph" href="#p6f89de8af6edd388" name="p6f89de8af6edd388"> ¶ </a>Are you familiar with HTML? It is the method used to add mark-up topages on the web, and we will be using it a few times in this book, soit would be nice if you know how it works, at least generally. If youare a good student, you could go search the web for a goodintroduction to HTML now, and come back here when you have read it.Most of you probably are lousy students, so I will just give a shortexplanation and hope it is enough.</p><p><a class="paragraph" href="#p5595eff2a86b5d87" name="p5595eff2a86b5d87"> ¶ </a><a name="key9"></a>HTML stands for 'HyperText Mark-up Language'. An HTML document isall text. Because it must be able to express the structure of thistext, information about which text is a heading, which text is purple,and so on, a few characters have a special meaning, somewhat likebackslashes in JavaScript strings. The 'less than' and 'greater than'characters are used to create '<a name="key10"></a>tags'. A tag gives extra informationabout the text in the document. It can stand on its own, for exampleto mark the place where a picture should appear in the page, or it cancontain text and other tags, for example when it marks the start andend of a paragraph.</p><p><a class="paragraph" href="#p28225fb69550a84c" name="p28225fb69550a84c"> ¶ </a>Some tags are compulsory, a whole HTML document must always becontained in between <code>html</code> tags. Here is an example of an HTMLdocument:</p><pre class="preformatted">&lt;html&gt;&lt;head&gt;&lt;title&gt;A quote&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;A quote&lt;/h1&gt;&lt;blockquote&gt;&lt;p&gt;The connection between the language in which we think/program and the problems and solutions we can imagine is very close. For this reason restricting language features with the intent of eliminating programmer errors is at best dangerous.&lt;/p&gt;&lt;p&gt;-- Bjarne Stroustrup&lt;/p&gt;&lt;/blockquote&gt;&lt;p&gt;Mr. Stroustrup is the inventor of the C++ programming language, but quite an insightful person nevertheless.&lt;/p&gt;&lt;p&gt;Also, here is a picture of an ostrich:&lt;/p&gt;&lt;img src=&quot;img/ostrich.png&quot;/&gt;&lt;/body&gt;&lt;/html&gt;</pre><p><a class="paragraph" href="#p23bb63064e929324" name="p23bb63064e929324"> ¶ </a>Elements that contain text or other tags are first opened with<code>&lt;tagname&gt;</code>, and afterwards finished with <code>&lt;/tagname&gt;</code>. The <code>html</code>element always contains two children: <code>head</code> and <code>body</code>. The firstcontains information <em>about</em> the document, the second contains theactual document.</p><p><a class="paragraph" href="#p6e09739d3bcd5a53" name="p6e09739d3bcd5a53"> ¶ </a>Most tag names are cryptic abbreviations. <code>h1</code> stands for 'heading 1',the biggest kind of heading. There are also <code>h2</code> to <code>h6</code> forsuccessively smaller headings. <code>p</code> means 'paragraph', and <code>img</code> standsfor 'image'. The <code>img</code> element does not contain any text or othertags, but it does have some extra information,<code>src=&quot;img/ostrich.png&quot;</code>, which is called an '<a name="key11"></a>attribute'. In thiscase, it contains information about the image file that should beshown here.</p><p><a class="paragraph" href="#p61592ab96ad6b347" name="p61592ab96ad6b347"> ¶ </a>Because <code>&lt;</code> and <code>&gt;</code> have a special meaning in HTML documents, they cannot be written directly in the text of the document. If you want tosay '<code>5 &lt;10</code>' in an HTML document, you have to write '<code>5 &amp;lt;10</code>',where '<code>lt</code>' stands for 'less than'. '<code>&amp;gt;</code>' is used for '<code>&gt;</code>', andbecause these codes also give the ampersand character a specialmeaning, a plain '<code>&amp;</code>' is written as '<code>&amp;amp;</code>'.</p><p><a class="paragraph" href="#p62a06dc7ccbbe1d4" name="p62a06dc7ccbbe1d4"> ¶ </a>Now, those are only the bare basics of HTML, but they should be enoughto make it through this chapter, and later chapters that deal withHTML documents, without getting entirely confused.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p18cbb1fe1ccd441e" name="p18cbb1fe1ccd441e"> ¶ </a>The JavaScript console has a function <code>viewHTML</code> that can be used tolook at HTML documents. I stored the example document above in thevariable <code>stroustrupQuote</code>, so you can view it by executing thefollowing code:</p><pre class="code"><span class="variable">viewHTML</span>(<span class="variable">stroustrupQuote</span>);</pre><p><a class="paragraph" href="#p44328054845e46ab" name="p44328054845e46ab"> ¶ </a>If you have some kind of pop-up blocker installed or integrated inyour browser, it will probably interfere with <code>viewHTML</code>, which triesto show the HTML document in a new window or tab. Try to configure theblocker to allow pop-ups from this site.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p15c5e14addbc1388" name="p15c5e14addbc1388"> ¶ </a>So, picking up the story again, the recluse wanted to have his book inHTML format. At first he just wrote all the tags directly into hismanuscript, but typing all those less-than and greater-than signs madehis fingers hurt, and he constantly forgot to write <code>&amp;amp;</code> when heneeded an <code>&amp;</code>. This gave him a headache. Next, he tried to write thebook in Microsoft Word, and then save it as HTML. But the HTML thatcame out of that was fifteen times bigger and more complicated than ithad to be. And besides, Microsoft Word gave him a headache.</p><p><a class="paragraph" href="#p1156d30627166a36" name="p1156d30627166a36"> ¶ </a>The solution that he eventually came up with was this: He would writethe book as plain text, following some simple rules about the wayparagraphs were separated and the way headings looked. Then, he wouldwrite a program to convert this text into precisely the HTML that hewanted.</p><p><a class="paragraph" href="#p231e5049ecd8f592" name="p231e5049ecd8f592"> ¶ </a>The rules are this:</p><ol><li>Paragraphs are separated by blank lines.</li><li>A paragraph that starts with a '%' symbol is a header. The more '%' symbols, the smaller the header.</li><li>Inside paragraphs, pieces of text can be emphasised by putting them between asterisks.</li><li>Footnotes are written between braces.</li></ol></div><hr/><div class="block"><p><a class="paragraph" href="#p7427e734fe433eef" name="p7427e734fe433eef"> ¶ </a>After he had struggled painfully with his book for six months, therecluse had still only finished a few paragraphs. At this point, hishut was struck by lightning, killing him, and forever putting hiswriting ambitions to rest. From the charred remains of his laptop, Icould recover the following file:</p><pre class="preformatted">% The Book of Programming%% The Two AspectsBelow the surface of the machine, the program moves. Without effort,it expands and contracts. In great harmony, electrons scatter andregroup. The forms on the monitor are but ripples on the water. Theessence stays invisibly below.When the creators built the machine, they put in the processor and thememory. From these arise the two aspects of the program.The aspect of the processor is the active substance. It is calledControl. The aspect of the memory is the passive substance. It iscalled Data.Data is made of merely bits, yet it takes complex forms. Controlconsists only of simple instructions, yet it performs difficulttasks. From the small and trivial, the large and complex arise.The program source is Data. Control arises from it. The Controlproceeds to create new Data. The one is born from the other, theother is useless without the one. This is the harmonious cycle ofData and Control.Of themselves, Data and Control are without structure. The programmersof old moulded their programs out of this raw substance. Over time,the amorphous Data has crystallised into data types, and the chaoticControl was restricted into control structures and functions.%% Short SayingsWhen a student asked Fu-Tzu about the nature of the cycle of Data andControl, Fu-Tzu replied 'Think of a compiler, compiling itself.'A student asked 'The programmers of old used only simple machines andno programming languages, yet they made beautiful programs. Why do weuse complicated machines and programming languages?'. Fu-Tzu replied'The builders of old used only sticks and clay, yet they madebeautiful huts.'A hermit spent ten years writing a program. 'My program can computethe motion of the stars on a 286-computer running MS DOS', he proudlyannounced. 'Nobody owns a 286-computer or uses MS DOS anymore.',Fu-Tzu responded.Fu-Tzu had written a small program that was full of global state anddubious shortcuts. Reading it, a student asked 'You warned us againstthese techniques, yet I find them in your program. How can this be?'Fu-Tzu said 'There is no need to fetch a water hose when the house isnot on fire.'{This is not to be read as an encouragement of sloppyprogramming, but rather as a warning against neurotic adherence torules of thumb.}%% WisdomA student was complaining about digital numbers. 'When I take the rootof two and then square it again, the result is already inaccurate!'.Overhearing him, Fu-Tzu laughed. 'Here is a sheet of paper. Write downthe precise value of the square root of two for me.'Fu-Tzu said 'When you cut against the grain of the wood, much strengthis needed. When you program against the grain of a problem, much codeis needed.'Tzu-li and Tzu-ssu were boasting about the size of their latestprograms. 'Two-hundred thousand lines', said Tzu-li, 'not countingcomments!'. 'Psah', said Tzu-ssu, 'mine is almost a *million* linesalready.' Fu-Tzu said 'My best program has five hundred lines.'Hearing this, Tzu-li and Tzu-ssu were enlightened.A student had been sitting motionless behind his computer for hours,frowning darkly. He was trying to write a beautiful solution to adifficult problem, but could not find the right approach. Fu-Tzu hithim on the back of his head and shouted '*Type something!*' The studentstarted writing an ugly solution. After he had finished, he suddenlyunderstood the beautiful solution.%% ProgressionA beginning programmer writes his programs like an ant builds herhill, one piece at a time, without thought for the bigger structure.His programs will be like loose sand. They may stand for a while, butgrowing too big they fall apart{Referring to the danger of internalinconsistency and duplicated structure in unorganised code.}.Realising this problem, the programmer will start to spend a lot oftime thinking about structure. His programs will be rigidlystructured, like rock sculptures. They are solid, but when they mustchange, violence must be done to them{Referring to the fact thatstructure tends to put restrictions on the evolution of a program.}.The master programmer knows when to apply structure and when to leavethings in their simple form. His programs are like clay, solid yetmalleable.%% LanguageWhen a programming language is created, it is given syntax andsemantics. The syntax describes the form of the program, the semanticsdescribe the function. When the syntax is beautiful and the semanticsare clear, the program will be like a stately tree. When the syntax isclumsy and the semantics confusing, the program will be like a bramblebush.Tzu-ssu was asked to write a program in the language called Java,which takes a very primitive approach to functions. Every morning, ashe sat down in front of his computer, he started complaining. All dayhe cursed, blaming the language for all that went wrong. Fu-Tzulistened for a while, and then reproached him, saying 'Every languagehas its own way. Follow its form, do not try to program as if youwere using another language.'</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p897b23e06210d6e" name="p897b23e06210d6e"> ¶ </a>To honour the memory of our good recluse, I would like to finish hisHTML-generating program for him. A good approach to this problem goeslike this:</p><ol><li>Split the file into paragraphs by cutting it at every empty line.</li><li>Remove the '%' characters from header paragraphs and mark them as headers.</li><li>Process the text of the paragraphs themselves, splitting them into normal parts, emphasised parts, and footnotes.</li><li>Move all the footnotes to the bottom of the document, leaving numbers<a class="footref" href="#footnote1">1</a> in their place.</li><li>Wrap each piece into the correct HTML tags.</li><li>Combine everything into a single HTML document.</li></ol><p><a class="paragraph" href="#p3639dfda43aa90ef" name="p3639dfda43aa90ef"> ¶ </a>This approach does not allow footnotes inside emphasised text, or viceversa. This is kind of arbitrary, but helps keep the example codesimple. If, at the end of the chapter, you feel like an extrachallenge, you can try to revise the program to support 'nested'mark-up.</p><p><a class="paragraph" href="#pa5c8ea56e8f40" name="pa5c8ea56e8f40"> ¶ </a>The whole manuscript, as a string value, is available on this pageby calling <code>recluseFile</code> function.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p3ea6f2079f69683b" name="p3ea6f2079f69683b"> ¶ </a>Step 1 of the algorithm is trivial. A blank line is what you get whenyou have two newlines in a row, and if you remember the <code>split</code> methodthat strings have, which we saw in <a href="chapter4.html">chapter 4</a>, you will realise that thiswill do the trick:</p><pre class="code"><span class="keyword">var</span><span class="variable">paragraphs</span>=<span class="variable">recluseFile</span>().<span class="property">split</span>(<span class="string">&quot;\n\n&quot;</span>);<span class="variable">print</span>(<span class="string">&quot;Found &quot;</span>, <span class="variable">paragraphs</span>.<span class="property">length</span>, <span class="string">&quot;paragraphs.&quot;</span>);</pre></div><hr/><div class="block"><a name="exercise2"></a><div class="exercisenum">Ex. 6.2</div><div class="exercise"><p><a class="paragraph" href="#p7a03749a314f5c0e" name="p7a03749a314f5c0e"> ¶ </a>Write a function <code>processParagraph</code> that, when given a paragraphstring as its argument, checks whether this paragraph is a header. Ifit is, it strips off the '%' characters and counts their number. Then,it returns an object with two properties, <code>content</code>, which containsthe text inside the paragraph, and <code>type</code>, which contains the tag thatthis paragraph must be wrapped in, <code>&quot;p&quot;</code> for regular paragraphs,<code>&quot;h1&quot;</code> for headers with one '%', and <code>&quot;hX&quot;</code> for headers with <code>X</code> '%'characters.</p><p><a class="paragraph" href="#p43476b9b9ff201a7" name="p43476b9b9ff201a7"> ¶ </a>Remember that strings have a <code>charAt</code> method that can be used to lookat a specific character inside them.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">processParagraph</span>(<span class="variabledef">paragraph</span>){<span class="keyword">var</span><span class="variabledef">header</span>=<span class="atom">0</span>;<span class="keyword">while</span> (<span class="localvariable">paragraph</span>.<span class="property">charAt</span>(<span class="atom">0</span>)==<span class="string">&quot;%&quot;</span>){<span class="localvariable">paragraph</span>=<span class="localvariable">paragraph</span>.<span class="property">slice</span>(<span class="atom">1</span>);<span class="localvariable">header</span>++;}<span class="keyword">return</span>{<span class="property">type</span>: (<span class="localvariable">header</span>==<span class="atom">0</span> ? <span class="string">&quot;p&quot;</span> : <span class="string">&quot;h&quot;</span> + <span class="localvariable">header</span>), <span class="property">content</span>: <span class="localvariable">paragraph</span>};}<span class="variable">show</span>(<span class="variable">processParagraph</span>(<span class="variable">paragraphs</span>[<span class="atom">0</span>]));</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#pa7f3dc1b71f0aa4" name="pa7f3dc1b71f0aa4"> ¶ </a>This is where we can try out the <code>map</code> function we saw earlier.</p><pre class="code"><span class="keyword">var</span><span class="variable">paragraphs</span>=<span class="variable">map</span>(<span class="variable">processParagraph</span>, <span class="variable">recluseFile</span>().<span class="property">split</span>(<span class="string">&quot;\n\n&quot;</span>));</pre><p><a class="paragraph" href="#p12974fd2c85f79a" name="p12974fd2c85f79a"> ¶ </a>And <em>bang</em>, we have an array of nicely categorised paragraph objects.We are getting ahead of ourselves though, we forgot step 3 of thealgorithm:</p><blockquote>Process the text of the paragraphs themselves, splitting them intonormal parts, emphasised parts, and footnotes.</blockquote><p><a class="paragraph" href="#p37365c2089df721d" name="p37365c2089df721d"> ¶ </a>Which can be decomposed into:</p><ol><li>If the paragraph starts with an asterisk, take off the emphasised part and store it.</li><li>If the paragraph starts with an opening brace, take off the footnote and store it.</li><li>Otherwise, take off the part until the first emphasised part or footnote, or until the end of the string, and store it as normal text.</li><li>If there is anything left in the paragraph, start at 1 again.</li></ol></div><hr/><div class="block"><a name="exercise3"></a><div class="exercisenum">Ex. 6.3</div><div class="exercise"><p><a class="paragraph" href="#p71cc2e8ae802b37f" name="p71cc2e8ae802b37f"> ¶ </a>Build a function <code>splitParagraph</code> which, given a paragraph string,returns an array of paragraph fragments. Think of a good way torepresent the fragments.</p><p><a class="paragraph" href="#p69e4f58fb69971b5" name="p69e4f58fb69971b5"> ¶ </a>The method <code>indexOf</code>, which searches for a character or sub-string ina string and returns its position, or <code>-1</code> if not found, will probablybe useful in some way here.</p><p><a class="paragraph" href="#p3ee6676215ac600b" name="p3ee6676215ac600b"> ¶ </a>This is a tricky algorithm, and there are many not-quite-correct orway-too-long ways to describe it. If you run into problems, just thinkabout it for a minute. Try to write inner functions that perform thesmaller actions that make up the algorithm.</p></div><div class="solution"><p><a class="paragraph" href="#pbb40d1f6f95d6da" name="pbb40d1f6f95d6da"> ¶ </a>Here is one possible solution:</p><pre class="code"><span class="keyword">function</span><span class="variable">splitParagraph</span>(<span class="variabledef">text</span>){<span class="keyword">function</span><span class="variabledef">indexOrEnd</span>(<span class="variabledef">character</span>){<span class="keyword">var</span><span class="variabledef">index</span>=<span class="localvariable">text</span>.<span class="property">indexOf</span>(<span class="localvariable">character</span>);<span class="keyword">return</span><span class="localvariable">index</span>==-<span class="atom">1</span> ? <span class="localvariable">text</span>.<span class="property">length</span> : <span class="localvariable">index</span>;}<span class="keyword">function</span><span class="variabledef">takeNormal</span>(){<span class="keyword">var</span><span class="variabledef">end</span>=<span class="variable">reduce</span>(<span class="variable">Math</span>.<span class="property">min</span>, <span class="localvariable">text</span>.<span class="property">length</span>, <span class="variable">map</span>(<span class="localvariable">indexOrEnd</span>, [<span class="string">&quot;*&quot;</span>, <span class="string">&quot;{&quot;</span>]));<span class="keyword">var</span><span class="variabledef">part</span>=<span class="localvariable">text</span>.<span class="property">slice</span>(<span class="atom">0</span>, <span class="localvariable">end</span>);<span class="localvariable">text</span>=<span class="localvariable">text</span>.<span class="property">slice</span>(<span class="localvariable">end</span>);<span class="keyword">return</span><span class="localvariable">part</span>;}<span class="keyword">function</span><span class="variabledef">takeUpTo</span>(<span class="variabledef">character</span>){<span class="keyword">var</span><span class="variabledef">end</span>=<span class="localvariable">text</span>.<span class="property">indexOf</span>(<span class="localvariable">character</span>, <span class="atom">1</span>);<span class="keyword">if</span> (<span class="localvariable">end</span>==-<span class="atom">1</span>) <span class="keyword">throw</span><span class="keyword">new</span><span class="variable">Error</span>(<span class="string">&quot;Missing closing '&quot;</span> + <span class="localvariable">character</span> + <span class="string">&quot;'&quot;</span>);<span class="keyword">var</span><span class="variabledef">part</span>=<span class="localvariable">text</span>.<span class="property">slice</span>(<span class="atom">1</span>, <span class="localvariable">end</span>);<span class="localvariable">text</span>=<span class="localvariable">text</span>.<span class="property">slice</span>(<span class="localvariable">end</span> + <span class="atom">1</span>);<span class="keyword">return</span><span class="localvariable">part</span>;}<span class="keyword">var</span><span class="variabledef">fragments</span>=[];<span class="keyword">while</span> (<span class="localvariable">text</span> !=<span class="string">&quot;&quot;</span>){<span class="keyword">if</span> (<span class="localvariable">text</span>.<span class="property">charAt</span>(<span class="atom">0</span>)==<span class="string">&quot;*&quot;</span>) <span class="localvariable">fragments</span>.<span class="property">push</span>({<span class="property">type</span>: <span class="string">&quot;emphasised&quot;</span>, <span class="property">content</span>: <span class="localvariable">takeUpTo</span>(<span class="string">&quot;*&quot;</span>)});<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">text</span>.<span class="property">charAt</span>(<span class="atom">0</span>)==<span class="string">&quot;{&quot;</span>) <span class="localvariable">fragments</span>.<span class="property">push</span>({<span class="property">type</span>: <span class="string">&quot;footnote&quot;</span>, <span class="property">content</span>: <span class="localvariable">takeUpTo</span>(<span class="string">&quot;}&quot;</span>)});<span class="keyword">else</span><span class="localvariable">fragments</span>.<span class="property">push</span>({<span class="property">type</span>: <span class="string">&quot;normal&quot;</span>, <span class="property">content</span>: <span class="localvariable">takeNormal</span>()});}<span class="keyword">return</span><span class="localvariable">fragments</span>;}</pre><p><a class="paragraph" href="#p345940589e670c12" name="p345940589e670c12"> ¶ </a>Note the over-eager use of <code>map</code> and <code>reduce</code> in the <code>takeNormal</code>function. This is a chapter about functional programming, so programfunctionally we will! Can you see how this works? The <code>map</code> producesan array of positions where the given characters were found, or theend of the string if they were not found, and the <code>reduce</code> takes theminimum of them, which is the next point in the string that we have tolook at.</p><p><a class="paragraph" href="#p69d4e54010e82198" name="p69d4e54010e82198"> ¶ </a>If you'd write that out without mapping and reducing you'd getsomething like this:</p><pre class="preformatted">var nextAsterisk=text.indexOf(&quot;*&quot;);var nextBrace=text.indexOf(&quot;{&quot;);var end=text.length;if (nextAsterisk !=-1) end=nextAsterisk;if (nextBrace !=-1 &amp;&amp;nextBrace &lt;end) end=nextBrace;</pre><p><a class="paragraph" href="#p8c0367fd215c195" name="p8c0367fd215c195"> ¶ </a>Which is even more hideous. Most of the time, when a decision has tobe made based on a series of things, even if there are only two ofthem, writing it as array operations is nicer than handling everyvalue in a separate <code>if</code> statement. (Fortunately, <a href="chapter10.html">chapter 10</a> describesan easier way to ask for the first occurrence of 'this or thatcharacter' in a string.)</p><p><a class="paragraph" href="#p3bc46f0ef5a06a22" name="p3bc46f0ef5a06a22"> ¶ </a>If you wrote a <code>splitParagraph</code> that stored fragments in a differentway than the solution above, you might want to adjust it, because thefunctions in the rest of the chapter assume that fragments are objectswith <code>type</code> and <code>content</code> properties.</p></div></div><hr/><div class="block"><p><a class="paragraph" href="#p8d8dfc9fda5e96b" name="p8d8dfc9fda5e96b"> ¶ </a>We can now wire <code>processParagraph</code> to also split the text inside theparagraphs, my version can be modified like this:</p><pre class="code"><span class="keyword">function</span><span class="variable">processParagraph</span>(<span class="variabledef">paragraph</span>){<span class="keyword">var</span><span class="variabledef">header</span>=<span class="atom">0</span>;<span class="keyword">while</span> (<span class="localvariable">paragraph</span>.<span class="property">charAt</span>(<span class="atom">0</span>)==<span class="string">&quot;%&quot;</span>){<span class="localvariable">paragraph</span>=<span class="localvariable">paragraph</span>.<span class="property">slice</span>(<span class="atom">1</span>);<span class="localvariable">header</span>++;}<span class="keyword">return</span>{<span class="property">type</span>: (<span class="localvariable">header</span>==<span class="atom">0</span> ? <span class="string">&quot;p&quot;</span> : <span class="string">&quot;h&quot;</span> + <span class="localvariable">header</span>), <span class="property">content</span>: <span class="variable">splitParagraph</span>(<span class="localvariable">paragraph</span>)};}</pre><p><a class="paragraph" href="#p1dc03c0bced024ba" name="p1dc03c0bced024ba"> ¶ </a>Mapping that over the array of paragraphs gives us an array ofparagraph objects, which in turn contain arrays of fragment objects.The next thing to do is to take out the footnotes, and put referencesto them in their place. Something like this:</p><pre class="code"><span class="keyword">function</span><span class="variable">extractFootnotes</span>(<span class="variabledef">paragraphs</span>){<span class="keyword">var</span><span class="variabledef">footnotes</span>=[];<span class="keyword">var</span><span class="variabledef">currentNote</span>=<span class="atom">0</span>;<span class="keyword">function</span><span class="variabledef">replaceFootnote</span>(<span class="variabledef">fragment</span>){<span class="keyword">if</span> (<span class="localvariable">fragment</span>.<span class="property">type</span>==<span class="string">&quot;footnote&quot;</span>){<span class="localvariable">currentNote</span>++;<span class="localvariable">footnotes</span>.<span class="property">push</span>(<span class="localvariable">fragment</span>);<span class="localvariable">fragment</span>.<span class="property">number</span>=<span class="localvariable">currentNote</span>;<span class="keyword">return</span>{<span class="property">type</span>: <span class="string">&quot;reference&quot;</span>, <span class="property">number</span>: <span class="localvariable">currentNote</span>};}<span class="keyword">else</span>{<span class="keyword">return</span><span class="localvariable">fragment</span>;}}<span class="variable">forEach</span>(<span class="localvariable">paragraphs</span>, <span class="keyword">function</span>(<span class="variabledef">paragraph</span>){<span class="localvariable">paragraph</span>.<span class="property">content</span>=<span class="variable">map</span>(<span class="localvariable">replaceFootnote</span>, <span class="localvariable">paragraph</span>.<span class="property">content</span>);});<span class="keyword">return</span><span class="localvariable">footnotes</span>;}</pre><p><a class="paragraph" href="#p1945e2a9469001e7" name="p1945e2a9469001e7"> ¶ </a>The <code>replaceFootnote</code> function is called on every fragment. When itgets a fragment that should stay where it is, it just returns it, butwhen it gets a footnote, it stores this footnote in the <code>footnotes</code>array, and returns a reference to it instead. In the process, everyfootnote and reference is also numbered.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p17175caf68cc7e1d" name="p17175caf68cc7e1d"> ¶ </a>That gives us enough tools to extract the information we need from thefile. All that is left now is generating the correct HTML.</p><p><a class="paragraph" href="#p749d0d61d6a10c1c" name="p749d0d61d6a10c1c"> ¶ </a>A lot of people think that concatenating strings is a great way toproduce HTML. When they need a link to, for example, a site where youcan play the game of Go, they will do:</p><pre class="code"><span class="keyword">var</span><span class="variable">url</span>=<span class="string">&quot;http://www.gokgs.com/&quot;</span>;<span class="keyword">var</span><span class="variable">text</span>=<span class="string">&quot;Play Go!&quot;</span>;<span class="keyword">var</span><span class="variable">linkText</span>=<span class="string">&quot;&lt;a href=\&quot;&quot;</span> + <span class="variable">url</span> + <span class="string">&quot;\&quot;&gt;&quot;</span> + <span class="variable">text</span> + <span class="string">&quot;&lt;/a&gt;&quot;</span>;<span class="variable">print</span>(<span class="variable">linkText</span>);</pre><p><a class="paragraph" href="#p747f2492516f6ec8" name="p747f2492516f6ec8"> ¶ </a>(Where <code>a</code> is the tag used to create links in HTML documents.) ... Notonly is this clumsy, but when the string <code>text</code> happens to include anangular bracket or an ampersand, it is also wrong. Weird things willhappen on your website, and you will look embarrassingly amateurish.We wouldn't want that to happen. A few simple HTML-generatingfunctions are easy to write. So let us write them.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p6fa1925fa79b3a64" name="p6fa1925fa79b3a64"> ¶ </a>The secret to successful HTML generation is to treat your HTMLdocument as a data structure instead of a flat piece of text.JavaScript's objects provide a very easy way to model this:</p><pre class="code"><span class="keyword">var</span><span class="variable">linkObject</span>={<span class="property">name</span>: <span class="string">&quot;a&quot;</span>, <span class="property">attributes</span>:{<span class="property">href</span>: <span class="string">&quot;http://www.gokgs.com/&quot;</span>}, <span class="property">content</span>: [<span class="string">&quot;Play Go!&quot;</span>]};</pre><p><a class="paragraph" href="#p556c15128bc138bf" name="p556c15128bc138bf"> ¶ </a>Each HTML element contains a <code>name</code> property, giving the name of thetag it represents. When it has attributes, it also contains an<code>attributes</code> property, which contains an object in which theattributes are stored. When it has content, there is a <code>content</code>property, containing an array of other elements contained in thiselement. Strings play the role of pieces of text in our HTML document,so the array <code>[&quot;Play Go!&quot;]</code> means that this link has only one elementinside it, which is a simple piece of text.</p><p><a class="paragraph" href="#p436b8a0933ca40c3" name="p436b8a0933ca40c3"> ¶ </a>Typing in these objects directly is clumsy, but we don't have to dothat. We provide a shortcut function to do this for us:</p><pre class="code"><span class="keyword">function</span><span class="variable">tag</span>(<span class="variabledef">name</span>, <span class="variabledef">content</span>, <span class="variabledef">attributes</span>){<span class="keyword">return</span>{<span class="property">name</span>: <span class="localvariable">name</span>, <span class="property">attributes</span>: <span class="localvariable">attributes</span>, <span class="property">content</span>: <span class="localvariable">content</span>};}</pre><p><a class="paragraph" href="#p1ecda8e342d6e46b" name="p1ecda8e342d6e46b"> ¶ </a>Note that, since we allow the <code>attributes</code> and <code>content</code> of an elementto be undefined if they are not applicable, the second and thirdargument to this function can be left off when they are not needed.</p><p><a class="paragraph" href="#p4cba4588483f2724" name="p4cba4588483f2724"> ¶ </a><code>tag</code> is still rather primitive, so we write shortcuts for commontypes of elements, such as links, or the outer structure of a simpledocument:</p><pre class="code"><span class="keyword">function</span><span class="variable">link</span>(<span class="variabledef">target</span>, <span class="variabledef">text</span>){<span class="keyword">return</span><span class="variable">tag</span>(<span class="string">&quot;a&quot;</span>, [<span class="localvariable">text</span>],{<span class="property">href</span>: <span class="localvariable">target</span>});}<span class="keyword">function</span><span class="variable">htmlDoc</span>(<span class="variabledef">title</span>, <span class="variabledef">bodyContent</span>){<span class="keyword">return</span><span class="variable">tag</span>(<span class="string">&quot;html&quot;</span>, [<span class="variable">tag</span>(<span class="string">&quot;head&quot;</span>, [<span class="variable">tag</span>(<span class="string">&quot;title&quot;</span>, [<span class="localvariable">title</span>])]), <span class="variable">tag</span>(<span class="string">&quot;body&quot;</span>, <span class="localvariable">bodyContent</span>)]);}</pre></div><hr/><div class="block"><a name="exercise4"></a><div class="exercisenum">Ex. 6.4</div><div class="exercise"><p><a class="paragraph" href="#p55aadeef2bce3455" name="p55aadeef2bce3455"> ¶ </a>Looking back at the example HTML document if necessary, write an<code>image</code> function which, when given the location of an image file, willcreate an <code>img</code> HTML element.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">image</span>(<span class="variabledef">src</span>){<span class="keyword">return</span><span class="variable">tag</span>(<span class="string">&quot;img&quot;</span>, [],{<span class="property">src</span>: <span class="localvariable">src</span>});}</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p6f2629dff438f71e" name="p6f2629dff438f71e"> ¶ </a>When we have created a document, it will have to be reduced to astring. But building this string from the data structures we have beenproducing is very straightforward. The important thing is to rememberto transform the special characters in the text of our document...</p><pre class="code"><span class="keyword">function</span><span class="variable">escapeHTML</span>(<span class="variabledef">text</span>){<span class="keyword">var</span><span class="variabledef">replacements</span>=[[<span class="string">/&amp;/g</span>, <span class="string">&quot;&amp;amp;&quot;</span>], [<span class="string">/&quot;/g</span>, <span class="string">&quot;&amp;quot;&quot;</span>], [<span class="string">/&lt;/g</span>, <span class="string">&quot;&amp;lt;&quot;</span>], [<span class="string">/&gt;/g</span>, <span class="string">&quot;&amp;gt;&quot;</span>]];<span class="variable">forEach</span>(<span class="localvariable">replacements</span>, <span class="keyword">function</span>(<span class="variabledef">replace</span>){<span class="localvariable">text</span>=<span class="localvariable">text</span>.<span class="property">replace</span>(<span class="localvariable">replace</span>[<span class="atom">0</span>], <span class="localvariable">replace</span>[<span class="atom">1</span>]);});<span class="keyword">return</span><span class="localvariable">text</span>;}</pre><p><a class="paragraph" href="#p20c7007a4d92929f" name="p20c7007a4d92929f"> ¶ </a>The <code>replace</code> method of strings creates a new string in which alloccurrences of the pattern in the first argument are replaced by thesecond argument, so <code>&quot;Borobudur&quot;.replace(/r/g, &quot;k&quot;)</code> gives<code>&quot;Bokobuduk&quot;</code>. Don't worry about the pattern syntax here ― we'll getto that in <a href="chapter10.html">chapter 10</a>. The <code>escapeHTML</code> function puts the differentreplacements that have to be made into an array, so that it can loopover them and apply them to the argument one by one.</p><p><a class="paragraph" href="#p3c2403698fee1561" name="p3c2403698fee1561"> ¶ </a>Double quotes are also replaced, because we will also be using thisfunction for the text inside the attributes of HTML tags. Those willbe surrounded by double quotes, and thus must not have any doublequotes inside of them.</p><p><a class="paragraph" href="#p76723fc7e0f72bae" name="p76723fc7e0f72bae"> ¶ </a>Calling replace four times means the computer has to go over the wholestring four times to check and replace its content. This is not veryefficient. If we cared enough, we could write a more complex versionof this function, something that resembles the <code>splitParagraph</code>function we saw earlier, to go over it only once. For now, we are toolazy for this. Again, <a href="chapter10.html">chapter 10</a> shows a much better way to do this.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p597f66cdb5f3e27e" name="p597f66cdb5f3e27e"> ¶ </a>To turn an HTML element object into a string, we can use a recursivefunction like this:</p><pre class="code"><span class="keyword">function</span><span class="variable">renderHTML</span>(<span class="variabledef">element</span>){<span class="keyword">var</span><span class="variabledef">pieces</span>=[];<span class="keyword">function</span><span class="variabledef">renderAttributes</span>(<span class="variabledef">attributes</span>){<span class="keyword">var</span><span class="variabledef">result</span>=[];<span class="keyword">if</span> (<span class="localvariable">attributes</span>){<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">name</span><span class="keyword">in</span><span class="localvariable">attributes</span>) <span class="localvariable">result</span>.<span class="property">push</span>(<span class="string">&quot;&quot;</span> + <span class="localvariable">name</span> + <span class="string">&quot;=\&quot;&quot;</span> + <span class="variable">escapeHTML</span>(<span class="localvariable">attributes</span>[<span class="localvariable">name</span>]) + <span class="string">&quot;\&quot;&quot;</span>);}<span class="keyword">return</span><span class="localvariable">result</span>.<span class="property">join</span>(<span class="string">&quot;&quot;</span>);}<span class="keyword">function</span><span class="variabledef">render</span>(<span class="variabledef">element</span>){<span class="comment">// Text node</span><span class="keyword">if</span> (typeof <span class="localvariable">element</span>==<span class="string">&quot;string&quot;</span>){<span class="localvariable">pieces</span>.<span class="property">push</span>(<span class="variable">escapeHTML</span>(<span class="localvariable">element</span>));}<span class="comment">// Empty tag</span><span class="keyword">else</span><span class="keyword">if</span> (!<span class="localvariable">element</span>.<span class="property">content</span> || <span class="localvariable">element</span>.<span class="property">content</span>.<span class="property">length</span>==<span class="atom">0</span>){<span class="localvariable">pieces</span>.<span class="property">push</span>(<span class="string">&quot;&lt;&quot;</span> + <span class="localvariable">element</span>.<span class="property">name</span> + <span class="localvariable">renderAttributes</span>(<span class="localvariable">element</span>.<span class="property">attributes</span>) + <span class="string">&quot;/&gt;&quot;</span>);}<span class="comment">// Tag with content</span><span class="keyword">else</span>{<span class="localvariable">pieces</span>.<span class="property">push</span>(<span class="string">&quot;&lt;&quot;</span> + <span class="localvariable">element</span>.<span class="property">name</span> + <span class="localvariable">renderAttributes</span>(<span class="localvariable">element</span>.<span class="property">attributes</span>) + <span class="string">&quot;&gt;&quot;</span>);<span class="variable">forEach</span>(<span class="localvariable">element</span>.<span class="property">content</span>, <span class="localvariable">render</span>);<span class="localvariable">pieces</span>.<span class="property">push</span>(<span class="string">&quot;&lt;/&quot;</span> + <span class="localvariable">element</span>.<span class="property">name</span> + <span class="string">&quot;&gt;&quot;</span>);}}<span class="localvariable">render</span>(<span class="localvariable">element</span>);<span class="keyword">return</span><span class="localvariable">pieces</span>.<span class="property">join</span>(<span class="string">&quot;&quot;</span>);}</pre><p><a class="paragraph" href="#p2dbe0143b8e2e574" name="p2dbe0143b8e2e574"> ¶ </a>Note the <code>in</code> loop that extracts the properties from a JavaScriptobject in order to make HTML tag attributes out of them. Also notethat in two places, arrays are being used to accumulate strings, whichare then joined into a single result string. Why didn't I just startwith an empty string and then add the content to it with the <code>+=</code>operator?</p><p><a class="paragraph" href="#p4c819786485d39b0" name="p4c819786485d39b0"> ¶ </a>It turns out that creating new strings, especially big strings, isquite a lot of work. Remember that JavaScript string values neverchange. If you concatenate something to them, a new string is created,the old ones stay intact. If we build up a big string by concatenatinglots of little strings, new strings have to be created at every step,only to be thrown away when the next piece is concatenated to them.If, on the other hand, we store all the little strings in an array andthen join them, only <em>one</em> big string has to be created.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p4e3b2805efaaea64" name="p4e3b2805efaaea64"> ¶ </a>So, let us try out this HTML generating system...</p><pre class="code"><span class="variable">print</span>(<span class="variable">renderHTML</span>(<span class="variable">link</span>(<span class="string">&quot;http://www.nedroid.com&quot;</span>, <span class="string">&quot;Drawings!&quot;</span>)));</pre><p><a class="paragraph" href="#p506d9a82709880b0" name="p506d9a82709880b0"> ¶ </a>That seems to work.</p><pre class="code"><span class="keyword">var</span><span class="variable">body</span>=[<span class="variable">tag</span>(<span class="string">&quot;h1&quot;</span>, [<span class="string">&quot;The Test&quot;</span>]), <span class="variable">tag</span>(<span class="string">&quot;p&quot;</span>, [<span class="string">&quot;Here is a paragraph, and an image...&quot;</span>]), <span class="variable">image</span>(<span class="string">&quot;img/sheep.png&quot;</span>)];<span class="keyword">var</span><span class="variable">doc</span>=<span class="variable">htmlDoc</span>(<span class="string">&quot;The Test&quot;</span>, <span class="variable">body</span>);<span class="variable">viewHTML</span>(<span class="variable">renderHTML</span>(<span class="variable">doc</span>));</pre><p><a class="paragraph" href="#p3276b3e80a052310" name="p3276b3e80a052310"> ¶ </a>Now, I should probably warn you that this approach is not perfect.What it actually renders is <a name="key12"></a>XML, which is similar to HTML, but morestructured. In simple cases, such as the above, this does not causeany problems. However, there are some things, which are correct XML,but not proper HTML, and these might confuse a browser that is tryingto show the documents we create. For example, if you have an empty<code>script</code> tag (used to put JavaScript into a page) in your document,browsers will not realise that it is empty and think that everythingafter it is JavaScript. (In this case, the problem can be fixed byputting a single space inside of the tag, so that it is no longerempty, and gets a proper closing tag.)</p></div><hr/><div class="block"><a name="exercise5"></a><div class="exercisenum">Ex. 6.5</div><div class="exercise"><p><a class="paragraph" href="#p1e0ef833450fc1f3" name="p1e0ef833450fc1f3"> ¶ </a>Write a function <code>renderFragment</code>, and use that to implement anotherfunction <code>renderParagraph</code>, which takes a paragraph object (with thefootnotes already filtered out), and produces the correct HTML element(which might be a paragraph or a header, depending on the <code>type</code>property of the paragraph object).</p><p><a class="paragraph" href="#p1f0861c7ed9d1bfa" name="p1f0861c7ed9d1bfa"> ¶ </a>This function might come in useful for rendering the footnotereferences:</p><pre class="code"><span class="keyword">function</span><span class="variable">footnote</span>(<span class="variabledef">number</span>){<span class="keyword">return</span><span class="variable">tag</span>(<span class="string">&quot;sup&quot;</span>, [<span class="variable">link</span>(<span class="string">&quot;#footnote&quot;</span> + <span class="localvariable">number</span>, <span class="variable">String</span>(<span class="localvariable">number</span>))]);}</pre><p><a class="paragraph" href="#p794dcad4550f2084" name="p794dcad4550f2084"> ¶ </a>A <code>sup</code> tag will show its content as 'superscript', which means itwill be smaller and a little higher than other text. The target of thelink will be something like <code>&quot;#footnote1&quot;</code>. Links that contain a '#'character refer to 'anchors' within a page, and in this case we willuse them to make it so that clicking on the footnote link will takethe reader to the bottom of the page, where the footnotes live.</p><p><a class="paragraph" href="#p72966e0371d3b74" name="p72966e0371d3b74"> ¶ </a>The tag to render emphasised fragments with is <code>em</code>, and normal textcan be rendered without any extra tags.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">renderParagraph</span>(<span class="variabledef">paragraph</span>){<span class="keyword">return</span><span class="variable">tag</span>(<span class="localvariable">paragraph</span>.<span class="property">type</span>, <span class="variable">map</span>(<span class="variable">renderFragment</span>, <span class="localvariable">paragraph</span>.<span class="property">content</span>));}<span class="keyword">function</span><span class="variable">renderFragment</span>(<span class="variabledef">fragment</span>){<span class="keyword">if</span> (<span class="localvariable">fragment</span>.<span class="property">type</span>==<span class="string">&quot;reference&quot;</span>) <span class="keyword">return</span><span class="variable">footnote</span>(<span class="localvariable">fragment</span>.<span class="property">number</span>);<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">fragment</span>.<span class="property">type</span>==<span class="string">&quot;emphasised&quot;</span>) <span class="keyword">return</span><span class="variable">tag</span>(<span class="string">&quot;em&quot;</span>, [<span class="localvariable">fragment</span>.<span class="property">content</span>]);<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">fragment</span>.<span class="property">type</span>==<span class="string">&quot;normal&quot;</span>) <span class="keyword">return</span><span class="localvariable">fragment</span>.<span class="property">content</span>;}</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p260d6cceac205754" name="p260d6cceac205754"> ¶ </a>We are almost finished. The only thing that we do not have a renderingfunction for yet are the footnotes. To make the <code>&quot;#footnote1&quot;</code> linkswork, an anchor must be included with every footnote. In HTML, ananchor is specified with an <code>a</code> element, which is also used for links.In this case, it needs a <code>name</code> attribute, instead of an <code>href</code>.</p><pre class="code"><span class="keyword">function</span><span class="variable">renderFootnote</span>(<span class="variabledef">footnote</span>){<span class="keyword">var</span><span class="variabledef">number</span>=<span class="string">&quot;[&quot;</span> + <span class="localvariable">footnote</span>.<span class="property">number</span> + <span class="string">&quot;] &quot;</span>;<span class="keyword">var</span><span class="variabledef">anchor</span>=<span class="variable">tag</span>(<span class="string">&quot;a&quot;</span>, [<span class="localvariable">number</span>],{<span class="property">name</span>: <span class="string">&quot;footnote&quot;</span> + <span class="localvariable">footnote</span>.<span class="property">number</span>});<span class="keyword">return</span><span class="variable">tag</span>(<span class="string">&quot;p&quot;</span>, [<span class="variable">tag</span>(<span class="string">&quot;small&quot;</span>, [<span class="localvariable">anchor</span>, <span class="localvariable">footnote</span>.<span class="property">content</span>])]);}</pre><p><a class="paragraph" href="#p15ce2e41d5804dbd" name="p15ce2e41d5804dbd"> ¶ </a>Here, then, is the function which, when given a file in the correctformat and a document title, returns an HTML document:</p><pre class="code"><span class="keyword">function</span><span class="variable">renderFile</span>(<span class="variabledef">file</span>, <span class="variabledef">title</span>){<span class="keyword">var</span><span class="variabledef">paragraphs</span>=<span class="variable">map</span>(<span class="variable">processParagraph</span>, <span class="localvariable">file</span>.<span class="property">split</span>(<span class="string">&quot;\n\n&quot;</span>));<span class="keyword">var</span><span class="variabledef">footnotes</span>=<span class="variable">map</span>(<span class="variable">renderFootnote</span>, <span class="variable">extractFootnotes</span>(<span class="localvariable">paragraphs</span>));<span class="keyword">var</span><span class="variabledef">body</span>=<span class="variable">map</span>(<span class="variable">renderParagraph</span>, <span class="localvariable">paragraphs</span>).<span class="property">concat</span>(<span class="localvariable">footnotes</span>);<span class="keyword">return</span><span class="variable">renderHTML</span>(<span class="variable">htmlDoc</span>(<span class="localvariable">title</span>, <span class="localvariable">body</span>));}<span class="variable">viewHTML</span>(<span class="variable">renderFile</span>(<span class="variable">recluseFile</span>(), <span class="string">&quot;The Book of Programming&quot;</span>));</pre><p><a class="paragraph" href="#p44b9e2a4b2c6f4ee" name="p44b9e2a4b2c6f4ee"> ¶ </a>The <a name="key13"></a><code>concat</code> method of an array can be used to concatenate anotherarray to it, similar to what the <code>+</code> operator does with strings.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p38be59fe5e85639c" name="p38be59fe5e85639c"> ¶ </a>In the chapters after this one, elementary higher-order functions like<code>map</code> and <code>reduce</code> will always be available and will be used by codeexamples. Now and then, a new useful tool is added to this. In<a href="chapter9.html">chapter 9</a>, we develop a more structured approach to this set of'basic' functions.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p56acbb13d5ed03ef" name="p56acbb13d5ed03ef"> ¶ </a>When using higher-order functions, it is often annoying that operatorsare not functions in JavaScript. We have needed <code>add</code> or <code>equals</code>functions at several points. Rewriting these every time, you willagree, is a pain. From now on, we will assume the existence of anobject called <code>op</code>, which contains these functions:</p><pre class="code"><span class="keyword">var</span><span class="variable">op</span>={<span class="string">&quot;+&quot;</span>: <span class="keyword">function</span>(<span class="variabledef">a</span>, <span class="variabledef">b</span>){<span class="keyword">return</span><span class="localvariable">a</span> + <span class="localvariable">b</span>;}, <span class="string">&quot;==&quot;</span>: <span class="keyword">function</span>(<span class="variabledef">a</span>, <span class="variabledef">b</span>){<span class="keyword">return</span><span class="localvariable">a</span>==<span class="localvariable">b</span>;}, <span class="string">&quot;===&quot;</span>: <span class="keyword">function</span>(<span class="variabledef">a</span>, <span class="variabledef">b</span>){<span class="keyword">return</span><span class="localvariable">a</span>===<span class="localvariable">b</span>;}, <span class="string">&quot;!&quot;</span>: <span class="keyword">function</span>(<span class="variabledef">a</span>){<span class="keyword">return</span> !<span class="localvariable">a</span>;}<span class="comment">/* and so on */</span>};</pre><p><a class="paragraph" href="#pfeabae2909dca1b" name="pfeabae2909dca1b"> ¶ </a>So we can write <code>reduce(op[&quot;+&quot;], 0, [1, 2, 3, 4, 5])</code> to sum an array.But what if we need something like <code>equals</code> or <code>makeAddFunction</code>, inwhich one of the arguments already has a value? In that case we areback to writing a new function again.</p><p><a class="paragraph" href="#p7748cd15a29a68dd" name="p7748cd15a29a68dd"> ¶ </a>For cases like that, something called '<a name="key14"></a>partial application' isuseful. You want to create a new function that already knows some ofits arguments, and treats any additional arguments it is passed ascoming after these fixed arguments. This can be done by makingcreative use of the <code>apply</code> method of a function:</p><pre class="code"><span class="keyword">function</span><span class="variable">asArray</span>(<span class="variabledef">quasiArray</span>, <span class="variabledef">start</span>){<span class="keyword">var</span><span class="variabledef">result</span>=[];<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">i</span>=(<span class="localvariable">start</span> || <span class="atom">0</span>);<span class="localvariable">i</span> &lt;<span class="localvariable">quasiArray</span>.<span class="property">length</span>;<span class="localvariable">i</span>++) <span class="localvariable">result</span>.<span class="property">push</span>(<span class="localvariable">quasiArray</span>[<span class="localvariable">i</span>]);<span class="keyword">return</span><span class="localvariable">result</span>;}<span class="keyword">function</span><span class="variable">partial</span>(<span class="variabledef">func</span>){<span class="keyword">var</span><span class="variabledef">fixedArgs</span>=<span class="variable">asArray</span>(<span class="localvariable">arguments</span>, <span class="atom">1</span>);<span class="keyword">return</span><span class="keyword">function</span>(){<span class="keyword">return</span><span class="localvariable">func</span>.<span class="property">apply</span>(<span class="atom">null</span>, <span class="localvariable">fixedArgs</span>.<span class="property">concat</span>(<span class="variable">asArray</span>(<span class="localvariable">arguments</span>)));};}</pre><p><a class="paragraph" href="#pe9b122460ca0eee" name="pe9b122460ca0eee"> ¶ </a>We want to allow binding multiple arguments at the same time, so the<code>asArray</code> function is necessary to make normal arrays out of the<code>arguments</code> objects. It copies their content into a real array, sothat the <code>concat</code> method can be used on it. It also takes an optionalsecond argument, which can be used to leave out some arguments at thestart.</p><p><a class="paragraph" href="#p342f5837255ffd22" name="p342f5837255ffd22"> ¶ </a>Also note that it is necessary to store the <code>arguments</code> of the outerfunction (<code>partial</code>) into a variable with another name, becauseotherwise the inner function can not see them ― it has its own<code>arguments</code> variable, which shadows the one of the outer function.</p><p><a class="paragraph" href="#p78f7fd1997c68fae" name="p78f7fd1997c68fae"> ¶ </a>Now <code>equals(10)</code> could be written as <code>partial(op[&quot;==&quot;], 10)</code>, withoutthe need for a specialized <code>equals</code> function. And you can do thingslike this:</p><pre class="code"><span class="variable">show</span>(<span class="variable">map</span>(<span class="variable">partial</span>(<span class="variable">op</span>[<span class="string">&quot;+&quot;</span>], <span class="atom">1</span>), [<span class="atom">0</span>, <span class="atom">2</span>, <span class="atom">4</span>, <span class="atom">6</span>, <span class="atom">8</span>, <span class="atom">10</span>]));</pre><p><a class="paragraph" href="#p53b9ce7b99d38fa4" name="p53b9ce7b99d38fa4"> ¶ </a>The reason <code>map</code> takes its function argument before its array argumentis that it is often useful to partially apply map by giving it afunction. This 'lifts' the function from operating on a single valueto operating on an array of values. For example, if you have an arrayof arrays of numbers, and you want to square them all, you do this:</p><pre class="code"><span class="keyword">function</span><span class="variable">square</span>(<span class="variabledef">x</span>){<span class="keyword">return</span><span class="localvariable">x</span> * <span class="localvariable">x</span>;}<span class="variable">show</span>(<span class="variable">map</span>(<span class="variable">partial</span>(<span class="variable">map</span>, <span class="variable">square</span>), [[<span class="atom">10</span>, <span class="atom">100</span>], [<span class="atom">12</span>, <span class="atom">16</span>], [<span class="atom">0</span>, <span class="atom">1</span>]]));</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p185552a7e4f5ee01" name="p185552a7e4f5ee01"> ¶ </a>One last trick that can be useful when you want to combine functionsis <a name="key15"></a>function composition. At the start of this chapter I showed afunction <code>negate</code>, which applies the boolean <em>not</em> operator to theresult of calling a function:</p><pre class="code"><span class="keyword">function</span><span class="variable">negate</span>(<span class="variabledef">func</span>){<span class="keyword">return</span><span class="keyword">function</span>(){<span class="keyword">return</span> !<span class="localvariable">func</span>.<span class="property">apply</span>(<span class="atom">null</span>, <span class="localvariable">arguments</span>);};}</pre><p><a class="paragraph" href="#p63a12d097069c39a" name="p63a12d097069c39a"> ¶ </a>This is a special case of a general pattern: call function A, and thenapply function B to the result. Composition is a common concept inmathematics. <a name="key16"></a>It can be caught in a higher-order functionlike this:</p><pre class="code"><span class="keyword">function</span><span class="variable">compose</span>(<span class="variabledef">func1</span>, <span class="variabledef">func2</span>){<span class="keyword">return</span><span class="keyword">function</span>(){<span class="keyword">return</span><span class="localvariable">func1</span>(<span class="localvariable">func2</span>.<span class="property">apply</span>(<span class="atom">null</span>, <span class="localvariable">arguments</span>));};}<span class="keyword">var</span><span class="variable">isUndefined</span>=<span class="variable">partial</span>(<span class="variable">op</span>[<span class="string">&quot;===&quot;</span>], <span class="atom">undefined</span>);<span class="keyword">var</span><span class="variable">isDefined</span>=<span class="variable">compose</span>(<span class="variable">op</span>[<span class="string">&quot;!&quot;</span>], <span class="variable">isUndefined</span>);<span class="variable">show</span>(<span class="variable">isDefined</span>(<span class="variable">Math</span>.<span class="property">PI</span>));<span class="variable">show</span>(<span class="variable">isDefined</span>(<span class="variable">Math</span>.<span class="property">PIE</span>));</pre><p><a class="paragraph" href="#p6fe822fa5221ce46" name="p6fe822fa5221ce46"> ¶ </a>Here we are defining new functions without using the <code>function</code>keyword at all. This can be useful when you need to create a simplefunction to give to, for example, <code>map</code> or <code>reduce</code>. However, when afunction becomes more complex than these examples, it is usuallyshorter (not to mention more efficient) to just write it out with<code>function</code>.</p></div><ol class="footnotes"><li><a name="footnote1"></a>Like this...</li></ol><h1><span class="number">Chapter 7: </span>Searching</h1><div class="block"><p><a class="paragraph" href="#p52ee64062049491e" name="p52ee64062049491e"> ¶ </a>This chapter does not introduce any new JavaScript-specific concepts.Instead, we will go through the solution to two problems, discussingsome interesting algorithms and techniques along the way. If this doesnot sound interesting to you, it is safe to skip to the next chapter.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p14264f955a1c38a8" name="p14264f955a1c38a8"> ¶ </a>Let me introduce our first problem. Take a look at this map. It showsHiva Oa, a small tropical island in the Pacific Ocean.</p><div class="illustration"><img src="img/Hiva Oa.png"/></div><p><a class="paragraph" href="#p4f3e199a5c919c9f" name="p4f3e199a5c919c9f"> ¶ </a>The grey lines are roads, and the numbers next to them are the lengthsof these roads. Imagine we need a program that finds the shortestroute between two points on Hiva Oa. How could we approach that? Thinkabout this for a moment.</p><p><a class="paragraph" href="#p863b223f0b945eb" name="p863b223f0b945eb"> ¶ </a>No really. Don't just steamroll on to the next paragraph. Try toseriously think of some ways you could do this, and consider theissues you would come up against. When reading a technical book, it isway too easy to just zoom over the text, nod solemnly, and promptlyforget what you have read. If you make a sincere effort to solve aproblem, it becomes <em>your</em> problem, and its solution will be moremeaningful.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p10cd40c44817971" name="p10cd40c44817971"> ¶ </a>The first aspect of this problem is, again, representing our data. Theinformation in the picture does not mean much to our computer. Wecould try writing a program that looks at the map and extracts theinformation in it... but that can get complicated. If we hadtwenty-thousand maps to interpret, this would be a good idea, in thiscase we will do the interpretation ourself and transcribe the map intoa more computer-friendly format.</p><p><a class="paragraph" href="#p60b43058c8cb0bbe" name="p60b43058c8cb0bbe"> ¶ </a>What does our program need to know? It has to be able to look up whichlocations are connected, and how long the roads between them are. Theplaces and roads on the island form a <a name="key1"></a>graph, as mathematicians callit. There are many ways to store graphs. A simple possibility is tojust store an array of road objects, each of which contains propertiesnaming its two endpoints and its length...</p><pre class="code"><span class="keyword">var</span><span class="variable">roads</span>=[{<span class="property">point1</span>: <span class="string">&quot;Point Kiukiu&quot;</span>, <span class="property">point2</span>: <span class="string">&quot;Hanaiapa&quot;</span>, <span class="property">length</span>: <span class="atom">19</span>},{<span class="property">point1</span>: <span class="string">&quot;Point Kiukiu&quot;</span>, <span class="property">point2</span>: <span class="string">&quot;Mt Feani&quot;</span>, <span class="property">length</span>: <span class="atom">15</span>}<span class="comment">/* and so on */</span>];</pre><p><a class="paragraph" href="#p4427d7bd1c17ee6a" name="p4427d7bd1c17ee6a"> ¶ </a>However, it turns out that the program, as it is working out a route,will very often need to get a list of all the roads that start at acertain location, like a person standing on a crossroads will look ata signpost and read &quot;Hanaiapa: 19km, Mount Feani: 15km&quot;. It would benice if this was easy (and quick) to do.</p><p><a class="paragraph" href="#p469cbb764dda878c" name="p469cbb764dda878c"> ¶ </a>With the representation given above, we have to sift through the wholelist of roads, picking out the relevant ones, every time we want thissignpost list. A better approach would be to store this list directly.For example, use an object that associates place-names with signpostlists:</p><pre class="code"><span class="keyword">var</span><span class="variable">roads</span>={<span class="string">&quot;Point Kiukiu&quot;</span>: [{<span class="property">to</span>: <span class="string">&quot;Hanaiapa&quot;</span>, <span class="property">distance</span>: <span class="atom">19</span>},{<span class="property">to</span>: <span class="string">&quot;Mt Feani&quot;</span>, <span class="property">distance</span>: <span class="atom">15</span>},{<span class="property">to</span>: <span class="string">&quot;Taaoa&quot;</span>, <span class="property">distance</span>: <span class="atom">15</span>}], <span class="string">&quot;Taaoa&quot;</span>: [<span class="comment">/* et cetera */</span>]};</pre><p><a class="paragraph" href="#p6a0a21645ee7ef1d" name="p6a0a21645ee7ef1d"> ¶ </a>When we have this object, getting the roads that leave from PointKiukiu is just a matter of looking at <code>roads[&quot;Point Kiukiu&quot;]</code>.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p18358b5e37d6e44d" name="p18358b5e37d6e44d"> ¶ </a>However, this new representation does contain duplicate information:The road between A and B is listed both under A and under B. The firstrepresentation was already a lot of work to type in, this one is evenworse.</p><p><a class="paragraph" href="#p32b789b4141e2041" name="p32b789b4141e2041"> ¶ </a>Fortunately, we have at our command the computer's talent forrepetitive work. We can specify the roads once, and have the correctdata structure be generated by the computer. First, initialise anempty object called <code>roads</code>, and write a function <code>makeRoad</code>:</p><pre class="code"><span class="keyword">var</span><span class="variable">roads</span>={};<span class="keyword">function</span><span class="variable">makeRoad</span>(<span class="variabledef">from</span>, <span class="variabledef">to</span>, <span class="variabledef">length</span>){<span class="keyword">function</span><span class="variabledef">addRoad</span>(<span class="variabledef">from</span>, <span class="variabledef">to</span>){<span class="keyword">if</span> (!(<span class="localvariable">from</span> in <span class="variable">roads</span>)) <span class="variable">roads</span>[<span class="localvariable">from</span>]=[];<span class="variable">roads</span>[<span class="localvariable">from</span>].<span class="property">push</span>({<span class="property">to</span>: <span class="localvariable">to</span>, <span class="property">distance</span>: <span class="localvariable">length</span>});}<span class="localvariable">addRoad</span>(<span class="localvariable">from</span>, <span class="localvariable">to</span>);<span class="localvariable">addRoad</span>(<span class="localvariable">to</span>, <span class="localvariable">from</span>);}</pre><p><a class="paragraph" href="#pf154c92fa6839c4" name="pf154c92fa6839c4"> ¶ </a>Nice, huh? Notice how the inner function, <code>addRoad</code>, uses the samenames (<code>from</code>, <code>to</code>) for its parameters as the outer function. Thesewill not interfere: inside <code>addRoad</code> they refer to <code>addRoad</code>'sparameters, and outside it they refer to <code>makeRoad</code>'s parameters.</p><p><a class="paragraph" href="#p398ae48177d16e36" name="p398ae48177d16e36"> ¶ </a>The <code>if</code> statement in <code>addRoad</code> makes sure that there is an array ofdestinations associated with the location named by <code>from</code>, if thereisn't already one it puts in an empty array. This way, the next linecan assume there is such an array and safely push the new road ontoit.</p><p><a class="paragraph" href="#p480e2c025d9e925c" name="p480e2c025d9e925c"> ¶ </a>Now the map information looks like this:</p><pre class="code"><span class="variable">makeRoad</span>(<span class="string">&quot;Point Kiukiu&quot;</span>, <span class="string">&quot;Hanaiapa&quot;</span>, <span class="atom">19</span>);<span class="variable">makeRoad</span>(<span class="string">&quot;Point Kiukiu&quot;</span>, <span class="string">&quot;Mt Feani&quot;</span>, <span class="atom">15</span>);<span class="variable">makeRoad</span>(<span class="string">&quot;Point Kiukiu&quot;</span>, <span class="string">&quot;Taaoa&quot;</span>, <span class="atom">15</span>);<span class="comment">// ...</span></pre></div><hr/><div class="block"><a name="exercise1"></a><div class="exercisenum">Ex. 7.1</div><div class="exercise"><p><a class="paragraph" href="#p7164d49e80109cfc" name="p7164d49e80109cfc"> ¶ </a>In the above description, the string <code>&quot;Point Kiukiu&quot;</code> still occursthree times in a row. We could make our description even more succinctby allowing multiple roads to be specified in one line.</p><p><a class="paragraph" href="#p34c12b1ed0610689" name="p34c12b1ed0610689"> ¶ </a>Write a function <code>makeRoads</code> that takes any uneven number ofarguments. The first argument is always the starting point of theroads, and every pair of arguments after that gives an ending pointand a distance.</p><p><a class="paragraph" href="#p57e725f47ce6a1c3" name="p57e725f47ce6a1c3"> ¶ </a>Do not duplicate the functionality of <code>makeRoad</code>, but have <code>makeRoads</code>call <code>makeRoad</code> to do the actual road-making.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">makeRoads</span>(<span class="variabledef">start</span>){<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">i</span>=<span class="atom">1</span>;<span class="localvariable">i</span> &lt;<span class="localvariable">arguments</span>.<span class="property">length</span>;<span class="localvariable">i</span> +=<span class="atom">2</span>) <span class="variable">makeRoad</span>(<span class="localvariable">start</span>, <span class="localvariable">arguments</span>[<span class="localvariable">i</span>], <span class="localvariable">arguments</span>[<span class="localvariable">i</span> + <span class="atom">1</span>]);}</pre><p><a class="paragraph" href="#p739a02fa780d1691" name="p739a02fa780d1691"> ¶ </a>This function uses one named parameter, <code>start</code>, and gets the otherparameters from the <code>arguments</code> (quasi-) array. <code>i</code> starts at <code>1</code>because it has to skip this first parameter. <code>i +=2</code> is short for <code>i=i + 2</code>, as you might recall.</p><pre class="code"><span class="keyword">var</span><span class="variable">roads</span>={};<span class="variable">makeRoads</span>(<span class="string">&quot;Point Kiukiu&quot;</span>, <span class="string">&quot;Hanaiapa&quot;</span>, <span class="atom">19</span>, <span class="string">&quot;Mt Feani&quot;</span>, <span class="atom">15</span>, <span class="string">&quot;Taaoa&quot;</span>, <span class="atom">15</span>);<span class="variable">makeRoads</span>(<span class="string">&quot;Airport&quot;</span>, <span class="string">&quot;Hanaiapa&quot;</span>, <span class="atom">6</span>, <span class="string">&quot;Mt Feani&quot;</span>, <span class="atom">5</span>, <span class="string">&quot;Atuona&quot;</span>, <span class="atom">4</span>, <span class="string">&quot;Mt Ootua&quot;</span>, <span class="atom">11</span>);<span class="variable">makeRoads</span>(<span class="string">&quot;Mt Temetiu&quot;</span>, <span class="string">&quot;Mt Feani&quot;</span>, <span class="atom">8</span>, <span class="string">&quot;Taaoa&quot;</span>, <span class="atom">4</span>);<span class="variable">makeRoads</span>(<span class="string">&quot;Atuona&quot;</span>, <span class="string">&quot;Taaoa&quot;</span>, <span class="atom">3</span>, <span class="string">&quot;Hanakee pearl lodge&quot;</span>, <span class="atom">1</span>);<span class="variable">makeRoads</span>(<span class="string">&quot;Cemetery&quot;</span>, <span class="string">&quot;Hanakee pearl lodge&quot;</span>, <span class="atom">6</span>, <span class="string">&quot;Mt Ootua&quot;</span>, <span class="atom">5</span>);<span class="variable">makeRoads</span>(<span class="string">&quot;Hanapaoa&quot;</span>, <span class="string">&quot;Mt Ootua&quot;</span>, <span class="atom">3</span>);<span class="variable">makeRoads</span>(<span class="string">&quot;Puamua&quot;</span>, <span class="string">&quot;Mt Ootua&quot;</span>, <span class="atom">13</span>, <span class="string">&quot;Point Teohotepapapa&quot;</span>, <span class="atom">14</span>);<span class="variable">show</span>(<span class="variable">roads</span>[<span class="string">&quot;Airport&quot;</span>]);</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p5722f0720bebfc58" name="p5722f0720bebfc58"> ¶ </a>We managed to considerably shorten our description of theroad-information by defining some convenient operations. You could saywe expressed the information more succinctly by expanding ourvocabulary. <a name="key2"></a>Defining a 'little language'like this is often a very powerful technique ― when, at any time, youfind yourself writing repetitive or redundant code, stop and try tocome up with a vocabulary that makes it shorter and denser.</p><p><a class="paragraph" href="#p5bcecb670274fb56" name="p5bcecb670274fb56"> ¶ </a>Redundant code is not only a bore to write, it is also error-prone,people pay less attention when doing something that doesn't requirethem to think. On top of that, repetitive code is hard to change,because structure that is repeated a hundred times has to be changed ahundred times when it turns out to be incorrect or suboptimal.</p></div><hr/><div class="block"><p><a class="paragraph" href="#pb859cf5c2d6f2fd" name="pb859cf5c2d6f2fd"> ¶ </a>If you ran all the pieces of code above, you should now have avariable named <code>roads</code> that contains all the roads on the island. Whenwe need the roads starting from a certain place, we could just do<code>roads[place]</code>. But then, when someone makes a typo in a place name,which is not unlikely with these names, he will get <code>undefined</code>instead of the array he expects, and strange errors will follow.Instead, we will use a function that retrieves the road arrays, andyells at us when we give it an unknown place name:</p><pre class="code"><span class="keyword">function</span><span class="variable">roadsFrom</span>(<span class="variabledef">place</span>){<span class="keyword">var</span><span class="variabledef">found</span>=<span class="variable">roads</span>[<span class="localvariable">place</span>];<span class="keyword">if</span> (<span class="localvariable">found</span>==<span class="atom">undefined</span>) <span class="keyword">throw</span><span class="keyword">new</span><span class="variable">Error</span>(<span class="string">&quot;No place named '&quot;</span> + <span class="localvariable">place</span> + <span class="string">&quot;' found.&quot;</span>);<span class="keyword">else</span><span class="keyword">return</span><span class="localvariable">found</span>;}<span class="variable">show</span>(<span class="variable">roadsFrom</span>(<span class="string">&quot;Puamua&quot;</span>));</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p1e5bca09b5aefa17" name="p1e5bca09b5aefa17"> ¶ </a>Here is a first stab at a path-finding algorithm, the gambler's method:</p><pre class="code"><span class="keyword">function</span><span class="variable">gamblerPath</span>(<span class="variabledef">from</span>, <span class="variabledef">to</span>){<span class="keyword">function</span><span class="variabledef">randomInteger</span>(<span class="variabledef">below</span>){<span class="keyword">return</span><span class="variable">Math</span>.<span class="property">floor</span>(<span class="variable">Math</span>.<span class="property">random</span>() * <span class="localvariable">below</span>);}<span class="keyword">function</span><span class="variabledef">randomDirection</span>(<span class="variabledef">from</span>){<span class="keyword">var</span><span class="variabledef">options</span>=<span class="variable">roadsFrom</span>(<span class="localvariable">from</span>);<span class="keyword">return</span><span class="localvariable">options</span>[<span class="localvariable">randomInteger</span>(<span class="localvariable">options</span>.<span class="property">length</span>)].<span class="property">to</span>;}<span class="keyword">var</span><span class="variabledef">path</span>=[];<span class="keyword">while</span> (<span class="atom">true</span>){<span class="localvariable">path</span>.<span class="property">push</span>(<span class="localvariable">from</span>);<span class="keyword">if</span> (<span class="localvariable">from</span>==<span class="localvariable">to</span>) <span class="keyword">break</span>;<span class="localvariable">from</span>=<span class="localvariable">randomDirection</span>(<span class="localvariable">from</span>);}<span class="keyword">return</span><span class="localvariable">path</span>;}<span class="variable">show</span>(<span class="variable">gamblerPath</span>(<span class="string">&quot;Hanaiapa&quot;</span>, <span class="string">&quot;Mt Feani&quot;</span>));</pre><p><a class="paragraph" href="#p4d05527b8c74ee0d" name="p4d05527b8c74ee0d"> ¶ </a>At every split in the road, the gambler rolls his dice to decide whichroad he shall take. If the dice sends him back the way he came, so beit. Sooner or later, he will arrive at his destination, since allplaces on the island are connected by roads.</p><p><a class="paragraph" href="#p3f973913a349c411" name="p3f973913a349c411"> ¶ </a>The most confusing line is probably the one containing<a name="key3"></a><code>Math.random</code>. This function returns a pseudo-random<a class="footref" href="#footnote1">1</a> numberbetween 0 and 1. Try calling it a few times from the console, it will(most likely) give you a different number every time. The function<code>randomInteger</code> multiplies this number by the argument it is given,and rounds the result down with <code>Math.floor</code>. Thus, for example,<code>randomInteger(3)</code> will produce the number <code>0</code>, <code>1</code>, or <code>2</code>.</p></div><hr/><div class="block"><p><a class="paragraph" href="#pe69ef526948e099" name="pe69ef526948e099"> ¶ </a>The gambler's method is the way to go for those who abhor structureand planning, who desperately search for adventure. We set out towrite a program that could find the <em>shortest</em> route between placesthough, so something else will be needed.</p><p><a class="paragraph" href="#p44756e2f577b7a69" name="p44756e2f577b7a69"> ¶ </a>A very straightforward approach to solving such a problem is called'<a name="key4"></a>generate and test'. It goes like this:</p><ol><li>Generate all possible routes.</li><li>In this set, find the shortest one that actually connects the start point to the end point.</li></ol><p><a class="paragraph" href="#p74f159b15463fb19" name="p74f159b15463fb19"> ¶ </a>Step two is not hard. Step one is a little problematic. If you allowroutes with circles in them, there is an infinite amount of routes. Ofcourse, routes with circles in them are unlikely to be the shortestroute to anywhere, and routes that do not start at the start point donot have to be considered either. For a small graph like Hiva Oa, itshould be possible to generate all non-cyclic (circle-free) routesstarting from a certain point.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p145242a550d748c8" name="p145242a550d748c8"> ¶ </a>But first, we will need some new tools. The first is a function named<code>member</code>, which is used to determine whether an element is foundwithin an array. The route will be kept as an array of names, and whenarriving at a new place, the algorithm calls <code>member</code> to check whetherwe have been at that place already. It could look like this:</p><pre class="code"><span class="keyword">function</span><span class="variable">member</span>(<span class="variabledef">array</span>, <span class="variabledef">value</span>){<span class="keyword">var</span><span class="variabledef">found</span>=<span class="atom">false</span>;<span class="variable">forEach</span>(<span class="localvariable">array</span>, <span class="keyword">function</span>(<span class="variabledef">element</span>){<span class="keyword">if</span> (<span class="localvariable">element</span>===<span class="localvariable">value</span>) <span class="localvariable">found</span>=<span class="atom">true</span>;});<span class="keyword">return</span><span class="localvariable">found</span>;}<span class="variable">print</span>(<span class="variable">member</span>([<span class="atom">6</span>, <span class="atom">7</span>, <span class="string">&quot;Bordeaux&quot;</span>], <span class="atom">7</span>));</pre><p><a class="paragraph" href="#p49342b38f17b6aca" name="p49342b38f17b6aca"> ¶ </a>However, this will go over the whole array, even if the value is foundimmediately at the first position. What wastefulness. When using a<code>for</code> loop, you can use the <code>break</code> statement to jump out of it, butin a <code>forEach</code> construct this will not work, because the body of theloop is a function, and <code>break</code> statements do not jump out offunctions. One solution could be to adjust <code>forEach</code> to recognise acertain kind of exceptions as signalling a break.</p><pre class="code"><span class="keyword">var</span><span class="variable">Break</span>={<span class="property">toString</span>: <span class="keyword">function</span>(){<span class="keyword">return</span><span class="string">&quot;Break&quot;</span>;}};<span class="keyword">function</span><span class="variable">forEach</span>(<span class="variabledef">array</span>, <span class="variabledef">action</span>){<span class="keyword">try</span>{<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">i</span>=<span class="atom">0</span>;<span class="localvariable">i</span> &lt;<span class="localvariable">array</span>.<span class="property">length</span>;<span class="localvariable">i</span>++) <span class="localvariable">action</span>(<span class="localvariable">array</span>[<span class="localvariable">i</span>]);}<span class="keyword">catch</span> (<span class="variabledef">exception</span>){<span class="keyword">if</span> (<span class="localvariable">exception</span> !=<span class="variable">Break</span>) <span class="keyword">throw</span><span class="localvariable">exception</span>;}}</pre><p><a class="paragraph" href="#p3074f95998f948d0" name="p3074f95998f948d0"> ¶ </a>Now, if the <code>action</code> function throws <code>Break</code>, <code>forEach</code> will absorbthe exception and stop looping. The object stored in the variable<code>Break</code> is used purely as a thing to compare with. The only reason Igave it a <code>toString</code> property is that this might be useful to figureout what kind of strange value you are dealing with if you somehow endup with a <code>Break</code> exception outside of a <code>forEach</code>.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p33f341c6a34dd74f" name="p33f341c6a34dd74f"> ¶ </a>Having a way to break out of <code>forEach</code> loops can be very useful, butin the case of the <code>member</code> function the result is still rather ugly,because you need to specifically store the result and later return it.We could add yet another kind of exception, <code>Return</code>, which can begiven a <code>value</code> property, and have <code>forEach</code> return this value whensuch an exception is thrown, but this would be terribly ad-hoc andmessy. What we really need is a whole new higher-order function,called <a name="key5"></a><code>any</code> (or sometimes <code>some</code>). It looks like this:</p><pre class="code"><span class="keyword">function</span><span class="variable">any</span>(<span class="variabledef">test</span>, <span class="variabledef">array</span>){<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">i</span>=<span class="atom">0</span>;<span class="localvariable">i</span> &lt;<span class="localvariable">array</span>.<span class="property">length</span>;<span class="localvariable">i</span>++){<span class="keyword">var</span><span class="variabledef">found</span>=<span class="localvariable">test</span>(<span class="localvariable">array</span>[<span class="localvariable">i</span>]);<span class="keyword">if</span> (<span class="localvariable">found</span>) <span class="keyword">return</span><span class="localvariable">found</span>;}<span class="keyword">return</span><span class="atom">false</span>;}<span class="keyword">function</span><span class="variable">member</span>(<span class="variabledef">array</span>, <span class="variabledef">value</span>){<span class="keyword">return</span><span class="variable">any</span>(<span class="variable">partial</span>(<span class="variable">op</span>[<span class="string">&quot;===&quot;</span>], <span class="localvariable">value</span>), <span class="localvariable">array</span>);}<span class="variable">print</span>(<span class="variable">member</span>([<span class="string">&quot;Fear&quot;</span>, <span class="string">&quot;Loathing&quot;</span>], <span class="string">&quot;Denial&quot;</span>));</pre><p><a class="paragraph" href="#p4bf8bb60fb252f3e" name="p4bf8bb60fb252f3e"> ¶ </a><code>any</code> goes over the elements in an array, from left to right, andapplies the test function to them. The first time this returns atrue-ish value, it returns that value. If no true-ish value is found,<code>false</code> is returned. Calling <code>any(test, array)</code> is more or lessequivalent to doing <code>test(array[0]) || test(array[1]) || ...</code>etcetera.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p634754d27023742a" name="p634754d27023742a"> ¶ </a>Just like <code>&amp;&amp;</code> is the companion of <code>||</code>, <code>any</code> has a companion called<a name="key6"></a><code>every</code>:</p><pre class="code"><span class="keyword">function</span><span class="variable">every</span>(<span class="variabledef">test</span>, <span class="variabledef">array</span>){<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">i</span>=<span class="atom">0</span>;<span class="localvariable">i</span> &lt;<span class="localvariable">array</span>.<span class="property">length</span>;<span class="localvariable">i</span>++){<span class="keyword">var</span><span class="variabledef">found</span>=<span class="localvariable">test</span>(<span class="localvariable">array</span>[<span class="localvariable">i</span>]);<span class="keyword">if</span> (!<span class="localvariable">found</span>) <span class="keyword">return</span><span class="localvariable">found</span>;}<span class="keyword">return</span><span class="atom">true</span>;}<span class="variable">show</span>(<span class="variable">every</span>(<span class="variable">partial</span>(<span class="variable">op</span>[<span class="string">&quot;!=&quot;</span>], <span class="atom">0</span>), [<span class="atom">1</span>, <span class="atom">2</span>, -<span class="atom">1</span>]));</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p25577b9a2fefc6bd" name="p25577b9a2fefc6bd"> ¶ </a>Another function we will need is <code>flatten</code>. This function takes anarray of arrays, and puts the elements of the arrays together in onebig array.</p><pre class="code"><span class="keyword">function</span><span class="variable">flatten</span>(<span class="variabledef">arrays</span>){<span class="keyword">var</span><span class="variabledef">result</span>=[];<span class="variable">forEach</span>(<span class="localvariable">arrays</span>, <span class="keyword">function</span> (<span class="variabledef">array</span>){<span class="variable">forEach</span>(<span class="localvariable">array</span>, <span class="keyword">function</span> (<span class="variabledef">element</span>){<span class="localvariable">result</span>.<span class="property">push</span>(<span class="localvariable">element</span>);});});<span class="keyword">return</span><span class="localvariable">result</span>;}</pre><p><a class="paragraph" href="#p420e7218c62b54aa" name="p420e7218c62b54aa"> ¶ </a>The same could have been done using the <code>concat</code> method and some kindof <code>reduce</code>, but this would be less efficient. Just like repeatedlyconcatenating strings together is slower than putting them into anarray and then calling <code>join</code>, repeatedly concatenating arraysproduces a lot of unnecessary intermediary array values.</p></div><hr/><div class="block"><a name="exercise2"></a><div class="exercisenum">Ex. 7.2</div><div class="exercise"><p><a class="paragraph" href="#p4195e954f55beb3a" name="p4195e954f55beb3a"> ¶ </a>Before starting to generate routes, we need one more higher-orderfunction. This one is called <a name="key7"></a><code>filter</code>. Like <code>map</code>, it takes afunction and an array as arguments, and produces a new array, butinstead of putting the results of calling the function in the newarray, it produces an array with only those values from the old arrayfor which the given function returns a true-like value. Write thisfunction.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">filter</span>(<span class="variabledef">test</span>, <span class="variabledef">array</span>){<span class="keyword">var</span><span class="variabledef">result</span>=[];<span class="variable">forEach</span>(<span class="localvariable">array</span>, <span class="keyword">function</span> (<span class="variabledef">element</span>){<span class="keyword">if</span> (<span class="localvariable">test</span>(<span class="localvariable">element</span>)) <span class="localvariable">result</span>.<span class="property">push</span>(<span class="localvariable">element</span>);});<span class="keyword">return</span><span class="localvariable">result</span>;}<span class="variable">show</span>(<span class="variable">filter</span>(<span class="variable">partial</span>(<span class="variable">op</span>[<span class="string">&quot;&gt;&quot;</span>], <span class="atom">5</span>), [<span class="atom">0</span>, <span class="atom">4</span>, <span class="atom">8</span>, <span class="atom">12</span>]));</pre><p><a class="paragraph" href="#p600d990341cb6b99" name="p600d990341cb6b99"> ¶ </a>(If the result of that application of <code>filter</code> surprises you, rememberthat the argument given to <code>partial</code> is used as the <em>first</em> argumentof the function, so it ends up to the left of the <code>&gt;</code>.)</p></div></div><hr/><div class="block"><p><a class="paragraph" href="#p62dacdece974027c" name="p62dacdece974027c"> ¶ </a>Imagine what an algorithm to generate routes would look like ― itstarts at the starting location, and starts to generate a route forevery road leaving there. At the end of each of these roads itcontinues to generate more routes. It doesn't run along one road, itbranches out. Because of this, <a name="key8"></a>recursion is a natural way to modelit.</p><pre class="code"><span class="keyword">function</span><span class="variable">possibleRoutes</span>(<span class="variabledef">from</span>, <span class="variabledef">to</span>){<span class="keyword">function</span><span class="variabledef">findRoutes</span>(<span class="variabledef">route</span>){<span class="keyword">function</span><span class="variabledef">notVisited</span>(<span class="variabledef">road</span>){<span class="keyword">return</span> !<span class="variable">member</span>(<span class="localvariable">route</span>.<span class="property">places</span>, <span class="localvariable">road</span>.<span class="property">to</span>);}<span class="keyword">function</span><span class="variabledef">continueRoute</span>(<span class="variabledef">road</span>){<span class="keyword">return</span><span class="localvariable">findRoutes</span>({<span class="property">places</span>: <span class="localvariable">route</span>.<span class="property">places</span>.<span class="property">concat</span>([<span class="localvariable">road</span>.<span class="property">to</span>]), <span class="property">length</span>: <span class="localvariable">route</span>.<span class="property">length</span> + <span class="localvariable">road</span>.<span class="property">distance</span>});}<span class="keyword">var</span><span class="variabledef">end</span>=<span class="localvariable">route</span>.<span class="property">places</span>[<span class="localvariable">route</span>.<span class="property">places</span>.<span class="property">length</span> - <span class="atom">1</span>];<span class="keyword">if</span> (<span class="localvariable">end</span>==<span class="localvariable">to</span>) <span class="keyword">return</span> [<span class="localvariable">route</span>];<span class="keyword">else</span><span class="keyword">return</span><span class="variable">flatten</span>(<span class="variable">map</span>(<span class="localvariable">continueRoute</span>, <span class="variable">filter</span>(<span class="localvariable">notVisited</span>, <span class="variable">roadsFrom</span>(<span class="localvariable">end</span>))));}<span class="keyword">return</span><span class="localvariable">findRoutes</span>({<span class="property">places</span>: [<span class="localvariable">from</span>], <span class="property">length</span>: <span class="atom">0</span>});}<span class="variable">show</span>(<span class="variable">possibleRoutes</span>(<span class="string">&quot;Point Teohotepapapa&quot;</span>, <span class="string">&quot;Point Kiukiu&quot;</span>).<span class="property">length</span>);<span class="variable">show</span>(<span class="variable">possibleRoutes</span>(<span class="string">&quot;Hanapaoa&quot;</span>, <span class="string">&quot;Mt Ootua&quot;</span>));</pre><p><a class="paragraph" href="#p387f53b9b4c55332" name="p387f53b9b4c55332"> ¶ </a>The function returns an array of route objects, each of which containsan array of places that the route passes, and a length. <code>findRoutes</code>recursively continues a route, returning an array with every possibleextension of that route. When the end of a route is the place where wewant to go, it just returns that route, since continuing past thatplace would be pointless. If it is another place, we must go on. The<code>flatten</code>/<code>map</code>/<code>filter</code> line is probably the hardest to read. This iswhat it says: 'Take all the roads going from the current location,discard the ones that go to places that this route has alreadyvisited. Continue each of these roads, which will give an array offinished routes for each of them, then put all these routes into asingle big array that we return.'</p><p><a class="paragraph" href="#p60218e4263e58450" name="p60218e4263e58450"> ¶ </a>That line does a lot. This is why good abstractions help: They allowyou to say complicated things without typing screenfulls of code.</p><p><a class="paragraph" href="#p162cf311167c8212" name="p162cf311167c8212"> ¶ </a>Doesn't this recurse forever, seeing how it keeps calling itself (via<code>continueRoute</code>)? No, at some point, all outgoing roads will go toplaces that a route has already passed, and the result of <code>filter</code>will be an empty array. Mapping over an empty array produces an emptyarray, and flattening that still gives an empty array. So calling<code>findRoutes</code> on a dead end produces an empty array, meaning 'there areno ways to continue this route'.</p><p><a class="paragraph" href="#p11bdf742e1ec64d1" name="p11bdf742e1ec64d1"> ¶ </a>Notice that places are appended to routes by using <a name="key9"></a><code>concat</code>, not<a name="key10"></a><code>push</code>. The <code>concat</code> method creates a new array, while <code>push</code>modifies the existing array. Because the function might branch offseveral routes from a single partial route, we must not modify thearray that represents the original route, because it must be usedseveral times.</p></div><hr/><div class="block"><a name="exercise3"></a><div class="exercisenum">Ex. 7.3</div><div class="exercise"><p><a class="paragraph" href="#p113c68095cc0f450" name="p113c68095cc0f450"> ¶ </a>Now that we have all possible routes, let us try to find the shortestone. Write a function <code>shortestRoute</code> that, like <code>possibleRoutes</code>,takes the names of a starting and ending location as arguments. Itreturns a single route object, of the type that <code>possibleRoutes</code>produces.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">shortestRoute</span>(<span class="variabledef">from</span>, <span class="variabledef">to</span>){<span class="keyword">var</span><span class="variabledef">currentShortest</span>=<span class="atom">null</span>;<span class="variable">forEach</span>(<span class="variable">possibleRoutes</span>(<span class="localvariable">from</span>, <span class="localvariable">to</span>), <span class="keyword">function</span>(<span class="variabledef">route</span>){<span class="keyword">if</span> (!<span class="localvariable">currentShortest</span> || <span class="localvariable">currentShortest</span>.<span class="property">length</span> &gt;<span class="localvariable">route</span>.<span class="property">length</span>) <span class="localvariable">currentShortest</span>=<span class="localvariable">route</span>;});<span class="keyword">return</span><span class="localvariable">currentShortest</span>;}</pre><p><a class="paragraph" href="#p6bd1ea7e4e1efe76" name="p6bd1ea7e4e1efe76"> ¶ </a>The tricky thing in 'minimising' or 'maximising' algorithms is to notscrew up when given an empty array. In this case, we happen to knowthat there is at least one road between every two places, so we couldjust ignore it. But that would be a bit lame. What if the road fromPuamua to Mount Ootua, which is steep and muddy, is washed away by arainstorm? It would be a shame if this caused our function to break aswell, so it takes care to return <code>null</code> when no routes are found.</p><p><a class="paragraph" href="#p30fff685a845eab9" name="p30fff685a845eab9"> ¶ </a>Then, the very functional, abstract-everything-we-can approach:</p><pre class="code"><span class="keyword">function</span><span class="variable">minimise</span>(<span class="variabledef">func</span>, <span class="variabledef">array</span>){<span class="keyword">var</span><span class="variabledef">minScore</span>=<span class="atom">null</span>;<span class="keyword">var</span><span class="variabledef">found</span>=<span class="atom">null</span>;<span class="variable">forEach</span>(<span class="localvariable">array</span>, <span class="keyword">function</span>(<span class="variabledef">element</span>){<span class="keyword">var</span><span class="variabledef">score</span>=<span class="localvariable">func</span>(<span class="localvariable">element</span>);<span class="keyword">if</span> (<span class="localvariable">minScore</span>==<span class="atom">null</span> || <span class="localvariable">score</span> &lt;<span class="localvariable">minScore</span>){<span class="localvariable">minScore</span>=<span class="localvariable">score</span>;<span class="localvariable">found</span>=<span class="localvariable">element</span>;}});<span class="keyword">return</span><span class="localvariable">found</span>;}<span class="keyword">function</span><span class="variable">getProperty</span>(<span class="variabledef">propName</span>){<span class="keyword">return</span><span class="keyword">function</span>(<span class="variabledef">object</span>){<span class="keyword">return</span><span class="localvariable">object</span>[<span class="localvariable">propName</span>];};}<span class="keyword">function</span><span class="variable">shortestRoute</span>(<span class="variabledef">from</span>, <span class="variabledef">to</span>){<span class="keyword">return</span><span class="variable">minimise</span>(<span class="variable">getProperty</span>(<span class="string">&quot;length&quot;</span>), <span class="variable">possibleRoutes</span>(<span class="localvariable">from</span>, <span class="localvariable">to</span>));}</pre><p><a class="paragraph" href="#p7d170cb50c40bf1c" name="p7d170cb50c40bf1c"> ¶ </a>Unfortunately, it is three times longer than the other version. Inprograms where you need to minimise several things it might be a goodidea to write the generic algorithm like this, so you can re-use it.In most cases the first version is probably good enough.</p><p><a class="paragraph" href="#p3d296aaee3135ce5" name="p3d296aaee3135ce5"> ¶ </a>Note the <a name="key11"></a><code>getProperty</code> function though, it is often useful whendoing functional programming with objects.</p></div></div><hr/><div class="block"><p><a class="paragraph" href="#p6cd3134a22b4e870" name="p6cd3134a22b4e870"> ¶ </a>Let us see what route our algorithm comes up with between Point Kiukiuand Point Teohotepapapa...</p><pre class="code"><span class="variable">show</span>(<span class="variable">shortestRoute</span>(<span class="string">&quot;Point Kiukiu&quot;</span>, <span class="string">&quot;Point Teohotepapapa&quot;</span>).<span class="property">places</span>);</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p3c100fea3e9f3555" name="p3c100fea3e9f3555"> ¶ </a>On a small island like Hiva Oa, it is not too much work to generateall possible routes. If you try to do that on a reasonably detailedmap of, say, Belgium, it is going to take an absurdly long time, notto mention an absurd amount of memory. Still, you have probably seenthose online route-planners. These give you a more or less optimalroute through a gigantic maze of roads in just a few seconds. How dothey do it?</p><p><a class="paragraph" href="#p1ec650eca82bbdbf" name="p1ec650eca82bbdbf"> ¶ </a>If you are paying attention, you may have noticed that it is notnecessary to generate all routes all the way to the end. If we startcomparing routes <em>while</em> we are building them, we can avoid buildingthis big set of routes, and, as soon as we have found a single routeto our destination, we can stop extending routes that are alreadylonger than that route.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p1b8d136b82118e91" name="p1b8d136b82118e91"> ¶ </a>To try this out, we will use a 20 by 20 grid as our map:</p><div class="illustration"><img src="img/height.png"/></div><p><a class="paragraph" href="#p179740b3947d7bde" name="p179740b3947d7bde"> ¶ </a>What you see here is an elevation map of a mountain landscape. Theyellow spots are the peaks, and the blue spots the valleys. The areais divided into squares with a size of a hundred meters. We have atour disposal a function <code>heightAt</code>, which can give us the height, inmeters, of any square on that map, where squares are represented byobjects with <code>x</code> and <code>y</code> properties.</p><pre class="code"><span class="variable">print</span>(<span class="variable">heightAt</span>({<span class="property">x</span>: <span class="atom">0</span>, <span class="property">y</span>: <span class="atom">0</span>}));<span class="variable">print</span>(<span class="variable">heightAt</span>({<span class="property">x</span>: <span class="atom">11</span>, <span class="property">y</span>: <span class="atom">18</span>}));</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p646f6b1177112caf" name="p646f6b1177112caf"> ¶ </a>We want to cross this landscape, on foot, from the top left to thebottom right. A grid can be approached like a graph. Every square is anode, which is connected to the squares around it.</p><p><a class="paragraph" href="#p20bce21c7475a861" name="p20bce21c7475a861"> ¶ </a>We do not like wasting energy, so we would prefer to take the easiestroute possible. Going uphill is heavier than going downhill, and goingdownhill is heavier than going level<a class="footref" href="#footnote2">2</a>. This function calculates theamount of 'weighted meters', between two adjacent squares, whichrepresents how tired you get from walking (or climbing) between them.Going uphill is counted as twice as heavy as going downhill.</p><pre class="code"><span class="keyword">function</span><span class="variable">weightedDistance</span>(<span class="variabledef">pointA</span>, <span class="variabledef">pointB</span>){<span class="keyword">var</span><span class="variabledef">heightDifference</span>=<span class="variable">heightAt</span>(<span class="localvariable">pointB</span>) - <span class="variable">heightAt</span>(<span class="localvariable">pointA</span>);<span class="keyword">var</span><span class="variabledef">climbFactor</span>=(<span class="localvariable">heightDifference</span> &lt;<span class="atom">0</span> ? <span class="atom">1</span> : <span class="atom">2</span>);<span class="keyword">var</span><span class="variabledef">flatDistance</span>=(<span class="localvariable">pointA</span>.<span class="property">x</span>==<span class="localvariable">pointB</span>.<span class="property">x</span> || <span class="localvariable">pointA</span>.<span class="property">y</span>==<span class="localvariable">pointB</span>.<span class="property">y</span> ? <span class="atom">100</span> : <span class="atom">141</span>);<span class="keyword">return</span><span class="localvariable">flatDistance</span> + <span class="localvariable">climbFactor</span> * <span class="variable">Math</span>.<span class="property">abs</span>(<span class="localvariable">heightDifference</span>);}</pre><p><a class="paragraph" href="#p42069c51328e70b" name="p42069c51328e70b"> ¶ </a>Note the <code>flatDistance</code> calculation. If the two points are on the samerow or column, they are right next to each other, and the distancebetween them is a hundred meters. Otherwise, they are assumed tobe diagonally adjacent, and the diagonal distance between twosquares of this size is a hundred times the square root of two, whichis approximately <code>141</code>. One is not allowed to call this function forsquares that are further than one step apart. (It could double-checkthis... but it is too lazy.)</p></div><hr/><div class="block"><p><a class="paragraph" href="#p7e47d79c78483ec4" name="p7e47d79c78483ec4"> ¶ </a>Points on the map are represented by objects containing <code>x</code> and <code>y</code>properties. These three functions are useful when working with suchobjects:</p><pre class="code"><span class="keyword">function</span><span class="variable">point</span>(<span class="variabledef">x</span>, <span class="variabledef">y</span>){<span class="keyword">return</span>{<span class="property">x</span>: <span class="localvariable">x</span>, <span class="property">y</span>: <span class="localvariable">y</span>};}<span class="keyword">function</span><span class="variable">addPoints</span>(<span class="variabledef">a</span>, <span class="variabledef">b</span>){<span class="keyword">return</span><span class="variable">point</span>(<span class="localvariable">a</span>.<span class="property">x</span> + <span class="localvariable">b</span>.<span class="property">x</span>, <span class="localvariable">a</span>.<span class="property">y</span> + <span class="localvariable">b</span>.<span class="property">y</span>);}<span class="keyword">function</span><span class="variable">samePoint</span>(<span class="variabledef">a</span>, <span class="variabledef">b</span>){<span class="keyword">return</span><span class="localvariable">a</span>.<span class="property">x</span>==<span class="localvariable">b</span>.<span class="property">x</span> &amp;&amp;<span class="localvariable">a</span>.<span class="property">y</span>==<span class="localvariable">b</span>.<span class="property">y</span>;}<span class="variable">show</span>(<span class="variable">samePoint</span>(<span class="variable">addPoints</span>(<span class="variable">point</span>(<span class="atom">10</span>, <span class="atom">10</span>), <span class="variable">point</span>(<span class="atom">4</span>, -<span class="atom">2</span>)), <span class="variable">point</span>(<span class="atom">14</span>, <span class="atom">8</span>)));</pre></div><hr/><div class="block"><a name="exercise4"></a><div class="exercisenum">Ex. 7.4</div><div class="exercise"><p><a class="paragraph" href="#p49859a249a4b2656" name="p49859a249a4b2656"> ¶ </a>If we are going to find routes through this map, we will again need afunction to create 'signposts', lists of directions that can be takenfrom a given point. Write a function <code>possibleDirections</code>, which takesa point object as argument and returns an array of nearby points. Wecan only move to adjacent points, both straight and diagonally, sosquares have a maximum of eight neighbours. Take care not to returnsquares that lie outside of the map. For all we know the edge of themap might be the edge of the world.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">possibleDirections</span>(<span class="variabledef">from</span>){<span class="keyword">var</span><span class="variabledef">mapSize</span>=<span class="atom">20</span>;<span class="keyword">function</span><span class="variabledef">insideMap</span>(<span class="variabledef">point</span>){<span class="keyword">return</span><span class="localvariable">point</span>.<span class="property">x</span> &gt;=<span class="atom">0</span> &amp;&amp;<span class="localvariable">point</span>.<span class="property">x</span> &lt;<span class="localvariable">mapSize</span> &amp;&amp;<span class="localvariable">point</span>.<span class="property">y</span> &gt;=<span class="atom">0</span> &amp;&amp;<span class="localvariable">point</span>.<span class="property">y</span> &lt;<span class="localvariable">mapSize</span>;}<span class="keyword">var</span><span class="variabledef">directions</span>=[<span class="variable">point</span>(-<span class="atom">1</span>, <span class="atom">0</span>), <span class="variable">point</span>(<span class="atom">1</span>, <span class="atom">0</span>), <span class="variable">point</span>(<span class="atom">0</span>, -<span class="atom">1</span>), <span class="variable">point</span>(<span class="atom">0</span>, <span class="atom">1</span>), <span class="variable">point</span>(-<span class="atom">1</span>, -<span class="atom">1</span>), <span class="variable">point</span>(-<span class="atom">1</span>, <span class="atom">1</span>), <span class="variable">point</span>(<span class="atom">1</span>, <span class="atom">1</span>), <span class="variable">point</span>(<span class="atom">1</span>, -<span class="atom">1</span>)];<span class="keyword">return</span><span class="variable">filter</span>(<span class="localvariable">insideMap</span>, <span class="variable">map</span>(<span class="variable">partial</span>(<span class="variable">addPoints</span>, <span class="localvariable">from</span>), <span class="localvariable">directions</span>));}<span class="variable">show</span>(<span class="variable">possibleDirections</span>(<span class="variable">point</span>(<span class="atom">0</span>, <span class="atom">0</span>)));</pre><p><a class="paragraph" href="#p7c1a3e8412416bc8" name="p7c1a3e8412416bc8"> ¶ </a>I created a variable <code>mapSize</code>, for the sole purpose of not having towrite <code>20</code> two times. If, at some other time, we want to use this samefunction for another map, it would be clumsy if the code was full of<code>20</code>s, which all have to be changed. We could even go as far as makingthe <code>mapSize</code> an argument to <code>possibleDirections</code>, so we can use thefunction for different maps without changing it. I judged that thatwas not necessary in this case though, such things can always bechanged when the need arises.</p><p><a class="paragraph" href="#p5d2c9b5e70e2749d" name="p5d2c9b5e70e2749d"> ¶ </a>Then why didn't I also add a variable to hold the <code>0</code>, which alsooccurs two times? I assumed that maps always start at <code>0</code>, so this oneis unlikely to ever change, and using a variable for it only addsnoise.</p></div></div><hr/><div class="block"><p><a class="paragraph" href="#p70789a0cfb7a7a6a" name="p70789a0cfb7a7a6a"> ¶ </a>To find a route on this map without having our browser cut off theprogram because it takes too long to finish, we have to stop ouramateurish attempts and implement a serious algorithm. A lot of workhas gone into problems like this in the past, and many solutions havebeen designed (some brilliant, others useless). A very popular andefficient one is called <a name="key12"></a>A* (pronounced A-star). We will spend therest of the chapter implementing an A* route-finding function for ourmap.</p><p><a class="paragraph" href="#p3f39b88a3fe7ae6c" name="p3f39b88a3fe7ae6c"> ¶ </a>Before I get to the algorithm itself, let me tell you a bit more aboutthe problem it solves. The trouble with searching routes throughgraphs is that, in big graphs, there are an awful lot of them. OurHiva Oa path-finder showed that, when the graph is small, all we neededto do was to make sure our paths didn't revisit points they hadalready passed. On our new map, this is not enough anymore.</p><p><a class="paragraph" href="#p52128e90b57b21e9" name="p52128e90b57b21e9"> ¶ </a>The fundamental problem is that there is too much room for going inthe wrong direction. Unless we somehow manage to steer our explorationof paths towards the goal, a choice we make for continuing a givenpath is more likely to go in the wrong direction than in the rightdirection. If you keep generating paths like that, you end up with anenormous amount of paths, and even if one of them accidentally reachesthe end point, you do not know whether that is the shortest path.</p><p><a class="paragraph" href="#p19b4c229e6854121" name="p19b4c229e6854121"> ¶ </a>So what you want to do is explore directions that are likely to getyou to the end point first. On a grid like our map, you can get arough estimate of how good a path is by checking how long it is andhow close its end is to the end point. By adding path length and anestimate of the distance it still has to go, you can get a rough ideaof which paths are promising. If you extend promising paths first, youare less likely to waste time on useless ones.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p605aef04ef4aade7" name="p605aef04ef4aade7"> ¶ </a>But that still is not enough. If our map was of a perfectly flatplane, the path that looked promising would almost always be the bestone, and we could use the above method to walk right to our goal. Butwe have valleys and hillsides blocking our paths, so it is hard totell in advance which direction will be the most efficient path.Because of this, we still end up having to explore way too many paths.</p><p><a class="paragraph" href="#p7e13f30083397647" name="p7e13f30083397647"> ¶ </a>To correct this, we can make clever use of the fact that we areconstantly exploring the most promising path first. Once we havedetermined that path A is the best way to get to point X, we canremember that. When, later on, path B also gets to point X, we knowthat it is not the best route, so we do not have to explore itfurther. This can prevent our program from building a lot of pointlesspaths.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p4933e09f45bed7ec" name="p4933e09f45bed7ec"> ¶ </a>The algorithm, then, goes something like this...</p><p><a class="paragraph" href="#p7429b315086105d4" name="p7429b315086105d4"> ¶ </a>There are two pieces of data to keep track of. The first one is calledthe open list, it contains the partial routes that must still beexplored. Each route has a score, which is calculated by adding itslength to its estimated distance from the goal. This estimate mustalways be optimistic, it should never overestimate the distance. Thesecond is a set of nodes that we have seen, together with the shortestpartial route that got us there. This one we will call the reachedlist. We start by adding a route that contains only the starting nodeto the open list, and recording it in the reached list.</p><p><a class="paragraph" href="#p54f2f4829fa45297" name="p54f2f4829fa45297"> ¶ </a>Then, as long as there are any nodes in the open list, we take out theone that has the lowest (best) score, and find the ways in which itcan be continued (by calling <code>possibleDirections</code>). For each of thenodes this returns, we create a new route by appending it to ouroriginal route, and adjusting the length of the route using<code>weightedDistance</code>. The endpoint of each of these new routes is thenlooked up in the reached list.</p><p><a class="paragraph" href="#p225b77195287d4ca" name="p225b77195287d4ca"> ¶ </a>If the node is not in the reached list yet, it means we have not seenit before, and we add the new route to the open list and record it inthe reached list. If we <em>had</em> seen it before, we compare the score ofthe new route to the score of the route in the reached list. If thenew route is shorter, we replace the existing route with the new one.Otherwise, we discard the new route, since we have already seen abetter way to get to that point.</p><p><a class="paragraph" href="#p15f21832c000f5e4" name="p15f21832c000f5e4"> ¶ </a>We continue doing this until the route we fetch from the open listends at the goal node, in which case we have found our route, or untilthe open list is empty, in which case we have found out that there isno route. In our case the map contains no unsurmountable obstacles, sothere is always a route.</p><p><a class="paragraph" href="#p6e3b0a4bdd0b7c01" name="p6e3b0a4bdd0b7c01"> ¶ </a>How do we know that the first full route that we get from the openlist is also the shortest one? This is a result of the fact that weonly look at a route when it has the lowest score. The score of aroute is its actual length plus an <em>optimistic</em> estimate of theremaining length. This means that if a route has the lowest score inthe open list, it is always the best route to its current endpoint ―it is impossible for another route to later find a better way to thatpoint, because if it were better, its score would have been lower.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p14edd10217b17d31" name="p14edd10217b17d31"> ¶ </a>Try not to get frustrated when the fine points of why this works arestill eluding you. When thinking about algorithms like this, havingseen 'something like it' before helps a lot, it gives you a point ofreference to compare the approach to. Beginning programmers have to dowithout such a point of reference, which makes it rather easy to getlost. Just realise that this is advanced stuff, globally read over therest of the chapter, and come back to it later when you feel like achallenge.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p3adb16bcddeec555" name="p3adb16bcddeec555"> ¶ </a>I am afraid that, for one aspect of the algorithm, I'm going to haveto invoke magic again. The open list needs to be able to hold a largeamount of routes, and to quickly find the route with the lowest scoreamong them. Storing them in a normal array, and searching through thisarray every time, is way too slow, so I give you a data structurecalled a <a name="key13"></a>binary heap. You create them with <code>new</code>, just like <code>Date</code>objects, giving them a function that is used to 'score' its elementsas argument. The resulting object has the methods <code>push</code> and <code>pop</code>,just like an array, but <code>pop</code> always gives you the element with thelowest score, instead of the one that was <code>push</code>ed last.</p><pre class="code"><span class="keyword">function</span><span class="variable">identity</span>(<span class="variabledef">x</span>){<span class="keyword">return</span><span class="localvariable">x</span>;}<span class="keyword">var</span><span class="variable">heap</span>=<span class="keyword">new</span><span class="variable">BinaryHeap</span>(<span class="variable">identity</span>);<span class="variable">forEach</span>([<span class="atom">2</span>, <span class="atom">4</span>, <span class="atom">5</span>, <span class="atom">1</span>, <span class="atom">6</span>, <span class="atom">3</span>], <span class="keyword">function</span>(<span class="variabledef">number</span>){<span class="variable">heap</span>.<span class="property">push</span>(<span class="localvariable">number</span>);});<span class="keyword">while</span> (<span class="variable">heap</span>.<span class="property">size</span>() &gt;<span class="atom">0</span>) <span class="variable">show</span>(<span class="variable">heap</span>.<span class="property">pop</span>());</pre><p><a class="paragraph" href="#p5fbbf2e6f17b02f1" name="p5fbbf2e6f17b02f1"> ¶ </a><a href="appendix2.html">Appendix 2</a> discusses the implementation of this data structure,which is quite interesting. After you have read <a href="chapter8.html">chapter 8</a>, you might wantto take a look at it.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p65e5c2761132d409" name="p65e5c2761132d409"> ¶ </a>The need to squeeze out as much efficiency as we can has anothereffect. The Hiva Oa algorithm used arrays of locations to storeroutes, and copied them with the <code>concat</code> method when it extendedthem. This time, we can not afford to copy arrays, since we will beexploring lots and lots of routes. Instead, we use a 'chain' ofobjects to store a route. Every object in the chain has someproperties, such as a point on the map, and the length of the route sofar, and it also has a property that points at the previous object inthe chain. Something like this:</p><div class="illustration"><img src="img/objectchain.png"/></div><p><a class="paragraph" href="#p2c8aee6703ed2618" name="p2c8aee6703ed2618"> ¶ </a>Where the cyan circles are the relevant objects, and the linesrepresent properties ― the end with the dot points at the value ofthe property. Object <code>A</code> is the start of a route here. Object <code>B</code> isused to build a new route, which continues from <code>A</code>. It has aproperty, which we will call <code>from</code>, pointing at the route it is basedon. When we need to reconstruct a route later, we can follow theseproperties to find all the points that the route passed. Note thatobject <code>B</code> is part of two routes, one that ends in <code>D</code> and one thatends in <code>E</code>. When there are a lot of routes, this can save us muchstorage space ― every new route only needs one new object for itself,the rest is shared with other routes that started the same way.</p></div><hr/><div class="block"><a name="exercise5"></a><div class="exercisenum">Ex. 7.5</div><div class="exercise"><p><a class="paragraph" href="#p7a25220698e3520" name="p7a25220698e3520"> ¶ </a>Write a function <code>estimatedDistance</code> that gives an optimistic estimateof the distance between two points. It does not have to look at theheight data, but can assume a flat map. Remember that we are onlytravelling straight and diagonally, and that we are counting thediagonal distance between two squares as <code>141</code>.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">estimatedDistance</span>(<span class="variabledef">pointA</span>, <span class="variabledef">pointB</span>){<span class="keyword">var</span><span class="variabledef">dx</span>=<span class="variable">Math</span>.<span class="property">abs</span>(<span class="localvariable">pointA</span>.<span class="property">x</span> - <span class="localvariable">pointB</span>.<span class="property">x</span>), <span class="variabledef">dy</span>=<span class="variable">Math</span>.<span class="property">abs</span>(<span class="localvariable">pointA</span>.<span class="property">y</span> - <span class="localvariable">pointB</span>.<span class="property">y</span>);<span class="keyword">if</span> (<span class="localvariable">dx</span> &gt;<span class="localvariable">dy</span>) <span class="keyword">return</span> (<span class="localvariable">dx</span> - <span class="localvariable">dy</span>) * <span class="atom">100</span> + <span class="localvariable">dy</span> * <span class="atom">141</span>;<span class="keyword">else</span><span class="keyword">return</span> (<span class="localvariable">dy</span> - <span class="localvariable">dx</span>) * <span class="atom">100</span> + <span class="localvariable">dx</span> * <span class="atom">141</span>;}</pre><p><a class="paragraph" href="#p20a1cd2bad40a101" name="p20a1cd2bad40a101"> ¶ </a>The strange formulae are used to decompose the path into a straightand a diagonal part. If you have a path like this...</p><div class="illustration"><img src="img/diagonalpath.png"/></div><p><a class="paragraph" href="#p426979e25aaa7f4a" name="p426979e25aaa7f4a"> ¶ </a>... the path is <code>6</code> squares wide and <code>3</code> high, so you get <code>6 - 3=3</code>straight moves, and <code>3</code> diagonal ones.</p><p><a class="paragraph" href="#p1440313db1fcdc3a" name="p1440313db1fcdc3a"> ¶ </a>If you wrote a function that just computes the straight 'Pythagorean'distance between the points, that would also work. What we need is anoptimistic estimate, and assuming you can go straight to the goal iscertainly optimistic. However, the closer the estimate is to the realdistance, the less useless paths our program has to try out.</p></div></div><hr/><div class="block"><a name="exercise6"></a><div class="exercisenum">Ex. 7.6</div><div class="exercise"><p><a class="paragraph" href="#p32380721aaad37bb" name="p32380721aaad37bb"> ¶ </a>We will use a binary heap for the open list. What would be a good datastructure for the reached list? This one will be used to look uproutes, given a pair of <code>x</code>, <code>y</code> coordinates. Preferably in a way thatis fast. Write three functions, <code>makeReachedList</code>, <code>storeReached</code>, and<code>findReached</code>. The first one creates your data structure, the secondone, given a reached list, a point, and a route, stores a route in it,and the last one, given a reached list and point, retrieves a route orreturns <code>undefined</code> to indicate that no route was found for thatpoint.</p></div><div class="solution"><p><a class="paragraph" href="#p1ce74e87516850c1" name="p1ce74e87516850c1"> ¶ </a>One reasonable idea would be to use an object with objects in it. Oneof the coordinates in the points, say <code>x</code>, is used as a property namefor the outer object, and the other, <code>y</code>, for the inner object. Thisdoes require some bookkeeping to handle the fact that, sometimes, theinner object we are looking for is not there (yet).</p><pre class="code"><span class="keyword">function</span><span class="variable">makeReachedList</span>(){<span class="keyword">return</span>{};}<span class="keyword">function</span><span class="variable">storeReached</span>(<span class="variabledef">list</span>, <span class="variabledef">point</span>, <span class="variabledef">route</span>){<span class="keyword">var</span><span class="variabledef">inner</span>=<span class="localvariable">list</span>[<span class="localvariable">point</span>.<span class="property">x</span>];<span class="keyword">if</span> (<span class="localvariable">inner</span>==<span class="atom">undefined</span>){<span class="localvariable">inner</span>={};<span class="localvariable">list</span>[<span class="localvariable">point</span>.<span class="property">x</span>]=<span class="localvariable">inner</span>;}<span class="localvariable">inner</span>[<span class="localvariable">point</span>.<span class="property">y</span>]=<span class="localvariable">route</span>;}<span class="keyword">function</span><span class="variable">findReached</span>(<span class="variabledef">list</span>, <span class="variabledef">point</span>){<span class="keyword">var</span><span class="variabledef">inner</span>=<span class="localvariable">list</span>[<span class="localvariable">point</span>.<span class="property">x</span>];<span class="keyword">if</span> (<span class="localvariable">inner</span>==<span class="atom">undefined</span>) <span class="keyword">return</span><span class="atom">undefined</span>;<span class="keyword">else</span><span class="keyword">return</span><span class="localvariable">inner</span>[<span class="localvariable">point</span>.<span class="property">y</span>];}</pre><p><a class="paragraph" href="#p2f0ec4286f7e1d1f" name="p2f0ec4286f7e1d1f"> ¶ </a>Another possibility is to merge the <code>x</code> and <code>y</code> of the point into asingle property name, and use that to store routes in a single object.</p><pre class="code"><span class="keyword">function</span><span class="variable">pointID</span>(<span class="variabledef">point</span>){<span class="keyword">return</span><span class="localvariable">point</span>.<span class="property">x</span> + <span class="string">&quot;-&quot;</span> + <span class="localvariable">point</span>.<span class="property">y</span>;}<span class="keyword">function</span><span class="variable">makeReachedList</span>(){<span class="keyword">return</span>{};}<span class="keyword">function</span><span class="variable">storeReached</span>(<span class="variabledef">list</span>, <span class="variabledef">point</span>, <span class="variabledef">route</span>){<span class="localvariable">list</span>[<span class="variable">pointID</span>(<span class="localvariable">point</span>)]=<span class="localvariable">route</span>;}<span class="keyword">function</span><span class="variable">findReached</span>(<span class="variabledef">list</span>, <span class="variabledef">point</span>){<span class="keyword">return</span><span class="localvariable">list</span>[<span class="variable">pointID</span>(<span class="localvariable">point</span>)];}</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p170f0ddac20707cd" name="p170f0ddac20707cd"> ¶ </a><a name="key14"></a>Defining a type of data structure by providing a setof functions to create and manipulate such structures is a usefultechnique. It makes it possible to 'isolate' the code that makes useof the structure from the details of the structure itself. Note that,no matter which of the above two implementations is used, code thatneeds a reached list works in exactly the same way. It doesn't carewhat kind of objects are used, as long as it gets the results itexpected.</p><p><a class="paragraph" href="#p11b5dca2b0171fd4" name="p11b5dca2b0171fd4"> ¶ </a>This will be discussed in much more detail in <a href="chapter8.html">chapter 8</a>, where we willlearn to make object types like <code>BinaryHeap</code>, which are created using<code>new</code> and have methods to manipulate them.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p5eae67a2437a9721" name="p5eae67a2437a9721"> ¶ </a>Here we finally have the actual path-finding function:</p><pre class="code"><span class="keyword">function</span><span class="variable">findRoute</span>(<span class="variabledef">from</span>, <span class="variabledef">to</span>){<span class="keyword">var</span><span class="variabledef">open</span>=<span class="keyword">new</span><span class="variable">BinaryHeap</span>(<span class="variable">routeScore</span>);<span class="keyword">var</span><span class="variabledef">reached</span>=<span class="variable">makeReachedList</span>();<span class="keyword">function</span><span class="variabledef">routeScore</span>(<span class="variabledef">route</span>){<span class="keyword">if</span> (<span class="localvariable">route</span>.<span class="property">score</span>==<span class="atom">undefined</span>) <span class="localvariable">route</span>.<span class="property">score</span>=<span class="variable">estimatedDistance</span>(<span class="localvariable">route</span>.<span class="property">point</span>, <span class="localvariable">to</span>) + <span class="localvariable">route</span>.<span class="property">length</span>;<span class="keyword">return</span><span class="localvariable">route</span>.<span class="property">score</span>;}<span class="keyword">function</span><span class="variabledef">addOpenRoute</span>(<span class="variabledef">route</span>){<span class="localvariable">open</span>.<span class="property">push</span>(<span class="localvariable">route</span>);<span class="variable">storeReached</span>(<span class="localvariable">reached</span>, <span class="localvariable">route</span>.<span class="property">point</span>, <span class="localvariable">route</span>);}<span class="localvariable">addOpenRoute</span>({<span class="property">point</span>: <span class="localvariable">from</span>, <span class="property">length</span>: <span class="atom">0</span>});<span class="keyword">while</span> (<span class="localvariable">open</span>.<span class="property">size</span>() &gt;<span class="atom">0</span>){<span class="keyword">var</span><span class="variabledef">route</span>=<span class="localvariable">open</span>.<span class="property">pop</span>();<span class="keyword">if</span> (<span class="variable">samePoint</span>(<span class="localvariable">route</span>.<span class="property">point</span>, <span class="localvariable">to</span>)) <span class="keyword">return</span><span class="localvariable">route</span>;<span class="variable">forEach</span>(<span class="variable">possibleDirections</span>(<span class="localvariable">route</span>.<span class="property">point</span>), <span class="keyword">function</span>(<span class="variabledef">direction</span>){<span class="keyword">var</span><span class="variabledef">known</span>=<span class="variable">findReached</span>(<span class="localvariable">reached</span>, <span class="localvariable">direction</span>);<span class="keyword">var</span><span class="variabledef">newLength</span>=<span class="localvariable">route</span>.<span class="property">length</span> + <span class="variable">weightedDistance</span>(<span class="localvariable">route</span>.<span class="property">point</span>, <span class="localvariable">direction</span>);<span class="keyword">if</span> (!<span class="localvariable">known</span> || <span class="localvariable">known</span>.<span class="property">length</span> &gt;<span class="localvariable">newLength</span>){<span class="keyword">if</span> (<span class="localvariable">known</span>) <span class="localvariable">open</span>.<span class="property">remove</span>(<span class="localvariable">known</span>);<span class="localvariable">addOpenRoute</span>({<span class="property">point</span>: <span class="localvariable">direction</span>, <span class="property">from</span>: <span class="localvariable">route</span>, <span class="property">length</span>: <span class="localvariable">newLength</span>});}});}<span class="keyword">return</span><span class="atom">null</span>;}</pre><p><a class="paragraph" href="#p627d0478bf5050f1" name="p627d0478bf5050f1"> ¶ </a>First, it creates the data structures it needs, one open list and onereached list. <code>routeScore</code> is the scoring function given to the binaryheap. Note how it stores its result in the route object, to preventhaving to re-calculate it multiple times.</p><p><a class="paragraph" href="#p6dc66f08bbae1c5" name="p6dc66f08bbae1c5"> ¶ </a><code>addOpenRoute</code> is a convenience function that adds a new route to boththe open list and the reached list. It is immediately used to add thestart of the route. Note that route objects always have the properties<code>point</code>, which holds the point at the end of the route, and <code>length</code>,which holds the current length of the route. Routes which are morethan one square long also have a <code>from</code> property, which points attheir predecessors.</p><p><a class="paragraph" href="#p2b065241401e6e48" name="p2b065241401e6e48"> ¶ </a>The <code>while</code> loop, as was described in the algorithm, keeps taking thelowest-scoring route from the open list and checks whether this getsus to the goal point. If it does not, we must continue by expandingit. This is what the <code>forEach</code> takes care of. It looks up this newpoint in the reached list. If it is not found there, or the node foundhas a longer length than the new route, a new route object is createdand added to the open list and reached list, and the existing route(if any) is removed from the open list.</p><p><a class="paragraph" href="#p3f08d59ab6d9538c" name="p3f08d59ab6d9538c"> ¶ </a>What if the route in <code>known</code> is not on the open list? It has to be,because routes are only removed from the open list when they have beenfound to be the most optimal route to their endpoint. If we try toremove a value from a binary heap that is not on it, it will throw anexception, so if my reasoning is wrong, we will probably see anexception when running the function.</p><p><a class="paragraph" href="#p2b2d7e407500c88d" name="p2b2d7e407500c88d"> ¶ </a>When code gets complex enough to make you doubt certain things aboutit, it is a good idea to add some checks that raise exceptions whensomething goes wrong. That way, you know that there are no weirdthings happening 'silently', and when you break something, youimmediately see what you broke.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p6a9bab4da8fa0eed" name="p6a9bab4da8fa0eed"> ¶ </a>Note that this algorithm does not use recursion, but still manages toexplore all those branches. The open list more or less takes over therole that the function call stack played in the recursive solution tothe Hiva Oa problem ― it keeps track of the paths that still have tobe explored. Every recursive algorithm can be rewritten in anon-recursive way by using a data structure to store the 'things thatmust still be done'.</p></div><hr/><div class="block"><p><a class="paragraph" href="#pad930b309189a46" name="pad930b309189a46"> ¶ </a>Well, let us try our path-finder:</p><pre class="code"><span class="keyword">var</span><span class="variable">route</span>=<span class="variable">findRoute</span>(<span class="variable">point</span>(<span class="atom">0</span>, <span class="atom">0</span>), <span class="variable">point</span>(<span class="atom">19</span>, <span class="atom">19</span>));</pre><p><a class="paragraph" href="#p1bf3e5c89fce62b6" name="p1bf3e5c89fce62b6"> ¶ </a>If you ran all the code above, and did not introduce any errors, thatcall, though it might take a few seconds to run, should give us aroute object. This object is rather hard to read. That can be helpedby using the <code>showRoute</code> function which, if your console is bigenough, will show a route on a map.</p><pre class="code"><span class="variable">showRoute</span>(<span class="variable">route</span>);</pre><p><a class="paragraph" href="#p225576595e8e0774" name="p225576595e8e0774"> ¶ </a>You can also pass multiple routes to <code>showRoute</code>, which can be usefulwhen you are, for example, trying to plan a scenic route, which mustinclude the beautiful viewpoint at <code>11</code>, <code>17</code>.</p><pre class="code"><span class="variable">showRoute</span>(<span class="variable">findRoute</span>(<span class="variable">point</span>(<span class="atom">0</span>, <span class="atom">0</span>), <span class="variable">point</span>(<span class="atom">11</span>, <span class="atom">17</span>)), <span class="variable">findRoute</span>(<span class="variable">point</span>(<span class="atom">11</span>, <span class="atom">17</span>), <span class="variable">point</span>(<span class="atom">19</span>, <span class="atom">19</span>)));</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p3396aee2bad97996" name="p3396aee2bad97996"> ¶ </a>Variations on the theme of <a name="key15"></a>searching an optimal route through agraph can be applied to many problems, many of which are not at allrelated to finding a physical path. For example, a program that needsto solve a puzzle of fitting a number of blocks into a limited spacecould do this by exploring the various 'paths' it gets by trying toput a certain block in a certain place. The paths that ends up withinsufficient room for the last blocks are dead ends, and the path thatmanages to fit in all blocks is the solution.</p></div><ol class="footnotes"><li><a name="footnote1"></a>Computers are deterministic machines: They always react in the sameway to the input they receive, so they can not produce truly randomvalues. Therefore, we have to make do with series of numbers that lookrandom, but are in fact the result of some complicated deterministiccomputation.</li><li><a name="footnote2"></a>No really, it is.</li></ol><h1><span class="number">Chapter 8: </span>Object-oriented Programming</h1><div class="block"><p><a class="paragraph" href="#p18e03940ba942b6f" name="p18e03940ba942b6f"> ¶ </a>In the early nineties, a thing called <a name="key1"></a>object-oriented programmingstirred up the software industry. Most of the ideas behind it were notreally new at the time, but they had finally gained enough momentum tostart rolling, to become fashionable. Books were being written,courses given, programming languages developed. All of a sudden,everybody was extolling the virtues of object-orientation,enthusiastically applying it to every problem, convincing themselvesthey had finally found the <em>right way to write programs</em>.</p><p><a class="paragraph" href="#p4a5356a6d996e9b9" name="p4a5356a6d996e9b9"> ¶ </a>These things happen a lot. When a process is hard and confusing,people are always on the lookout for a magic solution. When somethinglooking like such a solution presents itself, they are prepared tobecome devoted followers. For many programmers, even today,object-orientation (or their view of it) is the gospel. When a programis not 'truly object-oriented', whatever that means, it is considereddecidedly inferior.</p><p><a class="paragraph" href="#p4a5e752e289a65b1" name="p4a5e752e289a65b1"> ¶ </a>Few fads have managed to stay popular for as long as this one, though.Object-orientation's longevity can largely be explained by the factthat the ideas at its core are very solid and useful. In this chapter,we will discuss these ideas, along with JavaScript's (rathereccentric) take on them. The above paragraphs are by no means meant todiscredit these ideas. What I want to do is warn the reader againstdeveloping an unhealthy attachment to them.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p5d07c4f5109e7992" name="p5d07c4f5109e7992"> ¶ </a>As the name suggests, object-oriented programming is related toobjects. So far, we have used objects as loose aggregations of values,adding and altering their properties whenever we saw fit. In anobject-oriented approach, objects are viewed as little worlds of theirown, and the outside world may touch them only through a limited andwell-defined <a name="key2"></a>interface, a number of specific methods and properties.The 'reached list' we used at the end of <a href="chapter7.html">chapter 7</a> is an example ofthis: We used only three functions, <code>makeReachedList</code>, <code>storeReached</code>,and <code>findReached</code> to interact with it. These three functions form aninterface for such objects.</p><p><a class="paragraph" href="#p2e1bbb92823ad3b1" name="p2e1bbb92823ad3b1"> ¶ </a>The <code>Date</code>, <code>Error</code>, and <code>BinaryHeap</code> objects we have seen also worklike this. Instead of providing regular functions for working with theobjects, they provide a way to create such objects, using the <code>new</code>keyword, and a number of methods and properties that provide the restof the interface.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p13af050db602907b" name="p13af050db602907b"> ¶ </a>One way to give an object methods is to simply attach function valuesto it.</p><pre class="code"><span class="keyword">var</span><span class="variable">rabbit</span>={};<span class="variable">rabbit</span>.<span class="property">speak</span>=<span class="keyword">function</span>(<span class="variabledef">line</span>){<span class="variable">print</span>(<span class="string">&quot;The rabbit says '&quot;</span>, <span class="localvariable">line</span>, <span class="string">&quot;'&quot;</span>);};<span class="variable">rabbit</span>.<span class="property">speak</span>(<span class="string">&quot;Well, now you're asking me.&quot;</span>);</pre><p><a class="paragraph" href="#p12798fc3dfebc5cd" name="p12798fc3dfebc5cd"> ¶ </a>In most cases, the method will need to know <em>who</em> it should act on.For example, if there are different rabbits, the <code>speak</code> method mustindicate which rabbit is speaking. For this purpose, there is aspecial variable called <a name="key3"></a><code>this</code>, which is always present when afunction is called, and which points at the relevant object when thefunction is called as a method. A function is called as a method whenit is looked up as a property, and immediately called, as in<code>object.method()</code>.</p><pre class="code"><span class="keyword">function</span><span class="variable">speak</span>(<span class="variabledef">line</span>){<span class="variable">print</span>(<span class="string">&quot;The &quot;</span>, <span class="localvariable">this</span>.<span class="property">adjective</span>, <span class="string">&quot;rabbit says '&quot;</span>, <span class="localvariable">line</span>, <span class="string">&quot;'&quot;</span>);}<span class="keyword">var</span><span class="variable">whiteRabbit</span>={<span class="property">adjective</span>: <span class="string">&quot;white&quot;</span>, <span class="property">speak</span>: <span class="variable">speak</span>};<span class="keyword">var</span><span class="variable">fatRabbit</span>={<span class="property">adjective</span>: <span class="string">&quot;fat&quot;</span>, <span class="property">speak</span>: <span class="variable">speak</span>};<span class="variable">whiteRabbit</span>.<span class="property">speak</span>(<span class="string">&quot;Oh my ears and whiskers, how late it's getting!&quot;</span>);<span class="variable">fatRabbit</span>.<span class="property">speak</span>(<span class="string">&quot;I could sure use a carrot right now.&quot;</span>);</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p4ca40bb0e8fc17d7" name="p4ca40bb0e8fc17d7"> ¶ </a>I can now clarify the mysterious first argument to the <a name="key4"></a><code>apply</code>method, for which we always used <code>null</code> in <a href="chapter6.html">chapter 6</a>. This argument can beused to specify the object that the function must be applied to. Fornon-method functions, this is irrelevant, hence the <code>null</code>.</p><pre class="code"><span class="variable">speak</span>.<span class="property">apply</span>(<span class="variable">fatRabbit</span>, [<span class="string">&quot;Yum.&quot;</span>]);</pre><p><a class="paragraph" href="#p2f2d7cb0d84dd000" name="p2f2d7cb0d84dd000"> ¶ </a>Functions also have a <a name="key5"></a><code>call</code> method, which is similar to <code>apply</code>,but you can give the arguments for the function separately instead ofas an array:</p><pre class="code"><span class="variable">speak</span>.<span class="property">call</span>(<span class="variable">fatRabbit</span>, <span class="string">&quot;Burp.&quot;</span>);</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p37d65271d19568f2" name="p37d65271d19568f2"> ¶ </a>The <a name="key6"></a><code>new</code> keyword provides a convenient way of creating new objects.When a function is called with the word <code>new</code> in front of it, its<a name="key7"></a><code>this</code> variable will point at a <em>new</em> object, which it willautomatically return (unless it explicitly returns something else).Functions used to create new objects like this are called<a name="key8"></a>constructors. Here is a constructor for rabbits:</p><pre class="code"><span class="keyword">function</span><span class="variable">Rabbit</span>(<span class="variabledef">adjective</span>){<span class="localvariable">this</span>.<span class="property">adjective</span>=<span class="localvariable">adjective</span>;<span class="localvariable">this</span>.<span class="property">speak</span>=<span class="keyword">function</span>(<span class="variabledef">line</span>){<span class="variable">print</span>(<span class="string">&quot;The &quot;</span>, <span class="localvariable">this</span>.<span class="property">adjective</span>, <span class="string">&quot;rabbit says '&quot;</span>, <span class="localvariable">line</span>, <span class="string">&quot;'&quot;</span>);};}<span class="keyword">var</span><span class="variable">killerRabbit</span>=<span class="keyword">new</span><span class="variable">Rabbit</span>(<span class="string">&quot;killer&quot;</span>);<span class="variable">killerRabbit</span>.<span class="property">speak</span>(<span class="string">&quot;GRAAAAAAAAAH!&quot;</span>);</pre><p><a class="paragraph" href="#p11c69c27ded2fabf" name="p11c69c27ded2fabf"> ¶ </a>It is a convention, among JavaScript programmers, to start the namesof constructors with a capital letter. This makes it easy todistinguish them from other functions.</p><p><a class="paragraph" href="#p592ac456b8eebbb3" name="p592ac456b8eebbb3"> ¶ </a>Why is the <code>new</code> keyword even necessary? After all, we could havesimply written this:</p><pre class="code"><span class="keyword">function</span><span class="variable">makeRabbit</span>(<span class="variabledef">adjective</span>){<span class="keyword">return</span>{<span class="property">adjective</span>: <span class="localvariable">adjective</span>, <span class="property">speak</span>: <span class="keyword">function</span>(<span class="variabledef">line</span>){<span class="comment">/*etc*/</span>}};}<span class="keyword">var</span><span class="variable">blackRabbit</span>=<span class="variable">makeRabbit</span>(<span class="string">&quot;black&quot;</span>);</pre><p><a class="paragraph" href="#p16717b36f8642b81" name="p16717b36f8642b81"> ¶ </a>But that is not entirely the same. <code>new</code> does a few things behind thescenes. For one thing, our <code>killerRabbit</code> has a property called<a name="key9"></a><code>constructor</code>, which points at the <code>Rabbit</code> function that createdit. <code>blackRabbit</code> also has such a property, but it points at the<a name="key10"></a><code>Object</code> function.</p><pre class="code"><span class="variable">show</span>(<span class="variable">killerRabbit</span>.<span class="property">constructor</span>);<span class="variable">show</span>(<span class="variable">blackRabbit</span>.<span class="property">constructor</span>);</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p65aceab6b4c1ffdd" name="p65aceab6b4c1ffdd"> ¶ </a>Where did the <code>constructor</code> property come from? It is part of the<a name="key11"></a>prototype of a rabbit. Prototypes are a powerful, if somewhatconfusing, part of the way JavaScript objects work. Every object isbased on a prototype, which gives it a set of inherent properties. Thesimple objects we have used so far are based on the most basicprototype, which is associated with the <code>Object</code> constructor. In fact,typing <code>{}</code> is equivalent to typing <code>new Object()</code>.</p><pre class="code"><span class="keyword">var</span><span class="variable">simpleObject</span>={};<span class="variable">show</span>(<span class="variable">simpleObject</span>.<span class="property">constructor</span>);<span class="variable">show</span>(<span class="variable">simpleObject</span>.<span class="property">toString</span>);</pre><p><a class="paragraph" href="#p531e35cf3e01867e" name="p531e35cf3e01867e"> ¶ </a><a name="key12"></a><code>toString</code> is a method that is part of the <code>Object</code> prototype. Thismeans that all simple objects have a <code>toString</code> method, which convertsthem to a string. Our rabbit objects are based on the prototypeassociated with the <code>Rabbit</code> constructor. You can use a constructor's<code>prototype</code> property to get access to, well, their prototype:</p><pre class="code"><span class="variable">show</span>(<span class="variable">Rabbit</span>.<span class="property">prototype</span>);<span class="variable">show</span>(<span class="variable">Rabbit</span>.<span class="property">prototype</span>.<span class="property">constructor</span>);</pre><p><a class="paragraph" href="#p5dfb614a8bba419d" name="p5dfb614a8bba419d"> ¶ </a>Every function automatically gets a <code>prototype</code> property, whose<code>constructor</code> property points back at the function. Because the rabbitprototype is itself an object, it is based on the <code>Object</code> prototype,and shares its <code>toString</code> method.</p><pre class="code"><span class="variable">show</span>(<span class="variable">killerRabbit</span>.<span class="property">toString</span>==<span class="variable">simpleObject</span>.<span class="property">toString</span>);</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p6359c8d3085d6d12" name="p6359c8d3085d6d12"> ¶ </a>Even though objects seem to share the properties of their prototype,this sharing is one-way. The properties of the prototype influence theobject based on it, but the properties of this object never change theprototype.</p><p><a class="paragraph" href="#p3e4f8a85a38cfc7" name="p3e4f8a85a38cfc7"> ¶ </a>The precise rules are this: When looking up the value of a property,JavaScript first looks at the properties that the object <em>itself</em> has.If there is a property that has the name we are looking for, that isthe value we get. If there is no such property, it continues searchingthe prototype of the object, and then the prototype of the prototype,and so on. If no property is found, the value <code>undefined</code> is given. Onthe other hand, when <em>setting</em> the value of a property, JavaScriptnever goes to the prototype, but always sets the property in theobject itself.</p><pre class="code"><span class="variable">Rabbit</span>.<span class="property">prototype</span>.<span class="property">teeth</span>=<span class="string">&quot;small&quot;</span>;<span class="variable">show</span>(<span class="variable">killerRabbit</span>.<span class="property">teeth</span>);<span class="variable">killerRabbit</span>.<span class="property">teeth</span>=<span class="string">&quot;long, sharp, and bloody&quot;</span>;<span class="variable">show</span>(<span class="variable">killerRabbit</span>.<span class="property">teeth</span>);<span class="variable">show</span>(<span class="variable">Rabbit</span>.<span class="property">prototype</span>.<span class="property">teeth</span>);</pre><p><a class="paragraph" href="#p5450ae7ffc2e9fb8" name="p5450ae7ffc2e9fb8"> ¶ </a>This does mean that the prototype can be used at any time to addnew properties and methods to all objects based on it. For example, itmight become necessary for our rabbits to dance.</p><pre class="code"><span class="variable">Rabbit</span>.<span class="property">prototype</span>.<span class="property">dance</span>=<span class="keyword">function</span>(){<span class="variable">print</span>(<span class="string">&quot;The &quot;</span>, <span class="localvariable">this</span>.<span class="property">adjective</span>, <span class="string">&quot;rabbit dances a jig.&quot;</span>);};<span class="variable">killerRabbit</span>.<span class="property">dance</span>();</pre><p><a class="paragraph" href="#p6384880cdbf6db23" name="p6384880cdbf6db23"> ¶ </a>And, as you might have guessed, the prototypical rabbit is the perfectplace for values that all rabbits have in common, such as the <code>speak</code>method. Here is a new approach to the <code>Rabbit</code> constructor:</p><pre class="code"><span class="keyword">function</span><span class="variable">Rabbit</span>(<span class="variabledef">adjective</span>){<span class="localvariable">this</span>.<span class="property">adjective</span>=<span class="localvariable">adjective</span>;}<span class="variable">Rabbit</span>.<span class="property">prototype</span>.<span class="property">speak</span>=<span class="keyword">function</span>(<span class="variabledef">line</span>){<span class="variable">print</span>(<span class="string">&quot;The &quot;</span>, <span class="localvariable">this</span>.<span class="property">adjective</span>, <span class="string">&quot;rabbit says '&quot;</span>, <span class="localvariable">line</span>, <span class="string">&quot;'&quot;</span>);};<span class="keyword">var</span><span class="variable">hazelRabbit</span>=<span class="keyword">new</span><span class="variable">Rabbit</span>(<span class="string">&quot;hazel&quot;</span>);<span class="variable">hazelRabbit</span>.<span class="property">speak</span>(<span class="string">&quot;Good Frith!&quot;</span>);</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p3c4ac238702c7ecc" name="p3c4ac238702c7ecc"> ¶ </a>The fact that all objects have a prototype and receive some propertiesfrom this prototype can be tricky. It means that using an object tostore a set of things, such as the cats from <a href="chapter4.html">chapter 4</a>, can go wrong.If, for example, we wondered whether there is a cat called<code>&quot;constructor&quot;</code>, we would have checked it like this:</p><pre class="code"><span class="keyword">var</span><span class="variable">noCatsAtAll</span>={};<span class="keyword">if</span> (<span class="string">&quot;constructor&quot;</span> in <span class="variable">noCatsAtAll</span>) <span class="variable">print</span>(<span class="string">&quot;Yes, there definitely is a cat called 'constructor'.&quot;</span>);</pre><p><a class="paragraph" href="#p429d248add331700" name="p429d248add331700"> ¶ </a>This is problematic. A related problem is that it can often bepractical to extend the prototypes of standard constructors such as<code>Object</code> and <code>Array</code> with new useful functions. For example, we couldgive all objects a method called <code>properties</code>, which returns an arraywith the names of the (non-hidden) properties that the object has:</p><pre class="code"><span class="variable">Object</span>.<span class="property">prototype</span>.<span class="property">properties</span>=<span class="keyword">function</span>(){<span class="keyword">var</span><span class="variabledef">result</span>=[];<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">property</span><span class="keyword">in</span><span class="localvariable">this</span>) <span class="localvariable">result</span>.<span class="property">push</span>(<span class="localvariable">property</span>);<span class="keyword">return</span><span class="localvariable">result</span>;};<span class="keyword">var</span><span class="variable">test</span>={<span class="property">x</span>: <span class="atom">10</span>, <span class="property">y</span>: <span class="atom">3</span>};<span class="variable">show</span>(<span class="variable">test</span>.<span class="property">properties</span>());</pre><p><a class="paragraph" href="#p4cfd7a8a8a68e368" name="p4cfd7a8a8a68e368"> ¶ </a>And that immediately shows the problem. Now that the <code>Object</code>prototype has a property called <code>properties</code>, looping over theproperties of any object, using <code>for</code> and <a name="key13"></a><code>in</code>, will also give usthat shared property, which is generally not what we want. We areinterested only in the properties that the object itself has.</p><p><a class="paragraph" href="#p15d222d107370bb2" name="p15d222d107370bb2"> ¶ </a>Fortunately, there is a way to find out whether a property belongs tothe object itself or to one of its prototypes. Unfortunately, it doesmake looping over the properties of an object a bit clumsier. Everyobject has a method called <a name="key14"></a><code>hasOwnProperty</code>, which tells us whetherthe object has a property with a given name. Using this, we couldrewrite our <code>properties</code> method like this:</p><pre class="code"><span class="variable">Object</span>.<span class="property">prototype</span>.<span class="property">properties</span>=<span class="keyword">function</span>(){<span class="keyword">var</span><span class="variabledef">result</span>=[];<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">property</span><span class="keyword">in</span><span class="localvariable">this</span>){<span class="keyword">if</span> (<span class="localvariable">this</span>.<span class="property">hasOwnProperty</span>(<span class="localvariable">property</span>)) <span class="localvariable">result</span>.<span class="property">push</span>(<span class="localvariable">property</span>);}<span class="keyword">return</span><span class="localvariable">result</span>;};<span class="keyword">var</span><span class="variable">test</span>={<span class="string">&quot;Fat Igor&quot;</span>: <span class="atom">true</span>, <span class="string">&quot;Fireball&quot;</span>: <span class="atom">true</span>};<span class="variable">show</span>(<span class="variable">test</span>.<span class="property">properties</span>());</pre><p><a class="paragraph" href="#p5a1185bce6f9b589" name="p5a1185bce6f9b589"> ¶ </a><a name="key15"></a>And of course, we can abstract that into a higher-orderfunction. Note that the <code>action</code> function is called with both the nameof the property and the value it has in the object.</p><pre class="code"><span class="keyword">function</span><span class="variable">forEachIn</span>(<span class="variabledef">object</span>, <span class="variabledef">action</span>){<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">property</span><span class="keyword">in</span><span class="localvariable">object</span>){<span class="keyword">if</span> (<span class="localvariable">object</span>.<span class="property">hasOwnProperty</span>(<span class="localvariable">property</span>)) <span class="localvariable">action</span>(<span class="localvariable">property</span>, <span class="localvariable">object</span>[<span class="localvariable">property</span>]);}}<span class="keyword">var</span><span class="variable">chimera</span>={<span class="property">head</span>: <span class="string">&quot;lion&quot;</span>, <span class="property">body</span>: <span class="string">&quot;goat&quot;</span>, <span class="property">tail</span>: <span class="string">&quot;snake&quot;</span>};<span class="variable">forEachIn</span>(<span class="variable">chimera</span>, <span class="keyword">function</span>(<span class="variabledef">name</span>, <span class="variabledef">value</span>){<span class="variable">print</span>(<span class="string">&quot;The &quot;</span>, <span class="localvariable">name</span>, <span class="string">&quot;of a &quot;</span>, <span class="localvariable">value</span>, <span class="string">&quot;.&quot;</span>);});</pre><p><a class="paragraph" href="#p2420ca9a47b21ef8" name="p2420ca9a47b21ef8"> ¶ </a>But, what if we find a cat named <code>hasOwnProperty</code>? (You never know.)It will be stored in the object, and the next time we want to go overthe collection of cats, calling <code>object.hasOwnProperty</code> will fail,because that property no longer points at a function value. This canbe solved by doing something even uglier:</p><pre class="code"><span class="keyword">function</span><span class="variable">forEachIn</span>(<span class="variabledef">object</span>, <span class="variabledef">action</span>){<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">property</span><span class="keyword">in</span><span class="localvariable">object</span>){<span class="keyword">if</span> (<span class="variable">Object</span>.<span class="property">prototype</span>.<span class="property">hasOwnProperty</span>.<span class="property">call</span>(<span class="localvariable">object</span>, <span class="localvariable">property</span>)) <span class="localvariable">action</span>(<span class="localvariable">property</span>, <span class="localvariable">object</span>[<span class="localvariable">property</span>]);}}<span class="keyword">var</span><span class="variable">test</span>={<span class="property">name</span>: <span class="string">&quot;Mordecai&quot;</span>, <span class="property">hasOwnProperty</span>: <span class="string">&quot;Uh-oh&quot;</span>};<span class="variable">forEachIn</span>(<span class="variable">test</span>, <span class="keyword">function</span>(<span class="variabledef">name</span>, <span class="variabledef">value</span>){<span class="variable">print</span>(<span class="string">&quot;Property &quot;</span>, <span class="localvariable">name</span>, <span class="string">&quot;=&quot;</span>, <span class="localvariable">value</span>);});</pre><p><a class="paragraph" href="#p3abba784f5ae2cab" name="p3abba784f5ae2cab"> ¶ </a>(Note: This example does not currently work correctly in InternetExplorer 8, which apparently has some problems with overridingbuilt-in prototype properties.)</p><p><a class="paragraph" href="#p1ffca6e85480c92a" name="p1ffca6e85480c92a"> ¶ </a>Here, instead of using the method found in the object itself, we getthe method from the <code>Object</code> prototype, and then use <code>call</code> to applyit to the right object. Unless someone actually messes with the methodin <code>Object.prototype</code> (don't do that), this should work correctly.</p></div><hr/><div class="block"><p><a class="paragraph" href="#pbe9c467ae3a4c79" name="pbe9c467ae3a4c79"> ¶ </a><code>hasOwnProperty</code> can also be used in those situations where we havebeen using the <a name="key16"></a><code>in</code> operator to see whether an object has a specificproperty. There is one more catch, however. We saw in <a href="chapter4.html">chapter 4</a> thatsome properties, such as <code>toString</code>, are 'hidden', and do not show upwhen going over properties with <code>for</code>/<code>in</code>. It turns out that browsersin the Gecko family (Firefox, most importantly) give every object ahidden property named <code>__proto__</code>, which points to the prototype ofthat object. <code>hasOwnProperty</code> will return <code>true</code> for this one, eventhough the program did not explicitly add it. Having access to theprototype of an object can be very convenient, but making it aproperty like that was not a very good idea. Still, Firefox is awidely used browser, so when you write a program for the web you haveto be careful with this. There is a method <a name="key17"></a><code>propertyIsEnumerable</code>,which returns <code>false</code> for hidden properties, and which can be used tofilter out strange things like <code>__proto__</code>. An expression such as thisone can be used to reliably work around this:</p><pre class="code"><span class="keyword">var</span><span class="variable">object</span>={<span class="property">foo</span>: <span class="string">&quot;bar&quot;</span>};<span class="variable">show</span>(<span class="variable">Object</span>.<span class="property">prototype</span>.<span class="property">hasOwnProperty</span>.<span class="property">call</span>(<span class="variable">object</span>, <span class="string">&quot;foo&quot;</span>) &amp;&amp;<span class="variable">Object</span>.<span class="property">prototype</span>.<span class="property">propertyIsEnumerable</span>.<span class="property">call</span>(<span class="variable">object</span>, <span class="string">&quot;foo&quot;</span>));</pre><p><a class="paragraph" href="#p1eaec3a4d259aa40" name="p1eaec3a4d259aa40"> ¶ </a>Nice and simple, no? This is one of the not-so-well-designed aspectsof JavaScript. Objects play both the role of 'values with methods',for which prototypes work great, and 'sets of properties', for whichprototypes only get in the way.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p5392d7ffbb63c4f3" name="p5392d7ffbb63c4f3"> ¶ </a>Writing the above expression every time you need to check whether aproperty is present in an object is unworkable. We could put it into afunction, but an even better approach is to write a constructor and aprototype specifically for situations like this, where we want toapproach an object as just a set of properties. Because you can use itto look things up by name, we will call it a <a name="key18"></a><code>Dictionary</code>.</p><pre class="code"><span class="keyword">function</span><span class="variable">Dictionary</span>(<span class="variabledef">startValues</span>){<span class="localvariable">this</span>.<span class="property">values</span>=<span class="localvariable">startValues</span> ||{};}<span class="variable">Dictionary</span>.<span class="property">prototype</span>.<span class="property">store</span>=<span class="keyword">function</span>(<span class="variabledef">name</span>, <span class="variabledef">value</span>){<span class="localvariable">this</span>.<span class="property">values</span>[<span class="localvariable">name</span>]=<span class="localvariable">value</span>;};<span class="variable">Dictionary</span>.<span class="property">prototype</span>.<span class="property">lookup</span>=<span class="keyword">function</span>(<span class="variabledef">name</span>){<span class="keyword">return</span><span class="localvariable">this</span>.<span class="property">values</span>[<span class="localvariable">name</span>];};<span class="variable">Dictionary</span>.<span class="property">prototype</span>.<span class="property">contains</span>=<span class="keyword">function</span>(<span class="variabledef">name</span>){<span class="keyword">return</span><span class="variable">Object</span>.<span class="property">prototype</span>.<span class="property">hasOwnProperty</span>.<span class="property">call</span>(<span class="localvariable">this</span>.<span class="property">values</span>, <span class="localvariable">name</span>) &amp;&amp;<span class="variable">Object</span>.<span class="property">prototype</span>.<span class="property">propertyIsEnumerable</span>.<span class="property">call</span>(<span class="localvariable">this</span>.<span class="property">values</span>, <span class="localvariable">name</span>);};<span class="variable">Dictionary</span>.<span class="property">prototype</span>.<span class="property">each</span>=<span class="keyword">function</span>(<span class="variabledef">action</span>){<span class="variable">forEachIn</span>(<span class="localvariable">this</span>.<span class="property">values</span>, <span class="localvariable">action</span>);};<span class="keyword">var</span><span class="variable">colours</span>=<span class="keyword">new</span><span class="variable">Dictionary</span>({<span class="property">Grover</span>: <span class="string">&quot;blue&quot;</span>, <span class="property">Elmo</span>: <span class="string">&quot;orange&quot;</span>, <span class="property">Bert</span>: <span class="string">&quot;yellow&quot;</span>});<span class="variable">show</span>(<span class="variable">colours</span>.<span class="property">contains</span>(<span class="string">&quot;Grover&quot;</span>));<span class="variable">show</span>(<span class="variable">colours</span>.<span class="property">contains</span>(<span class="string">&quot;constructor&quot;</span>));<span class="variable">colours</span>.<span class="property">each</span>(<span class="keyword">function</span>(<span class="variabledef">name</span>, <span class="variabledef">colour</span>){<span class="variable">print</span>(<span class="localvariable">name</span>, <span class="string">&quot;is &quot;</span>, <span class="localvariable">colour</span>);});</pre><p><a class="paragraph" href="#p2921a27cd935902b" name="p2921a27cd935902b"> ¶ </a>Now the whole mess related to approaching objects as plain sets ofproperties has been 'encapsulated' in a convenient interface: oneconstructor and four methods. Note that the <code>values</code> property of a<code>Dictionary</code> object is not part of this interface, it is an internaldetail, and when you are using <code>Dictionary</code> objects you do not need todirectly use it.</p><p><a class="paragraph" href="#p54a4aa38e7a80eab" name="p54a4aa38e7a80eab"> ¶ </a>Whenever you write an interface, it is a good idea to add a commentwith a quick sketch of what it does and how it should be used. Thisway, when someone, possibly yourself three months after you wrote it,wants to work with the interface, they can quickly see how to use it,and do not have to study the whole program.</p><p><a class="paragraph" href="#p2aaba1b065516c82" name="p2aaba1b065516c82"> ¶ </a>Most of the time, when you are designing an interface, you will soonfind some limitations and problems in whatever you came up with, andchange it. To prevent wasting your time, it is advisable to documentyour interfaces only <em>after</em> they have been used in a few realsituations and proven themselves to be practical. ― Of course, thismight make it tempting to forget about documentation altogether.Personally, I treat writing documentation as a 'finishing touch' toadd to a system. When it feels ready, it is time to write somethingabout it, and to see if it sounds as good in English (or whateverlanguage) as it does in JavaScript (or whatever programming language).</p></div><hr/><div class="block"><p><a class="paragraph" href="#p588adda0b0472459" name="p588adda0b0472459"> ¶ </a>The distinction between the external interface of an object and itsinternal details is important for two reasons. Firstly, having asmall, clearly described interface makes an object easier to use. Youonly have to keep the interface in mind, and do not have to worryabout the rest unless you are changing the object itself.</p><p><a class="paragraph" href="#p56d8406fdc34ca54" name="p56d8406fdc34ca54"> ¶ </a>Secondly, it often turns out to be necessary or practical to changesomething about the internal implementation of an object type<a class="footref" href="#footnote1">1</a>, tomake it more efficient, for example, or to fix some problem. Whenoutside code is accessing every single property and detail in theobject, you can not change any of them without also updating a lot ofother code. If outside code only uses a small interface, you can dowhat you want, as long as you do not change the interface.</p><p><a class="paragraph" href="#p639a46444303f2d0" name="p639a46444303f2d0"> ¶ </a>Some people go very far in this. They will, for example, never includeproperties in the interface of object, only methods ― if their objecttype has a length, it will be accessible with the <code>getLength</code> method,not the <code>length</code> property. This way, if they ever want to change theirobject in such a way that it no longer has a <code>length</code> property, forexample because it now has some internal array whose length it mustreturn, they can update the function without changing the interface.</p><p><a class="paragraph" href="#p44dc075d8a2b8573" name="p44dc075d8a2b8573"> ¶ </a>My own take is that in most cases this is not worth it. Adding a<code>getLength</code> method which only contains <code>return this.length;</code> mostlyjust adds meaningless code, and, in most situations, I considermeaningless code a bigger problem than the risk of having tooccasionally change the interface to my objects.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p5e2f0cee5f85da20" name="p5e2f0cee5f85da20"> ¶ </a>Adding new methods to existing prototypes can be very convenient.Especially the <code>Array</code> and <code>String</code> prototypes in JavaScript could usea few more basic methods. We could, for example, replace <code>forEach</code> and<code>map</code> with methods on arrays, and make the <code>startsWith</code> function wewrote in <a href="chapter4.html">chapter 4</a> a method on strings.</p><p><a class="paragraph" href="#p584b92a939af8ba8" name="p584b92a939af8ba8"> ¶ </a>However, if your program has to run on the same web-page as anotherprogram (either written by you or by someone else) which uses<code>for</code>/<code>in</code> naively ― the way we have been using it so far ― thenadding things to prototypes, especially the <code>Object</code> and <code>Array</code>prototype, will definitely break something, because these loops willsuddenly start seeing those new properties. For this reason, somepeople prefer not to touch these prototypes at all. Of course, if youare careful, and you do not expect your code to have to coexist withbadly-written code, adding methods to standard prototypes is aperfectly good technique.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p3e80b90220c891b9" name="p3e80b90220c891b9"> ¶ </a>In this chapter we are going to build a virtual terrarium, a tank withinsects moving around in it. There will be some objects involved (thisis, after all, the chapter on object-oriented programming). We willtake a rather simple approach, and make the terrarium atwo-dimensional grid, like the second map in <a href="chapter7.html">chapter 7</a>. On this gridthere are a number of bugs. When the terrarium is active, all the bugsget a chance to take an action, such as moving, every half second.</p><p><a class="paragraph" href="#p2ac546ad345b5e63" name="p2ac546ad345b5e63"> ¶ </a>Thus, we chop both time and space into units with a fixed size ―squares for space, half seconds for time. This usually makes thingseasier to model in a program, but of course has the drawback of beingwildly inaccurate. Fortunately, this terrarium-simulator is notrequired to be accurate in any way, so we can get away with it.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p31d95b135879263b" name="p31d95b135879263b"> ¶ </a>A terrarium can be defined with a 'plan', which is an array ofstrings. We could have used a single string, but because JavaScriptstrings must stay on a single line it would have been a lot harder totype.</p><pre class="code"><span class="keyword">var</span><span class="variable">thePlan</span>=[<span class="string">&quot;############################&quot;</span>, <span class="string">&quot;# # # o ##&quot;</span>, <span class="string">&quot;# #&quot;</span>, <span class="string">&quot;# ##### #&quot;</span>, <span class="string">&quot;## # # ## #&quot;</span>, <span class="string">&quot;### ## # #&quot;</span>, <span class="string">&quot;# ### # #&quot;</span>, <span class="string">&quot;# #### #&quot;</span>, <span class="string">&quot;# ## o #&quot;</span>, <span class="string">&quot;# o # o ### #&quot;</span>, <span class="string">&quot;# # #&quot;</span>, <span class="string">&quot;############################&quot;</span>];</pre><p><a class="paragraph" href="#p2aad21964803d546" name="p2aad21964803d546"> ¶ </a>The <code>&quot;#&quot;</code> characters are used to represent the walls of the terrarium(and the ornamental rocks lying in it), the <code>&quot;o&quot;</code>s represent bugs, andthe spaces are, as you might have guessed, empty space.</p><p><a class="paragraph" href="#p740e6749d33ce2f9" name="p740e6749d33ce2f9"> ¶ </a>Such a plan-array can be used to create a terrarium-object. Thisobject keeps track of the shape and content of the terrarium, and letsthe bugs inside move. It has four methods: Firstly <code>toString</code>, whichconverts the terrarium back to a string similar to the plan it wasbased on, so that you can see what is going on inside it. Then thereis <code>step</code>, which allows all the bugs in the terrarium to move onestep, if they so desire. And finally, there are <code>start</code> and <code>stop</code>,which control whether the terrarium is 'running'. When it is running,<code>step</code> is automatically called every half second, so the bugs keepmoving.</p></div><hr/><div class="block"><a name="exercise1"></a><div class="exercisenum">Ex. 8.1</div><div class="exercise"><p><a class="paragraph" href="#p6a3a9ecbec6a2f09" name="p6a3a9ecbec6a2f09"> ¶ </a><a name="key19"></a>The points on the grid will be represented by objects again.In <a href="chapter7.html">chapter 7</a> we used three functions, <code>point</code>, <code>addPoints</code>, and<code>samePoint</code> to work with points. This time, we will use a constructorand two methods. Write the constructor <code>Point</code>, which takes twoarguments, the x and y coordinates of the point, and produces anobject with <code>x</code> and <code>y</code> properties. Give the prototype of thisconstructor a method <code>add</code>, which takes another point as argument andreturns a <em>new</em> point whose <code>x</code> and <code>y</code> are the sum of the <code>x</code> and <code>y</code>of the two given points. Also add a method <code>isEqualTo</code>, which takes apoint and returns a boolean indicating whether the <code>this</code> point refersto the same coordinates as the given point.</p><p><a class="paragraph" href="#p6470113307af5b6f" name="p6470113307af5b6f"> ¶ </a>Apart from the two methods, the <code>x</code> and <code>y</code> properties are also partof the interface of this type of objects: Code which uses pointobjects may freely retrieve and modify <code>x</code> and <code>y</code>.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">Point</span>(<span class="variabledef">x</span>, <span class="variabledef">y</span>){<span class="localvariable">this</span>.<span class="property">x</span>=<span class="localvariable">x</span>;<span class="localvariable">this</span>.<span class="property">y</span>=<span class="localvariable">y</span>;}<span class="variable">Point</span>.<span class="property">prototype</span>.<span class="property">add</span>=<span class="keyword">function</span>(<span class="variabledef">other</span>){<span class="keyword">return</span><span class="keyword">new</span><span class="variable">Point</span>(<span class="localvariable">this</span>.<span class="property">x</span> + <span class="localvariable">other</span>.<span class="property">x</span>, <span class="localvariable">this</span>.<span class="property">y</span> + <span class="localvariable">other</span>.<span class="property">y</span>);};<span class="variable">Point</span>.<span class="property">prototype</span>.<span class="property">isEqualTo</span>=<span class="keyword">function</span>(<span class="variabledef">other</span>){<span class="keyword">return</span><span class="localvariable">this</span>.<span class="property">x</span>==<span class="localvariable">other</span>.<span class="property">x</span> &amp;&amp;<span class="localvariable">this</span>.<span class="property">y</span>==<span class="localvariable">other</span>.<span class="property">y</span>;};<span class="variable">show</span>((<span class="keyword">new</span><span class="variable">Point</span>(<span class="atom">3</span>, <span class="atom">1</span>)).<span class="property">add</span>(<span class="keyword">new</span><span class="variable">Point</span>(<span class="atom">2</span>, <span class="atom">4</span>)));</pre><p><a class="paragraph" href="#pb18a786ec7d72cd" name="pb18a786ec7d72cd"> ¶ </a>Make sure your version of <code>add</code> leaves the <code>this</code> point intact andproduces a new point object. A method which changes the current pointinstead would be similar to the <code>+=</code> operator, whereas this one islike the <code>+</code> operator.</p></div></div><hr/><div class="block"><p><a class="paragraph" href="#p4a6b18b171398590" name="p4a6b18b171398590"> ¶ </a>When writing objects to implement a certain program, it is not alwaysvery clear which functionality goes where. Some things are bestwritten as methods of your objects, other things are better expressedas separate functions, and some things are best implemented by addinga new type of object. To keep things clear and organised, it isimportant to keep the amount of methods and responsibilities that anobject type has as small as possible. When an object does too much, itbecomes a big mess of functionality, and a formidable source ofconfusion.</p><p><a class="paragraph" href="#p672169de2a03529" name="p672169de2a03529"> ¶ </a>I said above that the terrarium object will be responsible for storingits contents and for letting the bugs inside it move. Firstly, notethat it <em>lets</em> them move, it doesn't <em>make</em> them move. The bugsthemselves will also be objects, and these objects are responsible fordeciding what they want to do. The terrarium merely provides theinfrastructure that asks them what to do every half second, and ifthey decide to move, it makes sure this happens.</p><p><a class="paragraph" href="#pbafe28cb7b5f0f7" name="pbafe28cb7b5f0f7"> ¶ </a>Storing the grid on which the content of the terrarium is kept can getquite complex. It has to define some kind of representation, ways toaccess this representation, a way to initialise the grid from a 'plan'array, a way to write the content of the grid to a string for the<code>toString</code> method, and the movement of the bugs on the grid. It wouldbe nice if part of this could be moved into another object, so thatthe terrarium object itself doesn't get too big and complex.</p></div><hr/><div class="block"><p><a class="paragraph" href="#pbd9c6f6076dd1a7" name="pbd9c6f6076dd1a7"> ¶ </a>Whenever you find yourself about to mix data representation andproblem-specific code in one object, it is a good idea to try and putthe data representation code into a separate type of object. In thiscase, we need to represent a grid of values, so I wrote a <code>Grid</code> type,which supports the operations that the terrarium will need.</p><p><a class="paragraph" href="#p6f1d3ff563ace594" name="p6f1d3ff563ace594"> ¶ </a>To store the values on the grid, there are two options. One can use anarray of arrays, like this:</p><pre class="code"><span class="keyword">var</span><span class="variable">grid</span>=[[<span class="string">&quot;0,0&quot;</span>, <span class="string">&quot;1,0&quot;</span>, <span class="string">&quot;2,0&quot;</span>], [<span class="string">&quot;0,1&quot;</span>, <span class="string">&quot;1,1&quot;</span>, <span class="string">&quot;2,1&quot;</span>]];<span class="variable">show</span>(<span class="variable">grid</span>[<span class="atom">1</span>][<span class="atom">2</span>]);</pre><p><a class="paragraph" href="#p6ed2e51aa687f5bb" name="p6ed2e51aa687f5bb"> ¶ </a>Or the values can all be put into a single array. In this case, theelement at <code>x</code>,<code>y</code> can be found by getting the element at position <code>x+ y * width</code> in the array, where <code>width</code> is the width of the grid.</p><pre class="code"><span class="keyword">var</span><span class="variable">grid</span>=[<span class="string">&quot;0,0&quot;</span>, <span class="string">&quot;1,0&quot;</span>, <span class="string">&quot;2,0&quot;</span>, <span class="string">&quot;0,1&quot;</span>, <span class="string">&quot;1,1&quot;</span>, <span class="string">&quot;2,1&quot;</span>];<span class="variable">show</span>(<span class="variable">grid</span>[<span class="atom">2</span> + <span class="atom">1</span> * <span class="atom">3</span>]);</pre><p><a class="paragraph" href="#p707a25be90bfffe" name="p707a25be90bfffe"> ¶ </a><a name="key20"></a>I chose the second representation, because it makes it mucheasier to initialise the array. <code>new Array(x)</code> produces a new array oflength <code>x</code>, filled with <code>undefined</code> values.</p><pre class="code"><span class="keyword">function</span><span class="variable">Grid</span>(<span class="variabledef">width</span>, <span class="variabledef">height</span>){<span class="localvariable">this</span>.<span class="property">width</span>=<span class="localvariable">width</span>;<span class="localvariable">this</span>.<span class="property">height</span>=<span class="localvariable">height</span>;<span class="localvariable">this</span>.<span class="property">cells</span>=<span class="keyword">new</span><span class="variable">Array</span>(<span class="localvariable">width</span> * <span class="localvariable">height</span>);}<span class="variable">Grid</span>.<span class="property">prototype</span>.<span class="property">valueAt</span>=<span class="keyword">function</span>(<span class="variabledef">point</span>){<span class="keyword">return</span><span class="localvariable">this</span>.<span class="property">cells</span>[<span class="localvariable">point</span>.<span class="property">y</span> * <span class="localvariable">this</span>.<span class="property">width</span> + <span class="localvariable">point</span>.<span class="property">x</span>];};<span class="variable">Grid</span>.<span class="property">prototype</span>.<span class="property">setValueAt</span>=<span class="keyword">function</span>(<span class="variabledef">point</span>, <span class="variabledef">value</span>){<span class="localvariable">this</span>.<span class="property">cells</span>[<span class="localvariable">point</span>.<span class="property">y</span> * <span class="localvariable">this</span>.<span class="property">width</span> + <span class="localvariable">point</span>.<span class="property">x</span>]=<span class="localvariable">value</span>;};<span class="variable">Grid</span>.<span class="property">prototype</span>.<span class="property">isInside</span>=<span class="keyword">function</span>(<span class="variabledef">point</span>){<span class="keyword">return</span><span class="localvariable">point</span>.<span class="property">x</span> &gt;=<span class="atom">0</span> &amp;&amp;<span class="localvariable">point</span>.<span class="property">y</span> &gt;=<span class="atom">0</span> &amp;&amp;<span class="localvariable">point</span>.<span class="property">x</span> &lt;<span class="localvariable">this</span>.<span class="property">width</span> &amp;&amp;<span class="localvariable">point</span>.<span class="property">y</span> &lt;<span class="localvariable">this</span>.<span class="property">height</span>;};<span class="variable">Grid</span>.<span class="property">prototype</span>.<span class="property">moveValue</span>=<span class="keyword">function</span>(<span class="variabledef">from</span>, <span class="variabledef">to</span>){<span class="localvariable">this</span>.<span class="property">setValueAt</span>(<span class="localvariable">to</span>, <span class="localvariable">this</span>.<span class="property">valueAt</span>(<span class="localvariable">from</span>));<span class="localvariable">this</span>.<span class="property">setValueAt</span>(<span class="localvariable">from</span>, <span class="atom">undefined</span>);};</pre></div><hr/><div class="block"><a name="exercise2"></a><div class="exercisenum">Ex. 8.2</div><div class="exercise"><p><a class="paragraph" href="#p40a4c6abd51cb533" name="p40a4c6abd51cb533"> ¶ </a>We will also need to go over all the elements of the grid, to find thebugs we need to move, or to convert the whole thing to a string. Tomake this easy, we can use a higher-order function that takes anaction as its argument. Add the method <code>each</code> to the prototype of<code>Grid</code>, which takes a function of two arguments as its argument. Itcalls this function for every point on the grid, giving it the pointobject for that point as its first argument, and the value that is onthe grid at that point as second argument.</p><p><a class="paragraph" href="#p3481d8529fd5bb73" name="p3481d8529fd5bb73"> ¶ </a>Go over the points starting at <code>0</code>,<code>0</code>, one row at a time, so that<code>1</code>,<code>0</code> is handled before <code>0</code>,<code>1</code>. This will make it easier to writethe <code>toString</code> function of the terrarium later. (Hint: Put a <code>for</code>loop for the <code>x</code> coordinate inside a loop for the <code>y</code> coordinate.)</p><p><a class="paragraph" href="#p42d988cd4825b7e4" name="p42d988cd4825b7e4"> ¶ </a>It is advisable not to muck about in the <code>cells</code> property of the gridobject directly, but use <code>valueAt</code> to get at the values. This way, ifwe decide (for some reason) to use a different method for storing thevalues, we only have to rewrite <code>valueAt</code> and <code>setValueAt</code>, and theother methods can stay untouched.</p></div><div class="solution"><pre class="code"><span class="variable">Grid</span>.<span class="property">prototype</span>.<span class="property">each</span>=<span class="keyword">function</span>(<span class="variabledef">action</span>){<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">y</span>=<span class="atom">0</span>;<span class="localvariable">y</span> &lt;<span class="localvariable">this</span>.<span class="property">height</span>;<span class="localvariable">y</span>++){<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">x</span>=<span class="atom">0</span>;<span class="localvariable">x</span> &lt;<span class="localvariable">this</span>.<span class="property">width</span>;<span class="localvariable">x</span>++){<span class="keyword">var</span><span class="variabledef">point</span>=<span class="keyword">new</span><span class="variable">Point</span>(<span class="localvariable">x</span>, <span class="localvariable">y</span>);<span class="localvariable">action</span>(<span class="localvariable">point</span>, <span class="localvariable">this</span>.<span class="property">valueAt</span>(<span class="localvariable">point</span>));}}};</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p137d4c10de0b3623" name="p137d4c10de0b3623"> ¶ </a>Finally, to test the grid:</p><pre class="code"><span class="keyword">var</span><span class="variable">testGrid</span>=<span class="keyword">new</span><span class="variable">Grid</span>(<span class="atom">3</span>, <span class="atom">2</span>);<span class="variable">testGrid</span>.<span class="property">setValueAt</span>(<span class="keyword">new</span><span class="variable">Point</span>(<span class="atom">1</span>, <span class="atom">0</span>), <span class="string">&quot;#&quot;</span>);<span class="variable">testGrid</span>.<span class="property">setValueAt</span>(<span class="keyword">new</span><span class="variable">Point</span>(<span class="atom">1</span>, <span class="atom">1</span>), <span class="string">&quot;o&quot;</span>);<span class="variable">testGrid</span>.<span class="property">each</span>(<span class="keyword">function</span>(<span class="variabledef">point</span>, <span class="variabledef">value</span>){<span class="variable">print</span>(<span class="localvariable">point</span>.<span class="property">x</span>, <span class="string">&quot;,&quot;</span>, <span class="localvariable">point</span>.<span class="property">y</span>, <span class="string">&quot;: &quot;</span>, <span class="localvariable">value</span>);});</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p46446fffa7849114" name="p46446fffa7849114"> ¶ </a>Before we can start to write a <code>Terrarium</code> constructor, we will haveto get a bit more specific about these 'bug objects' that will beliving inside it. Earlier, I mentioned that the terrarium will ask thebugs what action they want to take. This will work as follows: Eachbug object has an <code>act</code> method which, when called, returns an'action'. An action is an object with a <code>type</code> property, which namesthe type of action the bug wants to take, for example <code>&quot;move&quot;</code>. Formost actions, the action also contains extra information, such as thedirection the bug wants to go.</p><p><a class="paragraph" href="#p47cc4df13607024f" name="p47cc4df13607024f"> ¶ </a>Bugs are terribly myopic, they can only see the squares directlyaround them on the grid. But these they can use to base their actionon. When the <code>act</code> method is called, it is given an object withinformation about the surroundings of the bug in question. For each ofthe eight directions, it contains a property. The property indicatingwhat is above the bug is called <code>&quot;n&quot;</code>, for North, the oneindicating what is above and to the right <code>&quot;ne&quot;</code>, for North-East, andso on. To look up the direction these names refer to, the followingdictionary object is useful:</p><pre class="code"><span class="keyword">var</span><span class="variable">directions</span>=<span class="keyword">new</span><span class="variable">Dictionary</span>({<span class="string">&quot;n&quot;</span>: <span class="keyword">new</span><span class="variable">Point</span>( <span class="atom">0</span>, -<span class="atom">1</span>), <span class="string">&quot;ne&quot;</span>: <span class="keyword">new</span><span class="variable">Point</span>( <span class="atom">1</span>, -<span class="atom">1</span>), <span class="string">&quot;e&quot;</span>: <span class="keyword">new</span><span class="variable">Point</span>( <span class="atom">1</span>, <span class="atom">0</span>), <span class="string">&quot;se&quot;</span>: <span class="keyword">new</span><span class="variable">Point</span>( <span class="atom">1</span>, <span class="atom">1</span>), <span class="string">&quot;s&quot;</span>: <span class="keyword">new</span><span class="variable">Point</span>( <span class="atom">0</span>, <span class="atom">1</span>), <span class="string">&quot;sw&quot;</span>: <span class="keyword">new</span><span class="variable">Point</span>(-<span class="atom">1</span>, <span class="atom">1</span>), <span class="string">&quot;w&quot;</span>: <span class="keyword">new</span><span class="variable">Point</span>(-<span class="atom">1</span>, <span class="atom">0</span>), <span class="string">&quot;nw&quot;</span>: <span class="keyword">new</span><span class="variable">Point</span>(-<span class="atom">1</span>, -<span class="atom">1</span>)});<span class="variable">show</span>(<span class="keyword">new</span><span class="variable">Point</span>(<span class="atom">4</span>, <span class="atom">4</span>).<span class="property">add</span>(<span class="variable">directions</span>.<span class="property">lookup</span>(<span class="string">&quot;se&quot;</span>)));</pre><p><a class="paragraph" href="#p201f637041e299ba" name="p201f637041e299ba"> ¶ </a>When a bug decides to move, he indicates in which direction he wantsto go by giving the resulting action object a <code>direction</code> propertythat names one of these directions. We can make a simple, stupid bugthat always just goes south, 'towards the light', like this:</p><pre class="code"><span class="keyword">function</span><span class="variable">StupidBug</span>(){};<span class="variable">StupidBug</span>.<span class="property">prototype</span>.<span class="property">act</span>=<span class="keyword">function</span>(<span class="variabledef">surroundings</span>){<span class="keyword">return</span>{<span class="property">type</span>: <span class="string">&quot;move&quot;</span>, <span class="property">direction</span>: <span class="string">&quot;s&quot;</span>};};</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p12783aa99e1b1f2e" name="p12783aa99e1b1f2e"> ¶ </a>Now we can start on the <code>Terrarium</code> object type itself. First, itsconstructor, which takes a plan (an array of strings) as argument, andinitialises its grid.</p><pre class="code"><span class="keyword">var</span><span class="variable">wall</span>={};<span class="keyword">function</span><span class="variable">Terrarium</span>(<span class="variabledef">plan</span>){<span class="keyword">var</span><span class="variabledef">grid</span>=<span class="keyword">new</span><span class="variable">Grid</span>(<span class="localvariable">plan</span>[<span class="atom">0</span>].<span class="property">length</span>, <span class="localvariable">plan</span>.<span class="property">length</span>);<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">y</span>=<span class="atom">0</span>;<span class="localvariable">y</span> &lt;<span class="localvariable">plan</span>.<span class="property">length</span>;<span class="localvariable">y</span>++){<span class="keyword">var</span><span class="variabledef">line</span>=<span class="localvariable">plan</span>[<span class="localvariable">y</span>];<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">x</span>=<span class="atom">0</span>;<span class="localvariable">x</span> &lt;<span class="localvariable">line</span>.<span class="property">length</span>;<span class="localvariable">x</span>++){<span class="localvariable">grid</span>.<span class="property">setValueAt</span>(<span class="keyword">new</span><span class="variable">Point</span>(<span class="localvariable">x</span>, <span class="localvariable">y</span>), <span class="variable">elementFromCharacter</span>(<span class="localvariable">line</span>.<span class="property">charAt</span>(<span class="localvariable">x</span>)));}}<span class="localvariable">this</span>.<span class="property">grid</span>=<span class="localvariable">grid</span>;}<span class="keyword">function</span><span class="variable">elementFromCharacter</span>(<span class="variabledef">character</span>){<span class="keyword">if</span> (<span class="localvariable">character</span>==<span class="string">&quot;&quot;</span>) <span class="keyword">return</span><span class="atom">undefined</span>;<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">character</span>==<span class="string">&quot;#&quot;</span>) <span class="keyword">return</span><span class="variable">wall</span>;<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">character</span>==<span class="string">&quot;o&quot;</span>) <span class="keyword">return</span><span class="keyword">new</span><span class="variable">StupidBug</span>();}</pre><p><a class="paragraph" href="#p265091ec9b2588c2" name="p265091ec9b2588c2"> ¶ </a><code>wall</code> is an object that is used to mark the location of walls on thegrid. Like a real wall, it doesn't do much, it just sits there andtakes up space.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p139280591b6b0e8" name="p139280591b6b0e8"> ¶ </a>The most straightforward method of a terrarium object is <code>toString</code>,which transforms a terrarium into a string. To make this easier, wemark both the <code>wall</code> and the prototype of the <code>StupidBug</code> with aproperty <code>character</code>, which holds the character that represents them.</p><pre class="code"><span class="variable">wall</span>.<span class="property">character</span>=<span class="string">&quot;#&quot;</span>;<span class="variable">StupidBug</span>.<span class="property">prototype</span>.<span class="property">character</span>=<span class="string">&quot;o&quot;</span>;<span class="keyword">function</span><span class="variable">characterFromElement</span>(<span class="variabledef">element</span>){<span class="keyword">if</span> (<span class="localvariable">element</span>==<span class="atom">undefined</span>) <span class="keyword">return</span><span class="string">&quot;&quot;</span>;<span class="keyword">else</span><span class="keyword">return</span><span class="localvariable">element</span>.<span class="property">character</span>;}<span class="variable">show</span>(<span class="variable">characterFromElement</span>(<span class="variable">wall</span>));</pre></div><hr/><div class="block"><a name="exercise3"></a><div class="exercisenum">Ex. 8.3</div><div class="exercise"><p><a class="paragraph" href="#p5692c3b1fe7182a5" name="p5692c3b1fe7182a5"> ¶ </a>Now we can use the <code>each</code> method of the <code>Grid</code> object to build up astring. But to make the result readable, it would be nice to have anewline at the end of every row. The <code>x</code> coordinate of the positionson the grid can be used to determine when the end of a line isreached. Add a method <code>toString</code> to the <code>Terrarium</code> prototype, whichtakes no arguments and returns a string that, when given to <code>print</code>,shows a nice two-dimensional view of the terrarium.</p></div><div class="solution"><pre class="code"><span class="variable">Terrarium</span>.<span class="property">prototype</span>.<span class="property">toString</span>=<span class="keyword">function</span>(){<span class="keyword">var</span><span class="variabledef">characters</span>=[];<span class="keyword">var</span><span class="variabledef">endOfLine</span>=<span class="localvariable">this</span>.<span class="property">grid</span>.<span class="property">width</span> - <span class="atom">1</span>;<span class="localvariable">this</span>.<span class="property">grid</span>.<span class="property">each</span>(<span class="keyword">function</span>(<span class="variabledef">point</span>, <span class="variabledef">value</span>){<span class="localvariable">characters</span>.<span class="property">push</span>(<span class="variable">characterFromElement</span>(<span class="localvariable">value</span>));<span class="keyword">if</span> (<span class="localvariable">point</span>.<span class="property">x</span>==<span class="localvariable">endOfLine</span>) <span class="localvariable">characters</span>.<span class="property">push</span>(<span class="string">&quot;\n&quot;</span>);});<span class="keyword">return</span><span class="localvariable">characters</span>.<span class="property">join</span>(<span class="string">&quot;&quot;</span>);};</pre><p><a class="paragraph" href="#p6d6fe7f48ed236e" name="p6d6fe7f48ed236e"> ¶ </a>And to try it out...</p><pre class="code"><span class="keyword">var</span><span class="variable">terrarium</span>=<span class="keyword">new</span><span class="variable">Terrarium</span>(<span class="variable">thePlan</span>);<span class="variable">print</span>(<span class="variable">terrarium</span>.<span class="property">toString</span>());</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#pdab3c0c48b40f87" name="pdab3c0c48b40f87"> ¶ </a>It is possible that, when trying to solve the above exercise, you havetried to access <code>this.grid</code> inside the function that you pass as anargument to the grid's <code>each</code> method. This will not work. Calling afunction always results in a new <code>this</code> being defined inside thatfunction, even when it is not used as a method. Thus, any <code>this</code>variable outside of the function will not be visible.</p><p><a class="paragraph" href="#p6fceb2e91589da6a" name="p6fceb2e91589da6a"> ¶ </a>Sometimes it is straightforward to work around this by storing theinformation you need in a variable, like <code>endOfLine</code>, which <em>is</em>visible in the inner function. If you need access to the whole <code>this</code>object, you can store that in a variable too. The name <code>self</code> (or<code>that</code>) is often used for such a variable.</p><p><a class="paragraph" href="#pa47ded0a2ea1bbb" name="pa47ded0a2ea1bbb"> ¶ </a>But all these extra variables can get messy. Another good solution isto use a function similar to <code>partial</code> from <a href="chapter6.html">chapter 6</a>. Instead of addingarguments to a function, this one adds a <code>this</code> object, using thefirst argument to the function's <code>apply</code> method:</p><pre class="code"><span class="keyword">function</span><span class="variable">bind</span>(<span class="variabledef">func</span>, <span class="variabledef">object</span>){<span class="keyword">return</span><span class="keyword">function</span>(){<span class="keyword">return</span><span class="localvariable">func</span>.<span class="property">apply</span>(<span class="localvariable">object</span>, <span class="localvariable">arguments</span>);};}<span class="keyword">var</span><span class="variable">testArray</span>=[];<span class="keyword">var</span><span class="variable">pushTest</span>=<span class="variable">bind</span>(<span class="variable">testArray</span>.<span class="property">push</span>, <span class="variable">testArray</span>);<span class="variable">pushTest</span>(<span class="string">&quot;A&quot;</span>);<span class="variable">pushTest</span>(<span class="string">&quot;B&quot;</span>);<span class="variable">show</span>(<span class="variable">testArray</span>);</pre><p><a class="paragraph" href="#p5fca76321e7b900a" name="p5fca76321e7b900a"> ¶ </a>This way, you can <code>bind</code> an inner function to <code>this</code>, and it will havethe same <code>this</code> as the outer function.</p></div><hr/><div class="block"><a name="exercise4"></a><div class="exercisenum">Ex. 8.4</div><div class="exercise"><p><a class="paragraph" href="#p2f6a2baf6a6ea0a0" name="p2f6a2baf6a6ea0a0"> ¶ </a>In the expression <code>bind(testArray.push, testArray)</code> the name<code>testArray</code> still occurs twice. Can you design a function <a name="key21"></a><code>method</code>,which allows you to bind an object to one of its methods <em>without</em>naming the object twice?</p></div><div class="solution"><p><a class="paragraph" href="#p120fbfe1bd84d26" name="p120fbfe1bd84d26"> ¶ </a>It is possible to give the name of the method as a string. This way, the<code>method</code> function can look up the correct function value for itself.</p><pre class="code"><span class="keyword">function</span><span class="variable">method</span>(<span class="variabledef">object</span>, <span class="variabledef">name</span>){<span class="keyword">return</span><span class="keyword">function</span>(){<span class="keyword">return</span><span class="localvariable">object</span>[<span class="localvariable">name</span>].<span class="property">apply</span>(<span class="localvariable">object</span>, <span class="localvariable">arguments</span>);};}<span class="keyword">var</span><span class="variable">pushTest</span>=<span class="variable">method</span>(<span class="variable">testArray</span>, <span class="string">&quot;push&quot;</span>);</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p7a810d1a779f7817" name="p7a810d1a779f7817"> ¶ </a>We will need <code>bind</code> (or <code>method</code>) when implementing the <code>step</code> methodof a terrarium. This method has to go over all the bugs on the grid,ask them for an action, and execute the given action. You might betempted to use <code>each</code> on the grid, and just handle the bugs we comeacross. But then, when a bug moves South or East, we will come acrossit again in the same turn, and allow it to move again.</p><p><a class="paragraph" href="#p5e7251b804191f66" name="p5e7251b804191f66"> ¶ </a>Instead, we first gather all the bugs into an array, and then processthem. This method gathers bugs, or other things that have an <code>act</code>method, and stores them in objects that also contain their currentposition:</p><pre class="code"><span class="variable">Terrarium</span>.<span class="property">prototype</span>.<span class="property">listActingCreatures</span>=<span class="keyword">function</span>(){<span class="keyword">var</span><span class="variabledef">found</span>=[];<span class="localvariable">this</span>.<span class="property">grid</span>.<span class="property">each</span>(<span class="keyword">function</span>(<span class="variabledef">point</span>, <span class="variabledef">value</span>){<span class="keyword">if</span> (<span class="localvariable">value</span> !=<span class="atom">undefined</span> &amp;&amp;<span class="localvariable">value</span>.<span class="property">act</span>) <span class="localvariable">found</span>.<span class="property">push</span>({<span class="property">object</span>: <span class="localvariable">value</span>, <span class="property">point</span>: <span class="localvariable">point</span>});});<span class="keyword">return</span><span class="localvariable">found</span>;};</pre></div><hr/><div class="block"><a name="exercise5"></a><div class="exercisenum">Ex. 8.5</div><div class="exercise"><p><a class="paragraph" href="#p40072543c02b30aa" name="p40072543c02b30aa"> ¶ </a>When asking a bug to act, we must pass it an object with informationabout its current surroundings. This object will use the directionnames we saw earlier (<code>&quot;n&quot;</code>, <code>&quot;ne&quot;</code>, etcetera) as property names. Eachproperty holds a string of one character, as returned by<code>characterFromElement</code>, indicating what the bug can see in thatdirection.</p><p><a class="paragraph" href="#p4d6a26d8b927c395" name="p4d6a26d8b927c395"> ¶ </a>Add a method <code>listSurroundings</code> to the <code>Terrarium</code> prototype. It takesone argument, the point at which the bug is currently standing, andreturns an object with information about the surroundings of thatpoint. When the point is at the edge of the grid, use <code>&quot;#&quot;</code> for thedirections that go outside of the grid, so the bug will not try tomove there.</p><p><a class="paragraph" href="#p17dec5980cfd5fb6" name="p17dec5980cfd5fb6"> ¶ </a>Hint: Do not write out all the directions, use the <code>each</code> method onthe <code>directions</code> dictionary.</p></div><div class="solution"><pre class="code"><span class="variable">Terrarium</span>.<span class="property">prototype</span>.<span class="property">listSurroundings</span>=<span class="keyword">function</span>(<span class="variabledef">center</span>){<span class="keyword">var</span><span class="variabledef">result</span>={};<span class="keyword">var</span><span class="variabledef">grid</span>=<span class="localvariable">this</span>.<span class="property">grid</span>;<span class="variable">directions</span>.<span class="property">each</span>(<span class="keyword">function</span>(<span class="variabledef">name</span>, <span class="variabledef">direction</span>){<span class="keyword">var</span><span class="variabledef">place</span>=<span class="localvariable">center</span>.<span class="property">add</span>(<span class="localvariable">direction</span>);<span class="keyword">if</span> (<span class="localvariable">grid</span>.<span class="property">isInside</span>(<span class="localvariable">place</span>)) <span class="localvariable">result</span>[<span class="localvariable">name</span>]=<span class="variable">characterFromElement</span>(<span class="localvariable">grid</span>.<span class="property">valueAt</span>(<span class="localvariable">place</span>));<span class="keyword">else</span><span class="localvariable">result</span>[<span class="localvariable">name</span>]=<span class="string">&quot;#&quot;</span>;});<span class="keyword">return</span><span class="localvariable">result</span>;};</pre><p><a class="paragraph" href="#p413cebbd56aad079" name="p413cebbd56aad079"> ¶ </a>Note the use of the <code>grid</code> variable to work around the <code>this</code> problem.</p></div></div><hr/><div class="block"><p><a class="paragraph" href="#p6297bb18dc0fb882" name="p6297bb18dc0fb882"> ¶ </a>Both above methods are not part of the external interface of a<code>Terrarium</code> object, they are internal details. Some languages provideways to explicitly declare certain methods and properties 'private',and make it an error to use them from outside the object. JavaScriptdoes not, so you will have to rely on comments to describe theinterface to an object. Sometimes it can be useful to use some kind ofnaming scheme to distinguish between external and internal properties,for example by prefixing all internal ones with an underscore ('<code>_</code>').This will make accidental uses of properties that are not part of anobject's interface easier to spot.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p5c3903e78df76607" name="p5c3903e78df76607"> ¶ </a>Next is one more internal method, the one that will ask a bug for anaction and carry it out. It takes an object with <code>object</code> and <code>point</code>properties, as returned by <code>listActingCreatures</code>, as argument. For now,it only knows about the <code>&quot;move&quot;</code> action:</p><pre class="code"><span class="variable">Terrarium</span>.<span class="property">prototype</span>.<span class="property">processCreature</span>=<span class="keyword">function</span>(<span class="variabledef">creature</span>){<span class="keyword">var</span><span class="variabledef">surroundings</span>=<span class="localvariable">this</span>.<span class="property">listSurroundings</span>(<span class="localvariable">creature</span>.<span class="property">point</span>);<span class="keyword">var</span><span class="variabledef">action</span>=<span class="localvariable">creature</span>.<span class="property">object</span>.<span class="property">act</span>(<span class="localvariable">surroundings</span>);<span class="keyword">if</span> (<span class="localvariable">action</span>.<span class="property">type</span>==<span class="string">&quot;move&quot;</span> &amp;&amp;<span class="variable">directions</span>.<span class="property">contains</span>(<span class="localvariable">action</span>.<span class="property">direction</span>)){<span class="keyword">var</span><span class="variabledef">to</span>=<span class="localvariable">creature</span>.<span class="property">point</span>.<span class="property">add</span>(<span class="variable">directions</span>.<span class="property">lookup</span>(<span class="localvariable">action</span>.<span class="property">direction</span>));<span class="keyword">if</span> (<span class="localvariable">this</span>.<span class="property">grid</span>.<span class="property">isInside</span>(<span class="localvariable">to</span>) &amp;&amp;<span class="localvariable">this</span>.<span class="property">grid</span>.<span class="property">valueAt</span>(<span class="localvariable">to</span>)==<span class="atom">undefined</span>) <span class="localvariable">this</span>.<span class="property">grid</span>.<span class="property">moveValue</span>(<span class="localvariable">creature</span>.<span class="property">point</span>, <span class="localvariable">to</span>);}<span class="keyword">else</span>{<span class="keyword">throw</span><span class="keyword">new</span><span class="variable">Error</span>(<span class="string">&quot;Unsupported action: &quot;</span> + <span class="localvariable">action</span>.<span class="property">type</span>);}};</pre><p><a class="paragraph" href="#p20fba0575128ec62" name="p20fba0575128ec62"> ¶ </a>Note that it checks whether the chosen direction is inside of the gridand empty, and ignores it otherwise. This way, the bugs can ask forany action they like ― the action will only be carried out if it isactually possible. This acts as a layer of insulation between the bugsand the terrarium, and allows us to be less precise when writing thebugs' <code>act</code> methods ― for example the <code>StupidBug</code> just always travelsSouth, regardless of any walls that might stand in its way.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p6d41bfbdb15a2e59" name="p6d41bfbdb15a2e59"> ¶ </a>These three internal methods then finally allow us to write the <code>step</code>method, which gives all bugs a chance to do something (all elementswith an <code>act</code> method ― we could also give the <code>wall</code> object one if weso desired, and make the walls walk).</p><pre class="code"><span class="variable">Terrarium</span>.<span class="property">prototype</span>.<span class="property">step</span>=<span class="keyword">function</span>(){<span class="variable">forEach</span>(<span class="localvariable">this</span>.<span class="property">listActingCreatures</span>(), <span class="variable">bind</span>(<span class="localvariable">this</span>.<span class="property">processCreature</span>, <span class="localvariable">this</span>));};</pre><p><a class="paragraph" href="#p4a17101cbea56a43" name="p4a17101cbea56a43"> ¶ </a>Now, let us make a terrarium and see whether the bugs move...</p><pre class="code"><span class="keyword">var</span><span class="variable">terrarium</span>=<span class="keyword">new</span><span class="variable">Terrarium</span>(<span class="variable">thePlan</span>);<span class="variable">print</span>(<span class="variable">terrarium</span>);<span class="variable">terrarium</span>.<span class="property">step</span>();<span class="variable">print</span>(<span class="variable">terrarium</span>);</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p3bef263cc0ca4203" name="p3bef263cc0ca4203"> ¶ </a>Wait, how come the above calls <code>print(terrarium)</code> and ends updisplaying the output of our <a name="key22"></a><code>toString</code> method? <code>print</code> turns itsarguments to strings using the <code>String</code> function. Objects are turnedto strings by calling their <code>toString</code> method, so giving your ownobject types a meaningful <code>toString</code> is a good way to make themreadable when printed out.</p><pre class="code"><span class="variable">Point</span>.<span class="property">prototype</span>.<span class="property">toString</span>=<span class="keyword">function</span>(){<span class="keyword">return</span><span class="string">&quot;(&quot;</span> + <span class="localvariable">this</span>.<span class="property">x</span> + <span class="string">&quot;,&quot;</span> + <span class="localvariable">this</span>.<span class="property">y</span> + <span class="string">&quot;)&quot;</span>;};<span class="variable">print</span>(<span class="keyword">new</span><span class="variable">Point</span>(<span class="atom">5</span>, <span class="atom">5</span>));</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p66525715fa3ed4fe" name="p66525715fa3ed4fe"> ¶ </a>As promised, <code>Terrarium</code> objects also get <code>start</code> and <code>stop</code> methodsto start or stop their simulation. For this, we will use two functionsprovided by the browser, called <a name="key23"></a><code>setInterval</code> and <a name="key24"></a><code>clearInterval</code>.The first is used to cause its first argument (a function, or a stringcontaining JavaScript code) to be executed periodically. Its secondargument gives the amount of milliseconds (1/1000 second) betweeninvocations. It returns a value that can be given to <code>clearInterval</code>to stop its effect.</p><pre class="code"><span class="keyword">var</span><span class="variable">annoy</span>=<span class="variable">setInterval</span>(<span class="keyword">function</span>(){<span class="variable">print</span>(<span class="string">&quot;What?&quot;</span>);}, <span class="atom">400</span>);</pre><p><a class="paragraph" href="#p5a9b2d6a5" name="p5a9b2d6a5"> ¶ </a>And...</p><pre class="code"><span class="variable">clearInterval</span>(<span class="variable">annoy</span>);</pre><p><a class="paragraph" href="#p65c6552ce64152a2" name="p65c6552ce64152a2"> ¶ </a>There are similar functions for one-shot time-based actions.<a name="key25"></a><code>setTimeout</code> causes a function or string to be executed after agiven amount of milliseconds, and <a name="key26"></a><code>clearTimeout</code> cancels such anaction.</p></div><hr/><div class="block"><pre class="code"><span class="variable">Terrarium</span>.<span class="property">prototype</span>.<span class="property">start</span>=<span class="keyword">function</span>(){<span class="keyword">if</span> (!<span class="localvariable">this</span>.<span class="property">running</span>) <span class="localvariable">this</span>.<span class="property">running</span>=<span class="variable">setInterval</span>(<span class="variable">bind</span>(<span class="localvariable">this</span>.<span class="property">step</span>, <span class="localvariable">this</span>), <span class="atom">500</span>);};<span class="variable">Terrarium</span>.<span class="property">prototype</span>.<span class="property">stop</span>=<span class="keyword">function</span>(){<span class="keyword">if</span> (<span class="localvariable">this</span>.<span class="property">running</span>){<span class="variable">clearInterval</span>(<span class="localvariable">this</span>.<span class="property">running</span>);<span class="localvariable">this</span>.<span class="property">running</span>=<span class="atom">null</span>;}};</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p56dee92e9e45266d" name="p56dee92e9e45266d"> ¶ </a>Now we have a terrarium with some simple-minded bugs, and we can runit. But to see what is going on, we have to repeatedly do<code>print(terrarium)</code>, or we won't see what is going on. That is not verypractical. It would be nicer if it would print automatically. It wouldalso look better if, instead of printing a thousand terraria beloweach other, we could update a single printout of the terrarium. Forthat second problem, this page conveniently provides a function called<code>inPlacePrinter</code>. It returns a function like <code>print</code> which, instead ofadding to the output, replaces its previous output.</p><pre class="code"><span class="keyword">var</span><span class="variable">printHere</span>=<span class="variable">inPlacePrinter</span>();<span class="variable">printHere</span>(<span class="string">&quot;Now you see it.&quot;</span>);<span class="variable">setTimeout</span>(<span class="variable">partial</span>(<span class="variable">printHere</span>, <span class="string">&quot;Now you don't.&quot;</span>), <span class="atom">1000</span>);</pre><p><a class="paragraph" href="#p709059f44d4e6a50" name="p709059f44d4e6a50"> ¶ </a>To cause the terrarium to be re-printed every time it changes, we canmodify the <code>step</code> method as follows:</p><pre class="code"><span class="variable">Terrarium</span>.<span class="property">prototype</span>.<span class="property">step</span>=<span class="keyword">function</span>(){<span class="variable">forEach</span>(<span class="localvariable">this</span>.<span class="property">listActingCreatures</span>(), <span class="variable">bind</span>(<span class="localvariable">this</span>.<span class="property">processCreature</span>, <span class="localvariable">this</span>));<span class="keyword">if</span> (<span class="localvariable">this</span>.<span class="property">onStep</span>) <span class="localvariable">this</span>.<span class="property">onStep</span>();};</pre><p><a class="paragraph" href="#p4290eaad2c2db8ab" name="p4290eaad2c2db8ab"> ¶ </a>Now, when an <code>onStep</code> property has been added to a terrarium, it willbe called on every step.</p><pre class="code"><span class="keyword">var</span><span class="variable">terrarium</span>=<span class="keyword">new</span><span class="variable">Terrarium</span>(<span class="variable">thePlan</span>);<span class="variable">terrarium</span>.<span class="property">onStep</span>=<span class="variable">partial</span>(<span class="variable">inPlacePrinter</span>(), <span class="variable">terrarium</span>);<span class="variable">terrarium</span>.<span class="property">start</span>();</pre><p><a class="paragraph" href="#p2d0605452e8bd940" name="p2d0605452e8bd940"> ¶ </a>Note the use of <code>partial</code> ― it produces an in-place printer appliedto the terrarium. Such a printer only takes one argument, so afterpartially applying it there are no arguments left, and it becomes afunction of zero arguments. That is exactly what we need for the<code>onStep</code> property.</p><p><a class="paragraph" href="#p6373da70db3ecd6d" name="p6373da70db3ecd6d"> ¶ </a>Don't forget to stop the terrarium when it is no longer interesting(which should be pretty soon), so that it does not keep wasting yourcomputer's resources:</p><pre class="code"><span class="variable">terrarium</span>.<span class="property">stop</span>();</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p473ec2ade63fa198" name="p473ec2ade63fa198"> ¶ </a>But who wants a terrarium with just one kind of bug, and a stupid bugat that? Not me. It would be nice if we could add different kinds ofbugs. Fortunately, all we have to do is to make the<code>elementFromCharacter</code> function more general. Right now it containsthree cases which are typed in directly, or 'hard-coded':</p><pre class="code"><span class="keyword">function</span><span class="variable">elementFromCharacter</span>(<span class="variabledef">character</span>){<span class="keyword">if</span> (<span class="localvariable">character</span>==<span class="string">&quot;&quot;</span>) <span class="keyword">return</span><span class="atom">undefined</span>;<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">character</span>==<span class="string">&quot;#&quot;</span>) <span class="keyword">return</span><span class="variable">wall</span>;<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">character</span>==<span class="string">&quot;o&quot;</span>) <span class="keyword">return</span><span class="keyword">new</span><span class="variable">StupidBug</span>();}</pre><p><a class="paragraph" href="#p1d99a6fa022e107" name="p1d99a6fa022e107"> ¶ </a>The first two cases we can leave intact, but the last one is way toospecific. A better approach would be to store the characters and thecorresponding bug-constructors in a dictionary, and look for themthere:</p><pre class="code"><span class="keyword">var</span><span class="variable">creatureTypes</span>=<span class="keyword">new</span><span class="variable">Dictionary</span>();<span class="variable">creatureTypes</span>.<span class="property">register</span>=<span class="keyword">function</span>(<span class="variabledef">constructor</span>){<span class="localvariable">this</span>.<span class="property">store</span>(<span class="localvariable">constructor</span>.<span class="property">prototype</span>.<span class="property">character</span>, <span class="localvariable">constructor</span>);};<span class="keyword">function</span><span class="variable">elementFromCharacter</span>(<span class="variabledef">character</span>){<span class="keyword">if</span> (<span class="localvariable">character</span>==<span class="string">&quot;&quot;</span>) <span class="keyword">return</span><span class="atom">undefined</span>;<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">character</span>==<span class="string">&quot;#&quot;</span>) <span class="keyword">return</span><span class="variable">wall</span>;<span class="keyword">else</span><span class="keyword">if</span> (<span class="variable">creatureTypes</span>.<span class="property">contains</span>(<span class="localvariable">character</span>)) <span class="keyword">return</span><span class="keyword">new</span> (<span class="variable">creatureTypes</span>.<span class="property">lookup</span>(<span class="localvariable">character</span>))();<span class="keyword">else</span><span class="keyword">throw</span><span class="keyword">new</span><span class="variable">Error</span>(<span class="string">&quot;Unknown character: &quot;</span> + <span class="localvariable">character</span>);}</pre><p><a class="paragraph" href="#p24b496fddbe1c1a" name="p24b496fddbe1c1a"> ¶ </a>Note how the <code>register</code> method is added to <code>creatureTypes</code> ― this isa dictionary object, but there is no reason why it shouldn't supportan additional method. This method looks up the character associatedwith a constructor, and stores it in the dictionary. It should only becalled on constructors whose prototype does actually have a<code>character</code> property.</p><p><a class="paragraph" href="#p2577d0539c0a27ad" name="p2577d0539c0a27ad"> ¶ </a><code>elementFromCharacter</code> now looks up the character it is given in<code>creatureTypes</code>, and raises an exception when it comes across anunknown character.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p7dc5495832c0814d" name="p7dc5495832c0814d"> ¶ </a>Here is a new bug type, and the call to register its character in<code>creatureTypes</code>:</p><pre class="code"><span class="keyword">function</span><span class="variable">BouncingBug</span>(){<span class="localvariable">this</span>.<span class="property">direction</span>=<span class="string">&quot;ne&quot;</span>;}<span class="variable">BouncingBug</span>.<span class="property">prototype</span>.<span class="property">act</span>=<span class="keyword">function</span>(<span class="variabledef">surroundings</span>){<span class="keyword">if</span> (<span class="localvariable">surroundings</span>[<span class="localvariable">this</span>.<span class="property">direction</span>] !=<span class="string">&quot;&quot;</span>) <span class="localvariable">this</span>.<span class="property">direction</span>=(<span class="localvariable">this</span>.<span class="property">direction</span>==<span class="string">&quot;ne&quot;</span> ? <span class="string">&quot;sw&quot;</span> : <span class="string">&quot;ne&quot;</span>);<span class="keyword">return</span>{<span class="property">type</span>: <span class="string">&quot;move&quot;</span>, <span class="property">direction</span>: <span class="localvariable">this</span>.<span class="property">direction</span>};};<span class="variable">BouncingBug</span>.<span class="property">prototype</span>.<span class="property">character</span>=<span class="string">&quot;%&quot;</span>;<span class="variable">creatureTypes</span>.<span class="property">register</span>(<span class="variable">BouncingBug</span>);</pre><p><a class="paragraph" href="#p2a96bb089be30662" name="p2a96bb089be30662"> ¶ </a>Can you figure out what it does?</p></div><hr/><div class="block"><a name="exercise6"></a><div class="exercisenum">Ex. 8.6</div><div class="exercise"><p><a class="paragraph" href="#p18ddd7e93c010002" name="p18ddd7e93c010002"> ¶ </a>Create a bug type called <code>DrunkBug</code> which tries to move in a randomdirection every turn, never mind whether there is a wall there.Remember the <code>Math.random</code> trick from <a href="chapter7.html">chapter 7</a>.</p></div><div class="solution"><p><a class="paragraph" href="#p63e8265c4f32da15" name="p63e8265c4f32da15"> ¶ </a>To pick a random direction, we will need an array of direction names.We could of course just type <code>[&quot;n&quot;, &quot;ne&quot;, ...]</code>, but that duplicatesinformation, and duplicated information makes me nervous. We couldalso use the <code>each</code> method in <code>directions</code> to build the array, whichis better already.</p><p><a class="paragraph" href="#pfa2dff0e314562b" name="pfa2dff0e314562b"> ¶ </a>But there is clearly a generality to be discovered here. Getting alist of the property names in a dictionary sounds like a useful toolto have, so we add it to the <code>Dictionary</code> prototype.</p><pre class="code"><span class="variable">Dictionary</span>.<span class="property">prototype</span>.<span class="property">names</span>=<span class="keyword">function</span>(){<span class="keyword">var</span><span class="variabledef">names</span>=[];<span class="localvariable">this</span>.<span class="property">each</span>(<span class="keyword">function</span>(<span class="variabledef">name</span>, <span class="variabledef">value</span>){<span class="localvariable">names</span>.<span class="property">push</span>(<span class="localvariable">name</span>);});<span class="keyword">return</span><span class="localvariable">names</span>;};<span class="variable">show</span>(<span class="variable">directions</span>.<span class="property">names</span>());</pre><p><a class="paragraph" href="#p7cf14ca4dffbc4a9" name="p7cf14ca4dffbc4a9"> ¶ </a>A real neurotic programmer would immediately restore symmetry by alsoadding a <code>values</code> method, which returns a list of the values stored inthe dictionary. But I guess that can wait until we <a href="http://www.c2.com/cgi/wiki?YouArentGonnaNeedIt">need it</a>.</p><p><a class="paragraph" href="#pc02c2c5583dbd50" name="pc02c2c5583dbd50"> ¶ </a>Here is a way to take a random element from an array:</p><pre class="code"><span class="keyword">function</span><span class="variable">randomElement</span>(<span class="variabledef">array</span>){<span class="keyword">if</span> (<span class="localvariable">array</span>.<span class="property">length</span>==<span class="atom">0</span>) <span class="keyword">throw</span><span class="keyword">new</span><span class="variable">Error</span>(<span class="string">&quot;The array is empty.&quot;</span>);<span class="keyword">return</span><span class="localvariable">array</span>[<span class="variable">Math</span>.<span class="property">floor</span>(<span class="variable">Math</span>.<span class="property">random</span>() * <span class="localvariable">array</span>.<span class="property">length</span>)];}<span class="variable">show</span>(<span class="variable">randomElement</span>([<span class="string">&quot;heads&quot;</span>, <span class="string">&quot;tails&quot;</span>]));</pre><p><a class="paragraph" href="#p3f063625cdeea8e7" name="p3f063625cdeea8e7"> ¶ </a>And the bug itself:</p><pre class="code"><span class="keyword">function</span><span class="variable">DrunkBug</span>(){};<span class="variable">DrunkBug</span>.<span class="property">prototype</span>.<span class="property">act</span>=<span class="keyword">function</span>(<span class="variabledef">surroundings</span>){<span class="keyword">return</span>{<span class="property">type</span>: <span class="string">&quot;move&quot;</span>, <span class="property">direction</span>: <span class="variable">randomElement</span>(<span class="variable">directions</span>.<span class="property">names</span>())};};<span class="variable">DrunkBug</span>.<span class="property">prototype</span>.<span class="property">character</span>=<span class="string">&quot;~&quot;</span>;<span class="variable">creatureTypes</span>.<span class="property">register</span>(<span class="variable">DrunkBug</span>);</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p6c2121e5aefe5ffe" name="p6c2121e5aefe5ffe"> ¶ </a>So, let us test out our new bugs:</p><pre class="code"><span class="keyword">var</span><span class="variable">newPlan</span>=[<span class="string">&quot;############################&quot;</span>, <span class="string">&quot;# #####&quot;</span>, <span class="string">&quot;# ## ####&quot;</span>, <span class="string">&quot;# #### ~ ~ ##&quot;</span>, <span class="string">&quot;# ## ~ #&quot;</span>, <span class="string">&quot;# #&quot;</span>, <span class="string">&quot;# ### #&quot;</span>, <span class="string">&quot;# ##### #&quot;</span>, <span class="string">&quot;# ### #&quot;</span>, <span class="string">&quot;# % ### % #&quot;</span>, <span class="string">&quot;# ####### #&quot;</span>, <span class="string">&quot;############################&quot;</span>];<span class="keyword">var</span><span class="variable">terrarium</span>=<span class="keyword">new</span><span class="variable">Terrarium</span>(<span class="variable">newPlan</span>);<span class="variable">terrarium</span>.<span class="property">onStep</span>=<span class="variable">partial</span>(<span class="variable">inPlacePrinter</span>(), <span class="variable">terrarium</span>);<span class="variable">terrarium</span>.<span class="property">start</span>();</pre><p><a class="paragraph" href="#p248478d6c6accb5f" name="p248478d6c6accb5f"> ¶ </a>Notice the bouncing bugs bouncing off the drunk ones? Pure drama.Anyway, when you are done watching this fascinating show, shut itdown:</p><pre class="code"><span class="variable">terrarium</span>.<span class="property">stop</span>();</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p79f13bf15c758a3b" name="p79f13bf15c758a3b"> ¶ </a>We now have two kinds of objects that both have an <code>act</code> method and a<code>character</code> property. Because they share these traits, the terrariumcan approach them in the same way. This allows us to have all kinds ofbugs, without changing anything about the terrarium code. Thistechnique is called <a name="key27"></a>polymorphism, and it is arguably the mostpowerful aspect of object-oriented programming.</p><p><a class="paragraph" href="#p4ba9a1a3fa44f56b" name="p4ba9a1a3fa44f56b"> ¶ </a>The basic idea of polymorphism is that when a piece of code is writtento work with objects that have a certain interface, any kind of objectthat happens to support this interface can be plugged into the code,and it will just work. We already saw simple examples of this, likethe <code>toString</code> method on objects. All objects that have a meaningful<code>toString</code> method can be given to <code>print</code> and other functions thatneed to convert values to strings, and the correct string will beproduced, no matter how their <code>toString</code> method chooses to build thisstring.</p><p><a class="paragraph" href="#p1fc9c932dbf032c2" name="p1fc9c932dbf032c2"> ¶ </a>Similarly, <code>forEach</code> works on both real arrays and the pseudo-arraysfound in the <code>arguments</code> variable, because all it needs is a <code>length</code>property and properties called <code>0</code>, <code>1</code>, and so on, for the elementsof the array.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p758d80d940318015" name="p758d80d940318015"> ¶ </a>To make life in the terrarium more life-like, we will add to it theconcepts of food and reproduction. Each living thing in the terrariumgets a new property, <code>energy</code>, which is reduced by performing actions,and increased by eating things. When it has enough energy, a thing canreproduce<a class="footref" href="#footnote2">2</a>, generating a new creature of the same kind.</p><p><a class="paragraph" href="#p42c42d12dc3c248" name="p42c42d12dc3c248"> ¶ </a>If there are only bugs, wasting energy by moving around and eatingeach other, a terrarium will soon succumb to the forces of entropy,run out of energy, and become a lifeless wasteland. To prevent thisfrom happening (too quickly, at least), we add lichen to theterrarium. Lichen do not move, they just use photo-synthesis togather energy, and reproduce.</p><p><a class="paragraph" href="#p67d47ddc7a971734" name="p67d47ddc7a971734"> ¶ </a>To make this work, we will need a terrarium with a different<code>processCreature</code> method. We could just replace the method of to the<code>Terrarium</code> prototype, but we have become very attached to thesimulation of the bouncing and drunk bugs, and we would hate to breakour old terrarium.</p><p><a class="paragraph" href="#p65909203631b5139" name="p65909203631b5139"> ¶ </a>What we can do is create a new constructor, <code>LifeLikeTerrarium</code>, whoseprototype is based on the <code>Terrarium</code> prototype, but which has adifferent <code>processCreature</code> method.</p></div><hr/><div class="block"><p><a class="paragraph" href="#pf522d85fca0a3c8" name="pf522d85fca0a3c8"> ¶ </a>There are a few ways to do this. We could go over the properties of<code>Terrarium.prototype</code>, and add them one by one to<code>LifeLikeTerrarium.prototype</code>. This is easy to do, and in some casesit is the best solution, but in this case there is a cleaner way. Ifwe make the old prototype object the prototype of the new prototypeobject (you may have to re-read that a few times), it willautomatically have all its properties.</p><p><a class="paragraph" href="#pd6a518d7928ff39" name="pd6a518d7928ff39"> ¶ </a><a name="key28"></a>Unfortunately, JavaScript does not have a straightforwardway to create an object whose prototype is a certain other object. Itis possible to write a function that does this, though, by using thefollowing trick:</p><pre class="code"><span class="keyword">function</span><span class="variable">clone</span>(<span class="variabledef">object</span>){<span class="keyword">function</span><span class="variabledef">OneShotConstructor</span>(){}<span class="localvariable">OneShotConstructor</span>.<span class="property">prototype</span>=<span class="localvariable">object</span>;<span class="keyword">return</span><span class="keyword">new</span><span class="localvariable">OneShotConstructor</span>();}</pre><p><a class="paragraph" href="#p33ecaf21fae6c51d" name="p33ecaf21fae6c51d"> ¶ </a>This function uses an empty one-shot constructor, whose prototype isthe given object. When using <code>new</code> on this constructor, it will createa new object based on the given object.</p><pre class="code"><span class="keyword">function</span><span class="variable">LifeLikeTerrarium</span>(<span class="variabledef">plan</span>){<span class="variable">Terrarium</span>.<span class="property">call</span>(<span class="localvariable">this</span>, <span class="localvariable">plan</span>);}<span class="variable">LifeLikeTerrarium</span>.<span class="property">prototype</span>=<span class="variable">clone</span>(<span class="variable">Terrarium</span>.<span class="property">prototype</span>);<span class="variable">LifeLikeTerrarium</span>.<span class="property">prototype</span>.<span class="property">constructor</span>=<span class="variable">LifeLikeTerrarium</span>;</pre><p><a class="paragraph" href="#p2ba39a102e7bc" name="p2ba39a102e7bc"> ¶ </a>The new constructor doesn't need to do anything different from the oldone, so it just calls the old one on the <code>this</code> object. We also haveto restore the <code>constructor</code> property in the new prototype, or itwould claim its constructor is <code>Terrarium</code> (which, of course, is onlyreally a problem when we make use of this property, which we don't).</p></div><hr/><div class="block"><p><a class="paragraph" href="#p150b93ea584ba68d" name="p150b93ea584ba68d"> ¶ </a>It is now possible to replace some of the methods of the<code>LifeLikeTerrarium</code> object, or add new ones. We have based a newobject type on an old one, which saved us the work of re-writing allthe methods which are the same in <code>Terrarium</code> and <code>LifeLikeTerrarium</code>.This technique is called '<a name="key29"></a>inheritance'. The new type inherits theproperties of the old type. In most cases, this means the new typewill still support the interface of the old type, though it might alsosupport a few methods that the old type does not have. This way,objects of the new type can be (polymorphically) used in all theplaces where objects of the old type could be used.</p><p><a class="paragraph" href="#p3cd64c42173d9d1b" name="p3cd64c42173d9d1b"> ¶ </a>In most programming languages with explicit support forobject-oriented programming, inheritance is a very straightforwardthing. In JavaScript, the language doesn't really specify a simple wayto do it. Because of this, JavaScript programmers have invented manydifferent approaches to inheritance. Unfortunately, none of them isquite perfect. Fortunately, such a broad range of approaches allows aprogrammer to choose the most suitable one for the problem he issolving, and allows certain tricks that would be utterly impossible inother languages.</p><p><a class="paragraph" href="#p463807b9df8e8556" name="p463807b9df8e8556"> ¶ </a>At the end of this chapter, I will show a few other ways to doinheritance, and the issues they have.</p></div><hr/><div class="block"><p><a class="paragraph" href="#pdf62a47811257c7" name="pdf62a47811257c7"> ¶ </a>Here is the new <code>processCreature</code> method. It is big.</p><pre class="code"><span class="variable">LifeLikeTerrarium</span>.<span class="property">prototype</span>.<span class="property">processCreature</span>=<span class="keyword">function</span>(<span class="variabledef">creature</span>){<span class="keyword">if</span> (<span class="localvariable">creature</span>.<span class="property">object</span>.<span class="property">energy</span> &lt;=<span class="atom">0</span>) <span class="keyword">return</span>;<span class="keyword">var</span><span class="variabledef">surroundings</span>=<span class="localvariable">this</span>.<span class="property">listSurroundings</span>(<span class="localvariable">creature</span>.<span class="property">point</span>);<span class="keyword">var</span><span class="variabledef">action</span>=<span class="localvariable">creature</span>.<span class="property">object</span>.<span class="property">act</span>(<span class="localvariable">surroundings</span>);<span class="keyword">var</span><span class="variabledef">target</span>=<span class="atom">undefined</span>;<span class="keyword">var</span><span class="variabledef">valueAtTarget</span>=<span class="atom">undefined</span>;<span class="keyword">if</span> (<span class="localvariable">action</span>.<span class="property">direction</span> &amp;&amp;<span class="variable">directions</span>.<span class="property">contains</span>(<span class="localvariable">action</span>.<span class="property">direction</span>)){<span class="keyword">var</span><span class="variabledef">direction</span>=<span class="variable">directions</span>.<span class="property">lookup</span>(<span class="localvariable">action</span>.<span class="property">direction</span>);<span class="keyword">var</span><span class="variabledef">maybe</span>=<span class="localvariable">creature</span>.<span class="property">point</span>.<span class="property">add</span>(<span class="localvariable">direction</span>);<span class="keyword">if</span> (<span class="localvariable">this</span>.<span class="property">grid</span>.<span class="property">isInside</span>(<span class="localvariable">maybe</span>)){<span class="localvariable">target</span>=<span class="localvariable">maybe</span>;<span class="localvariable">valueAtTarget</span>=<span class="localvariable">this</span>.<span class="property">grid</span>.<span class="property">valueAt</span>(<span class="localvariable">target</span>);}}<span class="keyword">if</span> (<span class="localvariable">action</span>.<span class="property">type</span>==<span class="string">&quot;move&quot;</span>){<span class="keyword">if</span> (<span class="localvariable">target</span> &amp;&amp;!<span class="localvariable">valueAtTarget</span>){<span class="localvariable">this</span>.<span class="property">grid</span>.<span class="property">moveValue</span>(<span class="localvariable">creature</span>.<span class="property">point</span>, <span class="localvariable">target</span>);<span class="localvariable">creature</span>.<span class="property">point</span>=<span class="localvariable">target</span>;<span class="localvariable">creature</span>.<span class="property">object</span>.<span class="property">energy</span> -=<span class="atom">1</span>;}}<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">action</span>.<span class="property">type</span>==<span class="string">&quot;eat&quot;</span>){<span class="keyword">if</span> (<span class="localvariable">valueAtTarget</span> &amp;&amp;<span class="localvariable">valueAtTarget</span>.<span class="property">energy</span>){<span class="localvariable">this</span>.<span class="property">grid</span>.<span class="property">setValueAt</span>(<span class="localvariable">target</span>, <span class="atom">undefined</span>);<span class="localvariable">creature</span>.<span class="property">object</span>.<span class="property">energy</span> +=<span class="localvariable">valueAtTarget</span>.<span class="property">energy</span>;<span class="localvariable">valueAtTarget</span>.<span class="property">energy</span>=<span class="atom">0</span>;}}<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">action</span>.<span class="property">type</span>==<span class="string">&quot;photosynthese&quot;</span>){<span class="localvariable">creature</span>.<span class="property">object</span>.<span class="property">energy</span> +=<span class="atom">1</span>;}<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">action</span>.<span class="property">type</span>==<span class="string">&quot;reproduce&quot;</span>){<span class="keyword">if</span> (<span class="localvariable">target</span> &amp;&amp;!<span class="localvariable">valueAtTarget</span>){<span class="keyword">var</span><span class="variabledef">species</span>=<span class="variable">characterFromElement</span>(<span class="localvariable">creature</span>.<span class="property">object</span>);<span class="keyword">var</span><span class="variabledef">baby</span>=<span class="variable">elementFromCharacter</span>(<span class="localvariable">species</span>);<span class="localvariable">creature</span>.<span class="property">object</span>.<span class="property">energy</span> -=<span class="localvariable">baby</span>.<span class="property">energy</span> * <span class="atom">2</span>;<span class="keyword">if</span> (<span class="localvariable">creature</span>.<span class="property">object</span>.<span class="property">energy</span> &gt;<span class="atom">0</span>) <span class="localvariable">this</span>.<span class="property">grid</span>.<span class="property">setValueAt</span>(<span class="localvariable">target</span>, <span class="localvariable">baby</span>);}}<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">action</span>.<span class="property">type</span>==<span class="string">&quot;wait&quot;</span>){<span class="localvariable">creature</span>.<span class="property">object</span>.<span class="property">energy</span> -=<span class="atom">0.2</span>;}<span class="keyword">else</span>{<span class="keyword">throw</span><span class="keyword">new</span><span class="variable">Error</span>(<span class="string">&quot;Unsupported action: &quot;</span> + <span class="localvariable">action</span>.<span class="property">type</span>);}<span class="keyword">if</span> (<span class="localvariable">creature</span>.<span class="property">object</span>.<span class="property">energy</span> &lt;=<span class="atom">0</span>) <span class="localvariable">this</span>.<span class="property">grid</span>.<span class="property">setValueAt</span>(<span class="localvariable">creature</span>.<span class="property">point</span>, <span class="atom">undefined</span>);};</pre><p><a class="paragraph" href="#p2eb9628b144539c6" name="p2eb9628b144539c6"> ¶ </a>The function still starts by asking the creature for an action,provided it isn't out of energy (dead). Then, if the action has a<code>direction</code> property, it immediately computes which point on the gridthis direction points to and which value is currently sitting there.Three of the five supported actions need to know this, and the codewould be even uglier if they all computed it separately. If there isno <code>direction</code> property, or an invalid one, it leaves the variables<code>target</code> and <code>valueAtTarget</code> undefined.</p><p><a class="paragraph" href="#p678c8f5612aa7344" name="p678c8f5612aa7344"> ¶ </a>After this, it goes over all the actions. Some actions requireadditional checking before they are executed, this is done with aseparate <code>if</code> so that if a creature, for example, tries to walkthrough a wall, we do not generate an <code>&quot;Unsupported action&quot;</code>exception.</p><p><a class="paragraph" href="#p3b24dea4a496986b" name="p3b24dea4a496986b"> ¶ </a>Note that, in the <code>&quot;reproduce&quot;</code> action, the parent creature losestwice the energy that the newborn creature gets (childbearing is noteasy), and the new creature is only placed on the grid if the parenthad enough energy to produce it.</p><p><a class="paragraph" href="#p35cba7057ce1e0ef" name="p35cba7057ce1e0ef"> ¶ </a>After the action has been performed, we check whether the creature isout of energy. If it is, it dies, and we remove it.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p2f7f93b8a136a25b" name="p2f7f93b8a136a25b"> ¶ </a>Lichen is not a very complex organism. We will use the character <code>&quot;*&quot;</code>to represent it. Make sure you have defined the <code>randomElement</code>function from <a href="chapter8.html#exercise6">exercise 8.6</a>, because it is used again here.</p><pre class="code"><span class="keyword">function</span><span class="variable">Lichen</span>(){<span class="localvariable">this</span>.<span class="property">energy</span>=<span class="atom">5</span>;}<span class="variable">Lichen</span>.<span class="property">prototype</span>.<span class="property">act</span>=<span class="keyword">function</span>(<span class="variabledef">surroundings</span>){<span class="keyword">var</span><span class="variabledef">emptySpace</span>=<span class="variable">findDirections</span>(<span class="localvariable">surroundings</span>, <span class="string">&quot;&quot;</span>);<span class="keyword">if</span> (<span class="localvariable">this</span>.<span class="property">energy</span> &gt;=<span class="atom">13</span> &amp;&amp;<span class="localvariable">emptySpace</span>.<span class="property">length</span> &gt;<span class="atom">0</span>) <span class="keyword">return</span>{<span class="property">type</span>: <span class="string">&quot;reproduce&quot;</span>, <span class="property">direction</span>: <span class="variable">randomElement</span>(<span class="localvariable">emptySpace</span>)};<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">this</span>.<span class="property">energy</span> &lt;<span class="atom">20</span>) <span class="keyword">return</span>{<span class="property">type</span>: <span class="string">&quot;photosynthese&quot;</span>};<span class="keyword">else</span><span class="keyword">return</span>{<span class="property">type</span>: <span class="string">&quot;wait&quot;</span>};};<span class="variable">Lichen</span>.<span class="property">prototype</span>.<span class="property">character</span>=<span class="string">&quot;*&quot;</span>;<span class="variable">creatureTypes</span>.<span class="property">register</span>(<span class="variable">Lichen</span>);<span class="keyword">function</span><span class="variable">findDirections</span>(<span class="variabledef">surroundings</span>, <span class="variabledef">wanted</span>){<span class="keyword">var</span><span class="variabledef">found</span>=[];<span class="variable">directions</span>.<span class="property">each</span>(<span class="keyword">function</span>(<span class="variabledef">name</span>){<span class="keyword">if</span> (<span class="localvariable">surroundings</span>[<span class="localvariable">name</span>]==<span class="localvariable">wanted</span>) <span class="localvariable">found</span>.<span class="property">push</span>(<span class="localvariable">name</span>);});<span class="keyword">return</span><span class="localvariable">found</span>;}</pre><p><a class="paragraph" href="#p6b321b75a17e9afc" name="p6b321b75a17e9afc"> ¶ </a>Lichen do not grow bigger than 20 energy, or they would get <em>huge</em>when they are surrounded by other lichen and have no room toreproduce.</p></div><hr/><div class="block"><a name="exercise7"></a><div class="exercisenum">Ex. 8.7</div><div class="exercise"><p><a class="paragraph" href="#p7a952902fe987f86" name="p7a952902fe987f86"> ¶ </a>Create a <code>LichenEater</code> creature. It starts with an energy of <code>10</code>, andbehaves in the following way:</p><ul><li>When it has an energy of 30 or more, and there is room near it, it reproduces.</li><li>Otherwise, if there are lichen nearby, it eats a random one.</li><li>Otherwise, if there is space to move, it moves into a random nearby empty square.</li><li>Otherwise, it waits.</li></ul><p><a class="paragraph" href="#p362b1713f878db19" name="p362b1713f878db19"> ¶ </a>Use <code>findDirections</code> and <code>randomElement</code> to check the surroundings andto pick directions. Give the lichen-eater <code>&quot;c&quot;</code> as its character(pac-man).</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">LichenEater</span>(){<span class="localvariable">this</span>.<span class="property">energy</span>=<span class="atom">10</span>;}<span class="variable">LichenEater</span>.<span class="property">prototype</span>.<span class="property">act</span>=<span class="keyword">function</span>(<span class="variabledef">surroundings</span>){<span class="keyword">var</span><span class="variabledef">emptySpace</span>=<span class="variable">findDirections</span>(<span class="localvariable">surroundings</span>, <span class="string">&quot;&quot;</span>);<span class="keyword">var</span><span class="variabledef">lichen</span>=<span class="variable">findDirections</span>(<span class="localvariable">surroundings</span>, <span class="string">&quot;*&quot;</span>);<span class="keyword">if</span> (<span class="localvariable">this</span>.<span class="property">energy</span> &gt;=<span class="atom">30</span> &amp;&amp;<span class="localvariable">emptySpace</span>.<span class="property">length</span> &gt;<span class="atom">0</span>) <span class="keyword">return</span>{<span class="property">type</span>: <span class="string">&quot;reproduce&quot;</span>, <span class="property">direction</span>: <span class="variable">randomElement</span>(<span class="localvariable">emptySpace</span>)};<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">lichen</span>.<span class="property">length</span> &gt;<span class="atom">0</span>) <span class="keyword">return</span>{<span class="property">type</span>: <span class="string">&quot;eat&quot;</span>, <span class="property">direction</span>: <span class="variable">randomElement</span>(<span class="localvariable">lichen</span>)};<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">emptySpace</span>.<span class="property">length</span> &gt;<span class="atom">0</span>) <span class="keyword">return</span>{<span class="property">type</span>: <span class="string">&quot;move&quot;</span>, <span class="property">direction</span>: <span class="variable">randomElement</span>(<span class="localvariable">emptySpace</span>)};<span class="keyword">else</span><span class="keyword">return</span>{<span class="property">type</span>: <span class="string">&quot;wait&quot;</span>};};<span class="variable">LichenEater</span>.<span class="property">prototype</span>.<span class="property">character</span>=<span class="string">&quot;c&quot;</span>;<span class="variable">creatureTypes</span>.<span class="property">register</span>(<span class="variable">LichenEater</span>);</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p3eb90111f0a15929" name="p3eb90111f0a15929"> ¶ </a>And try it out.</p><pre class="code"><span class="keyword">var</span><span class="variable">lichenPlan</span>=[<span class="string">&quot;############################&quot;</span>, <span class="string">&quot;# ######&quot;</span>, <span class="string">&quot;# *** **##&quot;</span>, <span class="string">&quot;# *##** ** c *##&quot;</span>, <span class="string">&quot;# *** c ##** *#&quot;</span>, <span class="string">&quot;# c ##*** *#&quot;</span>, <span class="string">&quot;# ##** *#&quot;</span>, <span class="string">&quot;# c #* *#&quot;</span>, <span class="string">&quot;#* #** c *#&quot;</span>, <span class="string">&quot;#*** ##** c **#&quot;</span>, <span class="string">&quot;#***** ###*** *###&quot;</span>, <span class="string">&quot;############################&quot;</span>];<span class="keyword">var</span><span class="variable">terrarium</span>=<span class="keyword">new</span><span class="variable">LifeLikeTerrarium</span>(<span class="variable">lichenPlan</span>);<span class="variable">terrarium</span>.<span class="property">onStep</span>=<span class="variable">partial</span>(<span class="variable">inPlacePrinter</span>(), <span class="variable">terrarium</span>);<span class="variable">terrarium</span>.<span class="property">start</span>();</pre><p><a class="paragraph" href="#p32f60535b0258d2c" name="p32f60535b0258d2c"> ¶ </a>Most likely, you will see the lichen quickly over-grow a large part ofthe terrarium, after which the abundance of food makes the eaters sonumerous that they wipe out all the lichen, and thus themselves. Ah,tragedy of nature.</p><pre class="code"><span class="variable">terrarium</span>.<span class="property">stop</span>();</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p2ce28a6e767ca8f3" name="p2ce28a6e767ca8f3"> ¶ </a>Having the inhabitants of your terrarium go extinct after a fewminutes is kind of depressing. To deal with this, we have to teach ourlichen-eaters about long-term sustainable farming. By making them onlyeat if they see at least two lichen nearby, no matter how hungry theyare, they will never exterminate the lichen. This requires somediscipline, but the result is a biotope that does not destroy itself.Here is a new <code>act</code> method ― the only change is that it now only eatswhen <code>lichen.length</code> is at least two.</p><pre class="code"><span class="variable">LichenEater</span>.<span class="property">prototype</span>.<span class="property">act</span>=<span class="keyword">function</span>(<span class="variabledef">surroundings</span>){<span class="keyword">var</span><span class="variabledef">emptySpace</span>=<span class="variable">findDirections</span>(<span class="localvariable">surroundings</span>, <span class="string">&quot;&quot;</span>);<span class="keyword">var</span><span class="variabledef">lichen</span>=<span class="variable">findDirections</span>(<span class="localvariable">surroundings</span>, <span class="string">&quot;*&quot;</span>);<span class="keyword">if</span> (<span class="localvariable">this</span>.<span class="property">energy</span> &gt;=<span class="atom">30</span> &amp;&amp;<span class="localvariable">emptySpace</span>.<span class="property">length</span> &gt;<span class="atom">0</span>) <span class="keyword">return</span>{<span class="property">type</span>: <span class="string">&quot;reproduce&quot;</span>, <span class="property">direction</span>: <span class="variable">randomElement</span>(<span class="localvariable">emptySpace</span>)};<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">lichen</span>.<span class="property">length</span> &gt;<span class="atom">1</span>) <span class="keyword">return</span>{<span class="property">type</span>: <span class="string">&quot;eat&quot;</span>, <span class="property">direction</span>: <span class="variable">randomElement</span>(<span class="localvariable">lichen</span>)};<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">emptySpace</span>.<span class="property">length</span> &gt;<span class="atom">0</span>) <span class="keyword">return</span>{<span class="property">type</span>: <span class="string">&quot;move&quot;</span>, <span class="property">direction</span>: <span class="variable">randomElement</span>(<span class="localvariable">emptySpace</span>)};<span class="keyword">else</span><span class="keyword">return</span>{<span class="property">type</span>: <span class="string">&quot;wait&quot;</span>};};</pre><p><a class="paragraph" href="#p20678085b14d6a43" name="p20678085b14d6a43"> ¶ </a>Run the above <code>lichenPlan</code> terrarium again, and see how it goes.Unless you are very lucky, the lichen-eaters will probably still goextinct after a while, because, in a time of mass starvation, theycrawl aimlessly back and forth through empty space, instead of findingthe lichen that is sitting just around the corner.</p></div><hr/><div class="block"><a name="exercise8"></a><div class="exercisenum">Ex. 8.8</div><div class="exercise"><p><a class="paragraph" href="#p579343bcf39d474e" name="p579343bcf39d474e"> ¶ </a>Find a way to modify the <code>LichenEater</code> to be more likely to survive.Do not cheat ― <code>this.energy +=100</code> is cheating. If you rewrite theconstructor, do not forget to re-register it in the <code>creatureTypes</code>dictionary, or the terrarium will continue to use the old constructor.</p></div><div class="solution"><p><a class="paragraph" href="#p75ffb12656cb10eb" name="p75ffb12656cb10eb"> ¶ </a>One approach would be to reduce the randomness of its movement. Byalways picking a random direction, it will often move back and forthwithout getting anywhere. By remembering the last direction it went,and preferring that direction, the eater will waste less time, andfind food faster.</p><pre class="code"><span class="keyword">function</span><span class="variable">CleverLichenEater</span>(){<span class="localvariable">this</span>.<span class="property">energy</span>=<span class="atom">10</span>;<span class="localvariable">this</span>.<span class="property">direction</span>=<span class="string">&quot;ne&quot;</span>;}<span class="variable">CleverLichenEater</span>.<span class="property">prototype</span>.<span class="property">act</span>=<span class="keyword">function</span>(<span class="variabledef">surroundings</span>){<span class="keyword">var</span><span class="variabledef">emptySpace</span>=<span class="variable">findDirections</span>(<span class="localvariable">surroundings</span>, <span class="string">&quot;&quot;</span>);<span class="keyword">var</span><span class="variabledef">lichen</span>=<span class="variable">findDirections</span>(<span class="localvariable">surroundings</span>, <span class="string">&quot;*&quot;</span>);<span class="keyword">if</span> (<span class="localvariable">this</span>.<span class="property">energy</span> &gt;=<span class="atom">30</span> &amp;&amp;<span class="localvariable">emptySpace</span>.<span class="property">length</span> &gt;<span class="atom">0</span>){<span class="keyword">return</span>{<span class="property">type</span>: <span class="string">&quot;reproduce&quot;</span>, <span class="property">direction</span>: <span class="variable">randomElement</span>(<span class="localvariable">emptySpace</span>)};}<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">lichen</span>.<span class="property">length</span> &gt;<span class="atom">1</span>){<span class="keyword">return</span>{<span class="property">type</span>: <span class="string">&quot;eat&quot;</span>, <span class="property">direction</span>: <span class="variable">randomElement</span>(<span class="localvariable">lichen</span>)};}<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">emptySpace</span>.<span class="property">length</span> &gt;<span class="atom">0</span>){<span class="keyword">if</span> (<span class="localvariable">surroundings</span>[<span class="localvariable">this</span>.<span class="property">direction</span>] !=<span class="string">&quot;&quot;</span>) <span class="localvariable">this</span>.<span class="property">direction</span>=<span class="variable">randomElement</span>(<span class="localvariable">emptySpace</span>);<span class="keyword">return</span>{<span class="property">type</span>: <span class="string">&quot;move&quot;</span>, <span class="property">direction</span>: <span class="localvariable">this</span>.<span class="property">direction</span>};}<span class="keyword">else</span>{<span class="keyword">return</span>{<span class="property">type</span>: <span class="string">&quot;wait&quot;</span>};}};<span class="variable">CleverLichenEater</span>.<span class="property">prototype</span>.<span class="property">character</span>=<span class="string">&quot;c&quot;</span>;<span class="variable">creatureTypes</span>.<span class="property">register</span>(<span class="variable">CleverLichenEater</span>);</pre><p><a class="paragraph" href="#p4437e880cacc64e1" name="p4437e880cacc64e1"> ¶ </a>Try it out using the previous terrarium-plan.</p></div></div><hr/><div class="block"><a name="exercise9"></a><div class="exercisenum">Ex. 8.9</div><div class="exercise"><p><a class="paragraph" href="#pfec1523c677c149" name="pfec1523c677c149"> ¶ </a>A one-link food chain is still a bit rudimentary. Can you write a newcreature, <code>LichenEaterEater</code> (character <code>&quot;@&quot;</code>), which survives byeating lichen-eaters? Try to find a way to make it fit in theecosystem without dying out too quickly. Modify the <code>lichenPlan</code> arrayto include a few of these, and try them out.</p></div><div class="solution"><p><a class="paragraph" href="#p23994d0645459645" name="p23994d0645459645"> ¶ </a>You are on your own here. I failed to find a really good way toprevent these creatures from either going extinct right away orgobbling up all lichen-eaters and then going extinct. The trick ofonly eating when it spots two pieces of food doesn't work very wellfor them, because their food moves around so much it is rare to findtwo in one place. What does seem to help is making the eater-eaterreally fat (high energy), so that it can survive times whenlichen-eaters are scarce, and only reproduces slowly, which preventsit from exterminating its food source too quickly.</p><p><a class="paragraph" href="#p446e3604a8766308" name="p446e3604a8766308"> ¶ </a>The lichen and eaters go through a periodic movement ― sometimeslichen are abundant, which causes a lot of eaters to be born, whichcauses the lichen to become scarce, which causes the eaters to starve,which causes the lichen to become abundant, and so on. You could tryto make the lichen-eater-eaters 'hibernate' (use the <code>&quot;wait&quot;</code> actionfor a while), when they fail to find food for a few turns. If youchoose the right amount of turns for this hibernation, or have themwake up automatically when they smell lots of food, this could be agood strategy.</p></div></div><hr/><div class="block"><p><a class="paragraph" href="#p436c3a722d3cad23" name="p436c3a722d3cad23"> ¶ </a>That concludes our discussion of terraria. The rest of the chapter isdevoted to a more in-depth look at inheritance, and the problemsrelated to inheritance in JavaScript.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p3830370304b66488" name="p3830370304b66488"> ¶ </a>First, some theory. Students of object-oriented programming can oftenbe heard having lengthy, subtle discussions about correct andincorrect uses of inheritance. It is important to bear in mind thatinheritance, in the end, is just a trick that allows lazy<a class="footref" href="#footnote3">3</a>programmers to write less code. Thus, the question of whetherinheritance is being used correctly boils down to the question ofwhether the resulting code works correctly and avoids uselessrepetitions. Still, the principles used by these students provide agood way to start thinking about inheritance.</p><p><a class="paragraph" href="#p32881e0715c30db" name="p32881e0715c30db"> ¶ </a>Inheritance is the creation of a new type of objects, the'<a name="key30"></a>sub-type', based on an existing type, the '<a name="key31"></a>super-type'. Thesub-type starts with all the properties and methods of the super-type,it inherits them, and then modifies a few of these, and optionallyadds new ones. Inheritance is best used when the thing modelled by thesub-type can be said to <em>be</em> an object of the super-type.</p><p><a class="paragraph" href="#p1dec7ccc2bddffe4" name="p1dec7ccc2bddffe4"> ¶ </a>Thus, a <code>Piano</code> type could be a sub-type of an <code>Instrument</code> type,because a piano <em>is</em> an instrument. Because a piano has a whole arrayof keys, one might be tempted to make <code>Piano</code> a sub-type of <code>Array</code>,but a piano <em>is</em> no array, and implementing it like that is bound tolead to all kinds of silliness. For example, a piano also has pedals.Why would <code>piano[0]</code> give me the first key, and not the first pedal?The situation is, of course, that a piano <em>has</em> keys, so it would bebetter to give it a property <code>keys</code>, and possibly another property<code>pedals</code>, both holding arrays.</p><p><a class="paragraph" href="#p6a1c7c2b75c953a7" name="p6a1c7c2b75c953a7"> ¶ </a>It is possible for a sub-type to be the super-type of yet anothersub-type. Some problems are best solved by building a complex familytree of types. You have to take care not to get too inheritance-happy,though. Overuse of inheritance is a great way to make a program into abig ugly mess.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p644bfcb5a2a20d3e" name="p644bfcb5a2a20d3e"> ¶ </a>The working of the <code>new</code> keyword and the <code>prototype</code> property ofconstructors suggest a certain way of using objects. For simpleobjects, such as the terrarium-creatures, this way works rather well.Unfortunately, when a program starts to make serious use ofinheritance, this approach to objects quickly becomes clumsy. Addingsome functions to take care of common operations can make things alittle smoother. Many people define, for example, <code>inherit</code> and<code>method</code> methods on objects.</p><pre class="code"><span class="variable">Object</span>.<span class="property">prototype</span>.<span class="property">inherit</span>=<span class="keyword">function</span>(<span class="variabledef">baseConstructor</span>){<span class="localvariable">this</span>.<span class="property">prototype</span>=<span class="variable">clone</span>(<span class="localvariable">baseConstructor</span>.<span class="property">prototype</span>);<span class="localvariable">this</span>.<span class="property">prototype</span>.<span class="property">constructor</span>=<span class="localvariable">this</span>;};<span class="variable">Object</span>.<span class="property">prototype</span>.<span class="property">method</span>=<span class="keyword">function</span>(<span class="variabledef">name</span>, <span class="variabledef">func</span>){<span class="localvariable">this</span>.<span class="property">prototype</span>[<span class="localvariable">name</span>]=<span class="localvariable">func</span>;};<span class="keyword">function</span><span class="variable">StrangeArray</span>(){}<span class="variable">StrangeArray</span>.<span class="property">inherit</span>(<span class="variable">Array</span>);<span class="variable">StrangeArray</span>.<span class="property">method</span>(<span class="string">&quot;push&quot;</span>, <span class="keyword">function</span>(<span class="variabledef">value</span>){<span class="variable">Array</span>.<span class="property">prototype</span>.<span class="property">push</span>.<span class="property">call</span>(<span class="localvariable">this</span>, <span class="localvariable">value</span>);<span class="variable">Array</span>.<span class="property">prototype</span>.<span class="property">push</span>.<span class="property">call</span>(<span class="localvariable">this</span>, <span class="localvariable">value</span>);});<span class="keyword">var</span><span class="variable">strange</span>=<span class="keyword">new</span><span class="variable">StrangeArray</span>();<span class="variable">strange</span>.<span class="property">push</span>(<span class="atom">4</span>);<span class="variable">show</span>(<span class="variable">strange</span>);</pre><p><a class="paragraph" href="#p27152a799564fcf9" name="p27152a799564fcf9"> ¶ </a>If you search the web for the words 'JavaScript' and 'inheritance',you will come across scores of different variations on this, some ofthem quite a lot more complex and clever than the above.</p><p><a class="paragraph" href="#p5e8a5e0394d81eb" name="p5e8a5e0394d81eb"> ¶ </a>Note how the <code>push</code> method written here uses the <code>push</code> method fromthe prototype of its parent type. This is something that is done oftenwhen using inheritance ― a method in the sub-type internally uses amethod of the super-type, but extends it somehow.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p6a4f3dddfa85055c" name="p6a4f3dddfa85055c"> ¶ </a>The biggest problem with this basic approach is the duality betweenconstructors and prototypes. Constructors take a very central role,they are the things that give an object type its name, and when youneed to get at a prototype, you have to go to the constructor and takeits <code>prototype</code> property.</p><p><a class="paragraph" href="#p2e0cd0294f8f916b" name="p2e0cd0294f8f916b"> ¶ </a>Not only does this lead to a <em>lot</em> of typing (<code>&quot;prototype&quot;</code> is 9letters), it is also confusing. We had to write an empty, uselessconstructor for <code>StrangeArray</code> in the example above. Quite a fewtimes, I have found myself accidentally adding methods to aconstructor instead of its prototype, or trying to call <code>Array.slice</code>when I really meant <code>Array.prototype.slice</code>. As far as I am concerned,the prototype itself is the most important aspect of an object type,and the constructor is just an extension of that, a special kind ofmethod.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p7e0e1720d924931f" name="p7e0e1720d924931f"> ¶ </a>With a few simple helper methods added to <code>Object.prototype</code>, it ispossible to create an alternative approach to objects and inheritance.In this approach, a type is represented by its prototype, and we willuse capitalised variables to store these prototypes. When it needs todo any 'constructing' work, this is done by a method called<code>construct</code>. We add a method called <code>create</code> to the <code>Object</code>prototype, which is used in place of the <code>new</code> keyword. It clones theobject, and calls its <code>construct</code> method, if there is such a method,giving it the arguments that were passed to <code>create</code>.</p><pre class="code"><span class="variable">Object</span>.<span class="property">prototype</span>.<span class="property">create</span>=<span class="keyword">function</span>(){<span class="keyword">var</span><span class="variabledef">object</span>=<span class="variable">clone</span>(<span class="localvariable">this</span>);<span class="keyword">if</span> (typeof <span class="localvariable">object</span>.<span class="property">construct</span>==<span class="string">&quot;function&quot;</span>) <span class="localvariable">object</span>.<span class="property">construct</span>.<span class="property">apply</span>(<span class="localvariable">object</span>, <span class="localvariable">arguments</span>);<span class="keyword">return</span><span class="localvariable">object</span>;};</pre><p><a class="paragraph" href="#p37e6ddc63c91c187" name="p37e6ddc63c91c187"> ¶ </a>Inheritance can be done by cloning a prototype object and adding orreplacing some of its properties. We also provide a convenientshorthand for this, an <code>extend</code> method, which clones the object it isapplied to and adds to this clone the properties in the object that itis given as an argument.</p><pre class="code"><span class="variable">Object</span>.<span class="property">prototype</span>.<span class="property">extend</span>=<span class="keyword">function</span>(<span class="variabledef">properties</span>){<span class="keyword">var</span><span class="variabledef">result</span>=<span class="variable">clone</span>(<span class="localvariable">this</span>);<span class="variable">forEachIn</span>(<span class="localvariable">properties</span>, <span class="keyword">function</span>(<span class="variabledef">name</span>, <span class="variabledef">value</span>){<span class="localvariable">result</span>[<span class="localvariable">name</span>]=<span class="localvariable">value</span>;});<span class="keyword">return</span><span class="localvariable">result</span>;};</pre><p><a class="paragraph" href="#p74d7be1ca42471c" name="p74d7be1ca42471c"> ¶ </a>In a case where it is not safe to mess with the <code>Object</code> prototype,these can of course be implemented as regular (non-method) functions.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p4b11691c21a7a212" name="p4b11691c21a7a212"> ¶ </a>An example. If you are old enough, you may at one time have played a'text adventure' game, where you move through a virtual world bytyping commands, and get textual descriptions of the things around youand the actions you perform. Now those were games!</p><p><a class="paragraph" href="#p78217bb27e83fcae" name="p78217bb27e83fcae"> ¶ </a>We could write the prototype for an item in such a game like this.</p><pre class="code"><span class="keyword">var</span><span class="variable">Item</span>={<span class="property">construct</span>: <span class="keyword">function</span>(<span class="variabledef">name</span>){<span class="localvariable">this</span>.<span class="property">name</span>=<span class="localvariable">name</span>;}, <span class="property">inspect</span>: <span class="keyword">function</span>(){<span class="variable">print</span>(<span class="string">&quot;it is &quot;</span>, <span class="localvariable">this</span>.<span class="property">name</span>, <span class="string">&quot;.&quot;</span>);}, <span class="property">kick</span>: <span class="keyword">function</span>(){<span class="variable">print</span>(<span class="string">&quot;klunk!&quot;</span>);}, <span class="property">take</span>: <span class="keyword">function</span>(){<span class="variable">print</span>(<span class="string">&quot;you can not lift &quot;</span>, <span class="localvariable">this</span>.<span class="property">name</span>, <span class="string">&quot;.&quot;</span>);}};<span class="keyword">var</span><span class="variable">lantern</span>=<span class="variable">Item</span>.<span class="property">create</span>(<span class="string">&quot;the brass lantern&quot;</span>);<span class="variable">lantern</span>.<span class="property">kick</span>();</pre><p><a class="paragraph" href="#pdef19b06a873573" name="pdef19b06a873573"> ¶ </a>Inherit from it like this...</p><pre class="code"><span class="keyword">var</span><span class="variable">DetailedItem</span>=<span class="variable">Item</span>.<span class="property">extend</span>({<span class="property">construct</span>: <span class="keyword">function</span>(<span class="variabledef">name</span>, <span class="variabledef">details</span>){<span class="variable">Item</span>.<span class="property">construct</span>.<span class="property">call</span>(<span class="localvariable">this</span>, <span class="localvariable">name</span>);<span class="localvariable">this</span>.<span class="property">details</span>=<span class="localvariable">details</span>;}, <span class="property">inspect</span>: <span class="keyword">function</span>(){<span class="variable">print</span>(<span class="string">&quot;you see &quot;</span>, <span class="localvariable">this</span>.<span class="property">name</span>, <span class="string">&quot;, &quot;</span>, <span class="localvariable">this</span>.<span class="property">details</span>, <span class="string">&quot;.&quot;</span>);}});<span class="keyword">var</span><span class="variable">giantSloth</span>=<span class="variable">DetailedItem</span>.<span class="property">create</span>( <span class="string">&quot;the giant sloth&quot;</span>, <span class="string">&quot;it is quietly hanging from a tree, munching leaves&quot;</span>);<span class="variable">giantSloth</span>.<span class="property">inspect</span>();</pre><p><a class="paragraph" href="#p3a393a9c25c0d4b4" name="p3a393a9c25c0d4b4"> ¶ </a>Leaving out the compulsory <code>prototype</code> part makes things like calling<code>Item.construct</code> from <code>DetailedItem</code>'s constructor slightly simpler.Note that it would be a bad idea to just do <code>this.name=name</code> in<code>DetailedItem.construct</code>. This duplicates a line. Sure, duplicatingthe line is shorter than calling the <code>Item.construct</code> function, but ifwe end up adding something to this constructor later, we have to addit in two places.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p6f1156c2057a9871" name="p6f1156c2057a9871"> ¶ </a>Most of the time, a sub-type's constructor should start by calling theconstructor of the super-type. This way, it starts with a valid objectof the super-type, which it can then extend. In this new approach toprototypes, types that need no constructor can leave it out. They willautomatically inherit the constructor of their super-type.</p><pre class="code"><span class="keyword">var</span><span class="variable">SmallItem</span>=<span class="variable">Item</span>.<span class="property">extend</span>({<span class="property">kick</span>: <span class="keyword">function</span>(){<span class="variable">print</span>(<span class="localvariable">this</span>.<span class="property">name</span>, <span class="string">&quot;flies across the room.&quot;</span>);}, <span class="property">take</span>: <span class="keyword">function</span>(){<span class="comment">// (imagine some code that moves the item to your pocket here)</span><span class="variable">print</span>(<span class="string">&quot;you take &quot;</span>, <span class="localvariable">this</span>.<span class="property">name</span>, <span class="string">&quot;.&quot;</span>);}});<span class="keyword">var</span><span class="variable">pencil</span>=<span class="variable">SmallItem</span>.<span class="property">create</span>(<span class="string">&quot;the red pencil&quot;</span>);<span class="variable">pencil</span>.<span class="property">take</span>();</pre><p><a class="paragraph" href="#p177ec83e58f32995" name="p177ec83e58f32995"> ¶ </a>Even though <code>SmallItem</code> does not define its own constructor, creatingit with a <code>name</code> argument works, because it inherited the constructorfrom the <code>Item</code> prototype.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p184c126e4d8eb12d" name="p184c126e4d8eb12d"> ¶ </a>JavaScript has an operator called <a name="key32"></a><code>instanceof</code>, which can be used todetermine whether an object is based on a certain prototype. You giveit the object on the left hand side, and a constructor on the righthand side, and it returns a boolean, <code>true</code> if the constructor's<code>prototype</code> property is the direct or indirect prototype of theobject, and <code>false</code> otherwise.</p><p><a class="paragraph" href="#pbaadbbd2abbbf87" name="pbaadbbd2abbbf87"> ¶ </a>When you are not using regular constructors, using this operatorbecomes rather clumsy ― it expects a constructor function as itssecond argument, but we only have prototypes. A trick similar to the<code>clone</code> function can be used to get around it: We use a 'fakeconstructor', and apply <code>instanceof</code> to it.</p><pre class="code"><span class="variable">Object</span>.<span class="property">prototype</span>.<span class="property">hasPrototype</span>=<span class="keyword">function</span>(<span class="variabledef">prototype</span>){<span class="keyword">function</span><span class="variabledef">DummyConstructor</span>(){}<span class="localvariable">DummyConstructor</span>.<span class="property">prototype</span>=<span class="localvariable">prototype</span>;<span class="keyword">return</span><span class="localvariable">this</span> instanceof <span class="localvariable">DummyConstructor</span>;};<span class="variable">show</span>(<span class="variable">pencil</span>.<span class="property">hasPrototype</span>(<span class="variable">Item</span>));<span class="variable">show</span>(<span class="variable">pencil</span>.<span class="property">hasPrototype</span>(<span class="variable">DetailedItem</span>));</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p1d25ab62feead1a3" name="p1d25ab62feead1a3"> ¶ </a>Next, we want to make a small item that has a detailed description. Itseems like this item would have to inherit both from <code>DetailedItem</code>and <code>SmallItem</code>. JavaScript does not allow an object to have multipleprototypes, and even if it did, the problem would not be quite thateasy to solve. For example, if <code>SmallItem</code> would, for some reason,also define an <code>inspect</code> method, which <code>inspect</code> method should the newprototype use?</p><p><a class="paragraph" href="#p48915eba7a651e30" name="p48915eba7a651e30"> ¶ </a>Deriving an object type from more than one parent type is called<a name="key33"></a>multiple inheritance. Some languages chicken out and forbid italtogether, others define complicated schemes for making it work in awell-defined and practical way. It is possible to implement a decentmultiple-inheritance framework in JavaScript. In fact there are, asusual, multiple good approaches to this. But they all are too complexto be discussed here. Instead, I will show a very simple approachwhich suffices in most cases.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p16400015b22a7338" name="p16400015b22a7338"> ¶ </a>A <a name="key34"></a>mix-in is a specific kind of prototype which can be 'mixed into'other prototypes. <code>SmallItem</code> can be seen as such a prototype. Bycopying its <code>kick</code> and <code>take</code> methods into another prototype, we mixsmallness into this prototype.</p><pre class="code"><span class="keyword">function</span><span class="variable">mixInto</span>(<span class="variabledef">object</span>, <span class="variabledef">mixIn</span>){<span class="variable">forEachIn</span>(<span class="localvariable">mixIn</span>, <span class="keyword">function</span>(<span class="variabledef">name</span>, <span class="variabledef">value</span>){<span class="localvariable">object</span>[<span class="localvariable">name</span>]=<span class="localvariable">value</span>;});};<span class="keyword">var</span><span class="variable">SmallDetailedItem</span>=<span class="variable">clone</span>(<span class="variable">DetailedItem</span>);<span class="variable">mixInto</span>(<span class="variable">SmallDetailedItem</span>, <span class="variable">SmallItem</span>);<span class="keyword">var</span><span class="variable">deadMouse</span>=<span class="variable">SmallDetailedItem</span>.<span class="property">create</span>( <span class="string">&quot;Fred the mouse&quot;</span>, <span class="string">&quot;he is dead&quot;</span>);<span class="variable">deadMouse</span>.<span class="property">inspect</span>();<span class="variable">deadMouse</span>.<span class="property">kick</span>();</pre><p><a class="paragraph" href="#p21dd81048149cd05" name="p21dd81048149cd05"> ¶ </a>Remember that <code>forEachIn</code> only goes over the object's <em>own</em>properties, so it will copy <code>kick</code> and <code>take</code>, but not the constructorthat <code>SmallItem</code> inherited from <code>Item</code>.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p75d5ae0a2088df83" name="p75d5ae0a2088df83"> ¶ </a>Mixing prototypes gets more complex when the mix-in has a constructor,or when some of its methods 'clash' with methods in the prototype thatit is mixed into. Sometimes, it is workable to do a 'manual mix-in'.Say we have a prototype <code>Monster</code>, which has its own constructor, andwe want to mix that with <code>DetailedItem</code>.</p><pre class="code"><span class="keyword">var</span><span class="variable">Monster</span>=<span class="variable">Item</span>.<span class="property">extend</span>({<span class="property">construct</span>: <span class="keyword">function</span>(<span class="variabledef">name</span>, <span class="variabledef">dangerous</span>){<span class="variable">Item</span>.<span class="property">construct</span>.<span class="property">call</span>(<span class="localvariable">this</span>, <span class="localvariable">name</span>);<span class="localvariable">this</span>.<span class="property">dangerous</span>=<span class="localvariable">dangerous</span>;}, <span class="property">kick</span>: <span class="keyword">function</span>(){<span class="keyword">if</span> (<span class="localvariable">this</span>.<span class="property">dangerous</span>) <span class="variable">print</span>(<span class="localvariable">this</span>.<span class="property">name</span>, <span class="string">&quot;bites your head off.&quot;</span>);<span class="keyword">else</span><span class="variable">print</span>(<span class="localvariable">this</span>.<span class="property">name</span>, <span class="string">&quot;runs away, weeping.&quot;</span>);}});<span class="keyword">var</span><span class="variable">DetailedMonster</span>=<span class="variable">DetailedItem</span>.<span class="property">extend</span>({<span class="property">construct</span>: <span class="keyword">function</span>(<span class="variabledef">name</span>, <span class="variabledef">description</span>, <span class="variabledef">dangerous</span>){<span class="variable">DetailedItem</span>.<span class="property">construct</span>.<span class="property">call</span>(<span class="localvariable">this</span>, <span class="localvariable">name</span>, <span class="localvariable">description</span>);<span class="variable">Monster</span>.<span class="property">construct</span>.<span class="property">call</span>(<span class="localvariable">this</span>, <span class="localvariable">name</span>, <span class="localvariable">dangerous</span>);}, <span class="property">kick</span>: <span class="variable">Monster</span>.<span class="property">kick</span>});<span class="keyword">var</span><span class="variable">giantSloth</span>=<span class="variable">DetailedMonster</span>.<span class="property">create</span>( <span class="string">&quot;the giant sloth&quot;</span>, <span class="string">&quot;it is quietly hanging from a tree, munching leaves&quot;</span>, <span class="atom">true</span>);<span class="variable">giantSloth</span>.<span class="property">kick</span>();</pre><p><a class="paragraph" href="#p28df0d4d34a24925" name="p28df0d4d34a24925"> ¶ </a>But note that this causes <code>Item</code> constructor to be called twice whencreating a <code>DetailedMonster</code> ― once through the <code>DetailedItem</code>constructor, and once through the <code>Monster</code> constructor. In this casethere is not much harm done, but there are situations where this wouldcause a problem.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p5530c4df57764453" name="p5530c4df57764453"> ¶ </a>But don't let those complications discourage you from making use ofinheritance. Multiple inheritance, though extremely useful in somesituations, can be safely ignored most of the time. This is whylanguages like Java get away with forbidding multiple inheritance. Andif, at some point, you find that you really need it, you can searchthe web, do some research, and figure out an approach that works foryour situation.</p><p><a class="paragraph" href="#p759d3a7b43780a89" name="p759d3a7b43780a89"> ¶ </a>Now that I think about it, JavaScript would probably be a greatenvironment for building a text adventure. The ability to change thebehaviour of objects at will, which is what prototypical inheritancegives us, is very well suited for this. If you have an object<code>hedgehog</code>, which has the unique habit of rolling up when it iskicked, you can just change its <code>kick</code> method.</p><p><a class="paragraph" href="#p11b363307c0a7f67" name="p11b363307c0a7f67"> ¶ </a>Unfortunately, the text adventure went the way of the vinyl recordand, while once very popular, is nowadays only played by a smallpopulation of <a href="http://groups.google.com/group/rec.arts.int-fiction/topics">enthusiasts</a>.</p></div><ol class="footnotes"><li><a name="footnote1"></a>Such types are usually called 'classes' in other programminglanguages.</li><li><a name="footnote2"></a>To keep things reasonably simple, the creatures in our terrariumreproduce asexually, all by themselves.</li><li><a name="footnote3"></a>Laziness, for a programmer, is not necessarily a sin. The kind ofpeople who will industriously do the same thing over and over againtend to make great assembly-line workers and lousy programmers.</li></ol><h1><span class="number">Chapter 9: </span>Modularity</h1><div class="block"><p><a class="paragraph" href="#p462e143585b2bd04" name="p462e143585b2bd04"> ¶ </a>This chapter deals with the process of organising programs. In smallprograms, organisation rarely becomes a problem. As a program grows,however, it can reach a size where its structure and interpretationbecome hard to keep track of. Easily enough, such a program starts tolook like a bowl of spaghetti, an amorphous mass in which everythingseems to be connected to everything else.</p><p><a class="paragraph" href="#p6dbca427e076a788" name="p6dbca427e076a788"> ¶ </a>When structuring a program, we do two things. We separate it intosmaller parts, called <a name="key1"></a>modules, each of which has a specific role,and we specify the relations between these parts.</p><p><a class="paragraph" href="#p3895697c7cef4aaf" name="p3895697c7cef4aaf"> ¶ </a>In <a href="chapter8.html">chapter 8</a>, while developing a terrarium, we made use of a number offunctions described in <a href="chapter6.html">chapter 6</a>. The chapter also defined a few newconcepts that had nothing in particular to do with terraria, such as<code>clone</code> and the <code>Dictionary</code> type. All these things were haphazardlyadded to the environment. One way to split this program into moduleswould be:</p><ul><li>A module <code>FunctionalTools</code>, which contains the functions from <a href="chapter6.html">chapter 6</a>, and depends on nothing.</li><li>Then <code>ObjectTools</code>, which contains things like <code>clone</code> and <code>create</code>, and depends on <code>FunctionalTools</code>.</li><li><code>Dictionary</code>, containing the dictionary type, and depending on <code>FunctionalTools</code>.</li><li>And finally the <code>Terrarium</code> module, which depends on <code>ObjectTools</code> and <code>Dictionary</code>.</li></ul><p><a class="paragraph" href="#p2e1b410733dba78" name="p2e1b410733dba78"> ¶ </a>When a module <a name="key2"></a>depends on another module, it uses functions orvariables from that module, and will only work when this module isloaded.</p><p><a class="paragraph" href="#p3903f3609e775868" name="p3903f3609e775868"> ¶ </a>It is a good idea to make sure dependencies never form a circle. Notonly do circular dependencies create a practical problem (if module<code>A</code> and <code>B</code> depend on each other, which one should be loaded first?),it also makes the relation between the modules less straightforward,and can result in a modularised version of the spaghetti I mentionedearlier.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p5ada2c7b5f4cd057" name="p5ada2c7b5f4cd057"> ¶ </a>Most modern programming languages have some kind of module systembuilt in. Not JavaScript. Once again, we have to invent somethingourselves. The most obvious way to start is to put every module in adifferent file. This makes it clear which code belongs to whichmodule.</p><p><a class="paragraph" href="#p278741f16f40e062" name="p278741f16f40e062"> ¶ </a><a name="key3"></a>Browsers load JavaScript files when they find a <code>&lt;script&gt;</code>tag with an <code>src</code> attribute in the HTML of the web-page. The extension<code>.js</code> is usually used for files containing JavaScript code. On theconsole, a shortcut for loading files is provided by the <code>load</code>function.</p><pre class="code"><span class="variable">load</span>(<span class="string">&quot;FunctionalTools.js&quot;</span>);</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p3612a370b3fd2685" name="p3612a370b3fd2685"> ¶ </a>In some cases, giving load commands in the wrong order will result inerrors. If a module tries to create a <code>Dictionary</code> object, but the<code>Dictionary</code> module has not been loaded yet, it will be unable to findthe constructor, and will fail.</p><p><a class="paragraph" href="#pda0515a72640aa2" name="pda0515a72640aa2"> ¶ </a>One would imagine this to be easy to solve. Just put some calls to<code>load</code> at the top of the file for a module, to load all the modules itdepends on. Unfortunately, because of the way browsers work, calling<code>load</code> does not immediately cause the given file to be loaded. Thefile will be loaded <em>after</em> the current file has finished executing.Which is too late, usually.</p><p><a class="paragraph" href="#p60c820cc1f0bb29a" name="p60c820cc1f0bb29a"> ¶ </a>In most cases, the practical solution is to just manage dependenciesby hand: Put the <code>script</code> tags in your HTML documents in the rightorder.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p7ae6777e79353629" name="p7ae6777e79353629"> ¶ </a>There are two ways to (partially) automate dependency management. Thefirst is to keep a separate file with information about thedependencies between modules. This can be loaded first, and used todetermine the order in which to load the files. The second way is tonot use a <code>script</code> tag (<code>load</code> internally creates and adds such atag), but to fetch the content of the file directly (see <a href="chapter14.html">chapter 14</a>), andthen use the <code>eval</code> function to execute it. This makes script loadinginstantaneous, and thus easier to deal with.</p><p><a class="paragraph" href="#p64d1d3a066b53092" name="p64d1d3a066b53092"> ¶ </a><a name="key4"></a><code>eval</code>, short for 'evaluate', is an interesting function. You giveit a string value, and it will execute the content of the string asJavaScript code.</p><pre class="code"><span class="variable">eval</span>(<span class="string">&quot;print(\&quot;I am a string inside a string!\&quot;);&quot;</span>);</pre><p><a class="paragraph" href="#p2f7c4d375c787d44" name="p2f7c4d375c787d44"> ¶ </a>You can imagine that <code>eval</code> can be used to do some interesting things.Code can build new code, and run it. In most cases, however, problemsthat can be solved with creative uses of <code>eval</code> can also be solvedwith creative uses of anonymous functions, and the latter is lesslikely to cause strange problems.</p><p><a class="paragraph" href="#p3c7c1279aa2c552a" name="p3c7c1279aa2c552a"> ¶ </a>When <code>eval</code> is called inside a function, all new variables will becomelocal to that function. Thus, when a variation of the <code>load</code> would use<code>eval</code> internally, loading the <code>Dictionary</code> module would create a<code>Dictionary</code> constructor inside of the <code>load</code> function, which would belost as soon as the function returned. There are ways to work aroundthis, but they are rather clumsy.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p1760fa0cdd48ac47" name="p1760fa0cdd48ac47"> ¶ </a>Let us quickly go over the first variant of dependency management. Itrequires a special file for dependency information, which could looksomething like this:</p><pre class="code"><span class="keyword">var</span><span class="variable">dependencies</span>={<span class="string">&quot;ObjectTools.js&quot;</span>: [<span class="string">&quot;FunctionalTools.js&quot;</span>], <span class="string">&quot;Dictionary.js&quot;</span>: [<span class="string">&quot;ObjectTools.js&quot;</span>], <span class="string">&quot;TestModule.js&quot;</span>: [<span class="string">&quot;FunctionalTools.js&quot;</span>, <span class="string">&quot;Dictionary.js&quot;</span>]};</pre><p><a class="paragraph" href="#p36868c584900b459" name="p36868c584900b459"> ¶ </a>The <code>dependencies</code> object contains a property for each file thatdepends on other files. The values of the properties are arrays offile names. Note that we could not use a <code>Dictionary</code> object here,because we can not be sure that the <code>Dictionary</code> module has beenloaded yet. Because all the properties in this object will end in<code>&quot;.js&quot;</code>, they are unlikely to interfere with hidden properties like<code>__proto__</code> or <code>hasOwnProperty</code>, and a regular object will work fine.</p><p><a class="paragraph" href="#p67921e1675ae1581" name="p67921e1675ae1581"> ¶ </a>The dependency manager must do two things. Firstly it must make surethat files are loaded in the correct order, by loading a file'sdependencies before the file itself. And secondly, it must make surethat no file is loaded twice. Loading the same file twice might causeproblems, and is definitely a waste of time.</p><pre class="code"><span class="keyword">var</span><span class="variable">loadedFiles</span>={};<span class="keyword">function</span><span class="variable">require</span>(<span class="variabledef">file</span>){<span class="keyword">if</span> (<span class="variable">dependencies</span>[<span class="localvariable">file</span>]){<span class="keyword">var</span><span class="variabledef">files</span>=<span class="variable">dependencies</span>[<span class="localvariable">file</span>];<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">i</span>=<span class="atom">0</span>;<span class="localvariable">i</span> &lt;<span class="localvariable">files</span>.<span class="property">length</span>;<span class="localvariable">i</span>++) <span class="variable">require</span>(<span class="localvariable">files</span>[<span class="localvariable">i</span>]);}<span class="keyword">if</span> (!<span class="variable">loadedFiles</span>[<span class="localvariable">file</span>]){<span class="variable">loadedFiles</span>[<span class="localvariable">file</span>]=<span class="atom">true</span>;<span class="variable">load</span>(<span class="localvariable">file</span>);}}</pre><p><a class="paragraph" href="#p4b0482a846ce5463" name="p4b0482a846ce5463"> ¶ </a>The <a name="key5"></a><code>require</code> function can now be used to load a file and all itsdependencies. Note how it recursively calls itself to take care ofdependencies (and possible dependencies of that dependency).</p><pre class="code"><span class="variable">require</span>(<span class="string">&quot;TestModule.js&quot;</span>);</pre><pre class="code"><span class="variable">test</span>();</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p5f8fdc39c48e9f72" name="p5f8fdc39c48e9f72"> ¶ </a>Building a program as a set of nice, small modules often means theprogram will use a lot of different files. When programming for theweb, having lots of small JavaScript files on a page tends to make thepage slower to load. This does not have to be a problem though. Youcan write and test your program as a number of small files, and putthem all into a single big file when 'publishing' the program to theweb.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p511fd1a470b62a91" name="p511fd1a470b62a91"> ¶ </a>Just like an object type, a module has an interface. In simplecollection-of-functions modules such as <code>FunctionalTools</code>, theinterface usually consists of all the functions that are defined inthe module. In other cases, the interface of the module is only asmall part of the functions defined inside it. For example, ourmanuscript-to-HTML system from <a href="chapter6.html">chapter 6</a> only needs an interface of asingle function, <code>renderFile</code>. (The sub-system for building HTML wouldbe a separate module.)</p><p><a class="paragraph" href="#p263f60798e0d5774" name="p263f60798e0d5774"> ¶ </a>For modules which only define a single type of object, such as<code>Dictionary</code>, the object's interface is the same as the module'sinterface.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p3c747e5c1f737d59" name="p3c747e5c1f737d59"> ¶ </a>In JavaScript, 'top-level' variables all live together in a singleplace. In browsers, this place is an object that can be found underthe name <code>window</code>. The name is somewhat odd, <code>environment</code> or <code>top</code>would have made more sense, but since browsers associate a JavaScriptenvironment with a window (or 'frame'), someone decided that <code>window</code>was a logical name.</p><pre class="code"><span class="variable">show</span>(<span class="variable">window</span>);<span class="variable">show</span>(<span class="variable">window</span>.<span class="property">print</span>==<span class="variable">print</span>);<span class="variable">show</span>(<span class="variable">window</span>.<span class="property">window</span>.<span class="property">window</span>.<span class="property">window</span>.<span class="property">window</span>);</pre><p><a class="paragraph" href="#p352ca08c4808e061" name="p352ca08c4808e061"> ¶ </a>As the third line shows, the name <code>window</code> is merely a property ofthis environment object, pointing at itself.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p418c55cafaf82578" name="p418c55cafaf82578"> ¶ </a>When much code is loaded into an environment, it will use manytop-level variable names. Once there is more code than you can reallykeep track of, it becomes very easy to accidentally use a name thatwas already used for something else. This will break the code thatused the original value. The proliferation of top-level variables iscalled <a name="key6"></a>name-space pollution, and it can be a rather severe problemin JavaScript ― the language will not warn you when you redefine anexisting variable.</p><p><a class="paragraph" href="#p3aca3d89a64057bd" name="p3aca3d89a64057bd"> ¶ </a>There is no way to get rid of this problem entirely, but it can begreatly reduced by taking care to cause as little pollution aspossible. For one thing, modules should not use top-level variablesfor values that are not part of their external interface.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p1829408f56380633" name="p1829408f56380633"> ¶ </a>Not being able to define any internal functions and variables at allin your modules is, of course, not very practical. Fortunately, thereis a trick to get around this. We write all the code for the moduleinside a function, and then finally add the variables that are part ofthe module's interface to the <code>window</code> object. Because they werecreated in the same parent function, all the functions of the modulecan see each other, but code outside of the module can not.</p><pre class="code"><span class="keyword">function</span><span class="variable">buildMonthNameModule</span>(){<span class="keyword">var</span><span class="variabledef">names</span>=[<span class="string">&quot;January&quot;</span>, <span class="string">&quot;February&quot;</span>, <span class="string">&quot;March&quot;</span>, <span class="string">&quot;April&quot;</span>, <span class="string">&quot;May&quot;</span>, <span class="string">&quot;June&quot;</span>, <span class="string">&quot;July&quot;</span>, <span class="string">&quot;August&quot;</span>, <span class="string">&quot;September&quot;</span>, <span class="string">&quot;October&quot;</span>, <span class="string">&quot;November&quot;</span>, <span class="string">&quot;December&quot;</span>];<span class="keyword">function</span><span class="variabledef">getMonthName</span>(<span class="variabledef">number</span>){<span class="keyword">return</span><span class="localvariable">names</span>[<span class="localvariable">number</span>];}<span class="keyword">function</span><span class="variabledef">getMonthNumber</span>(<span class="variabledef">name</span>){<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">number</span>=<span class="atom">0</span>;<span class="localvariable">number</span> &lt;<span class="localvariable">names</span>.<span class="property">length</span>;<span class="localvariable">number</span>++){<span class="keyword">if</span> (<span class="localvariable">names</span>[<span class="localvariable">number</span>]==<span class="localvariable">name</span>) <span class="keyword">return</span><span class="localvariable">number</span>;}}<span class="variable">window</span>.<span class="property">getMonthName</span>=<span class="localvariable">getMonthName</span>;<span class="variable">window</span>.<span class="property">getMonthNumber</span>=<span class="localvariable">getMonthNumber</span>;}<span class="variable">buildMonthNameModule</span>();<span class="variable">show</span>(<span class="variable">getMonthName</span>(<span class="atom">11</span>));</pre><p><a class="paragraph" href="#p6abed197dfcfd02e" name="p6abed197dfcfd02e"> ¶ </a>This builds a very simple module for translating between month namesand their number (as used by <code>Date</code>, where January is <code>0</code>). But notethat <code>buildMonthNameModule</code> is still a top-level variable that is notpart of the module's interface. Also, we have to repeat the names ofthe interface functions three times. Ugh.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p3d1691c937faa6f7" name="p3d1691c937faa6f7"> ¶ </a>The first problem can be solved by making the module functionanonymous, and calling it directly. To do this, we have to add a pairof parentheses around the function value, or JavaScript will think itis a normal function definition, which can not be called directly.</p><p><a class="paragraph" href="#p7057309ec1009bce" name="p7057309ec1009bce"> ¶ </a>The second problem can be solved with a helper function, <code>provide</code>,which can be given an object containing the values that must beexported into the <code>window</code> object.</p><pre class="code"><span class="keyword">function</span><span class="variable">provide</span>(<span class="variabledef">values</span>){<span class="variable">forEachIn</span>(<span class="localvariable">values</span>, <span class="keyword">function</span>(<span class="variabledef">name</span>, <span class="variabledef">value</span>){<span class="variable">window</span>[<span class="localvariable">name</span>]=<span class="localvariable">value</span>;});}</pre><p><a class="paragraph" href="#pd61147f170d5ca3" name="pd61147f170d5ca3"> ¶ </a>Using this, we can write a module like this:</p><pre class="code">(<span class="keyword">function</span>(){<span class="keyword">var</span><span class="variabledef">names</span>=[<span class="string">&quot;Sunday&quot;</span>, <span class="string">&quot;Monday&quot;</span>, <span class="string">&quot;Tuesday&quot;</span>, <span class="string">&quot;Wednesday&quot;</span>, <span class="string">&quot;Thursday&quot;</span>, <span class="string">&quot;Friday&quot;</span>, <span class="string">&quot;Saturday&quot;</span>];<span class="variable">provide</span>({<span class="property">getDayName</span>: <span class="keyword">function</span>(<span class="variabledef">number</span>){<span class="keyword">return</span><span class="localvariable">names</span>[<span class="localvariable">number</span>];}, <span class="property">getDayNumber</span>: <span class="keyword">function</span>(<span class="variabledef">name</span>){<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">number</span>=<span class="atom">0</span>;<span class="localvariable">number</span> &lt;<span class="localvariable">names</span>.<span class="property">length</span>;<span class="localvariable">number</span>++){<span class="keyword">if</span> (<span class="localvariable">names</span>[<span class="localvariable">number</span>]==<span class="localvariable">name</span>) <span class="keyword">return</span><span class="localvariable">number</span>;}}});})();<span class="variable">show</span>(<span class="variable">getDayNumber</span>(<span class="string">&quot;Wednesday&quot;</span>));</pre><p><a class="paragraph" href="#p3d8d0684a25dbc3a" name="p3d8d0684a25dbc3a"> ¶ </a>I do not recommend writing modules like this right from the start.While you are still working on a piece of code, it is easier to justuse the simple approach we have used so far, and put everything at toplevel. That way, you can inspect the module's internal values in yourbrowser, and test them out. Once a module is more or less finished, itis not difficult to wrap it in a function.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p727ed06b4989266d" name="p727ed06b4989266d"> ¶ </a>There are cases where a module will export so many variables that itis a bad idea to put them all into the top-level environment. In caseslike this, you can do what the standard <code>Math</code> object does, andrepresent the module as a single object whose properties are thefunctions and values it exports. For example...</p><pre class="code"><span class="keyword">var</span><span class="variable">HTML</span>={<span class="property">tag</span>: <span class="keyword">function</span>(<span class="variabledef">name</span>, <span class="variabledef">content</span>, <span class="variabledef">properties</span>){<span class="keyword">return</span>{<span class="property">name</span>: <span class="localvariable">name</span>, <span class="property">properties</span>: <span class="localvariable">properties</span>, <span class="property">content</span>: <span class="localvariable">content</span>};}, <span class="property">link</span>: <span class="keyword">function</span>(<span class="variabledef">target</span>, <span class="variabledef">text</span>){<span class="keyword">return</span><span class="variable">HTML</span>.<span class="property">tag</span>(<span class="string">&quot;a&quot;</span>, [<span class="localvariable">text</span>],{<span class="property">href</span>: <span class="localvariable">target</span>});}<span class="comment">/* ... many more HTML-producing functions ... */</span>};</pre><p><a class="paragraph" href="#p17970bf58fef9476" name="p17970bf58fef9476"> ¶ </a>When you need the content of such a module so often that it becomescumbersome to constantly type <code>HTML</code>, you can always move it into thetop-level environment using <code>provide</code>.</p><pre class="code"><span class="variable">provide</span>(<span class="variable">HTML</span>);<span class="variable">show</span>(<span class="variable">link</span>(<span class="string">&quot;http://download.oracle.com/docs/cd/E19957-01/816-6408-10/object.htm&quot;</span>, <span class="string">&quot;This is how objects work.&quot;</span>));</pre><p><a class="paragraph" href="#p631548b0275f6ddb" name="p631548b0275f6ddb"> ¶ </a>You can even combine the function and object approaches, by puttingthe internal variables of the module inside a function, and havingthis function return an object containing its external interface.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p7cca580a8acbd620" name="p7cca580a8acbd620"> ¶ </a>When adding methods to standard prototypes, such as those of <code>Array</code>and <code>Object</code> a similar problem to name-space pollution occurs. If twomodules decide to add a <code>map</code> method to <code>Array.prototype</code>, you mighthave a problem. If these two versions of <code>map</code> have the precise sameeffect, things will continue to work, but only by sheer luck.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p19934344570563ca" name="p19934344570563ca"> ¶ </a>Designing an interface for a module or an object type is one of thesubtler aspects of programming. On the one hand, you do not want toexpose too many details. They will only get in the way when using themodule. On the other hand, you do not want to be <em>too</em> simple andgeneral, because that might make it impossible to use the module incomplex or specialised situations.</p><p><a class="paragraph" href="#p1559f2055beb9a4" name="p1559f2055beb9a4"> ¶ </a>Sometimes the solution is to provide two interfaces, a detailed'low-level' one for complicated things, and a simple 'high-level' onefor straightforward situations. The second one can usually be builtvery easily using the tools provided by the first one.</p><p><a class="paragraph" href="#p3e0782b573cdc399" name="p3e0782b573cdc399"> ¶ </a>In other cases, you just have to find the right idea around which tobase your interface. Compare this to the various approaches toinheritance we saw in <a href="chapter8.html">chapter 8</a>. By making prototypes the central concept,rather than constructors, we managed to make some things considerablymore straightforward.</p><p><a class="paragraph" href="#p1330ba7fba73a6b2" name="p1330ba7fba73a6b2"> ¶ </a>The best way to learn the value of good interface design is,unfortunately, to use bad interfaces. Once you get fed up with them,you'll figure out a way to improve them, and learn a lot in theprocess. Try not to assume that a lousy interface is 'just the way itis'. Fix it, or wrap it in a new interface that is better (we will seean example of this in <a href="chapter12.html">chapter 12</a>).</p></div><hr/><div class="block"><p><a class="paragraph" href="#p2855dfc6cedc9e10" name="p2855dfc6cedc9e10"> ¶ </a>There are functions which require a lot of arguments. Sometimes thismeans they are just badly designed, and can easily be remedied bysplitting them into a few more modest functions. But in other cases,there is no way around it. Typically, some of these arguments have asensible 'default' value. We could, for example, write yet anotherextended version of <code>range</code>.</p><pre class="code"><span class="keyword">function</span><span class="variable">range</span>(<span class="variabledef">start</span>, <span class="variabledef">end</span>, <span class="variabledef">stepSize</span>, <span class="variabledef">length</span>){<span class="keyword">if</span> (<span class="localvariable">stepSize</span>==<span class="atom">undefined</span>) <span class="localvariable">stepSize</span>=<span class="atom">1</span>;<span class="keyword">if</span> (<span class="localvariable">end</span>==<span class="atom">undefined</span>) <span class="localvariable">end</span>=<span class="localvariable">start</span> + <span class="localvariable">stepSize</span> * (<span class="localvariable">length</span> - <span class="atom">1</span>);<span class="keyword">var</span><span class="variabledef">result</span>=[];<span class="keyword">for</span> (;<span class="localvariable">start</span> &lt;=<span class="localvariable">end</span>;<span class="localvariable">start</span> +=<span class="localvariable">stepSize</span>) <span class="localvariable">result</span>.<span class="property">push</span>(<span class="localvariable">start</span>);<span class="keyword">return</span><span class="localvariable">result</span>;}<span class="variable">show</span>(<span class="variable">range</span>(<span class="atom">0</span>, <span class="atom">undefined</span>, <span class="atom">4</span>, <span class="atom">5</span>));</pre><p><a class="paragraph" href="#p553dbd9c534b0740" name="p553dbd9c534b0740"> ¶ </a>It can get hard to remember which argument goes where, not to mentionthe annoyance of having to pass <code>undefined</code> as a second argument whena <code>length</code> argument is used. We can make passing arguments to thisfunction more comprehensive by wrapping them in an object.</p><pre class="code"><span class="keyword">function</span><span class="variable">defaultTo</span>(<span class="variabledef">object</span>, <span class="variabledef">values</span>){<span class="variable">forEachIn</span>(<span class="localvariable">values</span>, <span class="keyword">function</span>(<span class="variabledef">name</span>, <span class="variabledef">value</span>){<span class="keyword">if</span> (!<span class="localvariable">object</span>.<span class="property">hasOwnProperty</span>(<span class="localvariable">name</span>)) <span class="localvariable">object</span>[<span class="localvariable">name</span>]=<span class="localvariable">value</span>;});}<span class="keyword">function</span><span class="variable">range</span>(<span class="variabledef">args</span>){<span class="variable">defaultTo</span>(<span class="localvariable">args</span>,{<span class="property">start</span>: <span class="atom">0</span>, <span class="property">stepSize</span>: <span class="atom">1</span>});<span class="keyword">if</span> (<span class="localvariable">args</span>.<span class="property">end</span>==<span class="atom">undefined</span>) <span class="localvariable">args</span>.<span class="property">end</span>=<span class="localvariable">args</span>.<span class="property">start</span> + <span class="localvariable">args</span>.<span class="property">stepSize</span> * (<span class="localvariable">args</span>.<span class="property">length</span> - <span class="atom">1</span>);<span class="keyword">var</span><span class="variabledef">result</span>=[];<span class="keyword">for</span> (;<span class="localvariable">args</span>.<span class="property">start</span> &lt;=<span class="localvariable">args</span>.<span class="property">end</span>;<span class="localvariable">args</span>.<span class="property">start</span> +=<span class="localvariable">args</span>.<span class="property">stepSize</span>) <span class="localvariable">result</span>.<span class="property">push</span>(<span class="localvariable">args</span>.<span class="property">start</span>);<span class="keyword">return</span><span class="localvariable">result</span>;}<span class="variable">show</span>(<span class="variable">range</span>({<span class="property">stepSize</span>: <span class="atom">4</span>, <span class="property">length</span>: <span class="atom">5</span>}));</pre><p><a class="paragraph" href="#p209935cf6c50e97b" name="p209935cf6c50e97b"> ¶ </a>The <code>defaultTo</code> function is useful for adding default values to anobject. It copies the properties of its second argument into its firstargument, skipping those that already have a value.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p1a7878ac38fce032" name="p1a7878ac38fce032"> ¶ </a>A module or group of modules that can be useful in more than oneprogram is usually called a <a name="key7"></a>library. For many programming languages,there is a huge set of quality libraries available. This meansprogrammers do not have to start from scratch all the time, which canmake them a lot more productive. For JavaScript, unfortunately, theamount of available libraries is not very large.</p><p><a class="paragraph" href="#p28730aa17f362171" name="p28730aa17f362171"> ¶ </a>But recently this seems to be improving. There are a number of goodlibraries with 'basic' tools, things like <code>map</code> and <code>clone</code>. Otherlanguages tend to provide such obviously useful things as built-instandard features, but with JavaScript you'll have to either build acollection of them for yourself or use a library. Using a library isrecommended: It is less work, and the code in a library has usuallybeen tested more thoroughly than the things you wrote yourself.</p><p><a class="paragraph" href="#p40fe3f5a106dc4ec" name="p40fe3f5a106dc4ec"> ¶ </a>Covering these basics, there are (among others) the 'lightweight'libraries <a href="http://www.prototypejs.org/">prototype</a>, <a href="http://mootools.net">mootools</a>, <a href="http://jquery.com">jQuery</a>, and <a href="http://mochikit.com">MochiKit</a>. There are also some larger 'frameworks'available, which do a lot more than just provide a set of basic tools.<a href="http://developer.yahoo.com/yui/">YUI</a> (by Yahoo), and <a href="http://dojotoolkit.org/">Dojo</a> seem to be the most popular ones in thatgenre. All of these can be downloaded and used free of charge. Mypersonal favourite is MochiKit, but this is mostly a matter of taste.When you get serious about JavaScript programming, it is a good ideato quickly glance through the documentation of each of these, to get ageneral idea about the way they work and the things they provide.</p><p><a class="paragraph" href="#p46d01329ecc618f" name="p46d01329ecc618f"> ¶ </a>The fact that a basic toolkit is almost indispensable for anynon-trivial JavaScript programs, combined with the fact that there areso many different toolkits, causes a bit of a dilemma for librarywriters. You either have to make your library depend on one of thetoolkits, or write the basic tools yourself and include them with thelibrary. The first option makes the library hard to use for people whoare using a different toolkit, and the second option adds a lot ofnon-essential code to the library. This dilemma might be one of thereasons why there are relatively few good, widely used JavaScriptlibraries. It is possible that, in the future, new versions ofECMAScript and changes in browsers will make toolkits less necessary,and thus (partially) solve this problem.</p></div><h1><span class="number">Chapter 10: </span>Regular Expressions</h1><div class="block"><p><a class="paragraph" href="#p64ff0b30104c964c" name="p64ff0b30104c964c"> ¶ </a>At various points in the previous chapters, we had to look forpatterns in string values. In <a href="chapter4.html">chapter 4</a> we extracted date values fromstrings by writing out the precise positions at which the numbers thatwere part of the date could be found. Later, in <a href="chapter6.html">chapter 6</a>, we saw someparticularly ugly pieces of code for finding certain types ofcharacters in a string, for example the characters that had to beescaped in HTML output.</p><p><a class="paragraph" href="#p4907100ef57e381c" name="p4907100ef57e381c"> ¶ </a><a name="key1"></a>Regular expressions are a language for describingpatterns in strings. They form a small, separate language, which isembedded inside JavaScript (and in various other programminglanguages, in one way or another). It is not a very readable language― big regular expressions tend to be completely unreadable. But, itis a useful tool, and can really simplify string-processing programs.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p213ad6cd9cbc5562" name="p213ad6cd9cbc5562"> ¶ </a>Just like strings get written between quotes, regular expressionpatterns get written between slashes (<a name="key2"></a><code>/</code>). This means that slashesinside the expression have to be escaped.</p><pre class="code"><span class="keyword">var</span><span class="variable">slash</span>=<span class="string">/\//</span>;<span class="variable">show</span>(<span class="string">&quot;AC/DC&quot;</span>.<span class="property">search</span>(<span class="variable">slash</span>));</pre><p><a class="paragraph" href="#p1101481f3b05a5ca" name="p1101481f3b05a5ca"> ¶ </a>The <a name="key3"></a><code>search</code> method resembles <code>indexOf</code>, but it searches for aregular expression instead of a string. Patterns specified by regularexpressions can do a few things that strings can not do. For a start,they allow some of their elements to match more than a singlecharacter. In <a href="chapter6.html">chapter 6</a>, when extracting mark-up from a document, weneeded to find the first asterisk or opening brace in a string. Thatcould be done like this:</p><pre class="code"><span class="keyword">var</span><span class="variable">asteriskOrBrace</span>=<span class="string">/[\{\*]/</span>;<span class="keyword">var</span><span class="variable">story</span>=<span class="string">&quot;We noticed the *giant sloth*, hanging from a giant branch.&quot;</span>;<span class="variable">show</span>(<span class="variable">story</span>.<span class="property">search</span>(<span class="variable">asteriskOrBrace</span>));</pre><p><a class="paragraph" href="#p5233b3c75c1b3d93" name="p5233b3c75c1b3d93"> ¶ </a>The <code>[</code> and <code>]</code> characters have a special meaning inside a regularexpression. They can enclose a set of characters, and they mean 'anyof these characters'. Most non-alphanumeric characters have somespecial meaning inside a regular expression, so it is a good idea toalways escape them with a backslash<a class="footref" href="#footnote1">1</a> when you use them to refer tothe actual characters.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p10dd6e1797cc70f4" name="p10dd6e1797cc70f4"> ¶ </a>There are a few shortcuts for sets of characters that are neededoften. The dot (<code>.</code>) can be used to mean 'any character that is not anewline', an escaped 'd' (<code>\d</code>) means 'any digit', an escaped 'w'(<code>\w</code>) matches any alphanumeric character (including underscores, forsome reason), and an escaped 's' (<code>\s</code>) matches any white-space (tab,newline, space) character.</p><pre class="code"><span class="keyword">var</span><span class="variable">digitSurroundedBySpace</span>=<span class="string">/\s\d\s/</span>;<span class="variable">show</span>(<span class="string">&quot;1a 2 3d&quot;</span>.<span class="property">search</span>(<span class="variable">digitSurroundedBySpace</span>));</pre><p><a class="paragraph" href="#p6e04fda25e1e13c5" name="p6e04fda25e1e13c5"> ¶ </a>The escaped 'd', 'w', and 's' can be replaced by their capital letterto mean their opposite. For example, <code>\S</code> matches any character thatis <em>not</em> white-space. When using <code>[</code> and <code>]</code>, a pattern can beinverted by starting with a <code>^</code> character:</p><pre class="code"><span class="keyword">var</span><span class="variable">notABC</span>=<span class="string">/[^ABC]/</span>;<span class="variable">show</span>(<span class="string">&quot;ABCBACCBBADABC&quot;</span>.<span class="property">search</span>(<span class="variable">notABC</span>));</pre><p><a class="paragraph" href="#p2684c39c7b00c483" name="p2684c39c7b00c483"> ¶ </a>As you can see, the way regular expressions use characters to expresspatterns makes them A) very short, and B) very hard to read.</p></div><hr/><div class="block"><a name="exercise1"></a><div class="exercisenum">Ex. 10.1</div><div class="exercise"><p><a class="paragraph" href="#p7ff8b44542842a86" name="p7ff8b44542842a86"> ¶ </a>Write a regular expression that matches a date in the format<code>&quot;XX/XX/XXXX&quot;</code>, where the <code>X</code>s are digits. Test it against the string<code>&quot;born 15/11/2003 (mother Spot): White Fang&quot;</code>.</p></div><div class="solution"><pre class="code"><span class="keyword">var</span><span class="variable">datePattern</span>=<span class="string">/\d\d\/\d\d\/\d\d\d\d/</span>;<span class="variable">show</span>(<span class="string">&quot;born 15/11/2003 (mother Spot): White Fang&quot;</span>.<span class="property">search</span>(<span class="variable">datePattern</span>));</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p44f51a2cf46d4125" name="p44f51a2cf46d4125"> ¶ </a>Sometimes you need to make sure a pattern starts at the beginning of astring, or ends at its end. For this, the special characters <code>^</code> and<code>$</code> can be used. The first matches the start of the string, the secondthe end.</p><pre class="code"><span class="variable">show</span>(<span class="string">/a+/</span>.<span class="property">test</span>(<span class="string">&quot;blah&quot;</span>));<span class="variable">show</span>(<span class="string">/^a+$/</span>.<span class="property">test</span>(<span class="string">&quot;blah&quot;</span>));</pre><p><a class="paragraph" href="#p2699070e35a42354" name="p2699070e35a42354"> ¶ </a>The first regular expression matches any string that contains an <code>a</code>character, the second only those strings that consist entirely of <code>a</code>characters.</p><p><a class="paragraph" href="#p15e04302f56cd0d8" name="p15e04302f56cd0d8"> ¶ </a>Note that regular expressions are objects, and have methods. Their<a name="key4"></a><code>test</code> method returns a boolean indicating whether the given stringmatches the expression.</p><p><a class="paragraph" href="#p22062b94cbeb2c8f" name="p22062b94cbeb2c8f"> ¶ </a>The code <code>\b</code> matches a 'word boundary', which can be punctuation,white-space, or the start or end of the string.</p><pre class="code"><span class="variable">show</span>(<span class="string">/cat/</span>.<span class="property">test</span>(<span class="string">&quot;concatenate&quot;</span>));<span class="variable">show</span>(<span class="string">/\bcat\b/</span>.<span class="property">test</span>(<span class="string">&quot;concatenate&quot;</span>));</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p68f6323f6df2f848" name="p68f6323f6df2f848"> ¶ </a>Parts of a pattern can be allowed to be repeated a number of times.Putting an asterisk (<code>*</code>) after an element allows it to be repeatedany number of times, including zero. A plus (<code>+</code>) does the same, butrequires the pattern to occur at least one time. A question mark (<code>?</code>)makes an element 'optional' ― it can occur zero or one times.</p><pre class="code"><span class="keyword">var</span><span class="variable">parenthesizedText</span>=<span class="string">/\(.*\)/</span>;<span class="variable">show</span>(<span class="string">&quot;Its (the sloth's) claws were gigantic!&quot;</span>.<span class="property">search</span>(<span class="variable">parenthesizedText</span>));</pre><p><a class="paragraph" href="#p12db0944e3d8f760" name="p12db0944e3d8f760"> ¶ </a>When necessary, braces can be used to be more precise about the amountof times an element may occur. A number between braces (<code>{4}</code>) givesthe exact amount of times it must occur. Two numbers with a commabetween them (<code>{3,10}</code>) indicate that the pattern must occur at leastas often as the first number, and at most as often as the second one.Similarly, <code>{2,}</code> means two or more occurrences, while <code>{,4}</code> meansfour or less.</p><pre class="code"><span class="keyword">var</span><span class="variable">datePattern</span>=<span class="string">/\d{1,2}\/\d\d?\/\d{4}/</span>;<span class="variable">show</span>(<span class="string">&quot;born 15/11/2003 (mother Spot): White Fang&quot;</span>.<span class="property">search</span>(<span class="variable">datePattern</span>));</pre><p><a class="paragraph" href="#p3892407e1b16f81" name="p3892407e1b16f81"> ¶ </a>The pieces <code>/\d{1,2}/</code> and <code>/\d\d?/</code> both express 'one or two digits'.</p></div><hr/><div class="block"><a name="exercise2"></a><div class="exercisenum">Ex. 10.2</div><div class="exercise"><p><a class="paragraph" href="#p61c72523f73c013f" name="p61c72523f73c013f"> ¶ </a>Write a pattern that matches e-mail addresses. For simplicity, assumethat the parts before and after the <code>@</code> can contain only alphanumericcharacters and the characters <code>.</code> and <code>-</code> (dot and dash), while thelast part of the address, the country code after the last dot, mayonly contain alphanumeric characters, and must be two or threecharacters long.</p></div><div class="solution"><pre class="code"><span class="keyword">var</span><span class="variable">mailAddress</span>=<span class="string">/\b[\w\.-]+@[\w\.-]+\.\w{2,3}\b/</span>;<span class="variable">show</span>(<span class="variable">mailAddress</span>.<span class="property">test</span>(<span class="string">&quot;kenny@test.net&quot;</span>));<span class="variable">show</span>(<span class="variable">mailAddress</span>.<span class="property">test</span>(<span class="string">&quot;I mailt kenny@tets.nets, but it didn wrok!&quot;</span>));<span class="variable">show</span>(<span class="variable">mailAddress</span>.<span class="property">test</span>(<span class="string">&quot;the_giant_sloth@gmail.com&quot;</span>));</pre><p><a class="paragraph" href="#p25a7a57651dc6d43" name="p25a7a57651dc6d43"> ¶ </a>The <code>\b</code>s at the start and end of the pattern make sure that thesecond string does not match.</p></div></div><hr/><div class="block"><p><a class="paragraph" href="#p2ed36c90566186ab" name="p2ed36c90566186ab"> ¶ </a>Part of a regular expression can be grouped together with parentheses.This allows us to use <code>*</code> and such on more than one character. Forexample:</p><pre class="code"><span class="keyword">var</span><span class="variable">cartoonCrying</span>=<span class="string">/boo(hoo+)+/i</span>;<span class="variable">show</span>(<span class="string">&quot;Then, he exclaimed 'Boohoooohoohooo'&quot;</span>.<span class="property">search</span>(<span class="variable">cartoonCrying</span>));</pre><p><a class="paragraph" href="#pb6974678990c6d9" name="pb6974678990c6d9"> ¶ </a>Where did the <code>i</code> at the end of that regular expression come from?After the closing slash, 'options' may be added to a regularexpression. An <code>i</code>, here, means the expression is case-insensitive,which allows the lower-case B in the pattern to match the upper-caseone in the string.</p><p><a class="paragraph" href="#p7dea2fbd0d4c23ca" name="p7dea2fbd0d4c23ca"> ¶ </a>A pipe character (<code>|</code>) is used to allow a pattern to make a choicebetween two elements. For example:</p><pre class="code"><span class="keyword">var</span><span class="variable">holyCow</span>=<span class="string">/(sacred|holy) (cow|bovine|bull|taurus)/i</span>;<span class="variable">show</span>(<span class="variable">holyCow</span>.<span class="property">test</span>(<span class="string">&quot;Sacred bovine!&quot;</span>));</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p4be8972ea05685cb" name="p4be8972ea05685cb"> ¶ </a>Often, looking for a pattern is just a first step in extractingsomething from a string. In previous chapters, this extraction wasdone by calling a string's <code>indexOf</code> and <code>slice</code> methods a lot. Nowthat we are aware of the existence of regular expressions, we can usethe <code>match</code> method instead. When a string is matched against a regularexpression, the result will be <code>null</code> if the match failed, or an arrayof matched strings if it succeeded.</p><pre class="code"><span class="variable">show</span>(<span class="string">&quot;No&quot;</span>.<span class="property">match</span>(<span class="string">/Yes/</span>));<span class="variable">show</span>(<span class="string">&quot;... yes&quot;</span>.<span class="property">match</span>(<span class="string">/yes/</span>));<span class="variable">show</span>(<span class="string">&quot;Giant Ape&quot;</span>.<span class="property">match</span>(<span class="string">/giant (\w+)/i</span>));</pre><p><a class="paragraph" href="#p4cb37024e57160d3" name="p4cb37024e57160d3"> ¶ </a>The first element in the returned array is always the part of thestring that matched the pattern. As the last example shows, when thereare parenthesized parts in the pattern, the parts they match are alsoadded to the array. Often, this makes extracting pieces of string veryeasy.</p><pre class="code"><span class="keyword">var</span><span class="variable">parenthesized</span>=<span class="variable">prompt</span>(<span class="string">&quot;Tell me something&quot;</span>, <span class="string">&quot;&quot;</span>).<span class="property">match</span>(<span class="string">/\((.*)\)/</span>);<span class="keyword">if</span> (<span class="variable">parenthesized</span> !=<span class="atom">null</span>) <span class="variable">print</span>(<span class="string">&quot;You parenthesized '&quot;</span>, <span class="variable">parenthesized</span>[<span class="atom">1</span>], <span class="string">&quot;'&quot;</span>);</pre></div><hr/><div class="block"><a name="exercise3"></a><div class="exercisenum">Ex. 10.3</div><div class="exercise"><p><a class="paragraph" href="#p4ef170c78fad7bcf" name="p4ef170c78fad7bcf"> ¶ </a>Re-write the function <code>extractDate</code> that we wrote in <a href="chapter4.html">chapter 4</a>. Whengiven a string, this function looks for something that follows thedate format we saw earlier. If it can find such a date, it puts thevalues into a <code>Date</code> object. Otherwise, it throws an exception. Makeit accept dates in which the day or month are written with only onedigit.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">extractDate</span>(<span class="variabledef">string</span>){<span class="keyword">var</span><span class="variabledef">found</span>=<span class="localvariable">string</span>.<span class="property">match</span>(<span class="string">/(\d\d?)\/(\d\d?)\/(\d{4})/</span>);<span class="keyword">if</span> (<span class="localvariable">found</span>==<span class="atom">null</span>) <span class="keyword">throw</span><span class="keyword">new</span><span class="variable">Error</span>(<span class="string">&quot;No date found in '&quot;</span> + <span class="localvariable">string</span> + <span class="string">&quot;'.&quot;</span>);<span class="keyword">return</span><span class="keyword">new</span><span class="variable">Date</span>(<span class="variable">Number</span>(<span class="localvariable">found</span>[<span class="atom">3</span>]), <span class="variable">Number</span>(<span class="localvariable">found</span>[<span class="atom">2</span>]) - <span class="atom">1</span>, <span class="variable">Number</span>(<span class="localvariable">found</span>[<span class="atom">1</span>]));}<span class="variable">show</span>(<span class="variable">extractDate</span>(<span class="string">&quot;born 5/2/2007 (mother Noog): Long-ear Johnson&quot;</span>));</pre><p><a class="paragraph" href="#p158086303fcfd023" name="p158086303fcfd023"> ¶ </a>This version is slightly longer than the previous one, but it has theadvantage of actually checking what it is doing, and shouting out whenit is given nonsensical input. This was a lot harder without regularexpressions ― it would have taken a lot of calls to <code>indexOf</code> to findout whether the numbers had one or two digits, and whether the dasheswere in the right places.</p></div></div><hr/><div class="block"><p><a class="paragraph" href="#p7b062f2259df786b" name="p7b062f2259df786b"> ¶ </a>The <a name="key5"></a><code>replace</code> method of string values, which we saw in <a href="chapter6.html">chapter 6</a>, can begiven a regular expression as its first argument.</p><pre class="code"><span class="variable">print</span>(<span class="string">&quot;Borobudur&quot;</span>.<span class="property">replace</span>(<span class="string">/[ou]/g</span>, <span class="string">&quot;a&quot;</span>));</pre><p><a class="paragraph" href="#p15713a2f0b98670b" name="p15713a2f0b98670b"> ¶ </a>Notice the <code>g</code> character after the regular expression. It stands for'global', and means that every part of the string that matches thepattern should be replaced. When this <code>g</code> is omitted, only the first<code>&quot;o&quot;</code> would be replaced.</p><p><a class="paragraph" href="#p378eee313c8f0c76" name="p378eee313c8f0c76"> ¶ </a>Sometimes it is necessary to keep parts of the replaced strings. Forexample, we have a big string containing the names of people, one nameper line, in the format &quot;Lastname, Firstname&quot;. We want to swap thesenames, and remove the comma, to get a simple &quot;Firstname Lastname&quot;format.</p><pre class="code"><span class="keyword">var</span><span class="variable">names</span>=<span class="string">&quot;Picasso, Pablo\nGauguin, Paul\nVan Gogh, Vincent&quot;</span>;<span class="variable">print</span>(<span class="variable">names</span>.<span class="property">replace</span>(<span class="string">/([\w]+), ([\w]+)/g</span>, <span class="string">&quot;$2 $1&quot;</span>));</pre><p><a class="paragraph" href="#p31d9c967337f9be2" name="p31d9c967337f9be2"> ¶ </a>The <code>$1</code> and <code>$2</code> the replacement string refer to the parenthesizedparts in the pattern. <code>$1</code> is replaced by the text that matchedagainst the first pair of parentheses, <code>$2</code> by the second, and so on,up to <code>$9</code>.</p><p><a class="paragraph" href="#p57faab01a0e0b3de" name="p57faab01a0e0b3de"> ¶ </a>If you have more than 9 parentheses parts in your pattern, this willno longer work. But there is one more way to replace pieces of astring, which can also be useful in some other tricky situations. Whenthe second argument given to the <code>replace</code> method is a function valueinstead of a string, this function is called every time a match isfound, and the matched text is replaced by whatever the functionreturns. The arguments given to the function are the matched elements,similar to the values found in the arrays returned by <code>match</code>: Thefirst one is the whole match, and after that comes one argument forevery parenthesized part of the pattern.</p><pre class="code"><span class="keyword">function</span><span class="variable">eatOne</span>(<span class="variabledef">match</span>, <span class="variabledef">amount</span>, <span class="variabledef">unit</span>){<span class="localvariable">amount</span>=<span class="variable">Number</span>(<span class="localvariable">amount</span>) - <span class="atom">1</span>;<span class="keyword">if</span> (<span class="localvariable">amount</span>==<span class="atom">1</span>){<span class="localvariable">unit</span>=<span class="localvariable">unit</span>.<span class="property">slice</span>(<span class="atom">0</span>, <span class="localvariable">unit</span>.<span class="property">length</span> - <span class="atom">1</span>);}<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">amount</span>==<span class="atom">0</span>){<span class="localvariable">unit</span>=<span class="localvariable">unit</span> + <span class="string">&quot;s&quot;</span>;<span class="localvariable">amount</span>=<span class="string">&quot;no&quot;</span>;}<span class="keyword">return</span><span class="localvariable">amount</span> + <span class="string">&quot;&quot;</span> + <span class="localvariable">unit</span>;}<span class="keyword">var</span><span class="variable">stock</span>=<span class="string">&quot;1 lemon, 2 cabbages, and 101 eggs&quot;</span>;<span class="variable">stock</span>=<span class="variable">stock</span>.<span class="property">replace</span>(<span class="string">/(\d+) (\w+)/g</span>, <span class="variable">eatOne</span>);<span class="variable">print</span>(<span class="variable">stock</span>);</pre></div><hr/><div class="block"><a name="exercise4"></a><div class="exercisenum">Ex. 10.4</div><div class="exercise"><p><a class="paragraph" href="#p3b6fcf5074d34c37" name="p3b6fcf5074d34c37"> ¶ </a>That last trick can be used to make the HTML-escaper from <a href="chapter6.html">chapter 6</a> moreefficient. You may remember that it looked like this: </p><pre class="code"><span class="keyword">function</span><span class="variable">escapeHTML</span>(<span class="variabledef">text</span>){<span class="keyword">var</span><span class="variabledef">replacements</span>=[[<span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;&amp;amp;&quot;</span>], [<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;&amp;quot;&quot;</span>], [<span class="string">&quot;&lt;&quot;</span>, <span class="string">&quot;&amp;lt;&quot;</span>], [<span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;&amp;gt;&quot;</span>]];<span class="variable">forEach</span>(<span class="localvariable">replacements</span>, <span class="keyword">function</span>(<span class="variabledef">replace</span>){<span class="localvariable">text</span>=<span class="localvariable">text</span>.<span class="property">replace</span>(<span class="localvariable">replace</span>[<span class="atom">0</span>], <span class="localvariable">replace</span>[<span class="atom">1</span>]);});<span class="keyword">return</span><span class="localvariable">text</span>;}</pre><p><a class="paragraph" href="#p38ca038b2155aa38" name="p38ca038b2155aa38"> ¶ </a>Write a new function <code>escapeHTML</code>, which does the same thing, but onlycalls <code>replace</code> once.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">escapeHTML</span>(<span class="variabledef">text</span>){<span class="keyword">var</span><span class="variabledef">replacements</span>={<span class="string">&quot;&lt;&quot;</span>: <span class="string">&quot;&amp;lt;&quot;</span>, <span class="string">&quot;&gt;&quot;</span>: <span class="string">&quot;&amp;gt;&quot;</span>, <span class="string">&quot;&amp;&quot;</span>: <span class="string">&quot;&amp;amp;&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>: <span class="string">&quot;&amp;quot;&quot;</span>};<span class="keyword">return</span><span class="localvariable">text</span>.<span class="property">replace</span>(<span class="string">/[&lt;&gt;&amp;&quot;]/g</span>, <span class="keyword">function</span>(<span class="variabledef">character</span>){<span class="keyword">return</span><span class="localvariable">replacements</span>[<span class="localvariable">character</span>];});}<span class="variable">print</span>(<span class="variable">escapeHTML</span>(<span class="string">&quot;The 'pre-formatted' tag is written \&quot;&lt;pre&gt;\&quot;.&quot;</span>));</pre><p><a class="paragraph" href="#p3c989769e16ba17d" name="p3c989769e16ba17d"> ¶ </a>The <code>replacements</code> object is a quick way to associate each characterwith its escaped version. Using it like this is safe (i.e. no<code>Dictionary</code> object is needed), because the only properties that willbe used are those matched by the <code>/[&lt;&gt;&amp;&quot;]/</code> expression.</p></div></div><hr/><div class="block"><p><a class="paragraph" href="#p5753b7e96196f238" name="p5753b7e96196f238"> ¶ </a>There are cases where the pattern you need to match against is notknown while you are writing the code. Say we are writing a (verysimple-minded) obscenity filter for a message board. We only want toallow messages that do not contain obscene words. The administrator ofthe board can specify a list of words that he or she considersunacceptable.</p><p><a class="paragraph" href="#p277ed728ec39bfd4" name="p277ed728ec39bfd4"> ¶ </a>The most efficient way to check a piece of text for a set of words isto use a regular expression. If we have our word list as an array, wecan build the regular expression like this:</p><pre class="code"><span class="keyword">var</span><span class="variable">badWords</span>=[<span class="string">&quot;ape&quot;</span>, <span class="string">&quot;monkey&quot;</span>, <span class="string">&quot;simian&quot;</span>, <span class="string">&quot;gorilla&quot;</span>, <span class="string">&quot;evolution&quot;</span>];<span class="keyword">var</span><span class="variable">pattern</span>=<span class="keyword">new</span><span class="variable">RegExp</span>(<span class="variable">badWords</span>.<span class="property">join</span>(<span class="string">&quot;|&quot;</span>), <span class="string">&quot;i&quot;</span>);<span class="keyword">function</span><span class="variable">isAcceptable</span>(<span class="variabledef">text</span>){<span class="keyword">return</span> !<span class="variable">pattern</span>.<span class="property">test</span>(<span class="localvariable">text</span>);}<span class="variable">show</span>(<span class="variable">isAcceptable</span>(<span class="string">&quot;Mmmm, grapes.&quot;</span>));<span class="variable">show</span>(<span class="variable">isAcceptable</span>(<span class="string">&quot;No more of that monkeybusiness, now.&quot;</span>));</pre><p><a class="paragraph" href="#p715e5fe8a3c62495" name="p715e5fe8a3c62495"> ¶ </a>We could add <code>\b</code> patterns around the words, so that the thing aboutgrapes would not be classified as unacceptable. That would also makethe second one acceptable, though, which is probably not correct.Obscenity filters are hard to get right (and usually way too annoyingto be a good idea).</p><p><a class="paragraph" href="#p47b71fdfc0954b56" name="p47b71fdfc0954b56"> ¶ </a>The first argument to the <a name="key6"></a><code>RegExp</code> constructor is a stringcontaining the pattern, the second argument can be used to addcase-insensitivity or globalness. When building a string to hold thepattern, you have to be careful with backslashes. Because, normally,backslashes are removed when a string is interpreted, any backslashesthat must end up in the regular expression itself have to be escaped:</p><pre class="code"><span class="keyword">var</span><span class="variable">digits</span>=<span class="keyword">new</span><span class="variable">RegExp</span>(<span class="string">&quot;\\d+&quot;</span>);<span class="variable">show</span>(<span class="variable">digits</span>.<span class="property">test</span>(<span class="string">&quot;101&quot;</span>));</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p67ee28b47e95b263" name="p67ee28b47e95b263"> ¶ </a>The most important thing to know about regular expressions is thatthey exist, and can greatly enhance the power of your string-manglingcode. They are so cryptic that you'll probably have to look up thedetails on them the first ten times you want to make use of them.Persevere, and you will soon be off-handedly writing expressions thatlook like occult gibberish</p><div class="illustration"><img src="img/xkcd_regular_expressions.png"/></div><p><a class="paragraph" href="#p57032844af1f87bf" name="p57032844af1f87bf"> ¶ </a>(Comic by <a href="http://xkcd.com">Randall Munroe</a>.)</p></div><ol class="footnotes"><li><a name="footnote1"></a>In this case, the backslashes were not really necessary, becausethe characters occur between <code>[</code> and <code>]</code>, but it is easier to justescape them anyway, so you won't have to think about it.</li></ol><h1><span class="number">Chapter 11: </span>Web programming: A crash course</h1><div class="block"><p><a class="paragraph" href="#p215a94a837046f1e" name="p215a94a837046f1e"> ¶ </a>You are probably reading this in a web browser, so you are likely tobe at least a little familiar with the World Wide Web. Thischapter contains a quick, superficial introduction to the variouselements that make the web work, and the way they relate toJavaScript. The three after this one are more practical, and show someof the ways JavaScript can be used to inspect and change a web-page.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p974cad8a7797534" name="p974cad8a7797534"> ¶ </a>The Internet is, basically, just a computer network spanning most ofthe world. Computer networks make it possible for computers to sendeach other messages. The techniques that underlie networking are aninteresting subject, but not the subject of this book. All you have toknow is that, typically, one computer, which we will call the<a name="key1"></a>server, is waiting for other computers to start talking to it. Onceanother computer, the <a name="key2"></a>client, opens communications with this server,they will exchange whatever it is that needs to be exchanged usingsome specific language, a <a name="key3"></a>protocol.</p><p><a class="paragraph" href="#p37853189e1adc3cf" name="p37853189e1adc3cf"> ¶ </a>The Internet is used to carry messages for <em>many</em> different protocols.There are protocols for chatting, protocols for file sharing,protocols used by malicious software to control the computer of thepoor schmuck who installed it, and so on. The protocol that is ofinterest to us is that used by the World Wide Web. It is called<a name="key4"></a>HTTP, which stands for Hyper Text Transfer Protocol, and is used toretrieve web-pages and the files associated with them.</p><p><a class="paragraph" href="#p2902c9e4e783994d" name="p2902c9e4e783994d"> ¶ </a>In HTTP communication, the server is the computer on which theweb-page is stored. The client is the computer, such as yours, whichasks the server for a page, so that it can display it. Asking for apage like this is called an '<a name="key5"></a>HTTP request'.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p1338349ab05e601b" name="p1338349ab05e601b"> ¶ </a>Web-pages and other files that are accessible through the Internet areidentified by <a name="key6"></a>URLs, which is an abbreviation of Universal ResourceLocators. A URL looks like this:</p><pre class="preformatted">http://acc6.its.brooklyn.cuny.edu/~phalsall/texts/taote-v3.html</pre><p><a class="paragraph" href="#p4d943105a436c077" name="p4d943105a436c077"> ¶ </a>It is composed of three parts. The start, <code>http://</code>, indicates thatthis URL uses the HTTP protocol. There are some other protocols, suchas FTP (File Transfer Protocol), which also make use of URLs. The nextpart, <code>acc6.its.brooklyn.cuny.edu</code>, names the server on which thispage can be found. The end of the URL,<code>/~phalsal/texts/taote-v3.html</code>, names a specific file on this server.</p><p><a class="paragraph" href="#p21770142dde6d5af" name="p21770142dde6d5af"> ¶ </a>Most of the time, the World Wide Web is accessed using a browser.After typing a URL or clicking a link, the browser makes theappropriate HTTP request to the appropriate server. If all goes well,the server responds by sending a file back to the browser, who showsit to the user in one way or another.</p><p><a class="paragraph" href="#p647f98273ef611ea" name="p647f98273ef611ea"> ¶ </a>When, as in the example, the retrieved file is an <a name="key7"></a>HTML document, itwill be displayed as a web-page. We briefly discussed HTML in <a href="chapter6.html">chapter 6</a>,where we saw that it could refer to image files. In <a href="chapter9.html">chapter 9</a>, wefound that HTML pages can also contain <code>&lt;script&gt;</code> tags to load filesof JavaScript code. When showing an HTML document, a browser willfetch all these extra files from their servers, so it can add them tothe document.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p1b80e87a36e47799" name="p1b80e87a36e47799"> ¶ </a>Although a URL is supposed to point at a file, it is possible for aweb-server to do something more complicated than just looking up afile and sending it to the client. ― It can process this file in someway first, or maybe there is no file at all, but only a program that,given a URL, has some way of generating the relevant document for it.</p><p><a class="paragraph" href="#p4a034a06d0f4a6e4" name="p4a034a06d0f4a6e4"> ¶ </a>Programs that transform or generate documents on a server are apopular way to make web-pages less static. When a file is just a file,it is always the same, but when there is a program that builds itevery time it is requested, it could be made to look different foreach person, based on things like whether this person has logged in orspecified certain preferences. This can also make managing the contentof web-pages much easier ― instead of adding a new HTML file wheneversomething new is put on a website, a new document is added to somecentral storage, and the program knows where to find it and how toshow it to clients.</p><p><a class="paragraph" href="#p5427df345f8f4442" name="p5427df345f8f4442"> ¶ </a>This kind of web programming is called <a name="key8"></a>server-side programming. Itaffects the document before it is sent to the user. In some cases, itis also practical to have a program that runs <em>after</em> the page hasbeen sent, when the user is looking at it. This is called <a name="key9"></a>client-sideprogramming, because the program runs on the client computer.Client-side web programming is what JavaScript was invented for.</p></div><hr/><div class="block"><p><a class="paragraph" href="#pb5d4950c3451eeb" name="pb5d4950c3451eeb"> ¶ </a>Running programs client-side has an inherent problem. You can neverreally know in advance what kinds of programs the page you arevisiting is going to run. If it can send information from yourcomputer to others, damage something, or infiltrate your system,surfing the web would be a rather hazardous activity.</p><p><a class="paragraph" href="#p2ca07b9de2aadd9b" name="p2ca07b9de2aadd9b"> ¶ </a>To solve this dilemma, browsers severely limit the things a JavaScriptprogram may do. It is not allowed to look at your files, or to modifyanything not related to the web-page it came with. Isolating aprogramming environment like this is called <a name="key10"></a>sand-boxing. Allowingthe programs enough room to be useful, and at the same timerestricting them enough to prevent them from doing harm is not an easything to do. Every few months, some JavaScript programmer comes upwith a new way to circumvent the limitations and do something harmfulor privacy-invading. The people responsible for the browsers respondby modifying their programs to make this trick impossible, and all iswell again ― until the next problem is discovered.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p75491f3ca449564a" name="p75491f3ca449564a"> ¶ </a>One of the first JavaScript tricks that became widely used is the<a name="key11"></a><a name="key12"></a><code>open</code> method of the <code>window</code> object. It takes a URLas an argument, and will open a new window showing that URL.</p><pre class="code"><span class="keyword">var</span><span class="variable">perry</span>=<span class="variable">window</span>.<span class="property">open</span>(<span class="string">&quot;http://www.pbfcomics.com&quot;</span>);</pre><p><a class="paragraph" href="#p66fb209b064e4e6a" name="p66fb209b064e4e6a"> ¶ </a>Unless you turned off pop-up blocking in <a href="chapter6.html">chapter 6</a>, there's a chance thatthis new window is blocked. There is a good reason pop-up blockersexist. Web-programmers, especially those trying to get people to payattention to advertisements, have abused the poor <code>window.open</code> methodso much that by now, most users hate it with a passion. It has itsplace though, and in this book we will be using it to show someexample pages. As a general rule, your scripts should not open any newwindows unless the user asked for them.</p><p><a class="paragraph" href="#p21aa8dc65094ea6a" name="p21aa8dc65094ea6a"> ¶ </a>Note that, because <code>open</code> (just like <code>setTimeout</code> and company) is amethod on the <code>window</code> object, the <code>window.</code> part can be left off.When a function is called 'normally', it is called as a method on thetop-level object, which is what <code>window</code> is. Personally, I think<code>open</code> sounds a bit generic, so I'll usually type <code>window.open</code>, whichmakes it clear that it is a window that is being opened.</p><p><a class="paragraph" href="#p7f5e5857b8aa51fc" name="p7f5e5857b8aa51fc"> ¶ </a>The value returned by <code>window.open</code> is a new window. This is theglobal object for the script running in that window, and contains allthe standard things like the <code>Object</code> constructor and the <code>Math</code>object. But if you try to look at them, most browsers will (probably)not let you...</p><pre class="code invalid"><span class="variable">show</span>(<span class="variable">perry</span>.<span class="property">Math</span>);</pre><p><a class="paragraph" href="#p4d7cf06c6a768e11" name="p4d7cf06c6a768e11"> ¶ </a>This is part of the sand-boxing that I mentioned earlier. Pages openedby your browser might show information that is meant only for you, forexample on sites where you logged in, and thus it would be bad if anyrandom script could go and read them. The exception to this rule ispages opened on the same domain: When a script running on a page from<code>eloquentjavascript.net</code> opens another page on that same domain, itcan do everything it wants to this page.</p><p><a class="paragraph" href="#p5be60148df827603" name="p5be60148df827603"> ¶ </a>An opened window can be closed with its <a name="key13"></a><a name="key14"></a><code>close</code>method. If you didn't already close it yourself...</p><pre class="code"><span class="variable">perry</span>.<span class="property">close</span>();</pre><p><a class="paragraph" href="#p7604215231778930" name="p7604215231778930"> ¶ </a>Other kinds of sub-documents, such as frames(documents-within-a-document), are also windows from the perspectiveof a JavaScript program, and have their own JavaScript environment. Infact, the environment that you have access to in the console belongsto a small invisible frame hidden somewhere on this page ― this way,it is slightly harder for you to accidentally mess up the whole page.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p610a3520542c16c7" name="p610a3520542c16c7"> ¶ </a>Every window object has a <a name="key15"></a><code>document</code> property, which contains anobject representing the document shown in that window. This objectcontains, for example, a property <a name="key16"></a><code>location</code>,with information about the URL of the document.</p><pre class="code"><span class="variable">show</span>(<span class="variable">document</span>.<span class="property">location</span>.<span class="property">href</span>);</pre><p><a class="paragraph" href="#p11f7166b478901" name="p11f7166b478901"> ¶ </a>Setting <code>document.location.href</code> to a new URL can be used to make thebrowser load another document. Another application of the <code>document</code>object is its <a name="key17"></a><code>write</code> method. This method, whengiven a string argument, writes some HTML to the document. When it isused on a fully loaded document, it will replace the whole document bythe given HTML, which is usually not what you want. The idea is tohave a script call it while the document is being loaded, in whichcase the written HTML will be inserted into the document at the placeof the <code>script</code> tag that triggered it. This is a simple way to addsome dynamic elements to a page. For example, here is a triviallysimple document showing the current time.</p><pre class="code"><span class="variable">print</span>(<span class="variable">timeWriter</span>);<span class="keyword">var</span><span class="variable">time</span>=<span class="variable">viewHTML</span>(<span class="variable">timeWriter</span>);</pre><pre class="code"><span class="variable">time</span>.<span class="property">close</span>();</pre><p><a class="paragraph" href="#p23deb3f634989fa0" name="p23deb3f634989fa0"> ¶ </a>Often, the techniques shown in <a href="chapter12.html">chapter 12</a> provide a cleaner and moreversatile way to modify the document, but occasionally,<code>document.write</code> is the nicest, simplest way to do something.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p1af46a916e59d79c" name="p1af46a916e59d79c"> ¶ </a>Another popular application of JavaScript in web pages centers around<a name="key18"></a>forms. In case you are not quite sure what the role of 'forms' is,let me give a quick summary.</p><p><a class="paragraph" href="#p74a67e1a3687d6ea" name="p74a67e1a3687d6ea"> ¶ </a>A basic HTTP request is a simple request for a file. When this file isnot really a passive file, but a server-side program, it can becomeuseful to include information other than a filename in the request.For this purpose, HTTP requests are allowed to contain additional'parameters'. Here is an example:</p><pre class="preformatted">http://www.google.com/search?q=aztec%20empire</pre><p><a class="paragraph" href="#p59ad99259d080c28" name="p59ad99259d080c28"> ¶ </a>After the filename (<code>/search</code>), the URL continues with a questionmark, after which the parameters follow. This request has oneparameter, called <code>q</code> (for 'query', presumably), whose value is <code>aztecempire</code>. The <code>%20</code> part corresponds to a space. There are a number ofcharacters that can not occur in these values, such as spaces,ampersands, or question marks. These are 'escaped' by replacing themwith a <code>%</code> followed by their numerical value<a class="footref" href="#footnote1">1</a>, which serves the samepurpose as the backslashes used in strings and regular expressions,but is even more unreadable.</p><p><a class="paragraph" href="#p7651937b8b7b5402" name="p7651937b8b7b5402"> ¶ </a>JavaScript provides functions <a name="key19"></a><code>encodeURIComponent</code> and<a name="key20"></a><code>decodeURIComponent</code> to add these codes to strings and remove themagain.</p><pre class="code"><span class="keyword">var</span><span class="variable">encoded</span>=<span class="variable">encodeURIComponent</span>(<span class="string">&quot;aztec empire&quot;</span>);<span class="variable">show</span>(<span class="variable">encoded</span>);<span class="variable">show</span>(<span class="variable">decodeURIComponent</span>(<span class="variable">encoded</span>));</pre><p><a class="paragraph" href="#p10bc7a0212b6ce51" name="p10bc7a0212b6ce51"> ¶ </a>When a request contains more than one parameter, they are separated byampersands, as in...</p><pre class="preformatted">http://www.google.com/search?q=aztec%20empire&amp;lang=nl</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p1d1ef60489c3c769" name="p1d1ef60489c3c769"> ¶ </a>A form, basically, is a way to make it easy for browser-users tocreate such parameterised URLs. It contains a number of fields, suchas input boxes for text, checkboxes that can be 'checked' and'unchecked', or thingies that allow you to choose from a given set ofvalues. It also usually contains a 'submit' button and, invisible tothe user, an 'action' URL to which it should be sent. When the submitbutton is clicked, or enter is pressed, the information that wasentered in the fields is added to this action URL as parameters, andthe browser will request this URL.</p><p><a class="paragraph" href="#p406cdbfa9fce1fdc" name="p406cdbfa9fce1fdc"> ¶ </a>Here is the HTML for a simple form:</p><pre class="preformatted">&lt;form name=&quot;userinfo&quot;method=&quot;get&quot;action=&quot;info.html&quot;&gt;&lt;p&gt;Please give us your information, so that we can send you spam.&lt;/p&gt;&lt;p&gt;Name: &lt;input type=&quot;text&quot;name=&quot;name&quot;/&gt;&lt;/p&gt;&lt;p&gt;E-Mail: &lt;input type=&quot;text&quot;name=&quot;email&quot;/&gt;&lt;/p&gt;&lt;p&gt;Sex: &lt;select name=&quot;sex&quot;&gt;&lt;option&gt;Male&lt;/option&gt;&lt;option&gt;Female&lt;/option&gt;&lt;option&gt;Other&lt;/option&gt;&lt;/select&gt;&lt;/p&gt;&lt;p&gt;&lt;input name=&quot;send&quot;type=&quot;submit&quot;value=&quot;Send!&quot;/&gt;&lt;/p&gt;&lt;/form&gt;</pre><p><a class="paragraph" href="#p538fdc14f7677e92" name="p538fdc14f7677e92"> ¶ </a>The name of the form can be used to access it with JavaScript, as weshall see in a moment. The names of the fields determine the names ofthe HTTP parameters that are used to store their values. Sending thisform might produce a URL like this:</p><pre class="preformatted">http://planetspam.com/info.html?name=Ted&amp;email=ted@zork.com&amp;sex=Male</pre><p><a class="paragraph" href="#p219ea7957ff322a8" name="p219ea7957ff322a8"> ¶ </a>There are quite a few other tags and properties that can be used informs, but in this book we will stick with simple ones, so that we canconcentrate on JavaScript.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p6c177da4e31618eb" name="p6c177da4e31618eb"> ¶ </a>The <code>method=&quot;get&quot;</code> property of the example form shown above indicatesthat this form should encode the values it is given as URL parameters,as shown before. There is an alternative method for sendingparameters, which is called <code>post</code>. An HTTP request using the <code>post</code>method contains, in addition to a URL, a block of data. A form usingthe <code>post</code> method puts the values of its parameters in this data blockinstead of in the URL.</p><p><a class="paragraph" href="#p1bd7ebeede29316a" name="p1bd7ebeede29316a"> ¶ </a>When sending big chunks of data, the <code>get</code> method will result in URLsthat are a mile wide, so <code>post</code> is usually more convenient. But thedifference between the two methods is not just a question ofconvenience. Traditionally, <code>get</code> requests are used for requests thatjust ask the server for some document, while <code>post</code> requests are usedto take an action that changes something on the server. For example,getting a list of recent messages on an Internet forum would be a<code>get</code> request, while adding a new message would be a <code>post</code> request.There is a good reason why most pages follow this distinction ―programs that automatically explore the web, such as those used bysearch engines, will generally only make <code>get</code> requests. If changes toa site can be made by <code>get</code> requests, these well-meaning 'crawlers'could do all kinds of damage.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p2fd2ddc325c801be" name="p2fd2ddc325c801be"> ¶ </a>When the browser is displaying a page containing a form, JavaScriptprograms can inspect and modify the values that are entered in theform's fields. This opens up possibilities for all kinds of tricks,such as checking values before they are sent to the server, orautomatically filling in certain fields.</p><p><a class="paragraph" href="#pb9141e4c88552c7" name="pb9141e4c88552c7"> ¶ </a>The form shown above can be found in the file <code>example_getinfo.html</code>.Open it.</p><pre class="code"><span class="keyword">var</span><span class="variable">form</span>=<span class="variable">window</span>.<span class="property">open</span>(<span class="string">&quot;example_getinfo.html&quot;</span>);</pre><p><a class="paragraph" href="#p121632dec93e9a8b" name="p121632dec93e9a8b"> ¶ </a>When a URL does not contain a server name, it is called a <a name="key21"></a>relative URL.Relative URLs are interpreted by the browser to refer to files on thesame server as the current document. Unless they start with a slash,the path (or directory) of the current document is also retained, andthe given path is appended to it.</p><p><a class="paragraph" href="#p12c860a567b9d97c" name="p12c860a567b9d97c"> ¶ </a>We will be adding a validity check to the form, so that it onlysubmits if the name field is not left empty and the e-mail fieldcontains something that looks like a valid e-mail address. Because weno longer want the form to submit immediately when the 'Send!' buttonis pressed, its <code>type</code> property has been changed from <code>&quot;submit&quot;</code> to<code>&quot;button&quot;</code>, which turns it into a regular button with no effect. ―<a href="chapter13.html">Chapter 13</a> will show a <em>much</em> better way of doing this, but for now, weuse the naive method.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p3ed6cce4bd3d7fc4" name="p3ed6cce4bd3d7fc4"> ¶ </a><a name="key22"></a>To be able to work with the newly opened window (if youclosed it, re-open it first), we 'attach' the console to it, likethis:</p><pre class="code"><span class="variable">attach</span>(<span class="variable">form</span>);</pre><p><a class="paragraph" href="#p7fa72de0dcd38820" name="p7fa72de0dcd38820"> ¶ </a>After doing this, the code run from the console will be run in thegiven window. To verify that we are indeed working with the correctwindow, we can look at the document's <code>location</code> and <code>title</code>properties.</p><pre class="code"><span class="variable">print</span>(<span class="variable">document</span>.<span class="property">location</span>.<span class="property">href</span>);<span class="variable">print</span>(<span class="variable">document</span>.<span class="property">title</span>);</pre><p><a class="paragraph" href="#p9206f8b81681121" name="p9206f8b81681121"> ¶ </a>Because we have entered a new environment, previously definedvariables, such as <code>form</code>, are no longer present.</p><pre class="code invalid"><span class="variable">show</span>(<span class="variable">form</span>);</pre><p><a class="paragraph" href="#p4e3dbc0688b0eebe" name="p4e3dbc0688b0eebe"> ¶ </a><a name="key23"></a>To get back to our starting environment, we can use the<code>detach</code> function (without arguments). But first, we have to add thatvalidation system to the form.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p3d9b7dfe0cab7c5" name="p3d9b7dfe0cab7c5"> ¶ </a>Every HTML tag shown in a document has a JavaScript object associatedwith it. These objects can be used to inspect and manipulate almostevery aspect of the document. In this chapter, we will work with theobjects for forms and form fields, <a href="chapter12.html">chapter 12</a> talks about these objects inmore detail.</p><p><a class="paragraph" href="#p77591c41cc2c3d3e" name="p77591c41cc2c3d3e"> ¶ </a><a name="key24"></a>The <code>document</code> object has a property named <code>forms</code>,which contains links to all the forms in the document, by name. Ourform has a property <code>name=&quot;userinfo&quot;</code>, so it can be found under theproperty <code>userinfo</code>.</p><pre class="code"><span class="keyword">var</span><span class="variable">userForm</span>=<span class="variable">document</span>.<span class="property">forms</span>.<span class="property">userinfo</span>;<span class="variable">print</span>(<span class="variable">userForm</span>.<span class="property">method</span>);<span class="variable">print</span>(<span class="variable">userForm</span>.<span class="property">action</span>);</pre><p><a class="paragraph" href="#p3ae64296ade58117" name="p3ae64296ade58117"> ¶ </a>In this case, the properties <code>method</code> and <code>action</code> that were given tothe HTML <code>form</code> tag are also present as properties of the JavaScriptobject. This is often the case, but not always: Some HTML propertiesare spelled differently in JavaScript, others are not present at all.<a href="chapter12.html">Chapter 12</a> will show a way to get at all properties.</p><p><a class="paragraph" href="#p3927f9f68734c04c" name="p3927f9f68734c04c"> ¶ </a>The object for the <code>form</code> tag has a property <code>elements</code>, which refersto an object containing the fields of the form, by name.</p><pre class="code"><span class="keyword">var</span><span class="variable">nameField</span>=<span class="variable">userForm</span>.<span class="property">elements</span>.<span class="property">name</span>;<span class="variable">nameField</span>.<span class="property">value</span>=<span class="string">&quot;Eugène&quot;</span>;</pre><p><a class="paragraph" href="#p1c7de725744a371d" name="p1c7de725744a371d"> ¶ </a>Text-input objects have a <code>value</code> property, which can be used to readand change their content. If you look at the form window after runningthe above code, you'll see that the name has been filled in.</p></div><hr/><div class="block"><a name="exercise1"></a><div class="exercisenum">Ex. 11.1</div><div class="exercise"><p><a class="paragraph" href="#p541dacbcab2766eb" name="p541dacbcab2766eb"> ¶ </a>Being able to read the values of the form fields makes it possible towrite a function <code>validInfo</code>, which takes a form object as itsargument and returns a boolean value: <code>true</code> when the <code>name</code> field isnot empty and the <code>email</code> field contains something that looks like ane-mail address, <code>false</code> otherwise. Write this function.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">validInfo</span>(<span class="variabledef">form</span>){<span class="keyword">return</span><span class="localvariable">form</span>.<span class="property">elements</span>.<span class="property">name</span>.<span class="property">value</span> !=<span class="string">&quot;&quot;</span> &amp;&amp;<span class="string">/^.+@.+\.\w{2,3}$/</span>.<span class="property">test</span>(<span class="localvariable">form</span>.<span class="property">elements</span>.<span class="property">email</span>.<span class="property">value</span>);}<span class="variable">show</span>(<span class="variable">validInfo</span>(<span class="variable">document</span>.<span class="property">forms</span>.<span class="property">userinfo</span>));</pre><p><a class="paragraph" href="#p1bb27b4bf43ed6e0" name="p1bb27b4bf43ed6e0"> ¶ </a>You did think to use a regular expression for the e-mail check, didn'tyou?</p></div></div><hr/><div class="block"><p><a class="paragraph" href="#p53d234c1e595089d" name="p53d234c1e595089d"> ¶ </a>All we have to do now is determine what happens when people click the'Send!' button. At the moment, it does not do anything at all. Thiscan be remedied by setting its <code>onclick</code> property.</p><pre class="code"><span class="variable">userForm</span>.<span class="property">elements</span>.<span class="property">send</span>.<span class="property">onclick</span>=<span class="keyword">function</span>(){<span class="variable">alert</span>(<span class="string">&quot;Click.&quot;</span>);};</pre><p><a class="paragraph" href="#p6aad7774d60be20b" name="p6aad7774d60be20b"> ¶ </a>Just like the actions given to <code>setInterval</code> and <code>setTimeout</code> (<a href="chapter8.html">chapter 8</a>),the value stored in an <a name="key25"></a><code>onclick</code> (or similar) property can be eithera function or a string of JavaScript code. In this case, we give it afunction that opens an alert window. Try clicking it.</p></div><hr/><div class="block"><a name="exercise2"></a><div class="exercisenum">Ex. 11.2</div><div class="exercise"><p><a class="paragraph" href="#p555067bbc9761c91" name="p555067bbc9761c91"> ¶ </a>Finish the form validator by giving the button's <code>onclick</code> property anew value ― a function that checks the form, submits when it isvalid, or pops up a warning message when it is not. It will be usefulto know that form objects have a <a name="key26"></a><code>submit</code> method that takes noparameters and submits the form.</p></div><div class="solution"><pre class="code"><span class="variable">userForm</span>.<span class="property">elements</span>.<span class="property">send</span>.<span class="property">onclick</span>=<span class="keyword">function</span>(){<span class="keyword">if</span> (<span class="variable">validInfo</span>(<span class="variable">userForm</span>)) <span class="variable">userForm</span>.<span class="property">submit</span>();<span class="keyword">else</span><span class="variable">alert</span>(<span class="string">&quot;Give us a name and a valid e-mail address!&quot;</span>);};</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p1a69d33802ce26f1" name="p1a69d33802ce26f1"> ¶ </a>Another trick related to form inputs, as well as other things that canbe 'selected', such as buttons and links, is the <a name="key27"></a><code>focus</code> method.When you know for sure that a user will want to start typing in acertain text field as soon as he enters the page, you can have yourscript start by placing the cursor in it, so he won't have to click itor select it in some other way.</p><pre class="code"><span class="variable">userForm</span>.<span class="property">elements</span>.<span class="property">name</span>.<span class="property">focus</span>();</pre><p><a class="paragraph" href="#p19e00e933fd2043f" name="p19e00e933fd2043f"> ¶ </a>Because the form sits in another window, it may not be obvious thatsomething was selected, depending on the browser you are using. Somepages also automatically make the cursor jump to the next field whenit looks like you finished filling in one field ― for example, whenyou type a zip code. This should not be overdone ― it makes the pagebehave in a way the user does not expect. If he is used to pressingtab to move the cursor manually, or mistyped the last character andwants to remove it, such magic cursor-jumping is very annoying.</p></div><hr/><div class="block"><pre class="code"><span class="variable">detach</span>();</pre><p><a class="paragraph" href="#p6fdc646aead27089" name="p6fdc646aead27089"> ¶ </a>Test the validator. When you enter valid information and click thebutton, the form should submit. If the console was still attached toit, this will cause it to detach itself, because the page reloads andthe JavaScript environment is replaced by a new one.</p><p><a class="paragraph" href="#p7945865eb0cacf1d" name="p7945865eb0cacf1d"> ¶ </a>If you haven't closed the form window yet, this will close it.</p><pre class="code"><span class="variable">form</span>.<span class="property">close</span>();</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p1d059983b3caec5" name="p1d059983b3caec5"> ¶ </a>The above may look easy, but let me assure you, client-sideweb programming is no walk in the park. It can, at times, be a verypainful ordeal. Why? Because programs that are supposed to run on theclient computer generally have to work for all popular browsers. Eachof these browsers tends to work slightly different. To make thingsworse, each of them contains a unique set of problems. Do not assumethat a program is bug-free just because it was made by a multi-billiondollar company. So it is up to us, the web-programmer, to rigorouslytest our programs, figure out what goes wrong, and find ways to workaround it.</p><p><a class="paragraph" href="#p1b88caf4f7052db" name="p1b88caf4f7052db"> ¶ </a>Some of you might think &quot;I will just report any problems/<a name="key28"></a>bugs I findto the browser manufacturers, and they will certainly solve fix themimmediately&quot;. These people are in for a major disappointment. The mostrecent version of Internet Explorer, the browser that is still used bysome seventy percent of web-surfers (and that every web-developerlikes to rag on) still contains bugs that have been known for overfive years. Serious bugs, too.</p><p><a class="paragraph" href="#p21f1b49e9fa83773" name="p21f1b49e9fa83773"> ¶ </a>But do not let that discourage you. With the right kind ofobsessive-compulsive mindset, such problems provide wonderfulchallenges. And for those of us who do not like wasting our time,being careful and avoiding the obscure corners of the browser'sfunctionality will generally prevent you from running into too muchtrouble.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p58bddd3ddb98c58a" name="p58bddd3ddb98c58a"> ¶ </a>Bugs aside, the by-design differences in interface between browsersstill make for an interesting challenge. The current situation lookssomething like this: On the one hand, there are all the 'small'browsers: Firefox, Safari, and Opera are the most important ones, butthere are more. These browsers all make a reasonable effort to adhereto a set of standards that have been developed, or are beingdeveloped, by the W3C, an organisation that tries to make the Web aless confusing place by defining standard interfaces for things likethis. On the other hand, there is Internet Explorer, Microsoft'sbrowser, which rose to dominance in a time when many of thesestandards did not really exist yet, and hasn't made much effort toadjust itself to what other people are doing.</p><p><a class="paragraph" href="#p68cd52aa0c7f1c75" name="p68cd52aa0c7f1c75"> ¶ </a>In some areas, such as the way the content of an HTML document can beapproached from JavaScript (<a href="chapter12.html">chapter 12</a>), the standards are based on themethod that Internet Explorer invented, and things work more or lessthe same on all browsers. In other areas, such as the way events(mouse-clicks, key-presses, and such) are handled (<a href="chapter13.html">chapter 13</a>), InternetExplorer works radically different from other browsers.</p><p><a class="paragraph" href="#p1f02739b0b86908b" name="p1f02739b0b86908b"> ¶ </a>For a long time, owing partially to the cluelessness of the averageJavaScript developer, and partially to the fact that browserincompatibilities were much worse when browsers like Internet Explorerversion 4 or 5 and old versions of Netscape were still common, theusual way to deal with such differences was to detect which browserthe user was running, and litter code with alternate solutions foreach browser ― if this is Internet Explorer, do this, if this isNetscape, do that, and if this is other browser that we didn't thinkof, just hope for the best. You can imagine how hideous, confusing,and long such programs were.</p><p><a class="paragraph" href="#p79c0429cd5e756e7" name="p79c0429cd5e756e7"> ¶ </a>Many sites would also just refuse to load when opened in a browserthat was 'not supported'. This caused a few of the minor browsers toswallow their pride and pretend they were Internet Explorer, just sothey would be allowed to load such pages. The properties of the<a name="key29"></a><code>navigator</code> object contain information about the browser that a pagewas loaded in, but because of such lying this information is notparticularly reliable. See what yours says<a class="footref" href="#footnote2">2</a>:</p><pre class="code"><span class="variable">forEachIn</span>(<span class="variable">navigator</span>, <span class="keyword">function</span>(<span class="variabledef">name</span>, <span class="variabledef">value</span>){<span class="variable">print</span>(<span class="localvariable">name</span>, <span class="string">&quot;=&quot;</span>, <span class="localvariable">value</span>);});</pre><p><a class="paragraph" href="#p4a14a9ef8ee4464d" name="p4a14a9ef8ee4464d"> ¶ </a>A better approach is to try and 'isolate' our programs fromdifferences in browsers. If you need, for example, to find out moreabout an event, such as the clicks we handled by setting the <code>onclick</code>property of our send button, you have to look at the top-level objectcalled <code>event</code> on Internet Explorer, but you have to use the firstargument passed to the event-handling function on other browsers. Tohandle this, and a number of other differences related to events, onecan write a helper function for attaching events to things, whichtakes care of all the plumbing and allows the event-handling functionsthemselves to be the same for all browsers. In <a href="chapter13.html">chapter 13</a> we will writesuch a function.</p><p><a class="paragraph" href="#p1e19541a30477d05" name="p1e19541a30477d05"> ¶ </a>(Note: The browser quirks mentioned in the following chapters refer tothe state of affairs in early 2007, and might no longer be accurate onsome points.)</p></div><hr/><div class="block"><p><a class="paragraph" href="#p8d68d5265638803" name="p8d68d5265638803"> ¶ </a>These chapters will only give a somewhat superficial introduction tothe subject of browser interfaces. They are not the main subject ofthis book, and they are complex enough to fill a thick book on theirown. When you understand the basics of these interfaces (andunderstand something about HTML), it is not too hard to look forspecific information online. The interface documentation for the<a href="https://developer.mozilla.org/en/Gecko_DOM_Reference">Firefox</a>and <a href="http://msdn2.microsoft.com/library/yek4tbz0.aspx">Internet Explorer</a> browsers are a goodplace to start.</p><p><a class="paragraph" href="#p1756b90f8bdb0b41" name="p1756b90f8bdb0b41"> ¶ </a>The information in the next chapters will not deal with the quirks of'previous-generation' browsers. They deal with Internet Explorer 6,Firefox 1.5, Opera 9, Safari 3, or any more recent versions of thesame browsers. Most of it will also probably be relevant to modern butobscure browsers such as Konqueror, but this has not been extensivelychecked. Fortunately, these previous-generation browsers have prettymuch died out, and are hardly used anymore.</p><p><a class="paragraph" href="#p35a7fa9a8037d35e" name="p35a7fa9a8037d35e"> ¶ </a>There is, however, a group of web-users that will still use a browserwithout JavaScript. A large part of this group consists of peopleusing a regular graphical browser, but with JavaScript disabled forsecurity reasons. Then there are people using textual browsers, orbrowsers for blind people. When working on a 'serious' site, it isoften a good idea to start with a plain HTML system that works, andthen add non-essential tricks and conveniences with JavaScript.</p></div><ol class="footnotes"><li><a name="footnote1"></a>The value a character gets is decided by the ASCII standard, whichassigns the numbers 0 to 127 to a set of letters and symbols used bythe Latin alphabet. This standard is a precursor of the Unicodestandard mentioned in <a href="chapter2.html">chapter 2</a>.</li><li><a name="footnote2"></a>Some browsers seem to hide the properties of the <code>navigator</code>object, in which case this will print nothing.</li></ol><h1><span class="number">Chapter 12: </span>The Document-Object Model</h1><div class="block"><p><a class="paragraph" href="#p2371f3184ab2f93d" name="p2371f3184ab2f93d"> ¶ </a>In <a href="chapter11.html">chapter 11</a> we saw JavaScript objects referring to <code>form</code> and <code>input</code>tags from the HTML document. Such objects are part of a structurecalled the <a name="key1"></a>Document-Object Model (<a name="key2"></a>DOM). Every tag of the documentis represented in this model, and can be looked up and interactedwith.</p><p><a class="paragraph" href="#p1a6b4b2b5e0c57b6" name="p1a6b4b2b5e0c57b6"> ¶ </a>HTML documents have what is called a hierarchical structure. Eachelement (or tag) except the top <code>&lt;html&gt;</code> tag is contained in anotherelement, its parent. This element can in turn contain child elements.You can visualise this as a kind of family tree:</p><div class="illustration"><img src="img/html.png"/></div><p><a class="paragraph" href="#p2b836579b7a3eb89" name="p2b836579b7a3eb89"> ¶ </a>The document-object model is based on such a view of the document.Note that the tree contains two types of elements: Nodes, which areshown as blue boxes, and pieces of simple text. The pieces of text, aswe will see, work somewhat different than the other elements. For onething, they never have children.</p><p><a class="paragraph" href="#p45c17045586e9c9d" name="p45c17045586e9c9d"> ¶ </a>Open the file <code>example_alchemy.html</code>, which contains the documentshown in the picture, and attach the console to it.</p><pre class="code"><span class="variable">attach</span>(<span class="variable">window</span>.<span class="property">open</span>(<span class="string">&quot;example_alchemy.html&quot;</span>));</pre><p><a class="paragraph" href="#p7892409b26883ab8" name="p7892409b26883ab8"> ¶ </a><a name="key3"></a>The object for the root of the documenttree, the <code>html</code> node, can be reached through the <code>documentElement</code>property of the <code>document</code> object. Most of the time, we need access tothe <code>body</code> part of the document instead, which is at<a name="key4"></a><code>document.body</code>.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p86956d8230219f9" name="p86956d8230219f9"> ¶ </a>The links between these nodes are available as properties of the nodeobjects. Every DOM object has a <a name="key5"></a><code>parentNode</code> property, which refersto the object in which it is contained, if any. These parents alsohave links pointing back to their children, but because there can bemore than one child, these are stored in a pseudo-array called<a name="key6"></a><code>childNodes</code>.</p><pre class="code"><span class="variable">show</span>(<span class="variable">document</span>.<span class="property">body</span>);<span class="variable">show</span>(<span class="variable">document</span>.<span class="property">body</span>.<span class="property">parentNode</span>);<span class="variable">show</span>(<span class="variable">document</span>.<span class="property">body</span>.<span class="property">childNodes</span>.<span class="property">length</span>);</pre><p><a class="paragraph" href="#p440f8233a2072614" name="p440f8233a2072614"> ¶ </a>For convenience, there are also links called <a name="key7"></a><code>firstChild</code> and<a name="key8"></a><code>lastChild</code>, pointing at the first and last child inside a node, or<code>null</code> when there are no children.</p><pre class="code"><span class="variable">show</span>(<span class="variable">document</span>.<span class="property">documentElement</span>.<span class="property">firstChild</span>);<span class="variable">show</span>(<span class="variable">document</span>.<span class="property">documentElement</span>.<span class="property">lastChild</span>);</pre><p><a class="paragraph" href="#p60f59a4c0b48d0fa" name="p60f59a4c0b48d0fa"> ¶ </a>Finally, there are properties called <a name="key9"></a><code>nextSibling</code> and<a name="key10"></a><code>previousSibling</code>, which point at the nodes sitting 'next' to a node― nodes that are children of the same parent, coming before or afterthe current node. Again, when there is no such sibling, the value ofthese properties is <code>null</code>.</p><pre class="code"><span class="variable">show</span>(<span class="variable">document</span>.<span class="property">body</span>.<span class="property">previousSibling</span>);<span class="variable">show</span>(<span class="variable">document</span>.<span class="property">body</span>.<span class="property">nextSibling</span>);</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p3ccb233a77d94d5d" name="p3ccb233a77d94d5d"> ¶ </a>To find out whether a node represents a simple piece of text or anactual HTML node, we can look at its <a name="key11"></a><code>nodeType</code> property. Thiscontains a number, <code>1</code> for regular nodes and <code>3</code> for text nodes. Thereare actually other kinds of objects with a <code>nodeType</code>, such as the<code>document</code> object, which has <code>9</code>, but the most common use for thisproperty is distinguishing between text nodes and other nodes.</p><pre class="code"><span class="keyword">function</span><span class="variable">isTextNode</span>(<span class="variabledef">node</span>){<span class="keyword">return</span><span class="localvariable">node</span>.<span class="property">nodeType</span>==<span class="atom">3</span>;}<span class="variable">show</span>(<span class="variable">isTextNode</span>(<span class="variable">document</span>.<span class="property">body</span>));<span class="variable">show</span>(<span class="variable">isTextNode</span>(<span class="variable">document</span>.<span class="property">body</span>.<span class="property">firstChild</span>.<span class="property">firstChild</span>));</pre><p><a class="paragraph" href="#p2be6a8ba1286bc38" name="p2be6a8ba1286bc38"> ¶ </a>Regular nodes have a property called <a name="key12"></a><code>nodeName</code>, indicating the typeof HTML tag that they represent. Text nodes, on the other hand, have a<a name="key13"></a><code>nodeValue</code>, containing their text content.</p><pre class="code"><span class="variable">show</span>(<span class="variable">document</span>.<span class="property">body</span>.<span class="property">firstChild</span>.<span class="property">nodeName</span>);<span class="variable">show</span>(<span class="variable">document</span>.<span class="property">body</span>.<span class="property">firstChild</span>.<span class="property">firstChild</span>.<span class="property">nodeValue</span>);</pre><p><a class="paragraph" href="#p39f0c2b86ed51ac1" name="p39f0c2b86ed51ac1"> ¶ </a>The <code>nodeName</code>s are always capitalised, which is something you need totake into account if you ever want to compare them to something.</p><pre class="code"><span class="keyword">function</span><span class="variable">isImage</span>(<span class="variabledef">node</span>){<span class="keyword">return</span> !<span class="variable">isTextNode</span>(<span class="localvariable">node</span>) &amp;&amp;<span class="localvariable">node</span>.<span class="property">nodeName</span>==<span class="string">&quot;IMG&quot;</span>;}<span class="variable">show</span>(<span class="variable">isImage</span>(<span class="variable">document</span>.<span class="property">body</span>.<span class="property">lastChild</span>));</pre></div><hr/><div class="block"><a name="exercise1"></a><div class="exercisenum">Ex. 12.1</div><div class="exercise"><p><a class="paragraph" href="#p693bc40cd9f0664f" name="p693bc40cd9f0664f"> ¶ </a>Write a function <code>asHTML</code> which, when given a DOM node, produces astring representing the HTML text for that node and its children. Youmay ignore attributes, just show nodes as <code>&lt;nodename&gt;</code>. The<code>escapeHTML</code> function from <a href="chapter10.html">chapter 10</a> is available to properly escapethe content of text nodes.</p><p><a class="paragraph" href="#p44eacebd36aa1758" name="p44eacebd36aa1758"> ¶ </a>Hint: Recursion!</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">asHTML</span>(<span class="variabledef">node</span>){<span class="keyword">if</span> (<span class="variable">isTextNode</span>(<span class="localvariable">node</span>)) <span class="keyword">return</span><span class="variable">escapeHTML</span>(<span class="localvariable">node</span>.<span class="property">nodeValue</span>);<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">node</span>.<span class="property">childNodes</span>.<span class="property">length</span>==<span class="atom">0</span>) <span class="keyword">return</span><span class="string">&quot;&lt;&quot;</span> + <span class="localvariable">node</span>.<span class="property">nodeName</span> + <span class="string">&quot;/&gt;&quot;</span>;<span class="keyword">else</span><span class="keyword">return</span><span class="string">&quot;&lt;&quot;</span> + <span class="localvariable">node</span>.<span class="property">nodeName</span> + <span class="string">&quot;&gt;&quot;</span> + <span class="variable">map</span>(<span class="variable">asHTML</span>, <span class="localvariable">node</span>.<span class="property">childNodes</span>).<span class="property">join</span>(<span class="string">&quot;&quot;</span>) + <span class="string">&quot;&lt;/&quot;</span> + <span class="localvariable">node</span>.<span class="property">nodeName</span> + <span class="string">&quot;&gt;&quot;</span>;}<span class="variable">print</span>(<span class="variable">asHTML</span>(<span class="variable">document</span>.<span class="property">body</span>));</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p6227576459690f7b" name="p6227576459690f7b"> ¶ </a>Nodes, in fact, already have something similar to <code>asHTML</code>. Their<a name="key14"></a><code>innerHTML</code> property can be used to retrieve the HTML text <em>inside</em>of the node, without the tags for the node itself. Some browsers alsosupport <code>outerHTML</code>, which does include the node itself, but not allof them.</p><pre class="code"><span class="variable">print</span>(<span class="variable">document</span>.<span class="property">body</span>.<span class="property">innerHTML</span>);</pre><p><a class="paragraph" href="#p20b19c3c14fb6cf8" name="p20b19c3c14fb6cf8"> ¶ </a>Some of these properties can also be modified. Setting the <code>innerHTML</code>of a node or the <code>nodeValue</code> of a text-node will change its content.Note that, in the first case, the given string is interpreted as HTML,while in the second case it is interpreted as plain text.</p><pre class="code"><span class="variable">document</span>.<span class="property">body</span>.<span class="property">firstChild</span>.<span class="property">firstChild</span>.<span class="property">nodeValue</span>=<span class="string">&quot;Chapter 1: The deep significance of the bottle&quot;</span>;</pre><p><a class="paragraph" href="#p5d1497533" name="p5d1497533"> ¶ </a>Or ...</p><pre class="code"><span class="variable">document</span>.<span class="property">body</span>.<span class="property">firstChild</span>.<span class="property">innerHTML</span>=<span class="string">&quot;Did you know the 'blink' tag yet? &lt;blink&gt;Joy!&lt;/blink&gt;&quot;</span>;</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p25697a36a698583f" name="p25697a36a698583f"> ¶ </a>We have been accessing nodes by going through a series of <code>firstChild</code>and <code>lastChild</code> properties. This can work, but it is verbose and easyto break ― if we add another node at the start of our document,<code>document.body.firstChild</code> no longer refers to the <code>h1</code> element, andcode which assumes it does will go wrong. On top of that, somebrowsers will add text-nodes for things like spaces and newlinesbetween tags, while others do not, so that the exact layout of the DOMtree can vary.</p><p><a class="paragraph" href="#p301690f60581a24" name="p301690f60581a24"> ¶ </a>An alternative to this is to give elements that you need to haveaccess to an <code>id</code> attribute. In the example page, the picture has anid <code>&quot;picture&quot;</code>, and we can use this to look it up.</p><pre class="code"><span class="keyword">var</span><span class="variable">picture</span>=<span class="variable">document</span>.<span class="property">getElementById</span>(<span class="string">&quot;picture&quot;</span>);<span class="variable">show</span>(<span class="variable">picture</span>.<span class="property">src</span>);<span class="variable">picture</span>.<span class="property">src</span>=<span class="string">&quot;img/ostrich.png&quot;</span>;</pre><p><a class="paragraph" href="#p64c511c6d47a97a4" name="p64c511c6d47a97a4"> ¶ </a><a name="key15"></a>When typing <code>getElementById</code>, note thatthe last letter is lowercase. Also, when typing it a lot, beware ofcarpal-tunnel syndrome. Because <code>document.getElementById</code> is aridiculously long name for a very common operation, it has become aconvention among JavaScript programmers to aggressively abbreviate itto <a name="key16"></a><code>$</code>. <code>$</code>, as you might remember, is considered a letter byJavaScript, and is thus a valid variable name.</p><pre class="code"><span class="keyword">function</span><span class="variable">$</span>(<span class="variabledef">id</span>){<span class="keyword">return</span><span class="variable">document</span>.<span class="property">getElementById</span>(<span class="localvariable">id</span>);}<span class="variable">show</span>(<span class="variable">$</span>(<span class="string">&quot;picture&quot;</span>));</pre><p><a class="paragraph" href="#p318d9b39b51b7152" name="p318d9b39b51b7152"> ¶ </a>DOM nodes also have a method <a name="key17"></a><code>getElementsByTagName</code> (another nice,short name), which, when given a tag name, returns an array of allnodes of that type contained in the node it was called on.</p><pre class="code"><span class="variable">show</span>(<span class="variable">document</span>.<span class="property">body</span>.<span class="property">getElementsByTagName</span>(<span class="string">&quot;BLINK&quot;</span>)[<span class="atom">0</span>]);</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p2e898bcad4486cb3" name="p2e898bcad4486cb3"> ¶ </a>Another thing we can do with these DOM nodes is creating new onesourselves. This makes it possible to add pieces to a document at will,which can be used to create some interesting effects. Unfortunately,the interface for doing this is extremely clumsy. But that can beremedied with some helper functions.</p><p><a class="paragraph" href="#p4d363d7f0d3ce5" name="p4d363d7f0d3ce5"> ¶ </a><a name="key18"></a><a name="key19"></a>The <code>document</code>object has <code>createElement</code> and <code>createTextNode</code> methods. The first isused to create regular nodes, the second, as the name suggests,creates text nodes.</p><pre class="code"><span class="keyword">var</span><span class="variable">secondHeader</span>=<span class="variable">document</span>.<span class="property">createElement</span>(<span class="string">&quot;H1&quot;</span>);<span class="keyword">var</span><span class="variable">secondTitle</span>=<span class="variable">document</span>.<span class="property">createTextNode</span>(<span class="string">&quot;Chapter 2: Deep magic&quot;</span>);</pre><p><a class="paragraph" href="#p681a6d5bd714cad5" name="p681a6d5bd714cad5"> ¶ </a>Next, we'll want to put the title name into the <code>h1</code> element, and thenadd the element to the document. The simplest way to do this is the<a name="key20"></a><code>appendChild</code> method, which can be called on every (non-text) node.</p><pre class="code"><span class="variable">secondHeader</span>.<span class="property">appendChild</span>(<span class="variable">secondTitle</span>);<span class="variable">document</span>.<span class="property">body</span>.<span class="property">appendChild</span>(<span class="variable">secondHeader</span>);</pre><p><a class="paragraph" href="#p2f9841d88b9f3000" name="p2f9841d88b9f3000"> ¶ </a>Often, you will also want to give these new nodes some attributes. Forexample, an <code>img</code> (image) tag is rather useless without an <code>src</code>property telling the browser which image it should show. Mostattributes can be approached directly as properties of the DOM nodes,but there are also methods <a name="key21"></a><code>setAttribute</code> and <a name="key22"></a><code>getAttribute</code>,which are used to access attributes in a more general way:</p><pre class="code"><span class="keyword">var</span><span class="variable">newImage</span>=<span class="variable">document</span>.<span class="property">createElement</span>(<span class="string">&quot;IMG&quot;</span>);<span class="variable">newImage</span>.<span class="property">setAttribute</span>(<span class="string">&quot;src&quot;</span>, <span class="string">&quot;img/Hiva Oa.png&quot;</span>);<span class="variable">document</span>.<span class="property">body</span>.<span class="property">appendChild</span>(<span class="variable">newImage</span>);<span class="variable">show</span>(<span class="variable">newImage</span>.<span class="property">getAttribute</span>(<span class="string">&quot;src&quot;</span>));</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p70aeeb1819ce2ccf" name="p70aeeb1819ce2ccf"> ¶ </a>But, when we want to build more than a few simple nodes, it gets verytiresome to create every single node with a call to<code>document.createElement</code> or <code>document.createTextNode</code>, and then addits attributes and child nodes one by one. Fortunately, it is not hardto write a function to do most of the work for us. Before we do so,there is one little detail to take care of ― the <code>setAttribute</code>method, while working fine on most browsers, does not always work onInternet Explorer. The names of a few HTML attributes already have aspecial meaning in JavaScript, and thus the corresponding objectproperties got an adjusted name. Specifically, the <code>class</code> attributebecomes <a name="key23"></a><code>className</code>, <code>for</code> becomes <code>htmlFor</code>, and <code>checked</code> isrenamed to <code>defaultChecked</code>. On Internet Explorer, <code>setAttribute</code> and<code>getAttribute</code> also work with these adjusted names, instead of theoriginal HTML names, which can be confusing. On top of that the<a name="key24"></a><code>style</code> attribute, which, along with <code>class</code>, will be discussedlater in this chapter, can not be set with <code>setAttribute</code> on thatbrowser.</p><p><a class="paragraph" href="#p791e905afd14653e" name="p791e905afd14653e"> ¶ </a>A workaround would look something like this:</p><pre class="code"><span class="keyword">function</span><span class="variable">setNodeAttribute</span>(<span class="variabledef">node</span>, <span class="variabledef">attribute</span>, <span class="variabledef">value</span>){<span class="keyword">if</span> (<span class="localvariable">attribute</span>==<span class="string">&quot;class&quot;</span>) <span class="localvariable">node</span>.<span class="property">className</span>=<span class="localvariable">value</span>;<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">attribute</span>==<span class="string">&quot;checked&quot;</span>) <span class="localvariable">node</span>.<span class="property">defaultChecked</span>=<span class="localvariable">value</span>;<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">attribute</span>==<span class="string">&quot;for&quot;</span>) <span class="localvariable">node</span>.<span class="property">htmlFor</span>=<span class="localvariable">value</span>;<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">attribute</span>==<span class="string">&quot;style&quot;</span>) <span class="localvariable">node</span>.<span class="property">style</span>.<span class="property">cssText</span>=<span class="localvariable">value</span>;<span class="keyword">else</span><span class="localvariable">node</span>.<span class="property">setAttribute</span>(<span class="localvariable">attribute</span>, <span class="localvariable">value</span>);}</pre><p><a class="paragraph" href="#p376e25cb4a452da4" name="p376e25cb4a452da4"> ¶ </a>For every case where Internet Explorer deviates from other browsers,it does something that works in all cases. Don't worry about thedetails ― this is the kind of ugly trick that we'd rather not need,but which non-conforming browsers force us to write. Having this, itis possible to write a simple function for building DOM elements.</p><pre class="code"><span class="keyword">function</span><span class="variable">dom</span>(<span class="variabledef">name</span>, <span class="variabledef">attributes</span>){<span class="keyword">var</span><span class="variabledef">node</span>=<span class="variable">document</span>.<span class="property">createElement</span>(<span class="localvariable">name</span>);<span class="keyword">if</span> (<span class="localvariable">attributes</span>){<span class="variable">forEachIn</span>(<span class="localvariable">attributes</span>, <span class="keyword">function</span>(<span class="variabledef">name</span>, <span class="variabledef">value</span>){<span class="variable">setNodeAttribute</span>(<span class="localvariable">node</span>, <span class="localvariable">name</span>, <span class="localvariable">value</span>);});}<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">i</span>=<span class="atom">2</span>;<span class="localvariable">i</span> &lt;<span class="localvariable">arguments</span>.<span class="property">length</span>;<span class="localvariable">i</span>++){<span class="keyword">var</span><span class="variabledef">child</span>=<span class="localvariable">arguments</span>[<span class="localvariable">i</span>];<span class="keyword">if</span> (typeof <span class="localvariable">child</span>==<span class="string">&quot;string&quot;</span>) <span class="localvariable">child</span>=<span class="variable">document</span>.<span class="property">createTextNode</span>(<span class="localvariable">child</span>);<span class="localvariable">node</span>.<span class="property">appendChild</span>(<span class="localvariable">child</span>);}<span class="keyword">return</span><span class="localvariable">node</span>;}<span class="keyword">var</span><span class="variable">newParagraph</span>=<span class="variable">dom</span>(<span class="string">&quot;P&quot;</span>, <span class="atom">null</span>, <span class="string">&quot;A paragraph with a &quot;</span>, <span class="variable">dom</span>(<span class="string">&quot;A&quot;</span>,{<span class="property">href</span>: <span class="string">&quot;http://en.wikipedia.org/wiki/Alchemy&quot;</span>}, <span class="string">&quot;link&quot;</span>), <span class="string">&quot;inside of it.&quot;</span>);<span class="variable">document</span>.<span class="property">body</span>.<span class="property">appendChild</span>(<span class="variable">newParagraph</span>);</pre><p><a class="paragraph" href="#p162c21af52c74199" name="p162c21af52c74199"> ¶ </a>The <a name="key25"></a><code>dom</code> function creates a DOM node. Its first argument gives thetag name of the node, its second argument is an object containing theattributes of the node, or <code>null</code> when no attributes are needed. Afterthat, any amount of arguments may follow, and these are added to thenode as child nodes. When strings appear here, they are first put intoa text node.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p39e473097619d796" name="p39e473097619d796"> ¶ </a><code>appendChild</code> is not the only way nodes can be inserted into anothernode. When the new node should not appear at the end of its parent,the <a name="key26"></a><code>insertBefore</code> method can be used to place it in front ofanother child node. It takes the new node as a first argument, and theexisting child as second argument.</p><pre class="code"><span class="keyword">var</span><span class="variable">link</span>=<span class="variable">newParagraph</span>.<span class="property">childNodes</span>[<span class="atom">1</span>];<span class="variable">newParagraph</span>.<span class="property">insertBefore</span>(<span class="variable">dom</span>(<span class="string">&quot;STRONG&quot;</span>, <span class="atom">null</span>, <span class="string">&quot;great &quot;</span>), <span class="variable">link</span>);</pre><p><a class="paragraph" href="#p11f16a6744ae4dcd" name="p11f16a6744ae4dcd"> ¶ </a>If a node that already has a <code>parentNode</code> is placed somewhere, it isautomatically removed from its current position ― nodes can not existin the document in more than one place.</p><p><a class="paragraph" href="#p579ea6f7e446ae9d" name="p579ea6f7e446ae9d"> ¶ </a>When a node must be replaced by another one, use the <a name="key27"></a><code>replaceChild</code>method, which again takes the new node as first argument and theexisting one as second argument.</p><pre class="code"><span class="variable">newParagraph</span>.<span class="property">replaceChild</span>(<span class="variable">document</span>.<span class="property">createTextNode</span>(<span class="string">&quot;lousy &quot;</span>), <span class="variable">newParagraph</span>.<span class="property">childNodes</span>[<span class="atom">1</span>]);</pre><p><a class="paragraph" href="#p4482097c05237c2a" name="p4482097c05237c2a"> ¶ </a>And, finally, there is <a name="key28"></a><code>removeChild</code> to remove a child node. Notethat this is called on the <em>parent</em> of the node to be removed, givingthe child as argument.</p><pre class="code"><span class="variable">newParagraph</span>.<span class="property">removeChild</span>(<span class="variable">newParagraph</span>.<span class="property">childNodes</span>[<span class="atom">1</span>]);</pre></div><hr/><div class="block"><a name="exercise2"></a><div class="exercisenum">Ex. 12.2</div><div class="exercise"><p><a class="paragraph" href="#p7de372f354824f06" name="p7de372f354824f06"> ¶ </a>Write the convenient function <a name="key29"></a><code>removeElement</code> which removes the DOMnode it is given as an argument from its parent node.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">removeElement</span>(<span class="variabledef">node</span>){<span class="keyword">if</span> (<span class="localvariable">node</span>.<span class="property">parentNode</span>) <span class="localvariable">node</span>.<span class="property">parentNode</span>.<span class="property">removeChild</span>(<span class="localvariable">node</span>);}<span class="variable">removeElement</span>(<span class="variable">newParagraph</span>);</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p343dadd85c8f719b" name="p343dadd85c8f719b"> ¶ </a>When creating new nodes and moving nodes around it is necessary to beaware of the following rule: Nodes are not allowed to be inserted intoanother document from the one in which they were created. This meansthat if you have extra frames or windows open, you can not take apiece of the document from one and move it to another, and nodescreated with methods on one <code>document</code> object must stay in thatdocument. Some browsers, notably Firefox, do not enforce thisrestriction, and thus a program which violates it will work fine inthose browsers but break on others.</p></div><hr/><div class="block"><p><a class="paragraph" href="#pf55e5ba81e9c1c7" name="pf55e5ba81e9c1c7"> ¶ </a>An example of something useful that can be done with this <code>dom</code>function is a program that takes JavaScript objects and summarisesthem in a <a name="key30"></a>table. Tables, in HTML, are created with a set of tagsstarting with <code>t</code>s, something like this:</p><pre class="preformatted">&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;th&gt;Tree &lt;/th&gt;&lt;th&gt;Flowers&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Apple&lt;/td&gt;&lt;td&gt;White &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Coral&lt;/td&gt;&lt;td&gt;Red &lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Pine &lt;/td&gt;&lt;td&gt;None &lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;</pre><p><a class="paragraph" href="#p4678f201e3f69cd2" name="p4678f201e3f69cd2"> ¶ </a>Each <code>tr</code> element is a row of the table. <code>th</code> and <code>td</code> elements arethe cells of the table, <code>td</code>s are normal data cells, <code>th</code> cells are'header' cells, which will be displayed in a slightly more prominentway. The <code>tbody</code> (table body) tag does not have to be included when atable is written as HTML, but when building a table from DOM nodes itshould be added, because Internet Explorer refuses to display tablescreated without a <code>tbody</code>.</p></div><hr/><div class="block"><a name="exercise3"></a><div class="exercisenum">Ex. 12.3</div><div class="exercise"><p><a class="paragraph" href="#p1f7399e46ec01044" name="p1f7399e46ec01044"> ¶ </a>The function <code>makeTable</code> takes two arrays as arguments. The firstcontains the JavaScript objects that it should summarise, and thesecond contains strings, which name the columns of the table and theproperties of the objects that should be shown in these columns. Forexample, the following will produce the table above:</p><pre class="code invalid"><span class="variable">makeTable</span>([{<span class="property">Tree</span>: <span class="string">&quot;Apple&quot;</span>, <span class="property">Flowers</span>: <span class="string">&quot;White&quot;</span>},{<span class="property">Tree</span>: <span class="string">&quot;Coral&quot;</span>, <span class="property">Flowers</span>: <span class="string">&quot;Red&quot;</span>},{<span class="property">Tree</span>: <span class="string">&quot;Pine&quot;</span>, <span class="property">Flowers</span>: <span class="string">&quot;None&quot;</span>}], [<span class="string">&quot;Tree&quot;</span>, <span class="string">&quot;Flowers&quot;</span>]);</pre><p><a class="paragraph" href="#p699a821489361909" name="p699a821489361909"> ¶ </a>Write this function.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">makeTable</span>(<span class="variabledef">data</span>, <span class="variabledef">columns</span>){<span class="keyword">var</span><span class="variabledef">headRow</span>=<span class="variable">dom</span>(<span class="string">&quot;TR&quot;</span>);<span class="variable">forEach</span>(<span class="localvariable">columns</span>, <span class="keyword">function</span>(<span class="variabledef">name</span>){<span class="localvariable">headRow</span>.<span class="property">appendChild</span>(<span class="variable">dom</span>(<span class="string">&quot;TH&quot;</span>, <span class="atom">null</span>, <span class="localvariable">name</span>));});<span class="keyword">var</span><span class="variabledef">body</span>=<span class="variable">dom</span>(<span class="string">&quot;TBODY&quot;</span>, <span class="atom">null</span>, <span class="localvariable">headRow</span>);<span class="variable">forEach</span>(<span class="localvariable">data</span>, <span class="keyword">function</span>(<span class="variabledef">object</span>){<span class="keyword">var</span><span class="variabledef">row</span>=<span class="variable">dom</span>(<span class="string">&quot;TR&quot;</span>);<span class="variable">forEach</span>(<span class="localvariable">columns</span>, <span class="keyword">function</span>(<span class="variabledef">name</span>){<span class="localvariable">row</span>.<span class="property">appendChild</span>(<span class="variable">dom</span>(<span class="string">&quot;TD&quot;</span>, <span class="atom">null</span>, <span class="variable">String</span>(<span class="localvariable">object</span>[<span class="localvariable">name</span>])));});<span class="localvariable">body</span>.<span class="property">appendChild</span>(<span class="localvariable">row</span>);});<span class="keyword">return</span><span class="variable">dom</span>(<span class="string">&quot;TABLE&quot;</span>, <span class="atom">null</span>, <span class="localvariable">body</span>);}<span class="keyword">var</span><span class="variable">table</span>=<span class="variable">makeTable</span>(<span class="variable">document</span>.<span class="property">body</span>.<span class="property">childNodes</span>, [<span class="string">&quot;nodeType&quot;</span>, <span class="string">&quot;tagName&quot;</span>]);<span class="variable">document</span>.<span class="property">body</span>.<span class="property">appendChild</span>(<span class="variable">table</span>);</pre><p><a class="paragraph" href="#p4e2188b5a2b3aa36" name="p4e2188b5a2b3aa36"> ¶ </a>Do not forget to convert the values from the objects to strings beforeadding them to the table ― our <code>dom</code> function only understandsstrings and DOM nodes.</p></div></div><hr/><div class="block"><p><a class="paragraph" href="#p7b5d594f0e4b3062" name="p7b5d594f0e4b3062"> ¶ </a>Closely tied to HTML and the document-object model is the topic of<a name="key31"></a>style-sheets. It is a big topic, and I will not discuss it entirely,but some understanding of style-sheets is necessary for a lot ofinteresting JavaScript techniques, so we will go over the basics.</p><p><a class="paragraph" href="#p64f6941be56bc96a" name="p64f6941be56bc96a"> ¶ </a>In old-fashioned HTML, the only way to change the appearance ofelements in a document was to give them extra attributes or to wrapthem in extra tags, such as <code>center</code> to center them horizontally, or<code>font</code> to change the font style or colour. Most of the time, this meantthat if you wanted the paragraphs or the tables in your document tolook a certain way, you had to add a bunch of attributes and tags to<em>every single one of them</em>. This quickly adds a lot of noise to suchdocuments, and makes them very painful to write or change by hand.</p><p><a class="paragraph" href="#p72fca0bf4e2a8dd2" name="p72fca0bf4e2a8dd2"> ¶ </a>Of course, people being the inventive monkeys they are, someone cameup with a solution. Style-sheets are a way to make statements like 'inthis document, all paragraphs use the Comic Sans font, and are purple,and all tables have a thick green border'. You specify them once, atthe top of the document or in a separate file, and they affect thewhole document. Here, for example, is a style-sheet to make headers 22points big and centered, and make paragraphs use the font and colourmentioned earlier, when they are of the 'ugly' class.</p><pre class="preformatted">&lt;style type=&quot;text/css&quot;&gt;h1{font-size: 22pt;text-align: center;}p.ugly{font-family: Comic Sans MS;color: purple;}&lt;/style&gt;</pre><p><a class="paragraph" href="#p349dc099954e894" name="p349dc099954e894"> ¶ </a>Classes are a concept related to styles. If you have different kindsof paragraphs, ugly ones and nice ones for example, setting the stylefor all <code>p</code> elements is not what you want, so <a name="key32"></a>classes can be used todistinguish between them. The above style will only be applied toparagraphs like this:</p><pre class="preformatted">&lt;p class=&quot;ugly&quot;&gt;Mirror, mirror...&lt;/p&gt;</pre><p><a class="paragraph" href="#p6c51025c01391032" name="p6c51025c01391032"> ¶ </a>And this is also the meaning of the <a name="key33"></a><code>className</code> property which wasbriefly mentioned for the <code>setNodeAttribute</code> function. The <a name="key34"></a><code>style</code>attribute can be used to add a piece of style directly to an element.For example, this gives our image a solid border 4 pixels ('px') wide.</p><pre class="code"><span class="variable">setNodeAttribute</span>(<span class="variable">$</span>(<span class="string">&quot;picture&quot;</span>), <span class="string">&quot;style&quot;</span>, <span class="string">&quot;border-width: 4px;border-style: solid;&quot;</span>);</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p3af4cf5019ec289a" name="p3af4cf5019ec289a"> ¶ </a>There is much more to styles: Some styles are inherited by child nodesfrom parent nodes, and interfere with each other in complex andinteresting ways, but for the purpose of DOM programming, the mostimportant thing to know is that each DOM node has a <code>style</code> property,which can be used to manipulate the style of that node, and that thereare a few kinds of styles that can be used to make nodes doextraordinary things.</p><p><a class="paragraph" href="#p38583625c73749a5" name="p38583625c73749a5"> ¶ </a>This <code>style</code> property refers to an object, which has properties forall the possible elements of the style. We can, for example, make thepicture's border green.</p><pre class="code"><span class="variable">$</span>(<span class="string">&quot;picture&quot;</span>).<span class="property">style</span>.<span class="property">borderColor</span>=<span class="string">&quot;green&quot;</span>;<span class="variable">show</span>(<span class="variable">$</span>(<span class="string">&quot;picture&quot;</span>).<span class="property">style</span>.<span class="property">borderColor</span>);</pre><p><a class="paragraph" href="#p6143d9936b617114" name="p6143d9936b617114"> ¶ </a>Note that in style-sheets, the words are separated by hyphens, as in<code>border-color</code>, while in JavaScript, capital letters are used to markthe different words, as in <code>borderColor</code>.</p><p><a class="paragraph" href="#p6f36589d568674e8" name="p6f36589d568674e8"> ¶ </a>A very practical kind of style is <code>display: none</code>. This can be used totemporarily hide a node: When <a name="key35"></a><code>style.display</code> is <code>&quot;none&quot;</code>, the elementdoes not appear at all to the viewer of the document, even though itdoes exist. Later, <code>display</code> can be set to the empty string, and theelement will re-appear.</p><pre class="code"><span class="variable">$</span>(<span class="string">&quot;picture&quot;</span>).<span class="property">style</span>.<span class="property">display</span>=<span class="string">&quot;none&quot;</span>;</pre><p><a class="paragraph" href="#p25f13b7a27de58c1" name="p25f13b7a27de58c1"> ¶ </a>And, to get our picture back:</p><pre class="code"><span class="variable">$</span>(<span class="string">&quot;picture&quot;</span>).<span class="property">style</span>.<span class="property">display</span>=<span class="string">&quot;&quot;</span>;</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p48aaace071bc7c1e" name="p48aaace071bc7c1e"> ¶ </a>Another set of style types that can be abused in interesting ways arethose related to positioning. In a simple HTML document, the browsertakes care of determining the screen positions of all the elements ―each element is put next to or below the elements that come before it,and nodes (generally) do not overlap.</p><p><a class="paragraph" href="#p1adb29643a45055d" name="p1adb29643a45055d"> ¶ </a><a name="key36"></a>When its <code>position</code> style is set to <code>&quot;absolute&quot;</code>, anode is taken out of the normal document 'flow'. It no longer takes uproom in the document, but sort of floats above it. The <code>left</code> and<code>top</code> styles can then be used to influence its position. This can beused for various purposes, from making a node obnoxiously follow themouse cursor to making 'windows' open on top of the rest of thedocument.</p><pre class="code"><span class="variable">$</span>(<span class="string">&quot;picture&quot;</span>).<span class="property">style</span>.<span class="property">position</span>=<span class="string">&quot;absolute&quot;</span>;<span class="keyword">var</span><span class="variable">angle</span>=<span class="atom">0</span>;<span class="keyword">var</span><span class="variable">spin</span>=<span class="variable">setInterval</span>(<span class="keyword">function</span>(){<span class="variable">angle</span> +=<span class="atom">0.1</span>;<span class="variable">$</span>(<span class="string">&quot;picture&quot;</span>).<span class="property">style</span>.<span class="property">left</span>=(<span class="atom">100</span> + <span class="atom">100</span> * <span class="variable">Math</span>.<span class="property">cos</span>(<span class="variable">angle</span>)) + <span class="string">&quot;px&quot;</span>;<span class="variable">$</span>(<span class="string">&quot;picture&quot;</span>).<span class="property">style</span>.<span class="property">top</span>=(<span class="atom">100</span> + <span class="atom">100</span> * <span class="variable">Math</span>.<span class="property">sin</span>(<span class="variable">angle</span>)) + <span class="string">&quot;px&quot;</span>;}, <span class="atom">100</span>);</pre><p><a class="paragraph" href="#p5dc64c194a44c865" name="p5dc64c194a44c865"> ¶ </a>If you aren't familiar with trigonometry, just believe me when I tellyou that the cosine and sine stuff is used to build coordinates lyingon the outline of a circle. Ten times per second, the angle at whichwe place the picture is changed, and new coordinates are computed. Itis a common error, when setting styles like this, to forget to append<code>&quot;px&quot;</code> to your value. In most cases, setting a style to a numberwithout a unit does not work, so you must add <code>&quot;px&quot;</code> for pixels, <code>&quot;%&quot;</code>for percent, <code>&quot;em&quot;</code> for 'ems' (the width of an <code>M</code> character), or<code>&quot;pt&quot;</code> for points.</p><p><a class="paragraph" href="#p439de65d084f14a3" name="p439de65d084f14a3"> ¶ </a>(Now put the image to rest again...)</p><pre class="code"><span class="variable">clearInterval</span>(<span class="variable">spin</span>);</pre><p><a class="paragraph" href="#p7b2d891f7bbe9c6c" name="p7b2d891f7bbe9c6c"> ¶ </a>The place that is treated as 0,0 for the purpose of these positionsdepends on the place of the node in the document. When it is placedinside another node that has <code>position: absolute</code> or <code>position:relative</code>, the top left of this node is used. Otherwise, you get thetop left corner of the document.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p328f153ff3a314e3" name="p328f153ff3a314e3"> ¶ </a><a name="key37"></a><a name="key38"></a>One last aspect of DOM nodes that isfun to play with is their size. There are style types called <code>width</code>and <code>height</code>, which can be used to set the absolute size of anelement.</p><pre class="code"><span class="variable">$</span>(<span class="string">&quot;picture&quot;</span>).<span class="property">style</span>.<span class="property">width</span>=<span class="string">&quot;400px&quot;</span>;<span class="variable">$</span>(<span class="string">&quot;picture&quot;</span>).<span class="property">style</span>.<span class="property">height</span>=<span class="string">&quot;200px&quot;</span>;</pre><p><a class="paragraph" href="#pcb511fd107a693c" name="pcb511fd107a693c"> ¶ </a>But, when you need to accurately set the size of an element, there isan tricky problem to take into account. Some browsers, in somecircumstances, take these sizes to mean the outside size of theobject, including any border and internal padding. Other browsers, inother circumstances, use the size of the space inside of the objectinstead, and do not count the width of borders and padding. Thus, ifyou set the size of an object that has a border or a padding, it willnot always appear the same size.</p><p><a class="paragraph" href="#p772ec2613c5bed6e" name="p772ec2613c5bed6e"> ¶ </a>Fortunately, you can inspect the inner and outer size of a node,which, when you really need to accurately size something, can be usedto compensate for browser behaviour. The <a name="key39"></a><code>offsetWidth</code> and<a name="key40"></a><code>offsetHeight</code> properties give you the outer size of your element(the space it takes up in the document), while the <a name="key41"></a><code>clientWidth</code> and<a name="key42"></a><code>clientHeight</code> properties give the space inside of it, if any.</p><pre class="code"><span class="variable">print</span>(<span class="string">&quot;Outer size: &quot;</span>, <span class="variable">$</span>(<span class="string">&quot;picture&quot;</span>).<span class="property">offsetWidth</span>, <span class="string">&quot;by &quot;</span>, <span class="variable">$</span>(<span class="string">&quot;picture&quot;</span>).<span class="property">offsetHeight</span>, <span class="string">&quot;pixels.&quot;</span>);<span class="variable">print</span>(<span class="string">&quot;Inner size: &quot;</span>, <span class="variable">$</span>(<span class="string">&quot;picture&quot;</span>).<span class="property">clientWidth</span>, <span class="string">&quot;by &quot;</span>, <span class="variable">$</span>(<span class="string">&quot;picture&quot;</span>).<span class="property">clientHeight</span>, <span class="string">&quot;pixels.&quot;</span>);</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p35b6eeb810806c1d" name="p35b6eeb810806c1d"> ¶ </a>If you've followed through with all the examples in this chapter, andmaybe did a few extra things by yourself, you will have completelymutilated the poor little document that we started with. Now let memoralise for a moment and tell you that you do not want to do this toreal pages. The temptation to add all kinds of moving bling-bling willat times be strong. Resist it, or your pages shall surely becomeunreadable or even, if you go far enough, induce the occasionalseizure.</p></div><h1><span class="number">Chapter 13: </span>Browser Events</h1><div class="block"><p><a class="paragraph" href="#p516abb9a2e865690" name="p516abb9a2e865690"> ¶ </a>To add interesting functionality to a web-page, just being able toinspect or modify the document is generally not enough. We also needto be able to detect what the user is doing, and respond to it. Forthis, we will use a thing called <a name="key1"></a>event handlers. Pressed keys areevents, mouse clicks are events, even mouse motion can be seen as aseries of events. In <a href="chapter11.html">chapter 11</a>, we added an <code>onclick</code> property to abutton, in order to do something when it was pressed. This is a simpleevent handler.</p><p><a class="paragraph" href="#p36415ead7203e803" name="p36415ead7203e803"> ¶ </a>The way browser events work is, fundamentally, very simple. It ispossible to register handlers for specific event types and specificDOM nodes. Whenever an <a name="key2"></a>event occurs, the handler for that event, ifany, is called. For some events, such as key presses, knowing justthat the event occurred is not good enough, you also want to knowwhich key was pressed. To store such information, every event createsan <a name="key3"></a>event object, which the handler can look at.</p><p><a class="paragraph" href="#p4052c5cacc6778f2" name="p4052c5cacc6778f2"> ¶ </a>It is important to realise that, even though events can fire at anytime, no two handlers ever run at the same moment. If other JavaScriptcode is still running, the browser waits until it finishes before itcalls the next handler. This also holds for code that is triggered inother ways, such as with <code>setTimeout</code>. In programmer jargon, browserJavaScript is <a name="key4"></a>single-threaded, there are never two '<a name="key5"></a>threads'running at the same time. This is, in most cases, a good thing. It isvery easy to get strange results when multiple things happen at thesame time.</p><p><a class="paragraph" href="#p720d0712e7504cad" name="p720d0712e7504cad"> ¶ </a>An event, when not handled, can 'bubble' through the DOM tree. Whatthis means is that if you click on, for example, a link in aparagraph, any handlers associated with the link are called first. Ifthere are no such handlers, or these handlers do not indicate thatthey have finished handling the event, the handlers for the paragraph,which is the parent of the link, are tried. After that, the handlersfor <code>document.body</code> get a turn. Finally, if no JavaScript handlershave taken care of the event, the browser handles it. When clicking alink, this means that the link will be followed.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p435a5bc9218ad643" name="p435a5bc9218ad643"> ¶ </a>So, as you see, events are easy. The only hard thing about them isthat browsers, while all supporting more or less the samefunctionality, support this functionality through differentinterfaces. As usual, the most incompatible browser is InternetExplorer, which ignores the standard that most other browsers follow.After that, there is Opera, which does not properly support someuseful events, such as the <code>onunload</code> event which fires when leaving apage, and sometimes gives confusing information about keyboard events.</p><p><a class="paragraph" href="#p1ad840eebb96a094" name="p1ad840eebb96a094"> ¶ </a>There are four event-related actions one might want to take.</p><ul><li>Registering an event handler.</li><li>Getting the event object.</li><li>Extracting information from this object.</li><li>Signalling that an event has been handled.</li></ul><p><a class="paragraph" href="#p14d4e49cdd6c8701" name="p14d4e49cdd6c8701"> ¶ </a>None of them work the same across all major browsers.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p29f2f582b585c7f3" name="p29f2f582b585c7f3"> ¶ </a>As a practice field for our event-handling, we open a document with abutton and a text field. Keep this window open (and attached) for therest of the chapter.</p><pre class="code"><span class="variable">attach</span>(<span class="variable">window</span>.<span class="property">open</span>(<span class="string">&quot;example_events.html&quot;</span>));</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p4b8ef4f4dff9fe01" name="p4b8ef4f4dff9fe01"> ¶ </a>The first action, registering a handler, can be done by setting anelement's <code>onclick</code> (or <code>onkeypress</code>, and so on) property. This doesin fact work across browsers, but it has an important drawback ― youcan only attach one handler to an element. Most of the time, one isenough, but there are cases, especially when a program has to be ableto work together with other programs (which might also be addinghandlers), that this is annoying.</p><p><a class="paragraph" href="#p53ab4448a79192fe" name="p53ab4448a79192fe"> ¶ </a><a name="key6"></a>In Internet Explorer, one can add a click handler to abutton like this:</p><pre class="code invalid"><span class="variable">$</span>(<span class="string">&quot;button&quot;</span>).<span class="property">attachEvent</span>(<span class="string">&quot;onclick&quot;</span>, <span class="keyword">function</span>(){<span class="variable">print</span>(<span class="string">&quot;Click!&quot;</span>);});</pre><p><a class="paragraph" href="#p1a1c706bf5e7dd9" name="p1a1c706bf5e7dd9"> ¶ </a><a name="key7"></a>On the other browsers, it goes like this:</p><pre class="code invalid"><span class="variable">$</span>(<span class="string">&quot;button&quot;</span>).<span class="property">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="keyword">function</span>(){<span class="variable">print</span>(<span class="string">&quot;Click!&quot;</span>);}, <span class="atom">false</span>);</pre><p><a class="paragraph" href="#p6a1dc47cf5217450" name="p6a1dc47cf5217450"> ¶ </a>Note how <code>&quot;on&quot;</code> is left off in the second case. The third argumentto <code>addEventListener</code>, <code>false</code>, indicates that the event should'bubble' through the DOM tree as normal. Giving <code>true</code> instead can beused to give this handler priority over the handlers 'beneath' it, butsince Internet Explorer does not support such a thing, this is rarelyuseful.</p></div><hr/><div class="block"><a name="exercise1"></a><div class="exercisenum">Ex. 13.1</div><div class="exercise"><p><a class="paragraph" href="#p4f929b97df1c21e8" name="p4f929b97df1c21e8"> ¶ </a>Write a function called <code>registerEventHandler</code> to wrap theincompatibilities of these two models. It takes three arguments: firsta DOM node that the handler should be attached to, then the name ofthe event type, such as <code>&quot;click&quot;</code> or <code>&quot;keypress&quot;</code>, and finally thehandler function.</p><p><a class="paragraph" href="#p4955486507b38739" name="p4955486507b38739"> ¶ </a>To determine which method should be called, look for the methodsthemselves ― if the DOM node has a method called <code>attachEvent</code>, youmay assume that this is the correct method. Note that this is muchpreferable to directly checking whether the browser is InternetExplorer. If a new browser arrives which uses Internet Explorer'smodel, or Internet Explorer suddenly switches to the standard model,the code will still work. Both are rather unlikely, of course, butdoing something in a smart way never hurts.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">registerEventHandler</span>(<span class="variabledef">node</span>, <span class="variabledef">event</span>, <span class="variabledef">handler</span>){<span class="keyword">if</span> (typeof <span class="localvariable">node</span>.<span class="property">addEventListener</span>==<span class="string">&quot;function&quot;</span>) <span class="localvariable">node</span>.<span class="property">addEventListener</span>(<span class="localvariable">event</span>, <span class="localvariable">handler</span>, <span class="atom">false</span>);<span class="keyword">else</span><span class="localvariable">node</span>.<span class="property">attachEvent</span>(<span class="string">&quot;on&quot;</span> + <span class="localvariable">event</span>, <span class="localvariable">handler</span>);}<span class="variable">registerEventHandler</span>(<span class="variable">$</span>(<span class="string">&quot;button&quot;</span>), <span class="string">&quot;click&quot;</span>, <span class="keyword">function</span>(){<span class="variable">print</span>(<span class="string">&quot;Click (2)&quot;</span>);});</pre><p><a class="paragraph" href="#p15573e9bf4a50775" name="p15573e9bf4a50775"> ¶ </a>Don't fret about the long, clumsy name. Later on, we will have to addan extra wrapper to wrap this wrapper, and it will have a shortername.</p><p><a class="paragraph" href="#p78adb8f0dce1437b" name="p78adb8f0dce1437b"> ¶ </a>It is also possible to do this check only once, and define<code>registerEventHandler</code> to hold a different function depending on thebrowser. This is more efficient, but a little strange.</p><pre class="code"><span class="keyword">if</span> (typeof <span class="variable">document</span>.<span class="property">addEventListener</span>==<span class="string">&quot;function&quot;</span>) <span class="keyword">var</span><span class="variable">registerEventHandler</span>=<span class="keyword">function</span>(<span class="variabledef">node</span>, <span class="variabledef">event</span>, <span class="variabledef">handler</span>){<span class="localvariable">node</span>.<span class="property">addEventListener</span>(<span class="localvariable">event</span>, <span class="localvariable">handler</span>, <span class="atom">false</span>);};<span class="keyword">else</span><span class="keyword">var</span><span class="variable">registerEventHandler</span>=<span class="keyword">function</span>(<span class="variabledef">node</span>, <span class="variabledef">event</span>, <span class="variabledef">handler</span>){<span class="localvariable">node</span>.<span class="property">attachEvent</span>(<span class="string">&quot;on&quot;</span> + <span class="localvariable">event</span>, <span class="localvariable">handler</span>);};</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p643d3dda1cb19245" name="p643d3dda1cb19245"> ¶ </a>Removing events works very much like adding them, but this time themethods <a name="key8"></a><code>detachEvent</code> and <a name="key9"></a><code>removeEventListener</code> are used. Notethat, to remove a handler, you need to have access to the function youattached to it.</p><pre class="code"><span class="keyword">function</span><span class="variable">unregisterEventHandler</span>(<span class="variabledef">node</span>, <span class="variabledef">event</span>, <span class="variabledef">handler</span>){<span class="keyword">if</span> (typeof <span class="localvariable">node</span>.<span class="property">removeEventListener</span>==<span class="string">&quot;function&quot;</span>) <span class="localvariable">node</span>.<span class="property">removeEventListener</span>(<span class="localvariable">event</span>, <span class="localvariable">handler</span>, <span class="atom">false</span>);<span class="keyword">else</span><span class="localvariable">node</span>.<span class="property">detachEvent</span>(<span class="string">&quot;on&quot;</span> + <span class="localvariable">event</span>, <span class="localvariable">handler</span>);}</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p79feb4226ccdc648" name="p79feb4226ccdc648"> ¶ </a>Exceptions produced by event handlers can, because of technicallimitations, not be caught by the console. Thus, they are handled bythe browser, which might mean they get hidden in some kind of 'errorconsole' somewhere, or cause a message to pop up. When you write anevent handler and it does not seem to work, it might be silentlyaborting because it causes some kind of error.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p3fc97834f2fb9c39" name="p3fc97834f2fb9c39"> ¶ </a><a name="key10"></a>Most browsers pass the <a name="key11"></a>event object as an argument to thehandler. Internet Explorer stores it in the top-level variable called<code>event</code>. When looking at JavaScript code, you will often come acrosssomething like <code>event || window.event</code>, which takes the local variable<code>event</code> or, if that is undefined, the top-level variable by that samename.</p><pre class="code"><span class="keyword">function</span><span class="variable">showEvent</span>(<span class="variabledef">event</span>){<span class="variable">show</span>(<span class="localvariable">event</span> || <span class="variable">window</span>.<span class="property">event</span>);}<span class="variable">registerEventHandler</span>(<span class="variable">$</span>(<span class="string">&quot;textfield&quot;</span>), <span class="string">&quot;keypress&quot;</span>, <span class="variable">showEvent</span>);</pre><p><a class="paragraph" href="#p1e85731019f5211" name="p1e85731019f5211"> ¶ </a>Type a few characters in the field, look at the objects, and shut itup again:</p><pre class="code"><span class="variable">unregisterEventHandler</span>(<span class="variable">$</span>(<span class="string">&quot;textfield&quot;</span>), <span class="string">&quot;keypress&quot;</span>, <span class="variable">showEvent</span>);</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p4b98195aa6c52a84" name="p4b98195aa6c52a84"> ¶ </a><a name="key12"></a><a name="key13"></a><a name="key14"></a><a name="key15"></a>When the userclicks his mouse, three events are generated. First <a name="key16"></a><code>mousedown</code>, atthe moment the mouse button is pressed. Then, <a name="key17"></a><code>mouseup</code>, at themoment it is released. And finally, <a name="key18"></a><code>click</code>, to indicate somethingwas clicked. When this happens two times in quick succession, a<a name="key19"></a><code>dblclick</code> (double-click) event is also generated. Note that it ispossible for the <code>mousedown</code> and <code>mouseup</code> events to happen some timeapart ― when the mouse button is held for a while.</p><p><a class="paragraph" href="#p6f732069cb906b8" name="p6f732069cb906b8"> ¶ </a>When you attach an event handler to, for example, a button, the factthat it has been clicked is often all you need to know. When thehandler, on the other hand, is attached to a node that has children,clicks from the children will 'bubble' up to it, and you will want tofind out which child has been clicked. For this purpose, event objectshave a property called <a name="key20"></a><code>target</code>... or <code>srcElement</code>, depending on thebrowser.</p><p><a class="paragraph" href="#pc23ad6b90cac8aa" name="pc23ad6b90cac8aa"> ¶ </a><a name="key21"></a><a name="key22"></a>Another interesting piece of informationare the precise coordinates at which the click occurred. Event objectsrelated to the mouse contain <a name="key23"></a><code>clientX</code> and <a name="key24"></a><code>clientY</code> properties,which give the <code>x</code> and <code>y</code> coordinates of the mouse, in pixels, on thescreen. Documents can scroll, though, so often these coordinates donot tell us much about the part of the document that the mouse isover. Some browsers provide <a name="key25"></a><code>pageX</code> and <a name="key26"></a><code>pageY</code> properties forthis purpose, but others (guess which) do not. Fortunately, theinformation about the amount of pixels the document has been scrolledcan be found in <code>document.body.scrollLeft</code> and<code>document.body.scrollTop</code>.</p><p><a class="paragraph" href="#p62cd9eb170cc7708" name="p62cd9eb170cc7708"> ¶ </a>This handler, attached to the whole document, intercepts all mouseclicks, and prints some information about them.</p><pre class="code"><span class="keyword">function</span><span class="variable">reportClick</span>(<span class="variabledef">event</span>){<span class="localvariable">event</span>=<span class="localvariable">event</span> || <span class="variable">window</span>.<span class="property">event</span>;<span class="keyword">var</span><span class="variabledef">target</span>=<span class="localvariable">event</span>.<span class="property">target</span> || <span class="localvariable">event</span>.<span class="property">srcElement</span>;<span class="keyword">var</span><span class="variabledef">pageX</span>=<span class="localvariable">event</span>.<span class="property">pageX</span>, <span class="variabledef">pageY</span>=<span class="localvariable">event</span>.<span class="property">pageY</span>;<span class="keyword">if</span> (<span class="localvariable">pageX</span>==<span class="atom">undefined</span>){<span class="localvariable">pageX</span>=<span class="localvariable">event</span>.<span class="property">clientX</span> + <span class="variable">document</span>.<span class="property">body</span>.<span class="property">scrollLeft</span>;<span class="localvariable">pageY</span>=<span class="localvariable">event</span>.<span class="property">clientY</span> + <span class="variable">document</span>.<span class="property">body</span>.<span class="property">scrollTop</span>;}<span class="variable">print</span>(<span class="string">&quot;Mouse clicked at &quot;</span>, <span class="localvariable">pageX</span>, <span class="string">&quot;, &quot;</span>, <span class="localvariable">pageY</span>, <span class="string">&quot;. Inside element:&quot;</span>);<span class="variable">show</span>(<span class="localvariable">target</span>);}<span class="variable">registerEventHandler</span>(<span class="variable">document</span>, <span class="string">&quot;click&quot;</span>, <span class="variable">reportClick</span>);</pre><p><a class="paragraph" href="#p2177351b46809e6c" name="p2177351b46809e6c"> ¶ </a>And get rid of it again:</p><pre class="code"><span class="variable">unregisterEventHandler</span>(<span class="variable">document</span>, <span class="string">&quot;click&quot;</span>, <span class="variable">reportClick</span>);</pre><p><a class="paragraph" href="#p283f8f76889606e0" name="p283f8f76889606e0"> ¶ </a>Obviously, writing all these checks and workarounds is not somethingyou want to do in every single event handler. In a moment, after wehave gotten acquainted with a few more incompatibilities, we willwrite a function to 'normalise' event objects to work the same acrossbrowsers.</p><p><a class="paragraph" href="#p4adb1a1ccca12b17" name="p4adb1a1ccca12b17"> ¶ </a>It is also sometimes possible to find out which mouse button waspressed, using the <a name="key27"></a><code>which</code> and <a name="key28"></a><code>button</code> properties of eventobjects. Unfortunately, this is very unreliable ― some browserspretend mouses have only one button, others report right-clicks asclicks during which the control key was held down, and so on.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p66c3fec7a30a209f" name="p66c3fec7a30a209f"> ¶ </a><a name="key29"></a><a name="key30"></a><a name="key31"></a>Apart from clicks, wemight also be interested in the movement of the mouse. The<a name="key32"></a><code>mousemove</code> event of a DOM node is fired whenever the mouse moveswhile it is over that element. There are also <a name="key33"></a><code>mouseover</code> and<a name="key34"></a><code>mouseout</code>, which are fired only when the mouse enters or leaves anode. For events of this last type, the <code>target</code> (or <code>srcElement</code>)property points at the node that the event is fired for, while the<a name="key35"></a><code>relatedTarget</code> (or <code>toElement</code>, or <code>fromElement</code>) property givesthe node that the mouse came from (for <code>mouseover</code>) or left to (for<code>mouseout</code>).</p><p><a class="paragraph" href="#p56a60965be9b927d" name="p56a60965be9b927d"> ¶ </a><code>mouseover</code> and <code>mouseout</code> can be tricky when they are registered onan element that has child nodes. Events fired for the child nodes willbubble up to the parent element, so you will also see a <code>mouseover</code>event when the mouse enters one of the child nodes. The <code>target</code> and<code>relatedTarget</code> properties can be used to detect (and ignore) suchevents.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p22a094298f9e2915" name="p22a094298f9e2915"> ¶ </a><a name="key36"></a><a name="key37"></a><a name="key38"></a>For every key that the userpresses, three events are generated: <a name="key39"></a><code>keydown</code>, <a name="key40"></a><code>keyup</code>, and<a name="key41"></a><code>keypress</code>. In general, you should use the first two in cases whereyou really want to know which key was pressed, for example when youwant to do something when the arrow keys are pressed. <code>keypress</code>, onthe other hand, is to be used when you are interested in the characterthat is being typed. The reason for this is that there is often nocharacter information in <code>keyup</code> and <code>keydown</code> events, and InternetExplorer does not generate a <code>keypress</code> event at all for special keyssuch as the arrow keys.</p><p><a class="paragraph" href="#p40cc1d688c4f47e9" name="p40cc1d688c4f47e9"> ¶ </a>Finding out which key was pressed can be quite a challenge by itself.For <code>keydown</code> and <code>keyup</code> events, the event object will have a<a name="key42"></a><code>keyCode</code> property, which contains a number. Most of the time, thesecodes can be used to identify keys in a reasonably browser-independentway. Finding out which code corresponds to which key can be done bysimple experiments...</p><pre class="code"><span class="keyword">function</span><span class="variable">printKeyCode</span>(<span class="variabledef">event</span>){<span class="localvariable">event</span>=<span class="localvariable">event</span> || <span class="variable">window</span>.<span class="property">event</span>;<span class="variable">print</span>(<span class="string">&quot;Key &quot;</span>, <span class="localvariable">event</span>.<span class="property">keyCode</span>, <span class="string">&quot;was pressed.&quot;</span>);}<span class="variable">registerEventHandler</span>(<span class="variable">$</span>(<span class="string">&quot;textfield&quot;</span>), <span class="string">&quot;keydown&quot;</span>, <span class="variable">printKeyCode</span>);</pre><pre class="code"><span class="variable">unregisterEventHandler</span>(<span class="variable">$</span>(<span class="string">&quot;textfield&quot;</span>), <span class="string">&quot;keydown&quot;</span>, <span class="variable">printKeyCode</span>);</pre><p><a class="paragraph" href="#p7350f32959d12e73" name="p7350f32959d12e73"> ¶ </a>In most browsers, a single key code corresponds to a single <em>physical</em>key on your keyboard. The Opera browser, however, will generatedifferent key codes for some keys depending on whether shift ispressed or not. Even worse, some of these shift-is-pressed codes arethe same codes that are also used for other keys ― shift-9, which onmost keyboards is used to type a parenthesis, gets the same code asthe down arrow, and as such is hard to distinguish from it. When thisthreatens to sabotage your programs, you can usually resolve it byignoring key events that have shift pressed.</p><p><a class="paragraph" href="#p7156fdbb9be9c4ab" name="p7156fdbb9be9c4ab"> ¶ </a>To find out whether the shift, control, or alt key was held during akey or mouse event, you can look at the <a name="key43"></a><code>shiftKey</code>, <a name="key44"></a><code>ctrlKey</code>, and<a name="key45"></a><code>altKey</code> properties of the event object.</p><p><a class="paragraph" href="#p40895e8835cd0c5d" name="p40895e8835cd0c5d"> ¶ </a>For <code>keypress</code> events, you will want to know which character wastyped. The event object will have a <a name="key46"></a><code>charCode</code> property, which, ifyou are lucky, contains the <a name="key47"></a>Unicode number corresponding to thecharacter that was typed, which can be converted to a 1-characterstring by using <a name="key48"></a><code>String.fromCharCode</code>. Unfortunately, some browsersdo not define this property, or define it as <code>0</code>, and store thecharacter code in the <a name="key49"></a><code>keyCode</code> property instead.</p><pre class="code"><span class="keyword">function</span><span class="variable">printCharacter</span>(<span class="variabledef">event</span>){<span class="localvariable">event</span>=<span class="localvariable">event</span> || <span class="variable">window</span>.<span class="property">event</span>;<span class="keyword">var</span><span class="variabledef">charCode</span>=<span class="localvariable">event</span>.<span class="property">charCode</span>;<span class="keyword">if</span> (<span class="localvariable">charCode</span>==<span class="atom">undefined</span> || <span class="localvariable">charCode</span>===<span class="atom">0</span>) <span class="localvariable">charCode</span>=<span class="localvariable">event</span>.<span class="property">keyCode</span>;<span class="variable">print</span>(<span class="string">&quot;Character '&quot;</span>, <span class="variable">String</span>.<span class="property">fromCharCode</span>(<span class="localvariable">charCode</span>), <span class="string">&quot;'&quot;</span>);}<span class="variable">registerEventHandler</span>(<span class="variable">$</span>(<span class="string">&quot;textfield&quot;</span>), <span class="string">&quot;keypress&quot;</span>, <span class="variable">printCharacter</span>);</pre><pre class="code"><span class="variable">unregisterEventHandler</span>(<span class="variable">$</span>(<span class="string">&quot;textfield&quot;</span>), <span class="string">&quot;keypress&quot;</span>, <span class="variable">printCharacter</span>);</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p5ac14b0f042b3dc0" name="p5ac14b0f042b3dc0"> ¶ </a>An event handler can 'stop' the event it is handling. There are twodifferent ways to do this. You can prevent the event from bubbling upto parent nodes and the handlers defined on those, and you can preventthe browser from taking the standard action associated with such anevent. It should be noted that browsers do not always follow this ―preventing the default behaviour for the pressing of certain 'hotkeys'will, on many browsers, not actually keep the browser from executingthe normal effect of these keys.</p><p><a class="paragraph" href="#p380482a2b001f697" name="p380482a2b001f697"> ¶ </a>On most browsers, stopping event bubbling is done with the<a name="key50"></a><code>stopPropagation</code> method of the event object, and preventing defaultbehaviour is done with the <a name="key51"></a><code>preventDefault</code> method. For InternetExplorer, this is done by setting the <a name="key52"></a><code>cancelBubble</code> property ofthis object to <code>true</code>, and the <a name="key53"></a><code>returnValue</code> property to <code>false</code>,respectively.</p><p><a class="paragraph" href="#pb67f76098fd7410" name="pb67f76098fd7410"> ¶ </a>And that was the last of the long list of incompatibilities that wewill discuss in this chapter. Which means that we can finally writethe event normaliser function and move on to more interesting things.</p><pre class="code"><span class="keyword">function</span><span class="variable">normaliseEvent</span>(<span class="variabledef">event</span>){<span class="keyword">if</span> (!<span class="localvariable">event</span>.<span class="property">stopPropagation</span>){<span class="localvariable">event</span>.<span class="property">stopPropagation</span>=<span class="keyword">function</span>(){<span class="localvariable">this</span>.<span class="property">cancelBubble</span>=<span class="atom">true</span>;};<span class="localvariable">event</span>.<span class="property">preventDefault</span>=<span class="keyword">function</span>(){<span class="localvariable">this</span>.<span class="property">returnValue</span>=<span class="atom">false</span>;};}<span class="keyword">if</span> (!<span class="localvariable">event</span>.<span class="property">stop</span>){<span class="localvariable">event</span>.<span class="property">stop</span>=<span class="keyword">function</span>(){<span class="localvariable">this</span>.<span class="property">stopPropagation</span>();<span class="localvariable">this</span>.<span class="property">preventDefault</span>();};}<span class="keyword">if</span> (<span class="localvariable">event</span>.<span class="property">srcElement</span> &amp;&amp;!<span class="localvariable">event</span>.<span class="property">target</span>) <span class="localvariable">event</span>.<span class="property">target</span>=<span class="localvariable">event</span>.<span class="property">srcElement</span>;<span class="keyword">if</span> ((<span class="localvariable">event</span>.<span class="property">toElement</span> || <span class="localvariable">event</span>.<span class="property">fromElement</span>) &amp;&amp;!<span class="localvariable">event</span>.<span class="property">relatedTarget</span>) <span class="localvariable">event</span>.<span class="property">relatedTarget</span>=<span class="localvariable">event</span>.<span class="property">toElement</span> || <span class="localvariable">event</span>.<span class="property">fromElement</span>;<span class="keyword">if</span> (<span class="localvariable">event</span>.<span class="property">clientX</span> !=<span class="atom">undefined</span> &amp;&amp;<span class="localvariable">event</span>.<span class="property">pageX</span>==<span class="atom">undefined</span>){<span class="localvariable">event</span>.<span class="property">pageX</span>=<span class="localvariable">event</span>.<span class="property">clientX</span> + <span class="variable">document</span>.<span class="property">body</span>.<span class="property">scrollLeft</span>;<span class="localvariable">event</span>.<span class="property">pageY</span>=<span class="localvariable">event</span>.<span class="property">clientY</span> + <span class="variable">document</span>.<span class="property">body</span>.<span class="property">scrollTop</span>;}<span class="keyword">if</span> (<span class="localvariable">event</span>.<span class="property">type</span>==<span class="string">&quot;keypress&quot;</span>){<span class="keyword">if</span> (<span class="localvariable">event</span>.<span class="property">charCode</span>===<span class="atom">0</span> || <span class="localvariable">event</span>.<span class="property">charCode</span>==<span class="atom">undefined</span>) <span class="localvariable">event</span>.<span class="property">character</span>=<span class="variable">String</span>.<span class="property">fromCharCode</span>(<span class="localvariable">event</span>.<span class="property">keyCode</span>);<span class="keyword">else</span><span class="localvariable">event</span>.<span class="property">character</span>=<span class="variable">String</span>.<span class="property">fromCharCode</span>(<span class="localvariable">event</span>.<span class="property">charCode</span>);}<span class="keyword">return</span><span class="localvariable">event</span>;}</pre><p><a class="paragraph" href="#p40286c84b5d3f72b" name="p40286c84b5d3f72b"> ¶ </a>A <a name="key54"></a><code>stop</code> method is added, which cancels both the bubbling andthe default action of the event. Some browsers already provide this,in which case we leave it as it is.</p><p><a class="paragraph" href="#p5fb19f529da455d6" name="p5fb19f529da455d6"> ¶ </a>Next we can write convenient wrappers for <code>registerEventHandler</code> and<code>unregisterEventHandler</code>:</p><pre class="code"><span class="keyword">function</span><span class="variable">addHandler</span>(<span class="variabledef">node</span>, <span class="variabledef">type</span>, <span class="variabledef">handler</span>){<span class="keyword">function</span><span class="variabledef">wrapHandler</span>(<span class="variabledef">event</span>){<span class="localvariable">handler</span>(<span class="variable">normaliseEvent</span>(<span class="localvariable">event</span> || <span class="variable">window</span>.<span class="property">event</span>));}<span class="variable">registerEventHandler</span>(<span class="localvariable">node</span>, <span class="localvariable">type</span>, <span class="localvariable">wrapHandler</span>);<span class="keyword">return</span>{<span class="property">node</span>: <span class="localvariable">node</span>, <span class="property">type</span>: <span class="localvariable">type</span>, <span class="property">handler</span>: <span class="localvariable">wrapHandler</span>};}<span class="keyword">function</span><span class="variable">removeHandler</span>(<span class="variabledef">object</span>){<span class="variable">unregisterEventHandler</span>(<span class="localvariable">object</span>.<span class="property">node</span>, <span class="localvariable">object</span>.<span class="property">type</span>, <span class="localvariable">object</span>.<span class="property">handler</span>);}<span class="keyword">var</span><span class="variable">blockQ</span>=<span class="variable">addHandler</span>(<span class="variable">$</span>(<span class="string">&quot;textfield&quot;</span>), <span class="string">&quot;keypress&quot;</span>, <span class="keyword">function</span>(<span class="variabledef">event</span>){<span class="keyword">if</span> (<span class="localvariable">event</span>.<span class="property">character</span>.<span class="property">toLowerCase</span>()==<span class="string">&quot;q&quot;</span>) <span class="localvariable">event</span>.<span class="property">stop</span>();});</pre><p><a class="paragraph" href="#p10b06183662315ec" name="p10b06183662315ec"> ¶ </a>The new <code>addHandler</code> function wraps the handler function it is givenin a new function, so it can take care of normalising the eventobjects. It returns an object that can be given to <code>removeHandler</code>when we want to remove this specific handler. Try typing a '<code>q</code>' inthe text field.</p><pre class="code"><span class="variable">removeHandler</span>(<span class="variable">blockQ</span>);</pre></div><hr/><div class="block"><p><a class="paragraph" href="#pee867787a173854" name="pee867787a173854"> ¶ </a>Armed with <code>addHandler</code> and the <code>dom</code> function from the last chapter,we are ready for more challenging feats of document-manipulation. Asan exercise, we will implement the game known as <a name="key55"></a>Sokoban. This issomething of a classic, but you may not have seen it before. The rulesare this: There is a grid, made up of walls, empty space, and one ormore 'exits'. On this grid, there are a number of crates or stones,and a little dude that the player controls. This dude can be movedhorizontally and vertically into empty squares, and can push theboulders around, provided that there is empty space behind them. Thegoal of the game is to move a given number of boulders into the exits.</p><p><a class="paragraph" href="#p234fe283b2505365" name="p234fe283b2505365"> ¶ </a>Just like the terraria from <a href="chapter8.html">chapter 8</a>, a Sokoban level can be representedas text. The variable <code>sokobanLevels</code>, in the <code>example_events.html</code>window, contains an array of level objects. Each level has a property<code>field</code>, containing a textual representation of the level, and aproperty <code>boulders</code>, indicating the amount of boulders that must beexpelled to finish the level.</p><pre class="code"><span class="variable">show</span>(<span class="variable">sokobanLevels</span>.<span class="property">length</span>);<span class="variable">show</span>(<span class="variable">sokobanLevels</span>[<span class="atom">1</span>].<span class="property">boulders</span>);<span class="variable">forEach</span>(<span class="variable">sokobanLevels</span>[<span class="atom">1</span>].<span class="property">field</span>, <span class="variable">print</span>);</pre><p><a class="paragraph" href="#p24d3da5c0f84c174" name="p24d3da5c0f84c174"> ¶ </a>In such a level, the <code>#</code> characters are walls, spaces are emptysquares, <code>0</code> characters are used for for boulders, an <code>@</code> for thestarting location of the player, and a <code>*</code> for the exit.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p47ecdfa2370825d1" name="p47ecdfa2370825d1"> ¶ </a>But, when playing the game, we do not want to be looking at thistextual representation. Instead, we will put a <a name="key56"></a>table into thedocument. I made small <a name="key57"></a>style-sheet (<a href="css/sokoban.css">sokoban.css</a>,if you are curious what it looks like) to give the cells of this tablea fixed square size, and added it to the example document. Each of thecells in this table will get a background image, representing the typeof the square (empty, wall, or exit). To show the location of theplayer and the boulders, images are added to these table cells, andmoved to different cells as appropriate.</p><p><a class="paragraph" href="#p35344ca902c88e34" name="p35344ca902c88e34"> ¶ </a>It would be possible to use this table as the main representation ofour data ― when we want to look whether there is a wall in a givensquare, we just inspect the background of the appropriate table cell,and to find the player, we just search for the image node with thecorrect <code>src</code> property. In some cases, this approach is practical, butfor this program I chose to keep a separate data structure for thegrid, because it makes things much more straightforward.</p><p><a class="paragraph" href="#p44bf042ee9cbbcb6" name="p44bf042ee9cbbcb6"> ¶ </a>This data structure is a two-dimensional grid of objects, representingthe squares of the playing field. Each of the objects must store thetype of background it has and whether there is a boulder or playerpresent in that cell. It should also contain a reference to the tablecell that is used to display it in the document, to make it easy tomove images in and out of this table cell.</p><p><a class="paragraph" href="#p7ae97e5f7cf79a44" name="p7ae97e5f7cf79a44"> ¶ </a>That gives us two kinds of objects ― one to hold the grid of theplaying field, and one to represent the individual cells in this grid.If we want the game to also do things like moving the next level atthe appropriate moment, and being able to reset the current level whenyou mess up, we will also need a 'controller' object, which creates orremoves the field objects at the appropriate moment. For convenience,we will be using the prototype approach outlined at the end of <a href="chapter8.html">chapter 8</a>,so object types are just prototypes, and the <code>create</code> method, ratherthan the <code>new</code> operator, is used to make new objects.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p5e757dc49c1d8b9e" name="p5e757dc49c1d8b9e"> ¶ </a>Let us start with the objects representing the squares of the game'sfield. They are responsible for setting the background of their cellscorrectly, and adding images as appropriate. The <code>img/sokoban/</code>directory contains a set of images, based on another ancient game,which will be used to visualise the game. For a start, the <code>Square</code>prototype could look like this.</p><pre class="code"><span class="keyword">var</span><span class="variable">Square</span>={<span class="property">construct</span>: <span class="keyword">function</span>(<span class="variabledef">character</span>, <span class="variabledef">tableCell</span>){<span class="localvariable">this</span>.<span class="property">background</span>=<span class="string">&quot;empty&quot;</span>;<span class="keyword">if</span> (<span class="localvariable">character</span>==<span class="string">&quot;#&quot;</span>) <span class="localvariable">this</span>.<span class="property">background</span>=<span class="string">&quot;wall&quot;</span>;<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">character</span>==<span class="string">&quot;*&quot;</span>) <span class="localvariable">this</span>.<span class="property">background</span>=<span class="string">&quot;exit&quot;</span>;<span class="localvariable">this</span>.<span class="property">tableCell</span>=<span class="localvariable">tableCell</span>;<span class="localvariable">this</span>.<span class="property">tableCell</span>.<span class="property">className</span>=<span class="localvariable">this</span>.<span class="property">background</span>;<span class="localvariable">this</span>.<span class="property">content</span>=<span class="atom">null</span>;<span class="keyword">if</span> (<span class="localvariable">character</span>==<span class="string">&quot;0&quot;</span>) <span class="localvariable">this</span>.<span class="property">content</span>=<span class="string">&quot;boulder&quot;</span>;<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">character</span>==<span class="string">&quot;@&quot;</span>) <span class="localvariable">this</span>.<span class="property">content</span>=<span class="string">&quot;player&quot;</span>;<span class="keyword">if</span> (<span class="localvariable">this</span>.<span class="property">content</span> !=<span class="atom">null</span>){<span class="keyword">var</span><span class="variabledef">image</span>=<span class="variable">dom</span>(<span class="string">&quot;IMG&quot;</span>,{<span class="property">src</span>: <span class="string">&quot;img/sokoban/&quot;</span> + <span class="localvariable">this</span>.<span class="property">content</span> + <span class="string">&quot;.gif&quot;</span>});<span class="localvariable">this</span>.<span class="property">tableCell</span>.<span class="property">appendChild</span>(<span class="localvariable">image</span>);}}, <span class="property">hasPlayer</span>: <span class="keyword">function</span>(){<span class="keyword">return</span><span class="localvariable">this</span>.<span class="property">content</span>==<span class="string">&quot;player&quot;</span>;}, <span class="property">hasBoulder</span>: <span class="keyword">function</span>(){<span class="keyword">return</span><span class="localvariable">this</span>.<span class="property">content</span>==<span class="string">&quot;boulder&quot;</span>;}, <span class="property">isEmpty</span>: <span class="keyword">function</span>(){<span class="keyword">return</span><span class="localvariable">this</span>.<span class="property">content</span>==<span class="atom">null</span> &amp;&amp;<span class="localvariable">this</span>.<span class="property">background</span>==<span class="string">&quot;empty&quot;</span>;}, <span class="property">isExit</span>: <span class="keyword">function</span>(){<span class="keyword">return</span><span class="localvariable">this</span>.<span class="property">background</span>==<span class="string">&quot;exit&quot;</span>;}};<span class="keyword">var</span><span class="variable">testSquare</span>=<span class="variable">Square</span>.<span class="property">create</span>(<span class="string">&quot;@&quot;</span>, <span class="variable">dom</span>(<span class="string">&quot;TD&quot;</span>));<span class="variable">show</span>(<span class="variable">testSquare</span>.<span class="property">hasPlayer</span>());</pre><p><a class="paragraph" href="#p707dcafe258fa48" name="p707dcafe258fa48"> ¶ </a>The <code>character</code> argument to the constructor will be used to transformcharacters from the level blueprints into actual <code>Square</code> objects. Toset the background of the cells, style-sheet classes are used (definedin <a href="css/sokoban.css">sokoban.css</a>), which are assigned to the <code>td</code>elements' <code>className</code> property.</p><p><a class="paragraph" href="#p2a57901f2f328f59" name="p2a57901f2f328f59"> ¶ </a>The methods like <code>hasPlayer</code> and <code>isEmpty</code> are a way to 'isolate' thecode that uses objects of this type from the internals of the objects.They are not strictly necessary in this case, but they will make theother code look better.</p></div><hr/><div class="block"><a name="exercise2"></a><div class="exercisenum">Ex. 13.2</div><div class="exercise"><p><a class="paragraph" href="#p58996516543d0e5f" name="p58996516543d0e5f"> ¶ </a>Add methods <code>moveContent</code> and <code>clearContent</code> to the <code>Square</code>prototype. The first one takes another <code>Square</code> object as an argument,and moves the content of the <code>this</code> square into the argument byupdating the <code>content</code> properties and moving the image node associatedwith this content. This will be used to move boulders and playersaround the grid. It may assume the square is not currently empty.<code>clearContent</code> removes the content from the square without moving itanywhere. Note that the <code>content</code> property for empty squares contains<code>null</code>.</p><p><a class="paragraph" href="#p9bc948783f82b2c" name="p9bc948783f82b2c"> ¶ </a>The <code>removeElement</code> function we defined in <a href="chapter12.html">chapter 12</a> is available in thischapter too, for your node-removing convenience. You may assume thatthe images are the only child nodes of the table cells, and can thusbe reached through, for example, <code>this.tableCell.lastChild</code>.</p></div><div class="solution"><pre class="code"><span class="variable">Square</span>.<span class="property">moveContent</span>=<span class="keyword">function</span>(<span class="variabledef">target</span>){<span class="localvariable">target</span>.<span class="property">content</span>=<span class="localvariable">this</span>.<span class="property">content</span>;<span class="localvariable">this</span>.<span class="property">content</span>=<span class="atom">null</span>;<span class="localvariable">target</span>.<span class="property">tableCell</span>.<span class="property">appendChild</span>(<span class="localvariable">this</span>.<span class="property">tableCell</span>.<span class="property">lastChild</span>);};<span class="variable">Square</span>.<span class="property">clearContent</span>=<span class="keyword">function</span>(){<span class="localvariable">this</span>.<span class="property">content</span>=<span class="atom">null</span>;<span class="variable">removeElement</span>(<span class="localvariable">this</span>.<span class="property">tableCell</span>.<span class="property">lastChild</span>);};</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p1773b9d99848aef3" name="p1773b9d99848aef3"> ¶ </a>The next object type will be called <code>SokobanField</code>. Its constructor isgiven an object from the <code>sokobanLevels</code> array, and is responsible forbuilding both a table of DOM nodes and a grid of <code>Square</code> objects.This object will also take care of the details of moving the playerand boulders around, through a <code>move</code> method that is given an argumentindicating which way the player wants to move.</p><p><a class="paragraph" href="#p70f3c7243a2d101e" name="p70f3c7243a2d101e"> ¶ </a>To identify the individual squares, and to indicate directions, wewill again use the <code>Point</code> object type from <a href="chapter8.html">chapter 8</a>, which, as you mightremember, has an <code>add</code> method.</p><p><a class="paragraph" href="#p796a6f5325ce8f2d" name="p796a6f5325ce8f2d"> ¶ </a>The base of the field prototype looks like this:</p><pre class="code"><span class="keyword">var</span><span class="variable">SokobanField</span>={<span class="property">construct</span>: <span class="keyword">function</span>(<span class="variabledef">level</span>){<span class="keyword">var</span><span class="variabledef">tbody</span>=<span class="variable">dom</span>(<span class="string">&quot;TBODY&quot;</span>);<span class="localvariable">this</span>.<span class="property">squares</span>=[];<span class="localvariable">this</span>.<span class="property">bouldersToGo</span>=<span class="localvariable">level</span>.<span class="property">boulders</span>;<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">y</span>=<span class="atom">0</span>;<span class="localvariable">y</span> &lt;<span class="localvariable">level</span>.<span class="property">field</span>.<span class="property">length</span>;<span class="localvariable">y</span>++){<span class="keyword">var</span><span class="variabledef">line</span>=<span class="localvariable">level</span>.<span class="property">field</span>[<span class="localvariable">y</span>];<span class="keyword">var</span><span class="variabledef">tableRow</span>=<span class="variable">dom</span>(<span class="string">&quot;TR&quot;</span>);<span class="keyword">var</span><span class="variabledef">squareRow</span>=[];<span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">x</span>=<span class="atom">0</span>;<span class="localvariable">x</span> &lt;<span class="localvariable">line</span>.<span class="property">length</span>;<span class="localvariable">x</span>++){<span class="keyword">var</span><span class="variabledef">tableCell</span>=<span class="variable">dom</span>(<span class="string">&quot;TD&quot;</span>);<span class="localvariable">tableRow</span>.<span class="property">appendChild</span>(<span class="localvariable">tableCell</span>);<span class="keyword">var</span><span class="variabledef">square</span>=<span class="variable">Square</span>.<span class="property">create</span>(<span class="localvariable">line</span>.<span class="property">charAt</span>(<span class="localvariable">x</span>), <span class="localvariable">tableCell</span>);<span class="localvariable">squareRow</span>.<span class="property">push</span>(<span class="localvariable">square</span>);<span class="keyword">if</span> (<span class="localvariable">square</span>.<span class="property">hasPlayer</span>()) <span class="localvariable">this</span>.<span class="property">playerPos</span>=<span class="keyword">new</span><span class="variable">Point</span>(<span class="localvariable">x</span>, <span class="localvariable">y</span>);}<span class="localvariable">tbody</span>.<span class="property">appendChild</span>(<span class="localvariable">tableRow</span>);<span class="localvariable">this</span>.<span class="property">squares</span>.<span class="property">push</span>(<span class="localvariable">squareRow</span>);}<span class="localvariable">this</span>.<span class="property">table</span>=<span class="variable">dom</span>(<span class="string">&quot;TABLE&quot;</span>,{<span class="string">&quot;class&quot;</span>: <span class="string">&quot;sokoban&quot;</span>}, <span class="localvariable">tbody</span>);<span class="localvariable">this</span>.<span class="property">score</span>=<span class="variable">dom</span>(<span class="string">&quot;DIV&quot;</span>, <span class="atom">null</span>, <span class="string">&quot;...&quot;</span>);<span class="localvariable">this</span>.<span class="property">updateScore</span>();}, <span class="property">getSquare</span>: <span class="keyword">function</span>(<span class="variabledef">position</span>){<span class="keyword">return</span><span class="localvariable">this</span>.<span class="property">squares</span>[<span class="localvariable">position</span>.<span class="property">y</span>][<span class="localvariable">position</span>.<span class="property">x</span>];}, <span class="property">updateScore</span>: <span class="keyword">function</span>(){<span class="localvariable">this</span>.<span class="property">score</span>.<span class="property">firstChild</span>.<span class="property">nodeValue</span>=<span class="localvariable">this</span>.<span class="property">bouldersToGo</span> + <span class="string">&quot;boulders to go.&quot;</span>;}, <span class="property">won</span>: <span class="keyword">function</span>(){<span class="keyword">return</span><span class="localvariable">this</span>.<span class="property">bouldersToGo</span> &lt;=<span class="atom">0</span>;}};<span class="keyword">var</span><span class="variable">testField</span>=<span class="variable">SokobanField</span>.<span class="property">create</span>(<span class="variable">sokobanLevels</span>[<span class="atom">0</span>]);<span class="variable">show</span>(<span class="variable">testField</span>.<span class="property">getSquare</span>(<span class="keyword">new</span><span class="variable">Point</span>(<span class="atom">10</span>, <span class="atom">2</span>)).<span class="property">content</span>);</pre><p><a class="paragraph" href="#p2c2b54280aa123b2" name="p2c2b54280aa123b2"> ¶ </a>The constructor goes over the lines and characters in the level, andstores the <code>Square</code> objects in the <code>squares</code> property. When itencounters the square with the player, it saves this position as<code>playerPos</code>, so that we can easily find the square with the playerlater on. <code>getSquare</code> is used to find a <code>Square</code> object correspondingto a certain <code>x,y</code> position on the field. Note that it doesn't takethe edges of the field into account ― to avoid writing some boringcode, we assume that the field is properly walled off, making itimpossible to walk out of it.</p><p><a class="paragraph" href="#p455575a17764e02d" name="p455575a17764e02d"> ¶ </a>The word <code>&quot;class&quot;</code> in the <code>dom</code> call that makes the <code>table</code> node isquoted as a string. This is necessary because <a name="key58"></a><code>class</code> is a 'reservedword' in JavaScript, and may not be used as a variable or propertyname.</p><p><a class="paragraph" href="#p573c956db8c8002f" name="p573c956db8c8002f"> ¶ </a>The amount of boulders that have to be cleared to win the level (thismay be less than the total amount of boulders on the level) is storedin <code>bouldersToGo</code>. Whenever a boulder is brought to the exit, we cansubtract 1 from this, and see whether the game is won yet. To show theplayer how he is doing, we will have to show this amount somehow. Forthis purpose, a <code>div</code> element with text is used. <code>div</code> nodes arecontainers without inherent markup. The score text can be updated withthe <code>updateScore</code> method. The <code>won</code> method will be used by thecontroller object to determine when the game is over, so the playercan move on to the next level.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p77c7622b4009788c" name="p77c7622b4009788c"> ¶ </a>If we want to actually see the playing field and the score, we willhave to insert them into the document somehow. That is what the<code>place</code> method is for. We'll also add a <code>remove</code> method to make iteasy to remove a field when we are done with it.</p><pre class="code"><span class="variable">SokobanField</span>.<span class="property">place</span>=<span class="keyword">function</span>(<span class="variabledef">where</span>){<span class="localvariable">where</span>.<span class="property">appendChild</span>(<span class="localvariable">this</span>.<span class="property">score</span>);<span class="localvariable">where</span>.<span class="property">appendChild</span>(<span class="localvariable">this</span>.<span class="property">table</span>);};<span class="variable">SokobanField</span>.<span class="property">remove</span>=<span class="keyword">function</span>(){<span class="variable">removeElement</span>(<span class="localvariable">this</span>.<span class="property">score</span>);<span class="variable">removeElement</span>(<span class="localvariable">this</span>.<span class="property">table</span>);};<span class="variable">testField</span>.<span class="property">place</span>(<span class="variable">document</span>.<span class="property">body</span>);</pre><p><a class="paragraph" href="#p5487ca31a17d9d6f" name="p5487ca31a17d9d6f"> ¶ </a>If all went well, you should see a Sokoban field now.</p></div><hr/><div class="block"><a name="exercise3"></a><div class="exercisenum">Ex. 13.3</div><div class="exercise"><p><a class="paragraph" href="#p748eef9d06aedd00" name="p748eef9d06aedd00"> ¶ </a>But this field doesn't do very much yet. Add a method called <code>move</code>.It takes a <code>Point</code> object specifying the move as argument (for example<code>-1,0</code> to move left), and takes care of moving the game elements inthe correct way.</p><p><a class="paragraph" href="#p3d38e80ddde25283" name="p3d38e80ddde25283"> ¶ </a>The correct way is this: The <code>playerPos</code> property can be used todetermine where the player is trying to move. If there is a boulderhere, look at the square behind this boulder. When there is an exitthere, remove the boulder and update the score. When there is emptyspace there, move the boulder into it. Next, try to move the player.If the square he is trying to move into is not empty, ignore the move.</p></div><div class="solution"><pre class="code"><span class="variable">SokobanField</span>.<span class="property">move</span>=<span class="keyword">function</span>(<span class="variabledef">direction</span>){<span class="keyword">var</span><span class="variabledef">playerSquare</span>=<span class="localvariable">this</span>.<span class="property">getSquare</span>(<span class="localvariable">this</span>.<span class="property">playerPos</span>);<span class="keyword">var</span><span class="variabledef">targetPos</span>=<span class="localvariable">this</span>.<span class="property">playerPos</span>.<span class="property">add</span>(<span class="localvariable">direction</span>);<span class="keyword">var</span><span class="variabledef">targetSquare</span>=<span class="localvariable">this</span>.<span class="property">getSquare</span>(<span class="localvariable">targetPos</span>);<span class="comment">// Possibly pushing a boulder</span><span class="keyword">if</span> (<span class="localvariable">targetSquare</span>.<span class="property">hasBoulder</span>()){<span class="keyword">var</span><span class="variabledef">pushTarget</span>=<span class="localvariable">this</span>.<span class="property">getSquare</span>(<span class="localvariable">targetPos</span>.<span class="property">add</span>(<span class="localvariable">direction</span>));<span class="keyword">if</span> (<span class="localvariable">pushTarget</span>.<span class="property">isEmpty</span>()){<span class="localvariable">targetSquare</span>.<span class="property">moveContent</span>(<span class="localvariable">pushTarget</span>);}<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">pushTarget</span>.<span class="property">isExit</span>()){<span class="localvariable">targetSquare</span>.<span class="property">moveContent</span>(<span class="localvariable">pushTarget</span>);<span class="localvariable">pushTarget</span>.<span class="property">clearContent</span>();<span class="localvariable">this</span>.<span class="property">bouldersToGo</span>--;<span class="localvariable">this</span>.<span class="property">updateScore</span>();}}<span class="comment">// Moving the player</span><span class="keyword">if</span> (<span class="localvariable">targetSquare</span>.<span class="property">isEmpty</span>()){<span class="localvariable">playerSquare</span>.<span class="property">moveContent</span>(<span class="localvariable">targetSquare</span>);<span class="localvariable">this</span>.<span class="property">playerPos</span>=<span class="localvariable">targetPos</span>;}};</pre><p><a class="paragraph" href="#p538b98bc3fc959ad" name="p538b98bc3fc959ad"> ¶ </a>By taking care of boulders first, the move code can work the same waywhen the player is moving normally and when he is pushing a boulder.Note how the square behind the boulder is found by adding the<code>direction</code> to the <code>playerPos</code> twice. Test it by moving left twosquares:</p><pre class="code"><span class="variable">testField</span>.<span class="property">move</span>(<span class="keyword">new</span><span class="variable">Point</span>(-<span class="atom">1</span>, <span class="atom">0</span>));<span class="variable">testField</span>.<span class="property">move</span>(<span class="keyword">new</span><span class="variable">Point</span>(-<span class="atom">1</span>, <span class="atom">0</span>));</pre><p><a class="paragraph" href="#p3c642348ee437a1c" name="p3c642348ee437a1c"> ¶ </a>If that worked, we moved a boulder into a place from which we can'tget it out anymore, so we'd better throw this field away.</p><pre class="code"><span class="variable">testField</span>.<span class="property">remove</span>();</pre></div></div><hr/><div class="block"><p><a class="paragraph" href="#p5b308c76a573480" name="p5b308c76a573480"> ¶ </a>All the 'game logic' has been taken care of now, and we just need acontroller to make it playable. The controller will be an object typecalled <code>SokobanGame</code>, which is responsible for the following things:</p><ul><li>Preparing a place where the game field can be placed.</li><li>Building and removing <code>SokobanField</code> objects.</li><li>Capturing key events and calling the <code>move</code> method on current field with the correct argument.</li><li>Keeping track of the current level number and moving to the next level when a level is won.</li><li>Adding buttons to reset the current level or the whole game (back to level 0).</li></ul><p><a class="paragraph" href="#p45ad3b18e78810ca" name="p45ad3b18e78810ca"> ¶ </a>We start again with an unfinished prototype.</p><pre class="code"><span class="keyword">var</span><span class="variable">SokobanGame</span>={<span class="property">construct</span>: <span class="keyword">function</span>(<span class="variabledef">place</span>){<span class="localvariable">this</span>.<span class="property">level</span>=<span class="atom">null</span>;<span class="localvariable">this</span>.<span class="property">field</span>=<span class="atom">null</span>;<span class="keyword">var</span><span class="variabledef">newGame</span>=<span class="variable">dom</span>(<span class="string">&quot;BUTTON&quot;</span>, <span class="atom">null</span>, <span class="string">&quot;New game&quot;</span>);<span class="variable">addHandler</span>(<span class="localvariable">newGame</span>, <span class="string">&quot;click&quot;</span>, <span class="variable">method</span>(<span class="localvariable">this</span>, <span class="string">&quot;newGame&quot;</span>));<span class="keyword">var</span><span class="variabledef">reset</span>=<span class="variable">dom</span>(<span class="string">&quot;BUTTON&quot;</span>, <span class="atom">null</span>, <span class="string">&quot;Reset level&quot;</span>);<span class="variable">addHandler</span>(<span class="localvariable">reset</span>, <span class="string">&quot;click&quot;</span>, <span class="variable">method</span>(<span class="localvariable">this</span>, <span class="string">&quot;reset&quot;</span>));<span class="localvariable">this</span>.<span class="property">container</span>=<span class="variable">dom</span>(<span class="string">&quot;DIV&quot;</span>, <span class="atom">null</span>, <span class="variable">dom</span>(<span class="string">&quot;H1&quot;</span>, <span class="atom">null</span>, <span class="string">&quot;Sokoban&quot;</span>), <span class="variable">dom</span>(<span class="string">&quot;DIV&quot;</span>, <span class="atom">null</span>, <span class="localvariable">newGame</span>, <span class="string">&quot;&quot;</span>, <span class="localvariable">reset</span>));<span class="localvariable">place</span>.<span class="property">appendChild</span>(<span class="localvariable">this</span>.<span class="property">container</span>);<span class="variable">addHandler</span>(<span class="variable">document</span>, <span class="string">&quot;keydown&quot;</span>, <span class="variable">method</span>(<span class="localvariable">this</span>, <span class="string">&quot;keyDown&quot;</span>));<span class="localvariable">this</span>.<span class="property">newGame</span>();}, <span class="property">newGame</span>: <span class="keyword">function</span>(){<span class="localvariable">this</span>.<span class="property">level</span>=<span class="atom">0</span>;<span class="localvariable">this</span>.<span class="property">reset</span>();}, <span class="property">reset</span>: <span class="keyword">function</span>(){<span class="keyword">if</span> (<span class="localvariable">this</span>.<span class="property">field</span>) <span class="localvariable">this</span>.<span class="property">field</span>.<span class="property">remove</span>();<span class="localvariable">this</span>.<span class="property">field</span>=<span class="variable">SokobanField</span>.<span class="property">create</span>(<span class="variable">sokobanLevels</span>[<span class="localvariable">this</span>.<span class="property">level</span>]);<span class="localvariable">this</span>.<span class="property">field</span>.<span class="property">place</span>(<span class="localvariable">this</span>.<span class="property">container</span>);}, <span class="property">keyDown</span>: <span class="keyword">function</span>(<span class="variabledef">event</span>){<span class="comment">// To be filled in</span>}};</pre><p><a class="paragraph" href="#p35d377ee1e3f49a8" name="p35d377ee1e3f49a8"> ¶ </a>The constructor builds a <code>div</code> element to hold the field, along withtwo buttons and a title. Note how <code>method</code> is used to attach methodson the <code>this</code> object to events.</p><p><a class="paragraph" href="#p42d09a84b15ae999" name="p42d09a84b15ae999"> ¶ </a>We can put a Sokoban game into our document like this:</p><pre class="code"><span class="keyword">var</span><span class="variable">sokoban</span>=<span class="variable">SokobanGame</span>.<span class="property">create</span>(<span class="variable">document</span>.<span class="property">body</span>);</pre></div><hr/><div class="block"><a name="exercise4"></a><div class="exercisenum">Ex. 13.4</div><div class="exercise"><p><a class="paragraph" href="#p53a2f6f5fc9bf0e8" name="p53a2f6f5fc9bf0e8"> ¶ </a>All that is left to do now is filling in the key event handler.Replace the <code>keyDown</code> method of the prototype with one that detectspresses of the arrow keys and, when it finds them, moves the player inthe correct direction. The following <code>Dictionary</code> will probably comein handy:</p><pre class="code"><span class="keyword">var</span><span class="variable">arrowKeyCodes</span>=<span class="keyword">new</span><span class="variable">Dictionary</span>({<span class="atom">37</span>: <span class="keyword">new</span><span class="variable">Point</span>(-<span class="atom">1</span>, <span class="atom">0</span>), <span class="comment">// left</span><span class="atom">38</span>: <span class="keyword">new</span><span class="variable">Point</span>(<span class="atom">0</span>, -<span class="atom">1</span>), <span class="comment">// up</span><span class="atom">39</span>: <span class="keyword">new</span><span class="variable">Point</span>(<span class="atom">1</span>, <span class="atom">0</span>), <span class="comment">// right</span><span class="atom">40</span>: <span class="keyword">new</span><span class="variable">Point</span>(<span class="atom">0</span>, <span class="atom">1</span>) <span class="comment">// down</span>});</pre><p><a class="paragraph" href="#pcb1472f81f00f3b" name="pcb1472f81f00f3b"> ¶ </a>After an arrow key has been handled, check <code>this.field.won()</code> to findout if that was the winning move. If the player won, use <code>alert</code> toshow a message, and go to the next level. If there is no next level(check <code>sokobanLevels.length</code>), restart the game instead.</p><p><a class="paragraph" href="#p3d967959c7cdf6ce" name="p3d967959c7cdf6ce"> ¶ </a>It is probably wise to stop the events for key presses after handlingthem, otherwise pressing arrow-up and arrow-down will scroll yourwindow, which is rather annoying.</p></div><div class="solution"><pre class="code"><span class="variable">SokobanGame</span>.<span class="property">keyDown</span>=<span class="keyword">function</span>(<span class="variabledef">event</span>){<span class="keyword">if</span> (<span class="variable">arrowKeyCodes</span>.<span class="property">contains</span>(<span class="localvariable">event</span>.<span class="property">keyCode</span>)){<span class="localvariable">event</span>.<span class="property">stop</span>();<span class="localvariable">this</span>.<span class="property">field</span>.<span class="property">move</span>(<span class="variable">arrowKeyCodes</span>.<span class="property">lookup</span>(<span class="localvariable">event</span>.<span class="property">keyCode</span>));<span class="keyword">if</span> (<span class="localvariable">this</span>.<span class="property">field</span>.<span class="property">won</span>()){<span class="keyword">if</span> (<span class="localvariable">this</span>.<span class="property">level</span> &lt;<span class="variable">sokobanLevels</span>.<span class="property">length</span> - <span class="atom">1</span>){<span class="variable">alert</span>(<span class="string">&quot;Excellent! Going to the next level.&quot;</span>);<span class="localvariable">this</span>.<span class="property">level</span>++;<span class="localvariable">this</span>.<span class="property">reset</span>();}<span class="keyword">else</span>{<span class="variable">alert</span>(<span class="string">&quot;You win! Game over.&quot;</span>);<span class="localvariable">this</span>.<span class="property">newGame</span>();}}}};</pre><p><a class="paragraph" href="#p1b830e985c329e93" name="p1b830e985c329e93"> ¶ </a>It has to be noted that capturing keys like this ― adding a handlerto the <code>document</code> and stopping the events that you are looking for ―is not very nice when there are other elements in the document. Forexample, try moving the cursor around in the text field at the top ofthe document. ― It won't work, you'll only move the little man in theSokoban game. If a game like this were to be used in a real site, itis probably best to put it in a frame or window of its own, so that itonly grabs events aimed at its own window.</p></div></div><hr/><div class="block"><a name="exercise5"></a><div class="exercisenum">Ex. 13.5</div><div class="exercise"><p><a class="paragraph" href="#p239cf757b63a655d" name="p239cf757b63a655d"> ¶ </a>When brought to the exit, the boulders vanish rather abruptly. Bymodifying the <code>Square.clearContent</code> method, try to show a 'falling'animation for boulders that are about to be removed. Make them growsmaller for a moment before, and then disappear. You can use<code>style.width=&quot;50%&quot;</code>, and similarly for <code>style.height</code>, to make animage appear, for example, half as big as it usually is.</p></div><div class="solution"><p><a class="paragraph" href="#p59c8b255e3854cba" name="p59c8b255e3854cba"> ¶ </a>We can use <code>setInterval</code> to handle the timing of the animation. Notethat the method makes sure to clear the interval after it is done. Ifyou don't do that, it will continue wasting your computer's time untilthe page is closed.</p><pre class="code"><span class="variable">Square</span>.<span class="property">clearContent</span>=<span class="keyword">function</span>(){<span class="variable">self</span>.<span class="property">content</span>=<span class="atom">null</span>;<span class="keyword">var</span><span class="variabledef">image</span>=<span class="localvariable">this</span>.<span class="property">tableCell</span>.<span class="property">lastChild</span>;<span class="keyword">var</span><span class="variabledef">size</span>=<span class="atom">100</span>;<span class="keyword">var</span><span class="variabledef">animate</span>=<span class="variable">setInterval</span>(<span class="keyword">function</span>(){<span class="localvariable">size</span> -=<span class="atom">10</span>;<span class="localvariable">image</span>.<span class="property">style</span>.<span class="property">width</span>=<span class="localvariable">size</span> + <span class="string">&quot;%&quot;</span>;<span class="localvariable">image</span>.<span class="property">style</span>.<span class="property">height</span>=<span class="localvariable">size</span> + <span class="string">&quot;%&quot;</span>;<span class="keyword">if</span> (<span class="localvariable">size</span> &lt;<span class="atom">60</span>){<span class="variable">clearInterval</span>(<span class="localvariable">animate</span>);<span class="variable">removeElement</span>(<span class="localvariable">image</span>);}}, <span class="atom">70</span>);};</pre><p><a class="paragraph" href="#p2883f0d262b85871" name="p2883f0d262b85871"> ¶ </a>Now, if you have a few hours to waste, try finishing all levels.</p></div></div><hr/><div class="block"><p><a class="paragraph" href="#p6f93696fe70dfa4e" name="p6f93696fe70dfa4e"> ¶ </a><a name="key59"></a><a name="key60"></a>Other event types that can be useful are<a name="key61"></a><code>focus</code> and <a name="key62"></a><code>blur</code>, which are fired on elements that can be'focused', such as form inputs. <code>focus</code>, obviously, happens when youput the focus on the element, for example by clicking on it. <code>blur</code> isJavaScript-speak for 'unfocus', and is fired when the focus leaves theelement.</p><pre class="code"><span class="variable">addHandler</span>(<span class="variable">$</span>(<span class="string">&quot;textfield&quot;</span>), <span class="string">&quot;focus&quot;</span>, <span class="keyword">function</span>(<span class="variabledef">event</span>){<span class="localvariable">event</span>.<span class="property">target</span>.<span class="property">style</span>.<span class="property">backgroundColor</span>=<span class="string">&quot;yellow&quot;</span>;});<span class="variable">addHandler</span>(<span class="variable">$</span>(<span class="string">&quot;textfield&quot;</span>), <span class="string">&quot;blur&quot;</span>, <span class="keyword">function</span>(<span class="variabledef">event</span>){<span class="localvariable">event</span>.<span class="property">target</span>.<span class="property">style</span>.<span class="property">backgroundColor</span>=<span class="string">&quot;&quot;</span>;});</pre><p><a class="paragraph" href="#p118c69cf1c7aa223" name="p118c69cf1c7aa223"> ¶ </a><a name="key63"></a>Another event related to form inputs is <a name="key64"></a><code>change</code>. Thisis fired when the content of the input has changed... except that forsome inputs, such as text inputs, it does not fire until the elementis unfocused.</p><pre class="code"><span class="variable">addHandler</span>(<span class="variable">$</span>(<span class="string">&quot;textfield&quot;</span>), <span class="string">&quot;change&quot;</span>, <span class="keyword">function</span>(<span class="variabledef">event</span>){<span class="variable">print</span>(<span class="string">&quot;Content of text field changed to '&quot;</span>, <span class="localvariable">event</span>.<span class="property">target</span>.<span class="property">value</span>, <span class="string">&quot;'.&quot;</span>);});</pre><p><a class="paragraph" href="#p7db698c4342d25e3" name="p7db698c4342d25e3"> ¶ </a>You can type all you want, the event will only fire when you clickoutside of the input, press tab, or unfocus it in some other way.</p><p><a class="paragraph" href="#p61e8f958414e8cfc" name="p61e8f958414e8cfc"> ¶ </a><a name="key65"></a>Forms also have a <a name="key66"></a><code>submit</code> event, which is fired whenthey submit. It can be stopped to prevent the submit from takingplace. This gives us a <em>much</em> better way to do the form validation wesaw in the previous chapter. You just register a <code>submit</code> handler,which stops the event when the content of the form is not valid. Thatway, when the user does not have JavaScript enabled, the form willstill work, it just won't have instant validation.</p><p><a class="paragraph" href="#p1337214030928c91" name="p1337214030928c91"> ¶ </a><a name="key67"></a><a name="key68"></a>Window objects have a <a name="key69"></a><code>load</code> event that fireswhen the document is fully loaded, which can be useful if your scriptneeds to do some kind of initialisation that has to wait until thewhole document is present. For example, the scripts on the pages forthis book go over the current chapter to hide solutions to exercises.You can't do that when the exercises are not loaded yet. There is alsoan <a name="key70"></a><code>unload</code> event, firing when the user leaves the document, butthis is not properly supported by all browsers.</p><p><a class="paragraph" href="#p62706f6f952b7d27" name="p62706f6f952b7d27"> ¶ </a><a name="key71"></a>Most of the time it is best to leave the laying out of adocument to the browser, but there are effects that can only beproduced by having a piece of JavaScript set the exact sizes of somenodes in a document. When you do this, make sure you also listen for<a name="key72"></a><code>resize</code> events on the window, and re-calculate the sizes of yourelement every time the window is resized.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p1576d7eeb23c322" name="p1576d7eeb23c322"> ¶ </a>Finally, I have to tell you something about event handlers that youwould rather not know. The Internet Explorer browser (which means, atthe time of writing, the browser used by a majority of web-surfers)has a bug that causes values to not be cleaned up as normal: Even whenthey are no longer used, they stay in the machine's memory. This isknown as a <a name="key73"></a>memory leak, and, once enough memory has been leaked,will seriously slow down a computer.</p><p><a class="paragraph" href="#p22f24bf084d74d4e" name="p22f24bf084d74d4e"> ¶ </a>When does this leaking occur? Due to a deficiency in InternetExplorer's <a name="key74"></a>garbage collector, the system whose purpose it is toreclaim unused values, when you have a DOM node that, through one ofits properties or in a more indirect way, refers to a normalJavaScript object, and this object, in turn, refers back to that DOMnode, both objects will not be collected. This has something to dowith the fact that DOM nodes and other JavaScript objects arecollected by different systems ― the system that cleans up DOM nodeswill take care to leave any nodes that are still referenced byJavaScript objects, and vice versa for the system that collects normalJavaScript values.</p><p><a class="paragraph" href="#p560d289a24cd2757" name="p560d289a24cd2757"> ¶ </a>As the above description shows, the problem is not specificallyrelated to event handlers. This code, for example, creates a bit ofun-collectable memory:</p><pre class="code invalid"><span class="keyword">var</span><span class="variable">jsObject</span>={<span class="property">link</span>: <span class="variable">document</span>.<span class="property">body</span>};<span class="variable">document</span>.<span class="property">body</span>.<span class="property">linkBack</span>=<span class="variable">jsObject</span>;</pre><p><a class="paragraph" href="#p3dd3e899a4484a02" name="p3dd3e899a4484a02"> ¶ </a>Even after such an Internet Explorer browser goes to a different page,it will still hold on to the <code>document.body</code> shown here. The reasonthis bug is often associated with event handlers is that it isextremely easy to make such circular links when registering a handler.The DOM node keeps references to its handlers, and the handler, mostof the time, has a reference to the DOM node. Even when this referenceis not intentionally made, JavaScript's scoping rules tend to add itimplicitly. Consider this function:</p><pre class="code invalid"><span class="keyword">function</span><span class="variable">addAlerter</span>(<span class="variabledef">element</span>){<span class="variable">addHandler</span>(<span class="localvariable">element</span>, <span class="string">&quot;click&quot;</span>, <span class="keyword">function</span>(){<span class="variable">alert</span>(<span class="string">&quot;Alert! ALERT!&quot;</span>);});}</pre><p><a class="paragraph" href="#p3b0788945ca0cdd9" name="p3b0788945ca0cdd9"> ¶ </a>The anonymous function that is created by the <code>addAlerter</code> functioncan 'see' the <code>element</code> variable. It doesn't use it, but that does notmatter ― just because it can see it, it will have a reference to it.By registering this function as an event handler on that same<code>element</code> object, we have created a circle.</p><p><a class="paragraph" href="#p274f002fddd7971a" name="p274f002fddd7971a"> ¶ </a>There are three ways to deal with this problem. The first approach, avery popular one, is to ignore it. Most scripts will only leak alittle bit, so it takes a long time and a lot of pages before theproblems become noticeable. And, when the problems are so subtle,who's going to hold <em>you</em> responsible? Programmers given to thisapproach will often searingly denounce Microsoft for their shoddyprogramming, and state that the problem is not their fault, so <em>they</em>shouldn't be fixing it.</p><p><a class="paragraph" href="#p425aad248cff4045" name="p425aad248cff4045"> ¶ </a>Such reasoning is not entirely without merit, of course. But when halfyour users are having problems with the web-pages you make, it is hardto deny that there is a practical problem. Which is why people workingon 'serious' sites usually make an attempt not to leak any memory.Which brings us to the second approach: Painstakingly making sure thatno circular references between DOM objects and regular objects arecreated. This means, for example, rewriting the above handler likethis:</p><pre class="code"><span class="keyword">function</span><span class="variable">addAlerter</span>(<span class="variabledef">element</span>){<span class="variable">addHandler</span>(<span class="localvariable">element</span>, <span class="string">&quot;click&quot;</span>, <span class="keyword">function</span>(){<span class="variable">alert</span>(<span class="string">&quot;Alert! ALERT!&quot;</span>);});<span class="localvariable">element</span>=<span class="atom">null</span>;}</pre><p><a class="paragraph" href="#p9dd7c644334aca3" name="p9dd7c644334aca3"> ¶ </a>Now the <code>element</code> variable no longer points at the DOM node, and thehandler will not leak. This approach is viable, but requires theprogrammer to <em>really</em> pay attention.</p><p><a class="paragraph" href="#p1f42dbaeb6e8d65b" name="p1f42dbaeb6e8d65b"> ¶ </a>The third solution, finally, is to not worry too much about creatingleaky structures, but to make sure to clean them up when you are donewith them. This means unregistering any event handlers when they areno longer needed, and registering an <code>onunload</code> event to unregisterthe handlers that are needed until the page is unloaded. It ispossible to extend an event-registering system, like our <code>addHandler</code>function, to automatically do this. When taking this approach, youmust keep in mind that event handlers are not the only possible sourceof memory leaks ― adding properties to DOM node objects can causesimilar problems.</p></div><h1><span class="number">Chapter 14: </span>HTTP requests</h1><div class="block"><p><a class="paragraph" href="#p743a85de1fe93747" name="p743a85de1fe93747"> ¶ </a>As mentioned in <a href="chapter11.html">chapter 11</a>, communication on the World Wide Web happensover the <a name="key1"></a>HTTP protocol. A simple <a name="key2"></a>request might looklike this:</p><pre class="preformatted">GET /files/fruit.txt HTTP/1.1Host: eloquentjavascript.netUser-Agent: The Imaginary Browser</pre><p><a class="paragraph" href="#p3ea737b5aacb10f" name="p3ea737b5aacb10f"> ¶ </a>Which asks for the file <code>files/fruit.txt</code> from the server at<code>eloquentjavascript.net</code>. In addition, it specifies that this requestuses version 1.1 of the HTTP protocol ― version 1.0 is also still inuse, and works slightly differently. The <code>Host</code> and <code>User-Agent</code> linesfollow a pattern: They start with a word that identifies theinformation they contain, followed by a colon and the actualinformation. These are called '<a name="key3"></a>headers'. The <code>User-Agent</code> headertells the server which browser (or other kind of program) is beingused to make the request. Other kinds of headers are often sent along,for example to state the types of documents that the client canunderstand, or the language that it prefers.</p><p><a class="paragraph" href="#p1b275f378f382ad8" name="p1b275f378f382ad8"> ¶ </a>When given the above request, the server might send the following<a name="key4"></a>response:</p><pre class="preformatted">HTTP/1.1 200 OKLast-Modified: Mon, 23 Jul 2007 08:41:56 GMTContent-Length: 24Content-Type: text/plainapples, oranges, bananas</pre><p><a class="paragraph" href="#p13683b7c6cac54c" name="p13683b7c6cac54c"> ¶ </a>The first line indicates again the version of the HTTP protocol,followed by the status of the request. In this case the status code is<code>200</code>, meaning 'OK, nothing out of the ordinary happened, I am sendingyou the file'. This is followed by a few headers, indicating (in thiscase) the last time the file was modified, its length, and its type(plain text). After the headers you get a blank line, followed by thefile itself.</p><p><a class="paragraph" href="#p2417c911b4676d0d" name="p2417c911b4676d0d"> ¶ </a>Apart from requests starting with <code>GET</code>, which indicates the clientjust wants to fetch a document, the word <code>POST</code> can also be used toindicate some information will be sent along with the request, whichthe server is expected to process in some way.<a class="footref" href="#footnote1">1</a></p></div><hr/><div class="block"><p><a class="paragraph" href="#p314f77f0ec94eb7a" name="p314f77f0ec94eb7a"> ¶ </a>When you click a link, submit a form, or in some other way encourageyour browser to go to a new page, it will do an HTTP request andimmediately unload the old page to show the newly loaded document. Intypical situations, this is just what you want ― it is how the webtraditionally works. Sometimes, however, a JavaScript program wants tocommunicate with the server without re-loading the page. The 'Load'button in the console, for example, can load files without leaving thepage.</p><p><a class="paragraph" href="#p2963d0bd02e1e35d" name="p2963d0bd02e1e35d"> ¶ </a>To be able to do things like that, the JavaScript program must makethe HTTP request itself. Contemporary browsers provide an interfacefor this. As with opening new windows, this interface is subject tosome restrictions. To prevent a script from doing anything scary, itis only allowed to make HTTP requests to the domain that the currentpage came from.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p6c40c04f1a4e9c8e" name="p6c40c04f1a4e9c8e"> ¶ </a><a name="key5"></a>An object used to make an HTTP request can, on mostbrowsers, be created by doing <code>new XMLHttpRequest()</code>. Older versionsof Internet Explorer, which originally invented these objects, requireyou to do <code>new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;)</code> or, on even olderversions, <code>new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;)</code>. <a name="key6"></a><code>ActiveXObject</code>is Internet Explorer's interface to various kinds of browser add-ons.We are already used to writing incompatibility-wrappers by now, so letus do so again:</p><pre class="code"><span class="keyword">function</span><span class="variable">makeHttpObject</span>(){<span class="keyword">try</span>{<span class="keyword">return</span><span class="keyword">new</span><span class="variable">XMLHttpRequest</span>();}<span class="keyword">catch</span> (<span class="variabledef">error</span>){}<span class="keyword">try</span>{<span class="keyword">return</span><span class="keyword">new</span><span class="variable">ActiveXObject</span>(<span class="string">&quot;Msxml2.XMLHTTP&quot;</span>);}<span class="keyword">catch</span> (<span class="variabledef">error</span>){}<span class="keyword">try</span>{<span class="keyword">return</span><span class="keyword">new</span><span class="variable">ActiveXObject</span>(<span class="string">&quot;Microsoft.XMLHTTP&quot;</span>);}<span class="keyword">catch</span> (<span class="variabledef">error</span>){}<span class="keyword">throw</span><span class="keyword">new</span><span class="variable">Error</span>(<span class="string">&quot;Could not create HTTP request object.&quot;</span>);}<span class="variable">show</span>(typeof(<span class="variable">makeHttpObject</span>()));</pre><p><a class="paragraph" href="#p47399bf3cf9b1d8a" name="p47399bf3cf9b1d8a"> ¶ </a>The wrapper tries to create the object in all three ways, using <code>try</code>and <code>catch</code> to detect which ones fail. If none of the ways work, whichmight be the case on older browsers or browsers with strict securitysettings, it raises an error.</p><p><a class="paragraph" href="#p1cf32e97597c0e1" name="p1cf32e97597c0e1"> ¶ </a>Now why is this object called an <em>XML</em> HTTP request? This is a bit ofa misleading name. <a name="key7"></a>XML is a way to store textual data. It uses tagsand attributes like HTML, but is more structured and flexible ― tostore your own kinds of data, you may define your own types of XMLtags. These HTTP request objects have some built-in functionality fordealing with retrieved XML documents, which is why they have XML intheir name. They can also handle other types of documents, though, andin my experience they are used just as often for non-XML requests.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p349618433b643891" name="p349618433b643891"> ¶ </a>Now that we have our HTTP object, we can use it to make a requestsimilar the example shown above.</p><pre class="code"><span class="keyword">var</span><span class="variable">request</span>=<span class="variable">makeHttpObject</span>();<span class="variable">request</span>.<span class="property">open</span>(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;files/fruit.txt&quot;</span>, <span class="atom">false</span>);<span class="variable">request</span>.<span class="property">send</span>(<span class="atom">null</span>);<span class="variable">print</span>(<span class="variable">request</span>.<span class="property">responseText</span>);</pre><p><a class="paragraph" href="#p568fd5163d41f6f7" name="p568fd5163d41f6f7"> ¶ </a>The <a name="key8"></a><code>open</code> method is used to configure a request. In this case wechoose to make a <code>GET</code> request for our <code>fruit.txt</code> file. The <a name="key9"></a>URLgiven here is relative, it does not contain the <code>http://</code> part or aserver name, which means it will look for the file on the server thatthe current document came from. The third parameter, <code>false</code>, will bediscussed in a moment. After <code>open</code> has been called, the actualrequest can be made with the <a name="key10"></a><code>send</code> method. When the request is a<code>POST</code> request, the data to be sent to the server (as a string) can bepassed to this method. For <code>GET</code> requests, one should just pass<code>null</code>.</p><p><a class="paragraph" href="#p17b3563d8f0ae54f" name="p17b3563d8f0ae54f"> ¶ </a>After the request has been made, the <a name="key11"></a><code>responseText</code> property of therequest object contains the content of the retrieved document. Theheaders that the server sent back can be inspected with the<a name="key12"></a><code>getResponseHeader</code> and <a name="key13"></a><code>getAllResponseHeaders</code> functions. Thefirst looks up a specific header, the second gives us a stringcontaining all the headers. These can occasionally be useful to getsome extra information about the document.</p><pre class="code"><span class="variable">print</span>(<span class="variable">request</span>.<span class="property">getAllResponseHeaders</span>());<span class="variable">show</span>(<span class="variable">request</span>.<span class="property">getResponseHeader</span>(<span class="string">&quot;Last-Modified&quot;</span>));</pre><p><a class="paragraph" href="#p26d4d4b30a20b42e" name="p26d4d4b30a20b42e"> ¶ </a>If, for some reason, you want to add headers to the request that issent to the server, you can do so with the <a name="key14"></a><code>setRequestHeader</code>method. This takes two strings as arguments, the name and the value ofthe header.</p><p><a class="paragraph" href="#p38a8852f3e0dac14" name="p38a8852f3e0dac14"> ¶ </a>The response code, which was <code>200</code> in the example, can be found underthe <a name="key15"></a><code>status</code> property. When something went wrong, this cryptic codewill indicate it. For example, <code>404</code> means the file you asked for didnot exist. The <a name="key16"></a><code>statusText</code> contains a slightly less crypticdescription of the status.</p><pre class="code"><span class="variable">show</span>(<span class="variable">request</span>.<span class="property">status</span>);<span class="variable">show</span>(<span class="variable">request</span>.<span class="property">statusText</span>);</pre><p><a class="paragraph" href="#p2224c3891b47d53e" name="p2224c3891b47d53e"> ¶ </a>When you want to check whether a request succeeded, comparing the<code>status</code> to <code>200</code> is usually enough. In theory, the server might insome situations return the code <code>304</code> to indicate that the olderversion of the document, which the browser has stored in its'<a name="key17"></a>cache', is still up to date. But it seems that browsers shield youfrom this by setting the <code>status</code> to <code>200</code> even when it is <code>304</code>.Also, if you are doing a request over a non-HTTP protocol<a class="footref" href="#footnote2">2</a>, such asFTP, the <code>status</code> will not be usable because the protocol does notuse HTTP status codes.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p499e386f31f6e47f" name="p499e386f31f6e47f"> ¶ </a>When a request is done as in the example above, the call to the <code>send</code>method does not return until the request is finished. This isconvenient, because it means the <code>responseText</code> is available after thecall to <code>send</code>, and we can start using it immediately. There is aproblem, though. When the server is slow, or the file is big, doing arequest might take quite a while. As long as this is happening, theprogram is waiting, which causes the whole browser to wait. Until theprogram finishes, the user can not do anything, not even scroll thepage. Pages that run on a local network, which is fast and reliable,might get away with doing requests like this. Pages on the big greatunreliable Internet, on the other hand, should not.</p><p><a class="paragraph" href="#p291f7223fcad270d" name="p291f7223fcad270d"> ¶ </a>When the third argument to <code>open</code> is <code>true</code>, the request is set to be'<a name="key18"></a>asynchronous'. This means that <code>send</code> will return right away, whilethe request happens in the background.</p><pre class="code"><span class="variable">request</span>.<span class="property">open</span>(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;files/fruit.xml&quot;</span>, <span class="atom">true</span>);<span class="variable">request</span>.<span class="property">send</span>(<span class="atom">null</span>);<span class="variable">show</span>(<span class="variable">request</span>.<span class="property">responseText</span>);</pre><p><a class="paragraph" href="#p6471230dbf8844b0" name="p6471230dbf8844b0"> ¶ </a>But wait a moment, and...</p><pre class="code"><span class="variable">print</span>(<span class="variable">request</span>.<span class="property">responseText</span>);</pre><p><a class="paragraph" href="#peae7ba1f220ae20" name="peae7ba1f220ae20"> ¶ </a>'Waiting a moment' could be implemented with <code>setTimeout</code> or somethinglike that, but there is a better way. A request object has a<a name="key19"></a><code>readyState</code> property, indicating the state it is in. This willbecome <code>4</code> when the document has been fully loaded, and have a smallervalue before that<a class="footref" href="#footnote3">3</a>. To react to changes in this status, you can setthe <a name="key20"></a><code>onreadystatechange</code> property of the object to a function. Thisfunction will be called every time the state changes.</p><pre class="code"><span class="variable">request</span>.<span class="property">open</span>(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;files/fruit.xml&quot;</span>, <span class="atom">true</span>);<span class="variable">request</span>.<span class="property">send</span>(<span class="atom">null</span>);<span class="variable">request</span>.<span class="property">onreadystatechange</span>=<span class="keyword">function</span>(){<span class="keyword">if</span> (<span class="variable">request</span>.<span class="property">readyState</span>==<span class="atom">4</span>) <span class="variable">show</span>(<span class="variable">request</span>.<span class="property">responseText</span>.<span class="property">length</span>);};</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p1ca7f490fba0e18a" name="p1ca7f490fba0e18a"> ¶ </a>When the file retrieved by the request object is an XML document, therequest's <a name="key21"></a><code>responseXML</code> property will hold a representation of thisdocument. This representation works like the DOM objects discussed in<a href="chapter12.html">chapter 12</a>, except that it doesn't have HTML-specific functionality, suchas <code>style</code> or <code>innerHTML</code>. <code>responseXML</code> gives us a document object,whose <code>documentElement</code> property refers to the outer tag of the XMLdocument.</p><pre class="code"><span class="keyword">var</span><span class="variable">catalog</span>=<span class="variable">request</span>.<span class="property">responseXML</span>.<span class="property">documentElement</span>;<span class="variable">show</span>(<span class="variable">catalog</span>.<span class="property">childNodes</span>.<span class="property">length</span>);</pre><p><a class="paragraph" href="#p1d65f6711ea2c673" name="p1d65f6711ea2c673"> ¶ </a>Such XML documents can be used to exchange structured information withthe server. Their form ― tags contained inside other tags ― is oftenvery suitable to store things that would be tricky to represent assimple flat text. The DOM interface is rather clumsy for extractinginformation though, and XML documents are notoriously wordy: The<code>fruit.xml</code> document looks like a lot, but all it says is 'apples arered, oranges are orange, and bananas are yellow'.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p1b952415eee0ffca" name="p1b952415eee0ffca"> ¶ </a><a name="key22"></a>As an alternative to XML, JavaScript programmers have come upwith something called <a href="http://www.json.org">JSON</a>. This uses thebasic notation of JavaScript values to represent 'hierarchical'information in a more minimalist way. A JSON document is a filecontaining a single JavaScript object or array, which in turn containsany number of other objects, arrays, strings, numbers, booleans, or<code>null</code> values. For an example, look at <code>fruit.json</code>:</p><pre class="code"><span class="variable">request</span>.<span class="property">open</span>(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;files/fruit.json&quot;</span>, <span class="atom">true</span>);<span class="variable">request</span>.<span class="property">send</span>(<span class="atom">null</span>);<span class="variable">request</span>.<span class="property">onreadystatechange</span>=<span class="keyword">function</span>(){<span class="keyword">if</span> (<span class="variable">request</span>.<span class="property">readyState</span>==<span class="atom">4</span>) <span class="variable">print</span>(<span class="variable">request</span>.<span class="property">responseText</span>);};</pre><p><a class="paragraph" href="#p3ce2b18ba499c2f7" name="p3ce2b18ba499c2f7"> ¶ </a>Such a piece of text can be converted to a normal JavaScript value byusing the <a name="key23"></a><code>eval</code> function. Parentheses should be added around itbefore calling <code>eval</code>, because otherwise JavaScript might interpret anobject (enclosed by braces) as a block of code, and produce an error.</p><pre class="code"><span class="keyword">function</span><span class="variable">evalJSON</span>(<span class="variabledef">json</span>){<span class="keyword">return</span><span class="variable">eval</span>(<span class="string">&quot;(&quot;</span> + <span class="localvariable">json</span> + <span class="string">&quot;)&quot;</span>);}<span class="keyword">var</span><span class="variable">fruit</span>=<span class="variable">evalJSON</span>(<span class="variable">request</span>.<span class="property">responseText</span>);<span class="variable">show</span>(<span class="variable">fruit</span>);</pre><p><a class="paragraph" href="#p7df8d1d76c10288e" name="p7df8d1d76c10288e"> ¶ </a>When running <code>eval</code> on a piece of text, you have to keep in mind thatthis means you let the piece of text run whichever code it wants.Since JavaScript only allows us to make requests to our own domain,you will usually know exactly what kind of text you are getting, andthis is not a problem. In other situations, it might be unsafe.</p></div><hr/><div class="block"><a name="exercise1"></a><div class="exercisenum">Ex. 14.1</div><div class="exercise"><p><a class="paragraph" href="#p61a3f689edac52d6" name="p61a3f689edac52d6"> ¶ </a>Write a function called <code>serializeJSON</code> which, when given a JavaScriptvalue, produces a string with the value's JSON representation. Simplevalues like numbers and booleans can be simply given to the <code>String</code>function to convert them to a string. Objects and arrays can behandled by recursion.</p><p><a class="paragraph" href="#p509523e8ecb763b7" name="p509523e8ecb763b7"> ¶ </a>Recognizing arrays can be tricky, since its type is <code>&quot;object&quot;</code>. Youcan use <code>instanceof Array</code>, but that only works for arrays that werecreated in your own window ― others will use the <code>Array</code> prototypefrom other windows, and <code>instanceof</code> will return <code>false</code>. A cheaptrick is to convert the <code>constructor</code> property to a string, and seewhether that contains <code>&quot;function Array&quot;</code>.</p><p><a class="paragraph" href="#p416d7e20add6f798" name="p416d7e20add6f798"> ¶ </a>When converting a string, you have to take care to escape specialcharacters inside it. If you use double-quotes around the string, thecharacters to escape are <code>\&quot;</code>, <code>\\</code>, <code>\f</code>, <code>\b</code>, <code>\n</code>, <code>\t</code>, <code>\r</code>, and<code>\v</code><a class="footref" href="#footnote4">4</a>.</p></div><div class="solution"><pre class="code"><span class="keyword">function</span><span class="variable">serializeJSON</span>(<span class="variabledef">value</span>){<span class="keyword">function</span><span class="variabledef">isArray</span>(<span class="variabledef">value</span>){<span class="keyword">return</span><span class="string">/^\s*function Array/</span>.<span class="property">test</span>(<span class="variable">String</span>(<span class="localvariable">value</span>.<span class="property">constructor</span>));}<span class="keyword">function</span><span class="variabledef">serializeArray</span>(<span class="variabledef">value</span>){<span class="keyword">return</span><span class="string">&quot;[&quot;</span> + <span class="variable">map</span>(<span class="variable">serializeJSON</span>, <span class="localvariable">value</span>).<span class="property">join</span>(<span class="string">&quot;, &quot;</span>) + <span class="string">&quot;]&quot;</span>;}<span class="keyword">function</span><span class="variabledef">serializeObject</span>(<span class="variabledef">value</span>){<span class="keyword">var</span><span class="variabledef">properties</span>=[];<span class="variable">forEachIn</span>(<span class="localvariable">value</span>, <span class="keyword">function</span>(<span class="variabledef">name</span>, <span class="variabledef">value</span>){<span class="localvariable">properties</span>.<span class="property">push</span>(<span class="variable">serializeString</span>(<span class="localvariable">name</span>) + <span class="string">&quot;: &quot;</span> + <span class="variable">serializeJSON</span>(<span class="localvariable">value</span>));});<span class="keyword">return</span><span class="string">&quot;{&quot;</span> + <span class="localvariable">properties</span>.<span class="property">join</span>(<span class="string">&quot;, &quot;</span>) + <span class="string">&quot;}&quot;</span>;}<span class="keyword">function</span><span class="variabledef">serializeString</span>(<span class="variabledef">value</span>){<span class="keyword">var</span><span class="variabledef">special</span>={<span class="string">&quot;\&quot;&quot;</span>: <span class="string">&quot;\\\&quot;&quot;</span>, <span class="string">&quot;\\&quot;</span>: <span class="string">&quot;\\\\&quot;</span>, <span class="string">&quot;\f&quot;</span>: <span class="string">&quot;\\f&quot;</span>, <span class="string">&quot;\b&quot;</span>: <span class="string">&quot;\\b&quot;</span>, <span class="string">&quot;\n&quot;</span>: <span class="string">&quot;\\n&quot;</span>, <span class="string">&quot;\t&quot;</span>: <span class="string">&quot;\\t&quot;</span>, <span class="string">&quot;\r&quot;</span>: <span class="string">&quot;\\r&quot;</span>, <span class="string">&quot;\v&quot;</span>: <span class="string">&quot;\\v&quot;</span>};<span class="keyword">var</span><span class="variabledef">escaped</span>=<span class="localvariable">value</span>.<span class="property">replace</span>(<span class="string">/[\&quot;\\\f\b\n\t\r\v]/g</span>, <span class="keyword">function</span>(<span class="variabledef">c</span>){<span class="keyword">return</span><span class="localvariable">special</span>[<span class="localvariable">c</span>];});<span class="keyword">return</span><span class="string">&quot;\&quot;&quot;</span> + <span class="localvariable">escaped</span> + <span class="string">&quot;\&quot;&quot;</span>;}<span class="keyword">var</span><span class="variabledef">type</span>=typeof <span class="localvariable">value</span>;<span class="keyword">if</span> (<span class="localvariable">type</span>==<span class="string">&quot;object&quot;</span> &amp;&amp;<span class="localvariable">isArray</span>(<span class="localvariable">value</span>)) <span class="keyword">return</span><span class="localvariable">serializeArray</span>(<span class="localvariable">value</span>);<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">type</span>==<span class="string">&quot;object&quot;</span>) <span class="keyword">return</span><span class="localvariable">serializeObject</span>(<span class="localvariable">value</span>);<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">type</span>==<span class="string">&quot;string&quot;</span>) <span class="keyword">return</span><span class="localvariable">serializeString</span>(<span class="localvariable">value</span>);<span class="keyword">else</span><span class="keyword">return</span><span class="variable">String</span>(<span class="localvariable">value</span>);}<span class="variable">print</span>(<span class="variable">serializeJSON</span>(<span class="variable">fruit</span>));</pre><p><a class="paragraph" href="#p788f4c1b7638b9f6" name="p788f4c1b7638b9f6"> ¶ </a>The trick used in <code>serializeString</code> is similar to what we saw in the<code>escapeHTML</code> function in <a href="chapter10.html">chapter 10</a>. It uses an object to look up thecorrect replacements for each of the characters. Some of them, such as<code>&quot;\\\\&quot;</code>, look quite weird because of the need to put two backslashesfor every backslash in the resulting string.</p><p><a class="paragraph" href="#p23459ab246be96c" name="p23459ab246be96c"> ¶ </a>Also note that the names of properties are quoted as strings. For someof them, this is not necessary, but for property names with spaces andother strange things in them it is, so the code just takes the easyway out and quotes everything.</p></div></div><hr/><div class="block"><p><a class="paragraph" href="#p1f6ce3dfed84a60f" name="p1f6ce3dfed84a60f"> ¶ </a>When making lots of requests, we do, of course, not want to repeat thewhole <code>open</code>, <code>send</code>, <code>onreadystatechange</code> ritual every time. A verysimple wrapper could look like this:</p><pre class="code"><span class="keyword">function</span><span class="variable">simpleHttpRequest</span>(<span class="variabledef">url</span>, <span class="variabledef">success</span>, <span class="variabledef">failure</span>){<span class="keyword">var</span><span class="variabledef">request</span>=<span class="variable">makeHttpObject</span>();<span class="localvariable">request</span>.<span class="property">open</span>(<span class="string">&quot;GET&quot;</span>, <span class="localvariable">url</span>, <span class="atom">true</span>);<span class="localvariable">request</span>.<span class="property">send</span>(<span class="atom">null</span>);<span class="localvariable">request</span>.<span class="property">onreadystatechange</span>=<span class="keyword">function</span>(){<span class="keyword">if</span> (<span class="localvariable">request</span>.<span class="property">readyState</span>==<span class="atom">4</span>){<span class="keyword">if</span> (<span class="localvariable">request</span>.<span class="property">status</span>==<span class="atom">200</span>) <span class="localvariable">success</span>(<span class="localvariable">request</span>.<span class="property">responseText</span>);<span class="keyword">else</span><span class="keyword">if</span> (<span class="localvariable">failure</span>) <span class="localvariable">failure</span>(<span class="localvariable">request</span>.<span class="property">status</span>, <span class="localvariable">request</span>.<span class="property">statusText</span>);}};}<span class="variable">simpleHttpRequest</span>(<span class="string">&quot;files/fruit.txt&quot;</span>, <span class="variable">print</span>);</pre><p><a class="paragraph" href="#p38f2c042d53afec1" name="p38f2c042d53afec1"> ¶ </a>The function retrieves the url it is given, and calls the function itis given as a second argument with the content. When a third argumentis given, this is used to indicate failure ― a non-<code>200</code> status code.</p><p><a class="paragraph" href="#p2724ce19ae53a641" name="p2724ce19ae53a641"> ¶ </a>To be able to do more complex requests, the function could be made toaccept extra parameters to specify the method (<code>GET</code> or <code>POST</code>), anoptional string to post as data, a way to add extra headers, and soon. When you have so many arguments, you'd probably want to pass themas an arguments-object as seen in <a href="chapter9.html">chapter 9</a>.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p3ab80399325e0221" name="p3ab80399325e0221"> ¶ </a>Some websites make use of intensive communication between the programsrunning on the client and the programs running on the server. For suchsystems, it can be practical to think of some HTTP requests as callsto functions that run on the server. The client makes request to URLsthat identify the functions, giving the arguments as URL parameters or<code>POST</code> data. The server then calls the function, and puts the resultinto JSON or XML document that it sends back. If you write a fewconvenient support functions, this can make calling server-sidefunctions almost as easy as calling client-side ones... except, ofcourse, that you do not get their results instantly.</p></div><ol class="footnotes"><li><a name="footnote1"></a>These are not the only types of requests. There is also <code>HEAD</code>, torequest just the headers for a document, not its content, <code>PUT</code>, toadd a document to a server, and <code>DELETE</code>, to delete a document. Theseare not used by browsers, and often not supported by web-servers, but― if you add server-side programs to support them ― they can beuseful.</li><li><a name="footnote2"></a>Not only the 'XML' part of the <code>XMLHttpRequest</code> name is misleading― the object can also be used for request over protocols other thanHTTP, so <code>Request</code> is the only meaningful part we have left.</li><li><a name="footnote3"></a><code>0</code> ('uninitialized') is the state of the object before <code>open</code> iscalled on it. Calling <code>open</code> moves it to <code>1</code> ('open'). Calling <code>send</code>makes it proceed to <code>2</code> ('sent'). When the server responds, it goes to<code>3</code> ('receiving'). Finally, <code>4</code> means 'loaded'.</li><li><a name="footnote4"></a>We already saw <code>\n</code>, which is a newline. <code>\t</code> is a tab character,<code>\r</code> a 'carriage return', which some systems use before or instead ofa newline to indicate the end of a line. <code>\b</code> (backspace), <code>\v</code>(vertical tab), and <code>\f</code> (form feed) are useful when working with oldprinters, but less so when dealing with Internet browsers.</li></ol><h1><span class="number">Appendix 1: </span>More (obscure) control structures</h1><div class="block"><p><a class="paragraph" href="#p317185e14fa160d2" name="p317185e14fa160d2"> ¶ </a>In <a href="chapter2.html">chapter 2</a>, a number of control statements were introduced, such as<code>while</code>, <code>for</code>, and <code>break</code>. To keep things simple, I left out someothers, which, in my experience, are a lot less useful. This appendixbriefly describes these missing control statements.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p7e8d95a2e61cb3be" name="p7e8d95a2e61cb3be"> ¶ </a>First, there is <a name="key1"></a><code>do</code>. <code>do</code> works like <code>while</code>, but instead ofexecuting the loop body zero or more times, it executes it one or moretimes. A <code>do</code> loop looks like this:</p><pre class="code"><span class="keyword">do</span>{<span class="keyword">var</span><span class="variable">answer</span>=<span class="variable">prompt</span>(<span class="string">&quot;Say 'moo'.&quot;</span>, <span class="string">&quot;&quot;</span>);<span class="variable">print</span>(<span class="string">&quot;You said '&quot;</span>, <span class="variable">answer</span>, <span class="string">&quot;'.&quot;</span>);}<span class="keyword">while</span> (<span class="variable">answer</span> !=<span class="string">&quot;moo&quot;</span>);</pre><p><a class="paragraph" href="#p5a5805128b83f50d" name="p5a5805128b83f50d"> ¶ </a>To emphasise the fact that the condition is only checked <em>after</em> theloop has run once, it is written at the end of the loop's body.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p50a14029a5eb8c80" name="p50a14029a5eb8c80"> ¶ </a>Next, there is <a name="key2"></a><code>continue</code>. This one is closely related to <code>break</code>,and can be used in the same places. While <code>break</code> jumps <em>out</em> of aloop and causes the program to proceed after the loop, <code>continue</code>jumps to the next iteration of the loop.</p><pre class="code"><span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">i</span>=<span class="atom">0</span>;<span class="variable">i</span> &lt;<span class="atom">10</span>;<span class="variable">i</span>++){<span class="keyword">if</span> (<span class="variable">i</span> % <span class="atom">3</span> !=<span class="atom">0</span>) <span class="keyword">continue</span>;<span class="variable">print</span>(<span class="variable">i</span>, <span class="string">&quot;is divisible by three.&quot;</span>);}</pre><p><a class="paragraph" href="#p1c12755797c60807" name="p1c12755797c60807"> ¶ </a>A similar effect can usually be produced using just <code>if</code>, but thereare cases where <code>continue</code> looks nicer.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p1888c5ed0ed59323" name="p1888c5ed0ed59323"> ¶ </a>When there is a loop sitting inside another loop, a <code>break</code> or<code>continue</code> statement will affect only the inner loop. Sometimes youwant to jump out of the <em>outer</em> loop. To be able to refer to aspecific loop, loop statements can be <a name="key3"></a>labelled. A label is a name(any valid variable name will do), followed by a colon (<code>:</code>).</p><pre class="code"><span class="property">outer</span>: <span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">sideA</span>=<span class="atom">1</span>;<span class="variable">sideA</span> &lt;<span class="atom">10</span>;<span class="variable">sideA</span>++){<span class="property">inner</span>: <span class="keyword">for</span> (<span class="keyword">var</span><span class="variable">sideB</span>=<span class="atom">1</span>;<span class="variable">sideB</span> &lt;<span class="atom">10</span>;<span class="variable">sideB</span>++){<span class="keyword">var</span><span class="variable">hypotenuse</span>=<span class="variable">Math</span>.<span class="property">sqrt</span>(<span class="variable">sideA</span> * <span class="variable">sideA</span> + <span class="variable">sideB</span> * <span class="variable">sideB</span>);<span class="keyword">if</span> (<span class="variable">hypotenuse</span> % <span class="atom">1</span>==<span class="atom">0</span>){<span class="variable">print</span>(<span class="string">&quot;A right triangle with straight sides of length &quot;</span>, <span class="variable">sideA</span>, <span class="string">&quot;and &quot;</span>, <span class="variable">sideB</span>, <span class="string">&quot;has a hypotenuse of &quot;</span>, <span class="variable">hypotenuse</span>, <span class="string">&quot;.&quot;</span>);<span class="keyword">break</span><span class="variable">outer</span>;}}}</pre></div><hr/><div class="block"><p><a class="paragraph" href="#p32873086b52cd02b" name="p32873086b52cd02b"> ¶ </a>Next, there is a construct called <a name="key4"></a><code>switch</code> which can be used tochoose which code to execute based on some value. This is a veryuseful thing to do, but the syntax JavaScript uses for this (which ittook from the C programming language) is so clumsy and ugly that Iusually prefer to use a chain of <code>if</code> statements instead.</p><pre class="code"><span class="keyword">function</span><span class="variable">weatherAdvice</span>(<span class="variabledef">weather</span>){<span class="keyword">switch</span>(<span class="localvariable">weather</span>){<span class="keyword">case</span><span class="string">&quot;rainy&quot;</span>: <span class="variable">print</span>(<span class="string">&quot;Remember to bring an umbrella.&quot;</span>);<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">&quot;sunny&quot;</span>: <span class="variable">print</span>(<span class="string">&quot;Dress lightly.&quot;</span>);<span class="keyword">case</span><span class="string">&quot;cloudy&quot;</span>: <span class="variable">print</span>(<span class="string">&quot;Go outside.&quot;</span>);<span class="keyword">break</span>;<span class="property">default</span>: <span class="variable">print</span>(<span class="string">&quot;Unknown weather type: &quot;</span>, <span class="localvariable">weather</span>);<span class="keyword">break</span>;}}<span class="variable">weatherAdvice</span>(<span class="string">&quot;sunny&quot;</span>);</pre><p><a class="paragraph" href="#p5bc54c4dd14212f3" name="p5bc54c4dd14212f3"> ¶ </a>Inside the block opened by <code>switch</code>, you can write a number of <code>case</code>labels. The program will jump to the label that corresponds to thevalue that <code>switch</code> was given (comparing the values with an equivalentof <code>===</code>, so without automatic type conversion), or to <code>default</code> if nomatching value is found. Then it start executing statements there, and<em>continues</em> past other labels, until it reaches a <code>break</code> statement.In some cases, such as the <code>&quot;sunny&quot;</code> case in the example, this can beused to share some code between cases (it recommends going outside forboth sunny and cloudy weather). Most of the time, this just adds a lotof ugly <code>break</code> statements, or causes problems when you forget to addone.</p><p><a class="paragraph" href="#p7d48e03d02d681a3" name="p7d48e03d02d681a3"> ¶ </a>Like loops, <code>switch</code> statements can be given a label.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p684cc333a8c52df1" name="p684cc333a8c52df1"> ¶ </a>Finally, there is a keyword named <a name="key5"></a><code>with</code>. I've never actually <em>used</em>this in a real program, but I have seen other people use it, so it isuseful to know what it is. Code using <code>with</code> looks like this:</p><pre class="code"><span class="keyword">var</span><span class="variable">scope</span>=<span class="string">&quot;outside&quot;</span>;<span class="keyword">var</span><span class="variable">object</span>={<span class="property">name</span>: <span class="string">&quot;Ignatius&quot;</span>, <span class="property">scope</span>: <span class="string">&quot;inside&quot;</span>};<span class="keyword">with</span>(<span class="variable">object</span>){<span class="variable">print</span>(<span class="string">&quot;Name==&quot;</span>, <span class="variable">name</span>, <span class="string">&quot;, scope==&quot;</span>, <span class="variable">scope</span>);<span class="variable">name</span>=<span class="string">&quot;Raoul&quot;</span>;<span class="keyword">var</span><span class="variable">newVariable</span>=<span class="atom">49</span>;}<span class="variable">show</span>(<span class="variable">object</span>.<span class="property">name</span>);<span class="variable">show</span>(<span class="variable">newVariable</span>);</pre><p><a class="paragraph" href="#p63b8a153093e63a" name="p63b8a153093e63a"> ¶ </a>Inside the block, the properties of the object given to <code>with</code> act asvariables. Newly introduced variables are <em>not</em> added as properties tothis object though. I assume the idea behind this construct was thatit could be useful in methods that make lots of use of the propertiesof their object. You could start such a method with <code>with(this){...}</code>, and not have to write <code>this</code> all the time after that.</p></div><h1><span class="number">Appendix 2: </span>Binary Heaps</h1><div class="block"><p><a class="paragraph" href="#p3ad51e69b1d4637a" name="p3ad51e69b1d4637a"> ¶ </a>In <a href="chapter7.html">chapter 7</a>, the <a name="key1"></a>binary heap was introduced as a method to store acollection of objects in such a way that the smallest element can bequickly found. As promised, this appendix will explain the detailsbehind this data structure.</p><p><a class="paragraph" href="#p16c209ac0cec8fab" name="p16c209ac0cec8fab"> ¶ </a>Consider again the problem we needed to solve. The A* algorithmcreated large amounts of small objects, and had to keep these in an'open list'. It was also constantly removing the smallest element fromthis list. The simplest approach would be to just keep all the objectsin an array, and search for the smallest one when we need it. But,unless we have a <em>lot</em> of time, this will not do. Finding the smallestelement in an unsorted array requires going over the whole array, andchecking each element.</p><p><a class="paragraph" href="#p572276834a90ce58" name="p572276834a90ce58"> ¶ </a>The next solution would be, of course, to sort our array. JavaScriptarrays have a wonderful <a name="key2"></a><code>sort</code> method, which can be used to do theheavy work. Unfortunately, re-sorting a whole array every time anelement is added is more work than searching for a minimum value inan unsorted array. Some tricks can be used, such as, instead ofre-sorting the whole array, just making sure new values are insertedin the right place so that the array, which was sorted before, stayssorted. This is coming closer to the approach a binary heap usesalready, but inserting a value in the middle of an array requiresmoving all the elements after it one place up, which is still just tooslow.</p><p><a class="paragraph" href="#p133087e88d1a67df" name="p133087e88d1a67df"> ¶ </a>Another approach is to not use an array at all, but to store thevalues in a set of interconnected objects. A simple form of this is tohave every object hold one value and two (or less) links to otherobjects. There is one root object, holding the smallest value, whichis used to access all the other objects. Links always point to objectsholding greater values, so the whole structure looks something likethis:</p><div class="illustration"><img src="img/tree.png"/></div><p><a class="paragraph" href="#p27ce575d43ee567" name="p27ce575d43ee567"> ¶ </a>Such structures are usually called <a name="key3"></a>trees, because of the way theybranch. Now, when you need the smallest element, you just take off thetop element and rearrange the tree so that one of the top element'schildren ― the one with the lowest value ― becomes the new top. Wheninserting new elements, you 'descend' the tree until you find anelement less than the new element, and insert it there. This takes alot less searching than a sorted array does, but it has thedisadvantage of creating a lot of objects, which also slows thingsdown.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p7859b5b1b88ff0df" name="p7859b5b1b88ff0df"> ¶ </a>A binary heap, then, does make use of a sorted array, but it is onlypartially sorted, much like the tree above. Instead of objects, thepositions in the array are used to form a tree, as this picture triesto show:</p><div class="illustration"><img src="img/heap.png"/></div><p><a class="paragraph" href="#p7867b77b4b2c7639" name="p7867b77b4b2c7639"> ¶ </a>Array element <code>1</code> is the root of the tree, array element <code>2</code> and <code>3</code>are its children, and in general array element <code>X</code> has children <code>X *2</code> and <code>X * 2 + 1</code>. You can see why this structure is called a 'heap'.Note that this array starts at <code>1</code>, while JavaScript arrays start at<code>0</code>. The heap will always keep the smallest element in position <code>1</code>,and make sure that for every element in the array at position <code>X</code>, theelement at <code>X / 2</code> (round down) is smaller.</p><p><a class="paragraph" href="#p306dfd56ae39b23a" name="p306dfd56ae39b23a"> ¶ </a>Finding the smallest element is now a matter of taking the element atposition <code>1</code>. But when this element is removed, the heap must makesure that there are no holes left in the array. To do this, it takesthe last element in the array and moves it to the start, and thencompares it to its child elements at position <code>2</code> and <code>3</code>. It islikely to be greater, so it is exchanged with one of them, and theprocess of comparing it with its children is repeated for the newposition, and so on, until it comes to a position where its childrenare greater, or a position where it has no children.</p><pre class="preformatted">[2, 3, 5, 4, 8, 7, 6]Take out 2, move 6 to the front.[6, 3, 5, 4, 8, 7]6 is greater than its first child 3, so swap them.[3, 6, 5, 4, 8, 7]Now 6 has children 4 and 8 (position 4 and 5). It is greater than4, so we swap again.[3, 4, 5, 6, 8, 7]6 is in position 4, and has no more children. The heap is in orderagain.</pre><p><a class="paragraph" href="#p4e546a29c19b6c57" name="p4e546a29c19b6c57"> ¶ </a>Similarly, when an element has to be added to the heap, it is put atthe end of the array and allowed to 'bubble' up by repeatedlyexchanging it with its parent, until we find a parent that is lessthan the new node.</p><pre class="preformatted">[3, 4, 5, 6, 8, 7]Element 2 gets added again, it starts at the back.[3, 4, 5, 6, 8, 7, 2]2 is in position 7, its parent is at 3, which is a 5. 5 is greaterthan 2, so we swap.[3, 4, 2, 6, 8, 7, 5]The parent of position 3 is position 1. Again, we swap.[2, 4, 3, 6, 8, 7, 5]The element can not go further than position 1, so we are done.</pre><p><a class="paragraph" href="#p32a5a6cbb1fc90f1" name="p32a5a6cbb1fc90f1"> ¶ </a>Note how adding or inserting an element does not require it to becompared with every element in the array. In fact, because the jumpsbetween parents and children get bigger as the array gets bigger, thisadvantage is especially large when we have a lot of elements<a class="footref" href="#footnote1">1</a>.</p></div><hr/><div class="block"><p><a class="paragraph" href="#p75d2422111be5673" name="p75d2422111be5673"> ¶ </a>Here is the full code of a binary heap implementation. Two things tonote are that, instead of directly comparing the elements put into theheap, a function (<code>scoreFunction</code>) is first applied to them, so thatit becomes possible to store objects that can not be directlycompared.</p><p><a class="paragraph" href="#p1ece19e94713954c" name="p1ece19e94713954c"> ¶ </a>Also, because JavaScript arrays start at <code>0</code>, and the parent/childcalculations use a system that starts at <code>1</code>, there are a few strangecalculations to compensate.</p><pre class="code"><span class="keyword">function</span><span class="variable">BinaryHeap</span>(<span class="variabledef">scoreFunction</span>){<span class="localvariable">this</span>.<span class="property">content</span>=[];<span class="localvariable">this</span>.<span class="property">scoreFunction</span>=<span class="localvariable">scoreFunction</span>;}<span class="variable">BinaryHeap</span>.<span class="property">prototype</span>={<span class="property">push</span>: <span class="keyword">function</span>(<span class="variabledef">element</span>){<span class="comment">// Add the new element to the end of the array.</span><span class="localvariable">this</span>.<span class="property">content</span>.<span class="property">push</span>(<span class="localvariable">element</span>);<span class="comment">// Allow it to bubble up.</span><span class="localvariable">this</span>.<span class="property">bubbleUp</span>(<span class="localvariable">this</span>.<span class="property">content</span>.<span class="property">length</span> - <span class="atom">1</span>);}, <span class="property">pop</span>: <span class="keyword">function</span>(){<span class="comment">// Store the first element so we can return it later.</span><span class="keyword">var</span><span class="variabledef">result</span>=<span class="localvariable">this</span>.<span class="property">content</span>[<span class="atom">0</span>];<span class="comment">// Get the element at the end of the array.</span><span class="keyword">var</span><span class="variabledef">end</span>=<span class="localvariable">this</span>.<span class="property">content</span>.<span class="property">pop</span>();<span class="comment">// If there are any elements left, put the end element at the</span><span class="comment">// start, and let it sink down.</span><span class="keyword">if</span> (<span class="localvariable">this</span>.<span class="property">content</span>.<span class="property">length</span> &gt;<span class="atom">0</span>){<span class="localvariable">this</span>.<span class="property">content</span>[<span class="atom">0</span>]=<span class="localvariable">end</span>;<span class="localvariable">this</span>.<span class="property">sinkDown</span>(<span class="atom">0</span>);}<span class="keyword">return</span><span class="localvariable">result</span>;}, <span class="property">remove</span>: <span class="keyword">function</span>(<span class="variabledef">node</span>){<span class="keyword">var</span><span class="variabledef">length</span>=<span class="localvariable">this</span>.<span class="property">content</span>.<span class="property">length</span>;<span class="comment">// To remove a value, we must search through the array to find</span><span class="comment">// it.</span><span class="keyword">for</span> (<span class="keyword">var</span><span class="variabledef">i</span>=<span class="atom">0</span>;<span class="localvariable">i</span> &lt;<span class="localvariable">length</span>;<span class="localvariable">i</span>++){<span class="keyword">if</span> (<span class="localvariable">this</span>.<span class="property">content</span>[<span class="localvariable">i</span>] !=<span class="localvariable">node</span>) <span class="keyword">continue</span>;<span class="comment">// When it is found, the process seen in 'pop' is repeated</span><span class="comment">// to fill up the hole.</span><span class="keyword">var</span><span class="variabledef">end</span>=<span class="localvariable">this</span>.<span class="property">content</span>.<span class="property">pop</span>();<span class="comment">// If the element we popped was the one we needed to remove,</span><span class="comment">// we're done.</span><span class="keyword">if</span> (<span class="localvariable">i</span>==<span class="localvariable">length</span> - <span class="atom">1</span>) <span class="keyword">break</span>;<span class="comment">// Otherwise, we replace the removed element with the popped</span><span class="comment">// one, and allow it to float up or sink down as appropriate.</span><span class="localvariable">this</span>.<span class="property">content</span>[<span class="localvariable">i</span>]=<span class="localvariable">end</span>;<span class="localvariable">this</span>.<span class="property">bubbleUp</span>(<span class="localvariable">i</span>);<span class="localvariable">this</span>.<span class="property">sinkDown</span>(<span class="localvariable">i</span>);<span class="keyword">break</span>;}}, <span class="property">size</span>: <span class="keyword">function</span>(){<span class="keyword">return</span><span class="localvariable">this</span>.<span class="property">content</span>.<span class="property">length</span>;}, <span class="property">bubbleUp</span>: <span class="keyword">function</span>(<span class="variabledef">n</span>){<span class="comment">// Fetch the element that has to be moved.</span><span class="keyword">var</span><span class="variabledef">element</span>=<span class="localvariable">this</span>.<span class="property">content</span>[<span class="localvariable">n</span>], <span class="variabledef">score</span>=<span class="localvariable">this</span>.<span class="property">scoreFunction</span>(<span class="localvariable">element</span>);<span class="comment">// When at 0, an element can not go up any further.</span><span class="keyword">while</span> (<span class="localvariable">n</span> &gt;<span class="atom">0</span>){<span class="comment">// Compute the parent element's index, and fetch it.</span><span class="keyword">var</span><span class="variabledef">parentN</span>=<span class="variable">Math</span>.<span class="property">floor</span>((<span class="localvariable">n</span> + <span class="atom">1</span>) / <span class="atom">2</span>) - <span class="atom">1</span>, <span class="variabledef">parent</span>=<span class="localvariable">this</span>.<span class="property">content</span>[<span class="localvariable">parentN</span>];<span class="comment">// If the parent has a lesser score, things are in order and we</span><span class="comment">// are done.</span><span class="keyword">if</span> (<span class="localvariable">score</span> &gt;=<span class="localvariable">this</span>.<span class="property">scoreFunction</span>(<span class="localvariable">parent</span>)) <span class="keyword">break</span>;<span class="comment">// Otherwise, swap the parent with the current element and</span><span class="comment">// continue.</span><span class="localvariable">this</span>.<span class="property">content</span>[<span class="localvariable">parentN</span>]=<span class="localvariable">element</span>;<span class="localvariable">this</span>.<span class="property">content</span>[<span class="localvariable">n</span>]=<span class="localvariable">parent</span>;<span class="localvariable">n</span>=<span class="localvariable">parentN</span>;}}, <span class="property">sinkDown</span>: <span class="keyword">function</span>(<span class="variabledef">n</span>){<span class="comment">// Look up the target element and its score.</span><span class="keyword">var</span><span class="variabledef">length</span>=<span class="localvariable">this</span>.<span class="property">content</span>.<span class="property">length</span>, <span class="variabledef">element</span>=<span class="localvariable">this</span>.<span class="property">content</span>[<span class="localvariable">n</span>], <span class="variabledef">elemScore</span>=<span class="localvariable">this</span>.<span class="property">scoreFunction</span>(<span class="localvariable">element</span>);<span class="keyword">while</span>(<span class="atom">true</span>){<span class="comment">// Compute the indices of the child elements.</span><span class="keyword">var</span><span class="variabledef">child2N</span>=(<span class="localvariable">n</span> + <span class="atom">1</span>) * <span class="atom">2</span>, <span class="variabledef">child1N</span>=<span class="localvariable">child2N</span> - <span class="atom">1</span>;<span class="comment">// This is used to store the new position of the element,</span><span class="comment">// if any.</span><span class="keyword">var</span><span class="variabledef">swap</span>=<span class="atom">null</span>;<span class="comment">// If the first child exists (is inside the array)...</span><span class="keyword">if</span> (<span class="localvariable">child1N</span> &lt;<span class="localvariable">length</span>){<span class="comment">// Look it up and compute its score.</span><span class="keyword">var</span><span class="variabledef">child1</span>=<span class="localvariable">this</span>.<span class="property">content</span>[<span class="localvariable">child1N</span>], <span class="variabledef">child1Score</span>=<span class="localvariable">this</span>.<span class="property">scoreFunction</span>(<span class="localvariable">child1</span>);<span class="comment">// If the score is less than our element's, we need to swap.</span><span class="keyword">if</span> (<span class="localvariable">child1Score</span> &lt;<span class="localvariable">elemScore</span>) <span class="localvariable">swap</span>=<span class="localvariable">child1N</span>;}<span class="comment">// Do the same checks for the other child.</span><span class="keyword">if</span> (<span class="localvariable">child2N</span> &lt;<span class="localvariable">length</span>){<span class="keyword">var</span><span class="variabledef">child2</span>=<span class="localvariable">this</span>.<span class="property">content</span>[<span class="localvariable">child2N</span>], <span class="variabledef">child2Score</span>=<span class="localvariable">this</span>.<span class="property">scoreFunction</span>(<span class="localvariable">child2</span>);<span class="keyword">if</span> (<span class="localvariable">child2Score</span> &lt;(<span class="localvariable">swap</span>==<span class="atom">null</span> ? <span class="localvariable">elemScore</span> : <span class="localvariable">child1Score</span>)) <span class="localvariable">swap</span>=<span class="localvariable">child2N</span>;}<span class="comment">// No need to swap further, we are done.</span><span class="keyword">if</span> (<span class="localvariable">swap</span>==<span class="atom">null</span>) <span class="keyword">break</span>;<span class="comment">// Otherwise, swap and continue.</span><span class="localvariable">this</span>.<span class="property">content</span>[<span class="localvariable">n</span>]=<span class="localvariable">this</span>.<span class="property">content</span>[<span class="localvariable">swap</span>];<span class="localvariable">this</span>.<span class="property">content</span>[<span class="localvariable">swap</span>]=<span class="localvariable">element</span>;<span class="localvariable">n</span>=<span class="localvariable">swap</span>;}}};</pre><p><a class="paragraph" href="#p52526691c872a7c" name="p52526691c872a7c"> ¶ </a>And a simple test...</p><pre class="code"><span class="keyword">var</span><span class="variable">heap</span>=<span class="keyword">new</span><span class="variable">BinaryHeap</span>(<span class="keyword">function</span>(<span class="variabledef">x</span>){<span class="keyword">return</span><span class="localvariable">x</span>;});<span class="variable">forEach</span>([<span class="atom">10</span>, <span class="atom">3</span>, <span class="atom">4</span>, <span class="atom">8</span>, <span class="atom">2</span>, <span class="atom">9</span>, <span class="atom">7</span>, <span class="atom">1</span>, <span class="atom">2</span>, <span class="atom">6</span>, <span class="atom">5</span>], <span class="variable">method</span>(<span class="variable">heap</span>, <span class="string">&quot;push&quot;</span>));<span class="variable">heap</span>.<span class="property">remove</span>(<span class="atom">2</span>);<span class="keyword">while</span> (<span class="variable">heap</span>.<span class="property">size</span>() &gt;<span class="atom">0</span>) <span class="variable">print</span>(<span class="variable">heap</span>.<span class="property">pop</span>());</pre></div><ol class="footnotes"><li><a name="footnote1"></a>The amount of comparisons and swaps that are needed ― in the worstcase ― can be approached by taking the logarithm (base 2) of theamount of elements in the heap.</li></ol></div><div class="footer">© <a href="mailto:marijnh@gmail.com">Marijn Haverbeke</a> (<a href="http://creativecommons.org/licenses/by/3.0/">license</a>), written March to July 2007, last modified on November 28 2013.</div></body></html>
